C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE POWER
OBJECT MODULE PLACED IN power.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE power.c OPTIMIZE(8,SIZE) BROWSE FLOATFUZZY(6) DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*******************************************************************************
   2           * é¢„è­¦ç”µæºæ§åˆ¶å™¨ä¸‹ä½æœºè½¯ä»¶
   3           *
   4           * debug1.00  20210122  ä¸€å·å‚æˆ¿
   5           * è½¯ä»¶æ„æ¶
   6           * 
   7           * debug1.01  20210123  ä¸€å·å‚æˆ¿
   8           * CANæ€»çº¿æ¥å£è°ƒè¯•
   9           * 
  10           * debug1.02  20210125  ä¸€å·å‚æˆ¿
  11           * æ•°æ®ç»„å¸§å¤„ç†
  12           * 
  13           * debug1.03  20210126  ä¸€å·å‚æˆ¿
  14           * GF6å®éªŒæ¿CANæ€»çº¿åè®®è°ƒè¯• 
  15           * 
  16           * debug1.04-1.05  20210207  ä¸€å·å‚æˆ¿
  17           * æ€»çº¿æŒ‡ä»¤ã€ä¸Šæ³¨æ•°æ®å—ã€RAMåœ°å€ä¸‹ä¼ 
  18           * a. ä¿®è®¢åˆ‡åŒºæ ‡å¿—ä¸ºç‹¬ç«‹å¯¹åº”å…³ç³»
  19           * b. CANæ€»çº¿åè®®è°ƒè¯•
  20           * 
  21           * debug1.06  20210216  ä¸€å·å‚æˆ¿
  22           * A/Bæ€»çº¿ä¸€è‡´æ€§ä¿®ç›– 
  23           * 
  24           * debug1.07  20210220  ä¸€å·å‚æˆ¿
  25           * ä¿®æ”¹500K  
  26           * 
  27           * debug1.08  20210222  ä¸€å·å‚æˆ¿
  28           * ä¿®æ”¹é‡è¦æ•°æ®å¸§æ ¼å¼  
  29           * 
  30           * debug1.09  20210223  ä¸€å·å‚æˆ¿
  31           * ä¿®æ”¹æŒ‡ä»¤æ ¼å¼ä¿®æ”¹ 
  32           *
  33           * debug1.10  20210223  ä¸€å·å‚æˆ¿
  34           * ä¿®æ”¹çŠ¶æ€é‡ä¸º0/1ï¼Œå¢åŠ çŠ¶æ€è§£æ
  35           * æ›´æ–°æœåŠ¡è¯·æ±‚æ—¶é—´é—´éš”
  36           * 
  37           * debug1.11 20210224  ä¸€å·å‚æˆ¿
  38           * å¢åŠ ABæ€»çº¿é¥æµ‹ä¿¡æ¯
  39           * ä¸Šæ³¨ç¨‹åºæµ‹è¯•
  40           * 
  41           * debug1.12  20210225  ä¸€å·å‚æˆ¿
  42           * ä¿®è®¢é¥æµ‹ä¿¡æ¯  å¤ªé˜³é˜µé¥æµ‹5-9ã€8-12
  43           * ä¿®è®¢ç³»æ•°
  44           * å¢åŠ æ‹Ÿåˆç”µæµç­‰çš„è´Ÿå€¼ä¿æŠ¤è®¾è®¡
  45           * 
  46           * debug1.13  20210312  ä¸€å·å‚æˆ¿
  47           * åè®®æ›´æ”¹åè”è¯•
  48           * 
  49           * debug1.14-debug1.15  20210312/15  home 
  50           * åè®®æ›´æ”¹åè”è¯•
  51           * é‡è¦æ•°æ®ã€è¿‡æ»¤åŒ…ã€RAMè®¾ç½®ï¼ŒæœåŠ¡è¯·æ±‚
  52           * 
  53           * debug1.16  20210316 å¡”æ¥¼åæ¥¼è°ƒè¯•é—´
  54           * ä¿®æ­£åˆ†æµçŠ¶æ€ï¼Œå¿«åŒ…é•¿åº¦ç­‰é—®é¢˜
  55           * 
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 2   

  56           * debug1.17~debug1.18  20210316 å¡”æ¥¼åæ¥¼è°ƒè¯•é—´
  57           * å¢åŠ 422å‡è¡¡å™¨æ•°æ®æ¥æ”¶è®¾ç½®
  58           * å‡è¡¡æŒ‡ä»¤å‘é€
  59           *  
  60           * debug1.19  20210317 å¡”æ¥¼åæ¥¼è°ƒè¯•é—´
  61           * å¢åŠ å•ä½“ç‰©ç†å€¼æ’åº
  62           * å¢åŠ ç”µé‡è®¡åŠŸèƒ½æ¨¡å—
  63           * 
  64           * debug1.20-debug1.21  20210317 home
  65           * å¢åŠ ä¸Šç”µåˆå§‹åŒ–æŒ‡ä»¤è®¾ç½®
  66           * å‚æ•°ä¸Šæ³¨æ¥æ”¶å¤„ç†
  67           * é‡è¦æ•°æ®å‘é€ã€æ¥æ”¶å¤„ç†
  68           * 
  69           * debug1.22  20210318 å¡”æ¥¼åæ¥¼è°ƒè¯•é—´  
  70           * å¥åº·å­—æ£€æµ‹
  71           * è“„ç”µæ± ç»„è¿‡å……ä¿æŠ¤ã€å•ä½“è¿‡å……ä¿æŠ¤
  72           * 
  73           * debug1.23  20210318 home
  74           * å¤šä½™ä»£ç åˆ é™¤
  75           * 
  76           * debug1.24  20210319  å¡”æ¥¼åæ¥¼è°ƒè¯•é—´  
  77           * å¥åº·å­—ç›‘æµ‹çŠ¶æ€ã€è‡ªæ£€ç­‰
  78           * 
  79           * debug1.25  20210319  å¡”æ¥¼åæ¥¼è°ƒè¯•é—´  æµ‹è¯•ç‰ˆæœ¬V1
  80           * ä¿®æ­£å‡è¡¡å™¨çŠ¶æ€åˆ¤è¯»é¡ºåºbug
  81           * 
  82           * debug1.26  20210320  å¡”æ¥¼åæ¥¼è°ƒè¯•é—´  æµ‹è¯•ç‰ˆæœ¬V1
  83           * ä¿®æ­£é‡è¦æ•°æ®åº”ç­”TITLE
  84           * å¢åŠ æ€»çº¿ABæ ‡è¯†
  85           * ä¿®æ­£è¿‡æ»¤åŒ…åŸºå‡†ç”µå‹ã€ä¿®æ­£å–å€¼é”™è¯¯
  86           * 
  87           * debug1.27  20210322  å¡”æ¥¼åæ¥¼è°ƒè¯•é—´  æµ‹è¯•ç‰ˆæœ¬V1
  88           * ä¿®æ­£æŒ‡ä»¤å‡è¡¡æŒ‡ä»¤è®¾ç½®ã€å‡è¡¡çŠ¶æ€<< bug ä¿®æ­£
  89           * å¢åŠ é—´æ¥æŒ‡ä»¤å‡è¡¡æ§åˆ¶è¾“å‡ºï¼ˆé€šæ–­ï¼‰
  90           * ä¿®æ­£å†…å­˜åœ°å€è®¾ç½®åº”ç­”åˆ¤è¯»bug  CANRXD-B  / A000 -> C000   
  91           * å¢åŠ å‡è¡¡ç¦æ­¢æ—¶å‘é€å…¨éƒ¨å‡è¡¡æ–­å¼€æŒ‡ä»¤
  92           * 
  93           * debug1.28  20210322  HOME
  94           * ä¿®æ”¹å•ä½“å……ç”µä¿æŠ¤é»˜è®¤ä¸ºç¦æ­¢çŠ¶æ€ -- singleProtectChargeEn=FALSE
  95           * ä¿®æ”¹è“„ç”µæ± å……ç”µä¿æŠ¤é»˜è®¤ä¸ºç¦æ­¢çŠ¶æ€ -- overChargeProtectEn=FALSE  
  96           * å¢åŠ ç³»ç»Ÿæ—¶é—´ç»´æŠ¤
  97           * å¢åŠ è‡ªä¸»æŒ‡ä»¤è®°å½•åŠŸèƒ½
  98           * ä¸Šæ³¨å‚æ•°èŒƒå›´åˆ¤æ–­
  99           * ä¿®æ­£å……ç”µç”µæµ1ã€2è®¡ç®—bug
 100           * 
 101           * debug1.29  20210322    å¡”æ¥¼åæ¥¼è°ƒè¯•é—´ 
 102           * ä¿®æ”¹ä¸­æ–­å‡½æ•°è°ƒç”¨using bug 
 103           * ä¿®æ­£healthStateWord2ç»„çŠ¶æ€å­— æ¸…é›¶ bug
 104           * ä¿®æ­£equVRefPhyåŸºå‡†ç”µå‹åˆ¤æ–­é€»è¾‘bug
 105           * å¢åŠ å‡è¡¡å™¨é‡‡é›†ç­‰å¾…æ—¶é—´çº¦ 140ms
 106           * 
 107           * debug1.30-deubg1.31  20210324    å¡”æ¥¼åæ¥¼è°ƒè¯•é—´ 
 108           * ä¿®æ”¹å•ä½“è¿‡å……ä¿æŠ¤ã€è“„ç”µæ± ç»„è¿‡å……ä¿æŠ¤æ¨¡å— 
 109           * ä¿®æ­£ç”µé‡ä¸Šæ³¨èŒƒå›´åˆ¤æ–­bug
 110           * ä¿®æ­£å±è”½å­—è®¾ç½®
 111           * ä¿®æ­£å‡è¡¡é‡‡é›†æ•°é‡ 40å­—èŠ‚
 112           
 113           
 114           * debug1.32  20210324    å¡”æ¥¼åæ¥¼è°ƒè¯•é—´ 
 115           * ä»£ç ä¼˜åŒ–
 116           * 
 117           
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 3   

 118           
 119           * æ³¨æ„ï¼š 
 120           * 1. å¥åº·å­—è®¾ç½®æ ‡å¿—ï¼Œ 16ä¸º4ç§’åæ¸…é™¤æ ‡å¿— 
 121           
 122          *******************************************************************************/
 123          
 124          #include <reg52.h>
 125          #include <absacc.h>
 126          #include <intrins.h>
 127          #include <math.h>
 128          
 129          #define TRUE 0xAA  // å®šä¹‰çœŸå€¼
 130          #define FALSE 0x55 // å®šä¹‰å‡å€¼
 131          
 132          #define SILENT_TIME 4 // æœ€å¤§æ€»çº¿æ²‰å¯‚æ—¶é—´(s) -- æ ¹æ®é€šè®¯åè®®æˆ–æ•°æ®çº¦å®šç¡®è®¤
 133          
 134          #define VERSION 131 // å†…éƒ¨ç‰ˆæœ¬
 135          
 136          #define BUSA_ADDR 0xA000 // æ€»çº¿Aåœ°å€
 137          #define BUSB_ADDR 0xC000 // æ€»çº¿Båœ°å€
 138          
 139          #define CAN_ACR 0x9B // æ¥æ”¶ç å¯„å­˜å™¨
 140          #define CAN_AMR 0xD4 // æ¥æ”¶å±è”½å¯„å­˜å™¨
 141          
 142          #define ONOFF_ADDR XBYTE[0xF800] // ONOFFæŒ‡ä»¤åœ°å€
 143          #define AN_ADDR XBYTE[0xF400]  // æ¨¡æ‹Ÿé‡åœ°å€
 144          
 145          #define AD574S XBYTE[0xFC00] // ADå¯åŠ¨è½¬æ¢
 146          #define AD574H XBYTE[0xFC02] // ADè½¬æ¢é«˜åœ°å€
 147          #define AD574L XBYTE[0xFC03] // ADè½¬æ¢ä½åœ°å€
 148          
 149          #define DA_A_CUR XBYTE[0xE400] // Aç»„ç”µæµ
 150          #define DA_A_VOL XBYTE[0xE800] // Aç»„ç”µå‹
 151          #define DA_B_CUR XBYTE[0xEC00] // Bç»„ç”µæµ
 152          #define DA_B_VOL XBYTE[0xF000] // Bç»„ç”µæµ
 153          
 154          #define TXD422BUFF XBYTE[0xE000] // RS422å‘é€
 155          #define RXD422BUFF XBYTE[0xE080] // RS422çš„Aæ¥æ”¶
 156          
 157          #define K1 0.025 // å……åˆ†æ¨¡å—1å¤ªé˜³ç”µæ± é˜µç”µæµç³»æ•°     811æ‰€ è”è¯•æ ‡å®šV1  20210225
 158          #define b1 0
 159          #define K2 0.025 // å……åˆ†æ¨¡å—2å¤ªé˜³ç”µæ± é˜µç”µæµç³»æ•°     811æ‰€ è”è¯•æ ‡å®šV1  20210225
 160          #define b2 0
 161          #define K3 0.025 // å……åˆ†æ¨¡å—3å¤ªé˜³ç”µæ± é˜µç”µæµç³»æ•°     811æ‰€ è”è¯•æ ‡å®šV1  20210225
 162          #define b3 0
 163          #define K4 0.025 // å……åˆ†æ¨¡å—4å¤ªé˜³ç”µæ± é˜µç”µæµç³»æ•°     811æ‰€ è”è¯•æ ‡å®šV1  20210225
 164          #define b4 0
 165          
 166          #define K5 0.025 // æ¯çº¿ç”µæµ1ç³»æ•°           811æ‰€ è”è¯•æ ‡å®šV1  20210225
 167          #define b5 0
 168          #define K6 0.025 // æ¯çº¿ç”µæµ2ç³»æ•°           811æ‰€ è”è¯•æ ‡å®šV1  20210225
 169          #define b6 0
 170          #define K7 0.025 // æ¯çº¿ç”µæµ3ç³»æ•°           811æ‰€ è”è¯•æ ‡å®šV1  20210225
 171          #define b7 0
 172          #define K8 0.025 // æ¯çº¿ç”µæµ4ç³»æ•°           811æ‰€ è”è¯•æ ‡å®šV1  20210225
 173          #define b8 0
 174          
 175          #define K9 0.025 // å……ç”µç”µæµ1ç³»æ•°           811æ‰€ è”è¯•æ ‡å®šV1  20210225
 176          #define b9 0.0
 177          #define K10 0.025 // å……ç”µç”µæµ2ç³»æ•°          811æ‰€ è”è¯•æ ‡å®šV1  20210225
 178          #define b10 0.0
 179          
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 4   

 180          #define K11 0.025 // æ”¾ç”µç”µæµ1ç³»æ•°          811æ‰€ è”è¯•æ ‡å®šV1  20210225
 181          #define b11 0.0
 182          #define K12 0.025 // æ”¾ç”µç”µæµ2ç³»æ•°          811æ‰€ è”è¯•æ ‡å®šV1  20210225
 183          #define b12 0.0
 184          
 185          #define K13 0.0025 // å‡è¡¡å™¨åŸºå‡†5Vç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 186          #define b13 0.00
 187          
 188          #define K14 0.025 // è“„ç”µæ± ä¸»ä»½ç”µå‹ï¼ˆä¸‹ä½æœºé‡‡é›†ï¼‰
 189          #define b14 0.0
 190          
 191          #define K16 0.025 // è“„ç”µæ± ä¸»ä»½ç”µå‹ï¼ˆå‡è¡¡å™¨é‡‡é›†ï¼‰  V = A*1000/4096
 192          #define b16 0.0
 193          #define K17 0.025 // è“„ç”µæ± å¤‡ä»½ç”µå‹ï¼ˆå‡è¡¡å™¨é‡‡é›†ï¼‰  V = A*1000/4096
 194          #define b17 0.0
 195          
 196          #define K18 0.025 // å……ç”µé˜µA1ç”µæµç³»æ•°
 197          #define b18 0.0
 198          #define K19 0.025 // å……ç”µé˜µA2ç”µæµç³»æ•°
 199          #define b19 0.0
 200          #define K20 0.025 // å……ç”µé˜µA3ç”µæµç³»æ•°
 201          #define b20 0.0
 202          #define K21 0.025 // å……ç”µé˜µA4ç”µæµç³»æ•°
 203          #define b21 0.0
 204          #define K22 0.025 // å……ç”µé˜µA5ç”µæµç³»æ•°
 205          #define b22 0.0
 206          
 207          #define K25 0.025 // å……ç”µé˜µB1ç”µæµç³»æ•°
 208          #define b25 0.0
 209          #define K26 0.025 // å……ç”µé˜µB2ç”µæµç³»æ•°
 210          #define b26 0.0
 211          #define K27 0.025 // å……ç”µé˜µB3ç”µæµç³»æ•°
 212          #define b27 0.0
 213          #define K28 0.025 // å……ç”µé˜µB4ç”µæµç³»æ•°
 214          #define b28 0.0
 215          #define K29 0.025 // å……ç”µé˜µB5ç”µæµç³»æ•°
 216          #define b29 0.0
 217          
 218          #define K23 0.025 // MEAç³»æ•°
 219          #define b23 0.0
 220          #define K24 0.025 // æ¯çº¿ç”µå‹ç³»æ•°
 221          #define b24 0.0
 222          
 223          #define Ka1 0.0025 // å•ä½“1ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 224          #define ba1 0
 225          #define Ka2 0.0025 // å•ä½“2ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 226          #define ba2 0
 227          #define Ka3 0.0025 // å•ä½“3ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 228          #define ba3 0
 229          #define Ka4 0.0025 // å•ä½“4ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 230          #define ba4 0
 231          #define Ka5 0.0025 // å•ä½“5ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 232          #define ba5 0
 233          #define Ka6 0.0025 // å•ä½“6ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 234          #define ba6 0
 235          #define Ka7 0.0025 // å•ä½“7ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 236          #define ba7 0
 237          #define Ka8 0.0025 // å•ä½“8ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 238          #define ba8 0
 239          #define Ka9 0.0025 // å•ä½“9ç”µå‹ç³»æ•°  -- å‡è¡¡å™¨  V = A*1000/4096
 240          #define ba9 0
 241          
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 5   

 242          #define Ks1 0.025 // å¤ªé˜³é˜µ1ç”µå‹ ç³»æ•°
 243          #define bs1 0
 244          #define Ks2 0.025 // å¤ªé˜³é˜µ2ç”µå‹ ç³»æ•°
 245          #define bs2 0
 246          #define Ks3 0.025 // å¤ªé˜³é˜µ3ç”µå‹ ç³»æ•°
 247          #define bs3 0
 248          #define Ks4 0.025 // å¤ªé˜³é˜µ4ç”µå‹ ç³»æ•°
 249          #define bs4 0
 250          #define Ks5 0.025 // å¤ªé˜³é˜µ5ç”µå‹ ç³»æ•°
 251          #define bs5 0
 252          #define Ks6 0.025 // å¤ªé˜³é˜µ6ç”µå‹ ç³»æ•°
 253          #define bs6 0
 254          #define Ks7 0.025 // å¤ªé˜³é˜µ7ç”µå‹ ç³»æ•°
 255          #define bs7 0
 256          #define Ks8 0.025 // å¤ªé˜³é˜µ8ç”µå‹ ç³»æ•°
 257          #define bs8 0
 258          #define Ks9 0.025 // å¤ªé˜³é˜µ9ç”µå‹ ç³»æ•°
 259          #define bs9 0
 260          #define Ks10 0.025 // å¤ªé˜³é˜µ10ç”µå‹ ç³»æ•°
 261          #define bs10 0
 262          #define Ks11 0.025 // å¤ªé˜³é˜µ11ç”µå‹ ç³»æ•°
 263          #define bs11 0
 264          #define Ks12 0.025 // å¤ªé˜³é˜µ12ç”µå‹ ç³»æ•°
 265          #define bs12 0
 266          #define Ks13 0.025 // å¤ªé˜³é˜µ13ç”µå‹ ç³»æ•°
 267          #define bs13 0
 268          #define Ks14 0.025 // å¤ªé˜³é˜µ14ç”µå‹ ç³»æ•°
 269          #define bs14 0
 270          #define Ks15 0.025 // å¤ªé˜³é˜µ15ç”µå‹ ç³»æ•°
 271          #define bs15 0
 272          #define Ks16 0.025 // å¤ªé˜³é˜µ16ç”µå‹ ç³»æ•°
 273          #define bs16 0
 274          
 275          sbit fgRstType = P1 ^ (unsigned int)(0x02); // çƒ­å¤ä½æ ‡è¯†ï¼Œ0=å†·å¤ä½ 1=çƒ­å¤ä½
 276          sbit onoffEn = P1 ^ (unsigned int)(0x04); // æŒ‡ä»¤è¾“å‡ºä½¿èƒ½
 277          sbit dog = P1 ^ (unsigned int)(0x05);   // çœ‹é—¨ç‹—è¾“å‡º
 278          sbit RXD422AEn = P1 ^ (unsigned int)0x00; // 422Aæ€»çº¿æ¥æ”¶ä½¿èƒ½ï¼Œ0ä¸ºä½¿èƒ½
 279          sbit TXD422En = P1 ^ (unsigned int)0x06;  // 422Aæ€»çº¿å‘é€ä½¿èƒ½ï¼Œ0ä¸ºä½¿èƒ½
 280          sbit TXDCONTROL = P3 ^ (unsigned int)0x01;  // å‘é€é—¨æ§ä¿¡å·
 281          sbit RXDCONTROL = P3 ^ (unsigned int)0x00;  // æ¥æ”¶é—¨æ§ä¿¡å·
 282          
 283          const unsigned char code rsTab[100] = {
 284            // æ¨¡æ‹Ÿé‡é‡‡é›†ç è¡¨
 285            0x10, // 00 æ¯çº¿ç”µæµ1
 286            0x11, // 01 æ¯çº¿ç”µæµ3
 287            0x12, // 02 æ¯çº¿ç”µæµ2
 288            0x13, // 03 æ¯çº¿ç”µæµ4
 289            0x14, // 04 æ”¾ç”µç”µæµ1ï¼ˆSCï¼‰
 290            0x15, // 05 è“„ç”µæ± ç”µå‹1ï¼ˆSCï¼‰
 291            0x16, // 06 æ”¾ç”µç”µæµ2ï¼ˆSCï¼‰
 292            0x17, // 07 è“„ç”µæ± ç”µå‹2ï¼ˆSCï¼‰
 293            0x18, // 08 BDRA1å·¥ä½œçŠ¶æ€
 294            0x19, // 09 æ”¾ç”µè¾“å‡ºç”µæµA1
 295            0x1A, // 10 BDRB1å·¥ä½œçŠ¶æ€
 296            0x1B, // 11 æ”¾ç”µè¾“å‡ºç”µæµB1
 297            0x1C, // 12 BDRA2å·¥ä½œçŠ¶æ€
 298            0x1D, // 13 æ”¾ç”µè¾“å‡ºç”µæµA2
 299            0x1E, // 14 BDRB2å·¥ä½œçŠ¶æ€
 300            0x1F, // 15 æ”¾ç”µè¾“å‡ºç”µæµB2
 301            0x20, // 16 BDRA3å·¥ä½œçŠ¶æ€
 302            0x21, // 17 æ”¾ç”µè¾“å‡ºç”µæµA3
 303            0x22, // 18 BDRB3å·¥ä½œçŠ¶æ€
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 6   

 304            0x23, // 19 æ”¾ç”µè¾“å‡ºç”µæµB3
 305            0x24, // 20 BDRA4å·¥ä½œçŠ¶æ€
 306            0x25, // 21 æ”¾ç”µè¾“å‡ºç”µæµA4
 307            0x26, // 22 BDRB4å·¥ä½œçŠ¶æ€
 308            0x27, // 23 æ”¾ç”µè¾“å‡ºç”µæµB4
 309            0x28, // 24 æ”¾ç”µæ¨¡å—æ¸©åº¦1
 310            0x29, // 25 å……ç”µç”µæµ1ï¼ˆSCï¼‰
 311            0x2A, // 26 æ”¾ç”µæ¨¡å—æ¸©åº¦2
 312            0x2B, // 27 å……ç”µç”µæµ2ï¼ˆSCï¼‰
 313            0x2C, // 28 é¢„æ¥é€šå¼€å…³1çŠ¶æ€
 314            0x2D, // 29 æ”¾ç”µå¼€å…³2-1çŠ¶æ€
 315            0x2E, // 30 æ”¾ç”µå¼€å…³1-1çŠ¶æ€
 316            0x2F, // 31 æ”¾ç”µå¼€å…³2-2çŠ¶æ€
 317            0x30, // 32 æ”¾ç”µå¼€å…³1-2çŠ¶æ€
 318            0x31, // 33 é¢„æ¥é€šå¼€å…³2çŠ¶æ€
 319            0x32, // 34 æ¯çº¿ç”µå‹
 320            0x33, // 35 å……åˆ†æ¨¡å—1å¤ªé˜³é˜µæ€»ç”µæµ
 321            0x34, // 36 å……åˆ†æ¨¡å—2å¤ªé˜³é˜µæ€»ç”µæµ
 322            0x35, // 37 å……åˆ†æ¨¡å—3å¤ªé˜³é˜µæ€»ç”µæµ
 323            0x36, // 38 å……åˆ†æ¨¡å—4å¤ªé˜³é˜µæ€»ç”µæµ
 324            0x37, // 39 å……ç”µé˜µA1çŠ¶æ€
 325            0x38, // 40 BEAç”µå‹1
 326            0x39, // 41 å……ç”µé˜µA2çŠ¶æ€
 327            0x3A, // 42 BEAç”µå‹2
 328            0x3B, // 43 å……ç”µé˜µA3çŠ¶æ€
 329            0x3C, // 44 å……ç”µé˜µA4çŠ¶æ€
 330            0x3D, // 45 å……ç”µé˜µA5çŠ¶æ€
 331            0x3E, // 46 å……ç”µé˜µB1çŠ¶æ€
 332            0x3F, // 47 å……ç”µé˜µB2çŠ¶æ€
 333            0x40, // 48 MEAç”µå‹
 334            0x41, // 49 å……ç”µé˜µB3çŠ¶æ€
 335            0x42, // 50 å……ç”µé˜µB4çŠ¶æ€
 336            0x43, // 51 å……ç”µé˜µB5çŠ¶æ€
 337            0x44, // 52 å¤ªé˜³ç”µæ± é˜µ3ç”µå‹
 338            0x45, // 53 å¤ªé˜³ç”µæ± é˜µ7ç”µå‹
 339            0x46, // 54 å¤ªé˜³ç”µæ± é˜µ11ç”µå‹
 340            0x47, // 55 å¤ªé˜³ç”µæ± é˜µ15ç”µå‹
 341            0x48, // 56 å¤ªé˜³ç”µæ± é˜µ2ç”µå‹
 342            0x49, // 57 å¤ªé˜³ç”µæ± é˜µ6ç”µå‹
 343            0x4A, // 58 å¤ªé˜³ç”µæ± é˜µ10ç”µå‹
 344            0x4B, // 59 å¤ªé˜³ç”µæ± é˜µ14ç”µå‹
 345            0x4C, // 60 å¤ªé˜³ç”µæ± é˜µ1ç”µå‹
 346            0x4D, // 61 å¤ªé˜³ç”µæ± é˜µ5ç”µå‹
 347            0x4E, // 62 å¤ªé˜³ç”µæ± é˜µ9ç”µå‹
 348            0x4F, // 63 å¤ªé˜³ç”µæ± é˜µ13ç”µå‹
 349            0x50, // 64 å¤ªé˜³ç”µæ± é˜µ4ç”µå‹
 350            0x51, // 65 å¤ªé˜³ç”µæ± é˜µ8ç”µå‹
 351            0x52, // 66 å¤ªé˜³ç”µæ± é˜µ12ç”µå‹
 352            0x53, // 67 å¤ªé˜³ç”µæ± é˜µ16ç”µå‹
 353            0x54, // 68 å……ç”µé˜µA1å……ç”µç”µæµ
 354            0x55, // 69 å……ç”µé˜µA3å……ç”µç”µæµ
 355            0x56, // 70 å……ç”µé˜µA2å……ç”µç”µæµ
 356            0x57, // 71 å……ç”µé˜µA5å……ç”µç”µæµ
 357            0x58, // 72 å……ç”µé˜µA4å……ç”µç”µæµ
 358            0x59, // 73 å……ç”µé˜µB1å……ç”µç”µæµ
 359            0x5A, // 74 å……ç”µé˜µB3å……ç”µç”µæµ
 360            0x5B, // 75 å……ç”µé˜µB5å……ç”µç”µæµ
 361            0x5C, // 76 å……ç”µé˜µB2å……ç”µç”µæµ
 362            0x5D, // 77 å……åˆ†æ¨¡å—3åˆ†æµä¿æŠ¤ç®¡é€šæ–­æŒ‡ç¤º
 363            0x5E, // 78 å……ç”µé˜µB4å……ç”µç”µæµ
 364            0x5F, // 79 åˆ†æµæ¨¡å—æ¸©åº¦1
 365            0x60, // 80 åˆ†æµæ¨¡å—æ¸©åº¦2
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 7   

 366            0x61, // 81 å……åˆ†æ¨¡å—2åˆ†æµä¿æŠ¤ç®¡é€šæ–­æŒ‡ç¤º
 367            0x62, // 82 å……åˆ†æ¨¡å—1åˆ†æµä¿æŠ¤ç®¡é€šæ–­æŒ‡ç¤º
 368            0x63, // 83 å……åˆ†æ¨¡å—4åˆ†æµä¿æŠ¤ç®¡é€šæ–­æŒ‡ç¤º
 369            0x64, // 84 ä¸‹ä½æœºä¸»æœº+5Vç”µæº
 370            0x65, // 85 ä¸‹ä½æœºå¤‡æœº+5Vç”µæº
 371          };
 372          
 373          const unsigned char code onoffTab[50] = {
 374            // é—´æ¥æŒ‡ä»¤é€šç è¡¨
 375            0xE1, // 01 åˆ†æµä¿æŠ¤ç®¡1æ–­å¼€
 376            0xE2, // 02 åˆ†æµä¿æŠ¤ç®¡5æ–­å¼€
 377            0xE3, // 03 åˆ†æµä¿æŠ¤ç®¡9æ–­å¼€
 378            0xE4, // 04 åˆ†æµä¿æŠ¤ç®¡13æ–­å¼€
 379            0xE5, // 05 å……ç”µé˜µA1æ–­å¼€
 380            0xE6, // 06 å……ç”µé˜µA3æ–­å¼€
 381            0xE7, // 07 å……ç”µé˜µA5æ–­å¼€
 382            0xE8, // 08 Aç»„å……ç”µé˜µæ¥é€š
 383            0xE9, // 09 å……åˆ†æ¨¡å—1åˆ†æµä¿æŠ¤ç®¡æ¥é€š
 384            0xEA, // 10 åˆ†æµä¿æŠ¤ç®¡3æ–­å¼€
 385            0xEB, // 11 åˆ†æµä¿æŠ¤ç®¡7æ–­å¼€
 386            0xEC, // 12 åˆ†æµä¿æŠ¤ç®¡11æ–­å¼€
 387            0xED, // 13 åˆ†æµä¿æŠ¤ç®¡15æ–­å¼€
 388            0xEE, // 14 å……ç”µé˜µA2æ–­å¼€
 389            0xD1, // 15 å……ç”µé˜µA4æ–­å¼€
 390            0xD2, // 16 å……åˆ†æ¨¡å—2åˆ†æµä¿æŠ¤ç®¡æ¥é€š
 391            0xD3, // 17 åˆ†æµä¿æŠ¤ç®¡2æ–­å¼€
 392            0xD4, // 18 åˆ†æµä¿æŠ¤ç®¡6æ–­å¼€
 393            0xD5, // 19 åˆ†æµä¿æŠ¤ç®¡10æ–­å¼€
 394            0xD6, // 20 åˆ†æµä¿æŠ¤ç®¡14æ–­å¼€
 395            0xD7, // 21 å……ç”µé˜µB1æ–­å¼€
 396            0xD8, // 22 å……ç”µé˜µB3æ–­å¼€
 397            0xD9, // 23 å……ç”µé˜µB5æ–­å¼€
 398            0xDA, // 24 Bç»„å……ç”µé˜µæ¥é€š
 399            0xDB, // 25 å……åˆ†æ¨¡å—3åˆ†æµä¿æŠ¤ç®¡æ¥é€š
 400            0xDC, // 26 åˆ†æµä¿æŠ¤ç®¡4æ–­å¼€
 401            0xDD, // 27 åˆ†æµä¿æŠ¤ç®¡8æ–­å¼€
 402            0xDE, // 28 åˆ†æµä¿æŠ¤ç®¡12æ–­å¼€
 403            0xB1, // 29 åˆ†æµä¿æŠ¤ç®¡16æ–­å¼€
 404            0xB2, // 30 å……ç”µé˜µB2æ–­å¼€
 405            0xB3, // 31 å……ç”µé˜µB4æ–­å¼€
 406            0xB4, // 32 å……åˆ†æ¨¡å—4åˆ†æµä¿æŠ¤ç®¡æ¥é€š
 407            0xB5, // 33 BDRA1ä½¿èƒ½
 408            0xB6, // 34 BDRA1ç¦æ­¢
 409            0xB7, // 35 BDRB1ä½¿èƒ½
 410            0xB8, // 36 BDRB1ç¦æ­¢
 411            0xB9, // 37 BDRA2ä½¿èƒ½
 412            0xBA, // 38 BDRA2ç¦æ­¢
 413            0xBB, // 39 BDRB2ä½¿èƒ½
 414            0xBC, // 40 BDRB2ç¦æ­¢
 415            0xBD, // 41 BDRA3ä½¿èƒ½
 416            0xBE, // 42 BDRA3ç¦æ­¢
 417            0x71, // 43 BDRB3ä½¿èƒ½
 418            0x72, // 44 BDRB3ç¦æ­¢
 419            0x73, // 45 BDRA4ä½¿èƒ½
 420            0x74, // 46 BDRA4ç¦æ­¢
 421            0x75, // 47 BDRB4ä½¿èƒ½
 422            0x76  // 48 BDRB4ç¦æ­¢
 423          };
 424          
 425          const unsigned int code equAqOnTab[9] = {
 426            0x8000, // 01 å•ä½“1æ¥é€š
 427            0x8005, // 02 å•ä½“2æ¥é€š
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 8   

 428            0x8009, // 03 å•ä½“3æ¥é€š
 429            0x800C, // 04 å•ä½“4æ¥é€š
 430            0x8011, // 05 å•ä½“5æ¥é€š
 431            0x8014, // 06 å•ä½“6æ¥é€š
 432            0x8018, // 07 å•ä½“7æ¥é€š
 433            0x801D, // 08 å•ä½“8æ¥é€š
 434            0x8021  // 09 å•ä½“9æ¥é€š
 435          };
 436          
 437          const unsigned int code equAqOffTab[9] = {
 438            0x8003, // 01 å•ä½“1æ–­å¼€
 439            0x8006, // 02 å•ä½“2æ–­å¼€
 440            0x800A, // 03 å•ä½“3æ–­å¼€
 441            0x800F, // 04 å•ä½“4æ–­å¼€
 442            0x8012, // 05 å•ä½“5æ–­å¼€
 443            0x8017, // 06 å•ä½“6æ–­å¼€
 444            0x801B, // 07 å•ä½“7æ–­å¼€
 445            0x801E, // 08 å•ä½“8æ–­å¼€
 446            0x8022  // 09 å•ä½“9æ–­å¼€
 447          };
 448          
 449          const float code volTab[8] = {(float)32.45, (float)32.85, (float)28.35, (float)32.05, (float)35.65, (float
             -)36.1, (float)36.55, (float)37.00}; // è“„ç”µæ± é™å‹å€¼
 450          const float code singlechargeVolt[8] = {(float)28.35, (float)32.05, (float)32.45, (float)32.85, (float)35.
             -65, (float)36.1, (float)36.55, (float)37.00};
 451          const unsigned char code volKickTab[8] = {0x03, 0x04, 0x01, 0x02, 0x05, 0x06, 0x07, 0x08}; // å¯¹åº”ç”µå‹
             -æ¡£ä½
 452          
 453          const unsigned char code curCsTab[8] = {0x01, 0x02, 0x03, 0x04, 0x00, 0x05, 0x06, 0x07}; // è“„ç”µæ± é™æµ
             -å€¼
 454          const unsigned char code volCsTab[8] = {0x01, 0x02, 0x03, 0x04, 0x00, 0x06, 0x07, 0x05}; // è“„ç”µæ± é™å
             -‹å€¼
 455          
 456          const unsigned char code volSwitchOnoffTabA[8] = {0x1D, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24}; // è“„ç
             -”µæ± Aåˆ‡æ¢æŒ‡ä»¤è¡¨
 457          const unsigned char code volSwitchOnoffTabB[8] = {0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x34}; // è“„ç
             -”µæ± Båˆ‡æ¢æŒ‡ä»¤è¡¨
 458          
 459          float xdata limbCurrent;  // å¤ªé˜³ç¿¼æ€»ç”µæµ PASS INIT
 460          float xdata limbCurrentA; // å¤ªé˜³ç¿¼Aç”µæµ PASS INIT
 461          float xdata limbCurrentB; // å¤ªé˜³ç¿¼Bç”µæµ PASS INIT
 462          
 463          float xdata chargeCurrent;  // å……ç”µç”µæµ  PASS INIT
 464          float xdata chargeCurrent1; // å……ç”µç”µæµ1 PASS INIT
 465          float xdata chargeCurrent2; // å……ç”µç”µæµ2 PASS INIT
 466          
 467          float xdata dischargeCurrent;  // æ”¾ç”µç”µæµ  PASS INIT
 468          float xdata dischargeCurrent1; // æ”¾ç”µç”µæµ1 PASS INIT
 469          float xdata dischargeCurrent2; // æ”¾ç”µç”µæµ2 PASS INIT
 470          
 471          float xdata genCurrent;       // æ¯çº¿ç”µæµ  PASS INIT
 472          float xdata meaV;         // meaV  PASS INIT
 473          float xdata generatrixVol;      // æ¯çº¿ç”µå‹  PASS INIT
 474          float xdata chargeArrayCurrent[10]; // å……ç”µé˜µA-Bç”µæµ1-5  PASS INIT
 475          
 476          unsigned int xdata accVAHard; // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼(å‡è¡¡å™¨åŸç )  PASS INIT
 477          
 478          float xdata accVAHardPyh; // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ ç‰©ç†å€¼  -- ä¸‹ä½æœºé‡‡é›†  PASS INIT
 479          float xdata accVAEquPyh;  // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡å™¨é‡‡é›†  PASS INIT
 480          float xdata accVBEquPyh;  // ç”µæ± ç»„ç”µå‹å¤‡é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡å™¨é‡‡é›†  PASS INIT
 481          float xdata equVRefPhy;   // å‡è¡¡åŸºå‡†ç”µå‹(ç‰©ç†å€¼)      -- å‡è¡¡å™¨é‡‡é›†  PASS INIT
 482          
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 9   

 483          unsigned char xdata chargeVolKickA;   // å……ç”µé™å‹æ¡£æ•°A A  PASS INIT 2/3
 484          unsigned char xdata chargeVolKickA_B; // å……ç”µé™å‹æ¡£æ•°A B  PASS INIT
 485          unsigned char xdata chargeVolKickA_C; // å……ç”µé™å‹æ¡£æ•°A C  PASS INIT
 486          
 487          unsigned char xdata chargeVolKickB;   // å……ç”µé™å‹æ¡£æ•°B A  PASS INIT 2/3
 488          unsigned char xdata chargeVolKickB_B; // å……ç”µé™å‹æ¡£æ•°B B  PASS INIT
 489          unsigned char xdata chargeVolKickB_C; // å……ç”µé™å‹æ¡£æ•°B C  PASS INIT
 490          
 491          unsigned char xdata chargeVolKickRsA; // å……ç”µé™å‹åˆ‡æ¢æ¡£æ•°A  PASS INIT
 492          unsigned char xdata chargeVolKickRsB; // å……ç”µé™å‹åˆ‡æ¢æ¡£æ•°B  PASS INIT
 493          
 494          unsigned char xdata chargeCurKickA;   // å……ç”µé™æµæ¡£æ•°A A  PASS INIT 2/3
 495          unsigned char xdata chargeCurKickA_B; // å……ç”µé™æµæ¡£æ•°A B  PASS INIT
 496          unsigned char xdata chargeCurKickA_C; // å……ç”µé™æµæ¡£æ•°A C  PASS INIT
 497          
 498          unsigned char xdata chargeCurKickB;   // å……ç”µé™æµæ¡£æ•°B A  PASS INIT 2/3
 499          unsigned char xdata chargeCurKickB_B; // å……ç”µé™æµæ¡£æ•°B B  PASS INIT
 500          unsigned char xdata chargeCurKickB_C; // å……ç”µé™æµæ¡£æ•°B C  PASS INIT
 501          
 502          unsigned char xdata fg16S; // 16s æ—¶é—´å®šæ—¶æ ‡å¿— -- é‡è¦æ•°æ®å‘é€è¯·æ±‚å‘¨æœŸ PASS INIT
 503          unsigned char xdata fg30S; // 30s æ—¶é—´å®šæ—¶è®¡æ•°æ ‡å¿—  å‡è¡¡å‘¨æœŸè®¡æ•°
 504          unsigned char xdata fg60S; // 60s æ—¶é—´å®šæ—¶è®¡æ•°æ ‡å¿—(è¿‡æ»¤åŒ…) PASS INIT
 505          
 506          unsigned char clockCount;    // 1sç¨‹åºè¿è¡Œå®šæ—¶è®¡æ•°å™¨  PASS INIT
 507          unsigned char errorCount;    // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨  å†…éƒ¨å˜é‡  PASS INIT
 508          unsigned char xdata errorCountA; // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨A  PASS INIT
 509          unsigned char xdata errorCountB; // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨B  PASS INIT
 510          
 511          unsigned char xdata resetCount;  // çƒ­å¤ä½è®¡æ•°  PASS INIT  2/3
 512          unsigned char xdata resetCountB; // çƒ­å¤ä½è®¡æ•°B  PASS INIT
 513          unsigned char xdata resetCountC; // çƒ­å¤ä½è®¡æ•°C  PASS INIT
 514          
 515          unsigned char xdata onoffExeCount;  // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•° A  PASS INIT  2/3
 516          unsigned char xdata onoffExeCountB; // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•° B  PASS INIT
 517          unsigned char xdata onoffExeCountC; // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•° C  PASS INIT
 518          
 519          unsigned char xdata onoffErrorCount;  // é¥æ§æŒ‡ä»¤é”™è¯¯è®¡æ•° A  PASS INIT  2/3
 520          unsigned char xdata onoffErrorCountB; // é¥æ§æŒ‡ä»¤é”™è¯¯è®¡æ•° B  PASS INIT
 521          unsigned char xdata onoffErrorCountC; // é¥æ§æŒ‡ä»¤é”™è¯¯è®¡æ•° C  PASS INIT
 522          
 523          unsigned char xdata onoffReceCount;  // æ€»çº¿æŒ‡ä»¤æ¥æ”¶è®¡æ•°å™¨ A PASS INIT 2/3
 524          unsigned char xdata onoffReceCountB; // æ€»çº¿æŒ‡ä»¤æ¥æ”¶è®¡æ•°å™¨ B PASS INIT
 525          unsigned char xdata onoffReceCountC; // æ€»çº¿æŒ‡ä»¤æ¥æ”¶è®¡æ•°å™¨ C PASS INIT
 526          
 527          unsigned char xdata fgSwitch1; // æ•°æ®é‡‡é›†ä¿å­˜åˆ‡åŒºæ ‡å¿—1 PASS INIT
 528          unsigned char xdata fgSwitch2; // æ•°æ®é‡‡é›†ä¿å­˜åˆ‡åŒºæ ‡å¿—2 PASS INIT
 529          
 530          unsigned char xdata wrOnoffIndex;   // å†™ç´¢å¼• PASS INIT
 531          unsigned char xdata rdOnoffIndex;   // è¯»ç´¢å¼• PASS INIT
 532          unsigned char xdata onoffBuffer[24][2]; // æŒ‡ä»¤æ¥æ”¶ç¼“å†²åŒº PASS INIT
 533          
 534          unsigned char xdata wrOnoffRecIndex;          // è‡ªä¸»æŒ‡ä»¤è®°å½•åŒºå†™ç´¢å¼• PASS INIT
 535          unsigned int xdata onoffBufferRec[24][6] _at_ 0x9800; // æŒ‡ä»¤è®°å½•ç¼“å­˜åŒº    PASS INIT
 536          
 537          unsigned int xdata anData[100];          // åŸå§‹æ¨¡æ‹Ÿé‡æ•°æ®é‡‡é›†åŒº 16bit
 538          unsigned char xdata rsFrame1A[70] _at_ 0x9000; // å¿«åŒ…é¥æµ‹å‚æ•°æ•°ç»„ åˆå§‹åŒ–ç»„å¸§æ›´æ–°
 539          unsigned char xdata rsFrame1B[70];
 540          unsigned char xdata rsFrame2A[170] _at_ 0x9200; // æ…¢åŒ…é¥æµ‹å‚æ•°æ•°ç»„ åˆå§‹åŒ–ç»„å¸§æ›´æ–°
 541          unsigned char xdata rsFrame2B[170];
 542          unsigned char xdata rsFrame3[70] _at_ 0x9400; // è¿‡æ»¤åŒ…é¥æµ‹å‚æ•°æ•°ç»„ åˆå§‹åŒ–ç»„å¸§æ›´æ–°
 543          
 544          unsigned char xdata filterDataRec[41]; // è¿‡æ»¤åŒ…æ•°æ® å¯¹æ¯”åŒ… PASS INIT
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 10  

 545          unsigned char xdata filterFrame[41];   // è¿‡æ»¤åŒ…æ•°æ®ç¼“å­˜åŒº PASS INIT
 546          
 547          unsigned char xdata fgRsRam;            // RAMåŒ…ä¸‹ä¼ è¯·æ±‚æ ‡å¿— PASS INIT
 548          unsigned char ramUploadData[8];           // RAMåœ°å€ä¸Šæ³¨æ•°æ®ä¿¡æ¯
 549          unsigned char xdata rsRamFrame[190];        // RAMåŒ… -- 128å­—èŠ‚ ç»„å¸§æ›´æ–°
 550          unsigned char xdata ramTestData[128] _at_ 0x9600; // ç‰¹å®šåœ°å€ 8000èµ·å§‹åœ°å€ PASS INIT
 551          
 552          unsigned char xdata fgImportantDataRx;     // é‡è¦æ•°æ®æ¢å¤è¯·æ±‚æ ‡å¿— PASS INIT
 553          unsigned char xdata rsImportantData[220];  // é‡è¦æ•°æ®ä¿å­˜åŒ…-ç¼“å­˜åŒº PASS INIT
 554          unsigned char xdata rsImportantFrame[320]; // é‡è¦æ•°æ®ä¿å­˜åŒ…-ç»„å¸§å‘é€åŒº åˆå§‹åŒ–å¡«å……å¤„ç†
 555          
 556          unsigned char xdata reqData[12]; // æœåŠ¡è¯·æ±‚ç  PASS INIT
 557          unsigned char wrReqIndex;    // å†™ç´¢å¼• PASS INIT
 558          unsigned char rdReqIndex;    // è¯»ç´¢å¼• PASS INIT
 559          
 560          unsigned char xdata fgUploadPara;    // ä¸Šæ³¨å‚æ•°è¯·æ±‚æ ‡å¿— PASS INIT
 561          unsigned char xdata uploadParaData[4]; // ä¸Šæ³¨å‚æ•°æ•°æ® PASS INIT
 562          
 563          unsigned char xdata fgCanBus; // å½“å‰æ€»çº¿ä½¿ç”¨çŠ¶æ€æ ‡å¿— PASS INIT
 564          
 565          unsigned char xdata *pSendA;       // Aæ€»çº¿å‘é€æŒ‡é’ˆ --  ä½¿ç”¨å‰æ›´æ–°
 566          unsigned char sendIndexA;        // Aæ€»çº¿å‘é€å¸§ç´¢å¼• --  CANInfoAåˆå§‹åŒ–
 567          unsigned char sendFrameA;        // Aæ€»çº¿å‘é€æ•°æ®åŒ…æ€»å¸§æ•° --  CANInfoAåˆå§‹åŒ–
 568          unsigned char receiveFrameA;       // Aæ€»çº¿æ¥æ”¶æ•°æ®å¸§è®¡æ•° --  CANInfoAåˆå§‹åŒ–
 569          unsigned int receiveSumA;        // Aæ€»çº¿æ¥æ”¶æ•°æ®åŒ…ç´¯åŠ å’Œ --  CANInfoAåˆå§‹åŒ–
 570          unsigned char receiveCountA;       // Aæ€»çº¿æ¥æ”¶æ•°æ®è®¡æ•° --  CANInfoAåˆå§‹åŒ–
 571          unsigned char xdata receiveBufferA[256]; // Aæ€»çº¿æ•°æ®åŒ…æ¥æ”¶ç¼“å­˜åŒº(wLength+Title+Data+Sum) --  CA
             -NInfoAåˆå§‹åŒ–
 572          
 573          unsigned char xdata *pSendB;       // Bæ€»çº¿å‘é€æŒ‡é’ˆ --  ä½¿ç”¨å‰æ›´æ–°
 574          unsigned char sendIndexB;        // Bæ€»çº¿å‘é€å¸§ç´¢å¼• --  CANInfoAåˆå§‹åŒ–
 575          unsigned char sendFrameB;        // Bæ€»çº¿å‘é€æ•°æ®åŒ…æ€»å¸§æ•° --  CANInfoAåˆå§‹åŒ–
 576          unsigned char receiveFrameB;       // Bæ€»çº¿æ¥æ”¶æ•°æ®å¸§è®¡æ•° --  CANInfoAåˆå§‹åŒ–
 577          unsigned int receiveSumB;        // Bæ€»çº¿æ¥æ”¶æ•°æ®åŒ…ç´¯åŠ å’Œ --  CANInfoAåˆå§‹åŒ–
 578          unsigned char receiveCountB;       // Bæ€»çº¿æ¥æ”¶æ•°æ®è®¡æ•° --  CANInfoAåˆå§‹åŒ–
 579          unsigned char xdata receiveBufferB[256]; // Bæ€»çº¿æ•°æ®åŒ…æ¥æ”¶ç¼“å­˜åŒº(wLength+Title+Data+Sum) --  CA
             -NInfoAåˆå§‹åŒ–
 580          
 581          unsigned char xdata pcuState1; // PCUçŠ¶æ€å­—1 PASS INIT
 582          unsigned char xdata pcuState2; // PCUçŠ¶æ€å­—2 PASS INIT
 583          unsigned char xdata pcuState3; // PCUçŠ¶æ€å­—3 PASS INIT
 584          unsigned char xdata pcuState4; // PCUçŠ¶æ€å­—4 PASS INIT
 585          
 586          unsigned int xdata accEquVA; // ç”µæ± ç»„ç”µå‹ä¸»(åŸç ) PASS INIT
 587          unsigned int xdata accEquVB; // ç”µæ± ç»„ç”µå‹å¤‡(åŸç ) PASS INIT
 588          unsigned int xdata equ12VP;  // å‡è¡¡+12Vç”µå‹(åŸç ) PASS INIT
 589          unsigned int xdata equ12VN;  // å‡è¡¡-12Vç”µå‹(åŸç ) PASS INIT
 590          unsigned int xdata equ5VP;   // å‡è¡¡+5Vç”µå‹(åŸç ) PASS INIT
 591          unsigned int xdata equVRef;  // å‡è¡¡åŸºå‡†ç”µå‹(åŸç ) PASS INIT
 592          
 593          unsigned int xdata aq[11];       // å•ä½“ç”µå‹ PASS INIT
 594          float xdata aqPhy[11];         // å•ä½“ç”µå‹ ç‰©ç†å€¼ PASS INIT
 595          float xdata aqPhyPx[11];       // å•ä½“ç”µå‹ ç‰©ç†å€¼æ’åº PASS INIT
 596          unsigned char xdata aqControlNumber; // å•ä½“æ§åˆ¶æ•°é‡ PASS INIT
 597          
 598          unsigned char xdata fgEquRx;       // å‡è¡¡422æ¥æ”¶æ ‡å¿— PASS INIT
 599          unsigned char xdata fgEquTx;       // å‡è¡¡422å‘é€æ ‡å¿— PASS INIT
 600          unsigned char xdata equDataBuffer[40]; // å‡è¡¡æ•°æ®æ¥æ”¶ç¼“å­˜ PASS INIT
 601          unsigned char xdata equRxCount;      // å‡è¡¡422æ¥æ”¶è®¡æ•° PASS INIT
 602          unsigned char xdata equExeCount[9];    // å‡è¡¡æ‰§è¡Œè®¡æ•° PASS INIT
 603          
 604          unsigned char xdata wrEquOnoffIndex;   // å‡è¡¡æŒ‡ä»¤å†™ç´¢å¼• PASS INIT
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 11  

 605          unsigned char xdata rdEquOnoffIndex;   // å‡è¡¡æŒ‡ä»¤è¯»ç´¢å¼• PASS INIT
 606          unsigned int xdata equOnoffBuffer[48]; // å‡è¡¡æŒ‡ä»¤æŒ‡ä»¤æ¥æ”¶ç¼“å†²åŒº PASS INIT
 607          
 608          float xdata equOpenValue;  // å‡è¡¡å¼€é—¨é™å€¼A PASS INIT  !!!!
 609          float xdata equOpenValueB; // å‡è¡¡å¼€é—¨é™å€¼B PASS INIT
 610          float xdata equOpenValueC; // å‡è¡¡å¼€é—¨é™å€¼C PASS INIT
 611          
 612          float xdata equCloseValue;  // å‡è¡¡å…³é—¨é™å€¼A PASS INIT !!!!
 613          float xdata equCloseValueB; // å‡è¡¡å…³é—¨é™å€¼B PASS INIT
 614          float xdata equCloseValueC; // å‡è¡¡å…³é—¨é™å€¼C PASS INIT
 615          
 616          unsigned char xdata equState1; // å‡è¡¡422çŠ¶æ€1 PASS INIT
 617          unsigned char xdata equState2; // å‡è¡¡422çŠ¶æ€2 PASS INIT
 618          
 619          unsigned char xdata sepCurrentState1; // åˆ†æµ1ä¿æŠ¤é€šæ–­çŠ¶æ€ PASS INIT
 620          unsigned char xdata sepCurrentState2; // åˆ†æµ2ä¿æŠ¤é€šæ–­çŠ¶æ€ PASS INIT
 621          unsigned char xdata sepCurrentState3; // åˆ†æµ3ä¿æŠ¤é€šæ–­çŠ¶æ€ PASS INIT
 622          unsigned char xdata sepCurrentState4; // åˆ†æµ4ä¿æŠ¤é€šæ–­çŠ¶æ€ PASS INIT
 623          
 624          unsigned char xdata fgAh;     // å®‰æ—¶è®¡å¯åŠ¨æ ‡å¿— PASS INIT
 625          unsigned int xdata AhCount16S;    // å®‰æ—¶è®¡è®¡æ•°æ—¶é—´ ï¼ˆ16S åˆ¤è¯»ï¼‰PASS INIT
 626          unsigned char xdata powerSave[6]; // ç”µé‡å€¼å­˜å‚¨ PASS INIT
 627          
 628          unsigned char xdata proportion;  // å……æ”¾æ¯”A PASS INIT  !!!
 629          unsigned char xdata proportionB; // å……æ”¾æ¯”B PASS INIT
 630          unsigned char xdata proportionC; // å……æ”¾æ¯”C PASS INIT
 631          
 632          float xdata chargePower;  // è“„ç”µæ± ç»„å……ç”µç”µé‡å€¼ PASS INIT
 633          float xdata dischargePower; // è“„ç”µæ± ç»„æ”¾ç”µç”µé‡å€¼ PASS INIT
 634          float xdata currentPower; // è“„ç”µæ± ç»„å½“å‰ç”µé‡å€¼ PASS INIT
 635          
 636          float xdata ntrPower;  // è“„ç”µæ± ç»„æ»¡ç”µé‡A PASS INIT
 637          float xdata ntrPowerB; // è“„ç”µæ± ç»„æ»¡ç”µé‡B PASS INIT
 638          float xdata ntrPowerC; // è“„ç”µæ± ç»„æ»¡ç”µé‡C PASS INIT
 639          
 640          unsigned char xdata importDataRxState; // é‡è¦æ•°æ®æ¢å¤çŠ¶æ€ PASS INIT
 641          unsigned char xdata selfControlCount;  // è‡ªä¸»æ§åˆ¶è®¡æ•° PASS INIT
 642          
 643          unsigned char xdata selfCheckStateWord; // è‡ªæ£€çŠ¶æ€å­— PASS INIT
 644          unsigned int xdata healthStateWord1;  // å¥åº·çŠ¶æ€å­—1 PASS INIT
 645          unsigned int xdata healthStateWord2;  // å¥åº·çŠ¶æ€å­—2 PASS INIT
 646          
 647          unsigned char xdata selfCheckStateContrl;  // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—A  PASS INIT  !!!
 648          unsigned char xdata selfCheckStateContrlB; // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—B  PASS INIT
 649          unsigned char xdata selfCheckStateContrlC; // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—C  PASS INIT
 650          
 651          unsigned int xdata aqStateContrl;  // å•ä½“æ§åˆ¶å­—A  PASS INIT  !!!
 652          unsigned int xdata aqStateContrlB; // å•ä½“æ§åˆ¶å­—B  PASS INIT
 653          unsigned int xdata aqStateContrlC; // å•ä½“æ§åˆ¶å­—C  PASS INIT
 654          
 655          unsigned int xdata healthStateContr1;  // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—A   PASS INIT  !!!
 656          unsigned int xdata healthStateContr1B; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—B   PASS INIT
 657          unsigned int xdata healthStateContr1C; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—C   PASS INIT
 658          
 659          unsigned int xdata healthStateContr2;  // å¥åº·çŠ¶æ€å­—2æ§åˆ¶å­—A   PASS INIT  !!!
 660          unsigned int xdata healthStateContr2B; // å¥åº·çŠ¶æ€å­—2æ§åˆ¶å­—B   PASS INIT
 661          unsigned int xdata healthStateContr2C; // å¥åº·çŠ¶æ€å­—2æ§åˆ¶å­—C   PASS INIT
 662          
 663          unsigned char xdata equControlEn;  // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€A   PASS INIT  !!!
 664          unsigned char xdata equControlEnB; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B   PASS INIT
 665          unsigned char xdata equControlEnC; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C   PASS INIT
 666          
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 12  

 667          unsigned char xdata singleProtectChargeEn;  //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€A   PASS INIT  !!!
 668          unsigned char xdata singleProtectChargeEnB; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B   PASS INIT
 669          unsigned char xdata singleProtectChargeEnC; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C   PASS INIT
 670          
 671          unsigned char xdata overChargeProtectEn;  // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—A   PASS INIT  !!!
 672          unsigned char xdata overChargeProtectEnB; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—B   PASS INIT
 673          unsigned char xdata overChargeProtectEnC; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—C   PASS INIT
 674          
 675          float xdata singleVProtectValueUP;  // å•ä½“ä¸Šé™ä¿æŠ¤å€¼A   PASS INIT  !!!
 676          float xdata singleVProtectValueUPB; // å•ä½“ä¸Šé™ä¿æŠ¤å€¼B   PASS INIT
 677          float xdata singleVProtectValueUPC; // å•ä½“ä¸Šé™ä¿æŠ¤å€¼C   PASS INIT
 678          
 679          float xdata singleVWardValueUP;  // å•ä½“ä¸Šé™æŠ¥è­¦å€¼A   PASS INIT  !!!
 680          float xdata singleVWardValueUPB; // å•ä½“ä¸Šé™æŠ¥è­¦å€¼B   PASS INIT
 681          float xdata singleVWardValueUPC; // å•ä½“ä¸Šé™æŠ¥è­¦å€¼C   PASS INIT
 682          
 683          float xdata singleVWardValueDOWN;  // å•ä½“ä¸‹é™æŠ¥è­¦å€¼A   PASS INIT  !!!
 684          float xdata singleVWardValueDOWNB; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼B   PASS INIT
 685          float xdata singleVWardValueDOWNC; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼C   PASS INIT
 686          
 687          float xdata batteryVAWardValueUP;  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A   PASS INIT  !!!
 688          float xdata batteryVAWardValueUPB; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B   PASS INIT
 689          float xdata batteryVAWardValueUPC; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C   PASS INIT
 690          
 691          float xdata batteryVAWardValueDOWN;  // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼A   PASS INIT  !!!
 692          float xdata batteryVAWardValueDOWNB; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼B   PASS INIT
 693          float xdata batteryVAWardValueDOWNC; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼C   PASS INIT
 694          
 695          unsigned char xdata fgOverChargeprotect;  // è“„ç”µæ± ç»„è¿‡å……æ ‡å¿—   PASS INIT
 696          unsigned char xdata chargeArrayCount[10]; // å……ç”µé˜µè¿‡å……è®¡æ•°AB-å…±è®¡10ç»„   PASS INIT
 697          unsigned char xdata fgOverChargePro;    // å……ç”µé˜µå•è·¯æ•…éšœæ ‡å¿—   PASS INIT
 698          unsigned char xdata fgOverChargeShort;    // å……ç”µé˜µçŸ­è·¯æ•…éšœæ ‡å¿—   PASS INIT
 699          
 700          unsigned char xdata singlesaveflag;    // å•ä½“è®°å¿†çŠ¶æ€æ ‡å¿—   PASS INIT
 701          unsigned char xdata singlesaveVLevelA; // æ¡£ä½è¿‡ç¨‹è®°å½•ä¿å­˜å˜é‡   PASS INIT
 702          unsigned char xdata singlesaveVLevelB; // æ¡£ä½è¿‡ç¨‹è®°å½•ä¿å­˜å˜é‡   PASS INIT
 703          
 704          unsigned char xdata chargeFlag;       // å……ç”µçŠ¶æ€æ ‡å¿—   PASS INIT
 705          unsigned char xdata currentModeCountA[3]; // å……ç”µæ¨¡å¼åˆ¤è¯»è®¡æ•°1    PASS INIT
 706          unsigned char xdata currentModeCountB[3]; // å……ç”µæ¨¡å¼åˆ¤è¯»è®¡æ•°2    PASS INIT
 707          
 708          unsigned char xdata checkCount1;    // æ¯çº¿è¿‡å‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°1
 709          unsigned char xdata checkCount2;    // æ¯çº¿æ¬ å‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°2
 710          unsigned char xdata checkCount3;    // è“„ç”µæ± ç»„è¿‡å‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°3
 711          unsigned char xdata checkCount4;    // è“„ç”µæ± ç»„æ¬ å‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°4
 712          unsigned char xdata checkCount5;    // å‡è¡¡åŸºå‡†ç”µå‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°5
 713          unsigned char xdata checkCount6;    // å‡è¡¡å·¥ä½œç›‘æµ‹æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°6
 714          unsigned char xdata checkCount7;    // åˆ†æµç®¡çŸ­è·¯æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°7
 715          unsigned char xdata checkCount8;    // ä¾›ç”µè‡ªæ£€æ—¶é—´è®¡æ•° -- å¥åº·ç›‘æµ‹è®¡æ•°8
 716          unsigned char xdata checkCountAqA[9]; // å•ä½“æ¬ å‹æ—¶é—´è®¡æ•°
 717          unsigned char xdata checkCountAqB[9]; // å•ä½“è¿‡å‹æ—¶é—´è®¡æ•°
 718          
 719          unsigned char xdata fgCheck1;    // æ¯çº¿è¿‡å‹æ ‡å¿— -- å¥åº·æ ‡å¿—1
 720          unsigned char xdata fgCheck2;    // æ¯çº¿æ¬ å‹æ ‡å¿— -- å¥åº·æ ‡å¿—2
 721          unsigned char xdata fgCheck3;    // è“„ç”µæ± ç»„ç”µå‹è¿‡å‹æ ‡å¿— -- å¥åº·æ ‡å¿—3
 722          unsigned char xdata fgCheck4;    // è“„ç”µæ± ç»„ç”µå‹æ¬ å‹æ ‡å¿— -- å¥åº·æ ‡å¿—4
 723          unsigned char xdata fgCheck5;    // å‡è¡¡åŸºå‡†ç”µå‹æ£€æµ‹æ ‡å¿— -- å¥åº·æ ‡å¿—5
 724          unsigned char xdata fgCheck6;    // å‡è¡¡å·¥ä½œæ£€æµ‹æ ‡å¿— -- å¥åº·æ ‡å¿—6
 725          unsigned char xdata fgCheck7;    // åˆ†æµç®¡çŸ­è·¯æ£€æµ‹æ ‡å¿— -- å¥åº·æ ‡å¿—7
 726          unsigned char xdata fgAqCheckA[9]; // å•ä½“æ¬ å‹æ ‡å¿—
 727          unsigned char xdata fgAqCheckB[9]; // å•ä½“è¿‡å‹æ ‡å¿—
 728          unsigned char xdata fgCheck8;    // ä¾›ç”µè‡ªæ£€æ ‡å¿— -- è‡ªæ£€æ ‡å¿—
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 13  

 729          
 730          unsigned int xdata overChargeProCount;     // è¿‡å……ä¿æŠ¤æ‰§è¡Œè®¡æ•°
 731          unsigned int xdata singleProtectChargeCount; // è¿‡å……ä¿æŠ¤æ‰§è¡Œè®¡æ•°
 732          
 733          unsigned char xdata selfCheckState; //è‡ªæ£€çŠ¶æ€
 734          unsigned char xdata selfCheckWord;  //è‡ªæ£€æ§åˆ¶å­—
 735          unsigned char xdata selfCheckWordB; //è‡ªæ£€æ§åˆ¶å­—
 736          unsigned char xdata selfCheckWordC; //è‡ªæ£€æ§åˆ¶å­—
 737          
 738          unsigned long xdata sysTime; // ç³»ç»Ÿæ—¶é—´   å¹¿æ’­æ—¶é—´ä¿®æ­£
 739          
 740          unsigned char code selectAB _at_ 0x7FFF; // ABæœºå·¥ä½œåˆ¤è¯»ä½  32K
 741          
 742          void SystemInit(void);               // ç³»ç»Ÿåˆå§‹åŒ–å‡½æ•°
 743          void DataInit(void);               // æ•°æ®åˆå§‹åŒ–å‡½æ•°
 744          void CANInit(unsigned int address);        // SJA1000åˆå§‹åŒ–å‡½æ•°
 745          void CPUInit(void);                // 80C32åˆå§‹åŒ–å‡½æ•°
 746          void ANCollect(void);              // æ¨¡æ‹Ÿé‡é‡‡é›†å‡½æ•°
 747          unsigned int ADConvert(unsigned char channel); // ADè½¬æ¢å‡½æ•°
 748          void StateWordBuild(void);             // ç»„çŠ¶æ€å­—å‡½æ•°
 749          
 750          void SaveData(void);      // é¥æµ‹åŒ…ç»„å¸§å‡½æ•°
 751          void SaveDataRs1(void);     // ç»„å¸§å‡½æ•°--åŒ…1
 752          void SaveDataRs2(void);     // ç»„å¸§å‡½æ•°--åŒ…2
 753          void SaveDataRs3(void);     // ç»„å¸§å‡½æ•°--åŒ…3
 754          void SaveRamDataRs(void);   // ç»„å¸§å‡½æ•°--RAM
 755          void SaveImportantDataRs(void); // ç»„å¸§å‡½æ•°--é‡è¦æ•°æ®
 756          
 757          void ImportantDataTx(void);             // é‡è¦æ•°æ®å‘é€å¤„ç†å‡½æ•°
 758          void ImportantDataRx(void);             // é‡è¦æ•°æ®æ¢å¤å¤„ç†å‡½æ•°
 759          void ImportantSaveData(unsigned char xdata *pRs); //é‡è¦æ•°æ®ç»„å¸§å‡½æ•°
 760          void ImportDataFlush(void);
 761          void DefaultInit(void); // é‡è¦æ•°æ®æ¢å¤å¤±è´¥åˆå§‹åŒ–
 762          
 763          void FilterManage(void);
 764          void FilterSaveData(unsigned char xdata *pRs);
 765          unsigned char FilterDataComp(void);
 766          
 767          void EquAncollect(void); // EQUæ¥æ”¶èµ·å§‹å¤„ç†
 768          
 769          void CANInfoA(void);  // CANåˆå§‹åŒ–-A
 770          void CANInfoB(void);  // CANåˆå§‹åŒ–-B
 771          void CanResume(void); // CANæ¢å¤å‡½æ•°
 772          
 773          void ONOFFOutput(unsigned char index);              // æŒ‡ä»¤è¾“å‡ºå‡½æ•°
 774          void ONOFFHook(void);                     // æŒ‡ä»¤è¾“å‡ºé“¾æ¥å‡½æ•°
 775          void OnoffSelfExeRec(unsigned char type, unsigned char number); // æŒ‡ä»¤è¾“å‡ºè®°å½•
 776          
 777          void UploadParaManage(void); // ä¸Šæ³¨å‚æ•°å¤„ç†å‡½æ•°
 778          void ChargeCheck(void);
 779          
 780          unsigned char Get2_3_U(unsigned char *a, unsigned char *b, unsigned char *c); // æ•°æ®3å–2åˆ¤å†³å‡½æ•°
 781          unsigned char Get2_3_F(float *a, float *b, float *c);             /* ä¸‰å–äºŒæµ®ç‚¹å‹     */
 782          unsigned char Get2_3_I(unsigned int *a, unsigned int *b, unsigned int *c);    /* ä¸‰å–äºŒæ— ç¬¦å·æ•´å‹  
             -   */
 783          
 784          void Delay(unsigned int time); // å›ºå®šå»¶æ—¶å‡½æ•°
 785          void DataProtect(void);      // æ•°æ®å‚æ•°ä¿æŠ¤å‡½æ•°
 786          
 787          void CANRXDA(void);      // Aæ€»çº¿CANä¸­æ–­æ¥æ”¶å¤„ç†å‡½æ•°
 788          void CANTXDA(void);      // Aæ€»çº¿CANä¸­æ–­å‘é€å¤„ç†å‡½æ•°
 789          void RsManageA(void);    // Aæ€»çº¿CANä¸­æ–­è½®è¯¢å¤„ç†å‡½æ•°
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 14  

 790          void ONOFFManageA(void);   // Aæ€»çº¿CANä¸­æ–­æŒ‡ä»¤å¤„ç†å‡½æ•°
 791          void DataManageA(void);    // Aæ€»çº¿CANä¸­æ–­æ•°æ®å—ï¼ˆç¨‹åºä»£ç ï¼‰å¤„ç†å‡½æ•°
 792          void RamManageA(void);     // Aæ€»çº¿RAMä¸­æ–­å¤„ç†å‡½æ•°
 793          void ImportantManageA(void); // Aæ€»çº¿é‡è¦æ•°æ®ä¸­æ–­å¤„ç†å‡½æ•°
 794          void TimeBcA(void);      // Aæ€»çº¿æ˜Ÿæ—¶å¹¿æ’­ä¸­æ–­å¤„ç†å‡½æ•°
 795          
 796          void CANRXDB(void);      // Bæ€»çº¿CANä¸­æ–­æ¥æ”¶å¤„ç†å‡½æ•°
 797          void CANTXDB(void);      // Bæ€»çº¿CANä¸­æ–­å‘é€å¤„ç†å‡½æ•°
 798          void RsManageB(void);    // Bæ€»çº¿CANä¸­æ–­è½®è¯¢å¤„ç†å‡½æ•°
 799          void ONOFFManageB(void);   // Bæ€»çº¿CANä¸­æ–­æŒ‡ä»¤å¤„ç†å‡½æ•°
 800          void DataManageB(void);    // Bæ€»çº¿CANä¸­æ–­æ•°æ®å—ï¼ˆç¨‹åºä»£ç ï¼‰å¤„ç†å‡½æ•°
 801          void RamManageB(void);     // Bæ€»çº¿RAMä¸­æ–­å¤„ç†å‡½æ•°
 802          void ImportantManageB(void); // Bæ€»çº¿é‡è¦æ•°æ®ä¸­æ–­å¤„ç†å‡½æ•°
 803          void TimeBcB(void);      // Bæ€»çº¿æ˜Ÿæ—¶å¹¿æ’­ä¸­æ–­å¤„ç†å‡½æ•°
 804          
 805          unsigned char SepCurrentStateCal(unsigned int val); // åˆ†æµçŠ¶æ€
 806          void PowerControl(void);              // å®‰æ—¶è®¡è®¡ç®—
 807          void SingleProtectChargeControl(void);        // å•ä½“ä¿æŠ¤
 808          void OverChargeProtect(void);           // è¿‡å……ä¿æŠ¤
 809          
 810          void EquOnoffHook(void);    // å‡è¡¡å™¨æŒ‡ä»¤422æ€»çº¿å‘é€
 811          unsigned char RamCheck(void); // SRAMè‡ªæ£€
 812          void EquControl(void);      // å‡è¡¡æ§åˆ¶æ¨¡å—
 813          void ChargeCheck(void);     // å……ç”µæ£€æµ‹
 814          void HealthStaClear(void);
 815          
 816          void SelfHealthCheck(void);    // è‡ªæ£€ç›‘æµ‹
 817          void HealthCheck(void);      // å¥åº·ç›‘æµ‹å‡½æ•°
 818          void HealthStateWordBuild(void); // å¥åº·çŠ¶æ€å­—
 819          void GenVolOverCheck(void);    // ç”µæºæ¯çº¿è¿‡å‹ç›‘æµ‹
 820          void GenVolUnderCheck(void);   // ç”µæºæ¯çº¿æ¬ å‹ç›‘æµ‹
 821          void AhVolOverCheck(void);     // è“„ç”µæ± ç»„ç”µå‹è¿‡å‹ç›‘æµ‹
 822          void AhVolUnderCheck(void);    // è“„ç”µæ± ç»„ç”µå‹æ¬ å‹ç›‘æµ‹
 823          void EquVRefCheck(void);     // å‡è¡¡åŸºå‡†ç›‘æµ‹
 824          void EquWorkCheck(void);     // å‡è¡¡å·¥ä½œç›‘æµ‹
 825          void SepCurrentShortCheck(void); // åˆ†æµç®¡çŸ­è·¯ç›‘æµ‹
 826          void AqVolCheck(void);       // å•ä½“ç”µå‹å¥åº·ç›‘æµ‹
 827          void PowerSupplyCheck(void);   // ä¾›ç”µè‡ªæ£€ç›‘æµ‹
 828          
 829          // *****************************************************************
 830          // å‡½æ•°åç§° : main
 831          // åŠŸèƒ½æè¿° :
 832          //*****************************************************************
 833          void main(void)
 834          {
 835   1        unsigned char fg4S;            // 4Sæ§åˆ¶å‘¨æœŸ
 836   1        volatile unsigned char clockCountTemp; // æ»¡è¶³è§„åˆ™æ£€æŸ¥å¢åŠ ä¸´æ—¶å˜é‡
 837   1      
 838   1        SystemInit(); // ç³»ç»Ÿåˆå§‹åŒ–
 839   1      
 840   1        while (1) // æ‰§è¡Œå›ºå®šå‘¨æœŸä»»åŠ¡  1s
 841   1        {
 842   2          dog = !dog; // 1s ç‰µç‹—ä¸€æ¬¡
 843   2      
 844   2          fg4S++; // å‘¨æœŸè®¡æ—¶
 845   2      
 846   2          SaveData();    // ç»„å¸§å‡½æ•°
 847   2          DataProtect(); // æ•°æ®ä¿æŠ¤å‡½æ•°
 848   2      
 849   2          ANCollect();    // æ¨¡æ‹Ÿé‡é‡‡é›†
 850   2          StateWordBuild(); // æ„æˆçŠ¶æ€å­—  å¿…é¡»å…ˆæ›´æ–°åç»­æœ‰ä½¿ç”¨
 851   2          Delay(2000);    // å»¶æ—¶æ“ä½œ
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 15  

 852   2          ChargeCheck();
 853   2      
 854   2          EquControl(); // å‡è¡¡æ§åˆ¶åŠŸèƒ½ -- 30s æ§åˆ¶å‘¨æœŸ
 855   2          EquOnoffHook(); // å‡è¡¡å™¨æŒ‡ä»¤å‘é€ -- æ¯ç§’å‘é€1æ¡å‡è¡¡æŒ‡ä»¤
 856   2      
 857   2          FilterManage(); // è¿‡æ»¤åŒ…ç®¡ç†
 858   2      
 859   2          if (fg4S > 3)
 860   2          {
 861   3            fg4S = 0;
 862   3            PowerControl();
 863   3            OverChargeProtect();      // è“„ç”µæ± ç»„è¿‡å……ä¿æŠ¤
 864   3            SingleProtectChargeControl(); // å•ä½“è¿‡å……ä¿æŠ¤æ§åˆ¶
 865   3          }
 866   2      
 867   2          CanResume();    // CANæ€»çº¿å¼‚å¸¸å¤„ç†å‡½æ•°
 868   2          UploadParaManage(); // ä¸Šæ³¨å‚æ•°æ›´æ–°å¤„ç†
 869   2      
 870   2          HealthCheck();     // å¥åº·ç›‘æµ‹
 871   2          SelfHealthCheck(); // è‡ªæ£€ç›‘æµ‹
 872   2      
 873   2          ONOFFHook(); // é—´æ¥æŒ‡ä»¤å¤„ç†é’©å­
 874   2          SaveData();  // ç»„å¸§å‡½æ•°
 875   2          dog = !dog;  // 1s ç‰µç‹—2æ¬¡
 876   2      
 877   2          ImportantDataTx(); // å‘é€é‡è¦æ•°æ®
 878   2      
 879   2          clockCountTemp = clockCount; // å¢åŠ ä¸´æ—¶å˜é‡ é™æ€è§„åˆ™ä¿®æ”¹
 880   2          while (clockCountTemp < 100) // å»¶æ—¶ç­‰å¾…1s
 881   2          {
 882   3            clockCountTemp = clockCount;
 883   3          }
 884   2          EA = 0;
 885   2          clockCount = (unsigned char)(clockCount - 100); // æ—¶é—´è¡¥å¿
 886   2          sysTime++;                    // ç»´æŠ¤ç³»ç»Ÿæ—¶é—´
 887   2          EA = 1;
 888   2        }
 889   1      }
 890          
 891          //*****************************************************************
 892          // å‡½æ•°åç§° : Delay
 893          // åŠŸèƒ½æè¿° :
 894          //*****************************************************************
 895          void Delay(unsigned int time)
 896          {
 897   1        unsigned int k;
 898   1      
 899   1        for (k = 0; k < time; k++) // å¾ªç¯å»¶æ—¶
 900   1        {
 901   2          _nop_(); // æ‰§è¡Œç©ºè¯­å¥
 902   2        }
 903   1      }
 904          
 905          //*****************************************************************
 906          // å‡½æ•°åç§° : DataProtect
 907          // åŠŸèƒ½æè¿° :
 908          //*****************************************************************
 909          void DataProtect(void)
 910          {
 911   1        unsigned char result1;
 912   1      
 913   1        result1 = Get2_3_U(&resetCount, &resetCountB, &resetCountC); // çƒ­å¤ä½è®¡æ•°3å–2åˆ¤å†³
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 16  

 914   1        if (result1 == FALSE)
 915   1        {
 916   2          resetCount = 0; // ä¸‰å–äºŒæ¢å¤è®¾ç½®
 917   2          resetCountB = 0;
 918   2          resetCountC = 0;
 919   2        }
 920   1      
 921   1        result1 = Get2_3_U(&onoffExeCount, &onoffExeCountB, &onoffExeCountC); // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°(åŒ…æ‹¬æ
             -Œ‡ä»¤ã€ä¸Šæ³¨æ•°æ®ã€ä¸Šæ³¨ä»£ç ) 3å–2åˆ¤å†³
 922   1        if (result1 == FALSE)
 923   1        {
 924   2          onoffExeCount = 0; // ä¸‰å–äºŒæ¢å¤è®¾ç½®
 925   2          onoffExeCountB = 0;
 926   2          onoffExeCountC = 0;
 927   2        }
 928   1      
 929   1        result1 = Get2_3_U(&onoffReceCount, &onoffReceCountB, &onoffReceCountC); // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°(åŒ…æ
             -‹¬æŒ‡ä»¤ã€ä¸Šæ³¨æ•°æ®ã€ä¸Šæ³¨ä»£ç ) 3å–2åˆ¤å†³
 930   1        if (result1 == FALSE)
 931   1        {
 932   2          onoffReceCount = 0; // ä¸‰å–äºŒæ¢å¤è®¾ç½®
 933   2          onoffReceCountB = 0;
 934   2          onoffReceCountC = 0;
 935   2        }
 936   1      
 937   1        result1 = Get2_3_U(&onoffErrorCount, &onoffErrorCountB, &onoffErrorCountC); // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°(å
             -Œ…æ‹¬æŒ‡ä»¤ã€ä¸Šæ³¨æ•°æ®ã€ä¸Šæ³¨ä»£ç ) 3å–2åˆ¤å†³
 938   1        if (result1 == FALSE)
 939   1        {
 940   2          onoffErrorCount = 0; // ä¸‰å–äºŒæ¢å¤è®¾ç½®
 941   2          onoffErrorCountB = 0;
 942   2          onoffErrorCountC = 0;
 943   2        }
 944   1      
 945   1        result1 = Get2_3_U(&chargeVolKickA, &chargeVolKickA_B, &chargeVolKickA_C); //
 946   1        if (result1 == FALSE)
 947   1        {
 948   2          chargeVolKickA = 5; //  ä¸‰å–äºŒæ¢å¤è®¾ç½®
 949   2          chargeVolKickA_B = 5;
 950   2          chargeVolKickA_C = 5;
 951   2        }
 952   1      
 953   1        result1 = Get2_3_U(&chargeVolKickB, &chargeVolKickB_B, &chargeVolKickB_C); //
 954   1        if (result1 == FALSE)
 955   1        {
 956   2          chargeVolKickB = 5; //  ä¸‰å–äºŒæ¢å¤è®¾ç½®
 957   2          chargeVolKickB_B = 5;
 958   2          chargeVolKickB_C = 5;
 959   2        }
 960   1      
 961   1        result1 = Get2_3_U(&chargeCurKickA, &chargeCurKickA_B, &chargeCurKickA_C); //
 962   1        if (result1 == FALSE)
 963   1        {
 964   2          chargeCurKickA = 5; //  ä¸‰å–äºŒæ¢å¤è®¾ç½®
 965   2          chargeCurKickA_B = 5;
 966   2          chargeCurKickA_C = 5;
 967   2        }
 968   1      
 969   1        result1 = Get2_3_U(&chargeCurKickB, &chargeCurKickB_B, &chargeCurKickB_C); //
 970   1        if (result1 == FALSE)
 971   1        {
 972   2          chargeCurKickB = 5; //  ä¸‰å–äºŒæ¢å¤è®¾ç½®
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 17  

 973   2          chargeCurKickB_B = 5;
 974   2          chargeCurKickB_C = 5;
 975   2        }
 976   1      
 977   1        result1 = Get2_3_F(&equOpenValue, &equOpenValueB, &equOpenValueC); //
 978   1        if (result1 == FALSE)
 979   1        {
 980   2          equOpenValue = 0.06;  // å‡è¡¡å¼€é—¨é™å€¼  A
 981   2          equOpenValueB = 0.06; // å‡è¡¡å¼€é—¨é™å€¼  B
 982   2          equOpenValueC = 0.06; // å‡è¡¡å¼€é—¨é™å€¼  C
 983   2        }
 984   1      
 985   1        result1 = Get2_3_F(&equCloseValue, &equCloseValueB, &equCloseValueC); //
 986   1        if (result1 == FALSE)
 987   1        {
 988   2          equCloseValue = 0.01;  // å‡è¡¡å…³é—¨é™å€¼  A
 989   2          equCloseValueB = 0.01; // å‡è¡¡å…³é—¨é™å€¼  B
 990   2          equCloseValueC = 0.01; // å‡è¡¡å…³é—¨é™å€¼  C
 991   2        }
 992   1      
 993   1        result1 = Get2_3_U(&proportion, &proportionB, &proportionC); //
 994   1        if (result1 == FALSE)
 995   1        {
 996   2          proportion = 102;  // å……æ”¾æ¯”
 997   2          proportionB = 102; // å……æ”¾æ¯”
 998   2          proportionC = 102; // å……æ”¾æ¯”
 999   2        }
1000   1      
1001   1        result1 = Get2_3_U(&selfCheckStateContrl, &selfCheckStateContrlB, &selfCheckStateContrlC); //
1002   1        if (result1 == FALSE)
1003   1        {
1004   2          selfCheckStateContrl = 0xFF;  // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  A
1005   2          selfCheckStateContrlB = 0xFF; // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  B
1006   2          selfCheckStateContrlC = 0xFF; // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  C
1007   2        }
1008   1      
1009   1        result1 = Get2_3_I(&aqStateContrl, &aqStateContrlB, &aqStateContrlC); //
1010   1        if (result1 == FALSE)
1011   1        {
1012   2          aqStateContrl = 0xFFFF;  // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–A
1013   2          aqStateContrlB = 0xFFFF; // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–B
1014   2          aqStateContrlC = 0xFFFF; // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–C
1015   2        }
1016   1      
1017   1        result1 = Get2_3_I(&healthStateContr1, &healthStateContr1B, &healthStateContr1C); //
1018   1        if (result1 == FALSE)
1019   1        {
1020   2          healthStateContr1 = 0xFFFF;  // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—   é»˜è®¤ A
1021   2          healthStateContr1B = 0xFFFF; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—   é»˜è®¤ B
1022   2          healthStateContr1C = 0xFFFF; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­—   é»˜è®¤ C
1023   2        }
1024   1      
1025   1        result1 = Get2_3_I(&healthStateContr2, &healthStateContr2B, &healthStateContr2C); //
1026   1        if (result1 == FALSE)
1027   1        {
1028   2          healthStateContr2 = 0xFFFF;  // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­—   é»˜è®¤ A
1029   2          healthStateContr2B = 0xFFFF; // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­—   é»˜è®¤ B
1030   2          healthStateContr2C = 0xFFFF; // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­—   é»˜è®¤ C
1031   2        }
1032   1      
1033   1        result1 = Get2_3_U(&equControlEn, &equControlEnB, &equControlEnC); //
1034   1        if (result1 == FALSE)
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 18  

1035   1        {
1036   2          equControlEn = TRUE;  // å‡è¡¡ä½¿èƒ½çŠ¶æ€A
1037   2          equControlEnB = TRUE; // å‡è¡¡ä½¿èƒ½çŠ¶æ€B
1038   2          equControlEnC = TRUE; // å‡è¡¡ä½¿èƒ½çŠ¶æ€C
1039   2        }
1040   1      
1041   1        result1 = Get2_3_U(&singleProtectChargeEn, &singleProtectChargeEnB, &singleProtectChargeEnC); //
1042   1        if (result1 == FALSE)
1043   1        {
1044   2          singleProtectChargeEn = FALSE;  //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€A
1045   2          singleProtectChargeEnB = FALSE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B
1046   2          singleProtectChargeEnC = FALSE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C
1047   2        }
1048   1      
1049   1        result1 = Get2_3_U(&overChargeProtectEn, &overChargeProtectEnB, &overChargeProtectEnC); //
1050   1        if (result1 == FALSE)
1051   1        {
1052   2          overChargeProtectEn = FALSE;  // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—A
1053   2          overChargeProtectEnB = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—B
1054   2          overChargeProtectEnC = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—C
1055   2        }
1056   1      
1057   1        result1 = Get2_3_F(&singleVProtectValueUP, &singleVProtectValueUPB, &singleVProtectValueUPC); //
1058   1        if (result1 == FALSE)
1059   1        {
1060   2          singleVProtectValueUP = (float)4.20;  // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼A
1061   2          singleVProtectValueUPB = (float)4.20; // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼B
1062   2          singleVProtectValueUPC = (float)4.20; // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼C
1063   2        }
1064   1      
1065   1        result1 = Get2_3_F(&singleVWardValueUP, &singleVWardValueUPB, &singleVWardValueUPC); //
1066   1        if (result1 == FALSE)
1067   1        {
1068   2          singleVWardValueDOWN = (float)3.50;  // å•ä½“ä¸‹é™æŠ¥è­¦å€¼A
1069   2          singleVWardValueDOWNB = (float)3.50; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼B
1070   2          singleVWardValueDOWNC = (float)3.50; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼C
1071   2        }
1072   1      
1073   1        result1 = Get2_3_F(&singleVWardValueDOWN, &singleVWardValueDOWNB, &singleVWardValueDOWNC); //
1074   1        if (result1 == FALSE)
1075   1        {
1076   2          singleVWardValueDOWN = 0;  // å•ä½“ä¸‹é™æŠ¥è­¦å€¼A
1077   2          singleVWardValueDOWNB = 0; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼B
1078   2          singleVWardValueDOWNC = 0; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼C
1079   2        }
1080   1      
1081   1        result1 = Get2_3_F(&batteryVAWardValueUP, &batteryVAWardValueUPB, &batteryVAWardValueUPC); //
1082   1        if (result1 == FALSE)
1083   1        {
1084   2          batteryVAWardValueUP = (float)37.8;  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A
1085   2          batteryVAWardValueUPB = (float)37.8; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B
1086   2          batteryVAWardValueUPC = (float)37.8; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C
1087   2        }
1088   1      
1089   1        result1 = Get2_3_F(&batteryVAWardValueDOWN, &batteryVAWardValueDOWNB, &batteryVAWardValueDOWNC); //
1090   1        if (result1 == FALSE)
1091   1        {
1092   2          batteryVAWardValueDOWN = (float)27.0;  // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼A
1093   2          batteryVAWardValueDOWNB = (float)27.0; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼B
1094   2          batteryVAWardValueDOWNC = (float)27.0; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼C
1095   2        }
1096   1      }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 19  

1097          
1098          //*****************************************************************
1099          // å‡½æ•°åç§° : SystemInit
1100          //    åŠŸèƒ½æè¿° :
1101          //*****************************************************************
1102          void SystemInit(void)
1103          {
1104   1        EA = 0; // å…³ä¸­æ–­
1105   1        dog = !dog;
1106   1      
1107   1        ONOFF_ADDR = 0xFF; // è¾“å‡ºæŒ‡ä»¤ç FFH
1108   1        onoffEn = 0;     // æŒ‡ä»¤è¾“å‡ºä½¿èƒ½
1109   1        onoffEn = 1;     // æŒ‡ä»¤è¾“å‡ºç¦èƒ½
1110   1      
1111   1        RXDCONTROL = 1; // é—¨æ§ç¦æ­¢
1112   1        RXD422AEn = 1;  // æ¥æ”¶ç¦æ­¢
1113   1        TXDCONTROL = 1; // é—¨æ§ç¦æ­¢
1114   1        TXD422En = 1; // å‘é€ç¦æ­¢
1115   1      
1116   1        DA_A_CUR = 0; // é»˜è®¤ 0 - 5æ¡£
1117   1        DA_A_VOL = 0; // é»˜è®¤ 0 - 5æ¡£
1118   1        DA_B_CUR = 0; // é»˜è®¤ 0 - 5æ¡£
1119   1        DA_B_VOL = 0; // é»˜è®¤ 0 - 5æ¡£
1120   1      
1121   1        fgRstType = 1;    // è®¾ç½®P1å£è¾“å…¥çŠ¶æ€
1122   1        if (fgRstType == 1) // åˆ¤æ–­æ˜¯å†·å¤ä½æˆ–çƒ­å¤ä½
1123   1        {
1124   2          resetCount++;                  // çƒ­å¯åŠ¨è®¡æ•°è‡ªåŠ    init
1125   2          resetCount = (unsigned char)(resetCount & 0x0F); // è®¡æ•°æ¸…é›¶æ“ä½œ    init
1126   2      
1127   2          resetCountB = resetCount; // B,Cèµ‹å€¼    init
1128   2          resetCountC = resetCount; //        init
1129   2        }
1130   1        else
1131   1        {
1132   2          resetCount = 0;  // å†·å¯åŠ¨å¤ä½è®¡æ•°æ¸…é›¶
1133   2          resetCountB = 0; // B,Cèµ‹å€¼
1134   2          resetCountC = 0; // åˆå§‹åŒ–
1135   2        }
1136   1      
1137   1        DataInit(); // é»˜è®¤æ•°æ®åˆå§‹åŒ–
1138   1      
1139   1        dog = !dog;  // å¢åŠ å–‚ç‹—æ“ä½œ
1140   1        ANCollect(); // æ¨¡æ‹Ÿé‡é‡‡é›†
1141   1        dog = !dog;  // å¢åŠ å–‚ç‹—æ“ä½œ
1142   1      
1143   1        StateWordBuild(); // æ„æˆçŠ¶æ€å­—
1144   1        SaveData();     // ç»„å¸§å‡½æ•° æ•°æ®å¡«å……A/BåŒº
1145   1        SaveData();     // ç»„å¸§å‡½æ•°
1146   1        SaveRamDataRs();  // å¡«å……RAMå‘é€ç¼“å­˜åŒº  -- å¡«å……å¤„ç†
1147   1      
1148   1        FilterSaveData(&filterFrame[0]); // è¿‡æ»¤å‚æ•°é¥æµ‹ç»„å¸§  -- å¡«å……å¤„ç†
1149   1        FilterDataComp();        // è¿‡æ»¤åŒ…æ•°æ®å¯¹æ¯”  -- å¡«å……å¤„ç†
1150   1      
1151   1        ImportantSaveData(&rsImportantData[0]); // é‡è¦æ•°æ®ç¼“å­˜æ›´æ–°  -- å¡«å……å¤„ç†
1152   1        SaveImportantDataRs();          // é‡è¦æ•°æ®ç»„å¸§æ›´æ–°  -- å¡«å……å¤„ç†
1153   1      
1154   1        CPUInit(); // 80C32åˆå§‹åŒ–
1155   1      
1156   1        CANInit(BUSA_ADDR); // CANæ€»çº¿åˆå§‹åŒ–
1157   1        CANInit(BUSB_ADDR);
1158   1        CANInfoA();
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 20  

1159   1        CANInfoB();
1160   1      
1161   1        EA = 1; // å¼€ä¸­æ–­
1162   1      
1163   1        ImportantDataRx(); // é‡è¦æ•°æ®æ¢å¤å¤„ç†
1164   1      }
1165          
1166          //*****************************************************************
1167          // å‡½æ•°åç§° : DataInit
1168          // åŠŸèƒ½æè¿° :
1169          // *****************************************************************
1170          void DataInit(void)
1171          {
1172   1        unsigned int i;
1173   1        unsigned int j;
1174   1      
1175   1        clockCount = 0; // 1sç¨‹åºè¿è¡Œå®šæ—¶è®¡æ•°å™¨         init
1176   1        errorCount = 0; // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨      init
1177   1      
1178   1        fg16S = 0; // é‡è¦æ•°æ®æœåŠ¡è¯·æ±‚åŒ… init
1179   1        fg30S = 0; // å‡è¡¡æ—¶é—´è®¡æ•° init
1180   1        fg60S = 0; // è¿‡æ»¤æŠ¥60sè®¡æ—¶æ¸…é›¶ init
1181   1      
1182   1        errorCountA = 0; // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨A      init
1183   1        errorCountB = 0; // æ€»çº¿é€šè®¯ä¸ç¬¦åˆåè®®è®¡æ•°å™¨B      init
1184   1      
1185   1        onoffExeCount = 0;  // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°A     init
1186   1        onoffExeCountB = 0; // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°B     init
1187   1        onoffExeCountC = 0; // é¥æ§æŒ‡ä»¤æ‰§è¡Œè®¡æ•°C   init
1188   1      
1189   1        onoffErrorCount = 0;  // æŒ‡ä»¤é”™è¯¯è®¡æ•°A   init
1190   1        onoffErrorCountB = 0; // æŒ‡ä»¤é”™è¯¯è®¡æ•°B   init
1191   1        onoffErrorCountC = 0; // æŒ‡ä»¤é”™è¯¯è®¡æ•°C   init
1192   1      
1193   1        onoffReceCount = 0;  // æŒ‡ä»¤æ¥æ”¶è®¡æ•°A    init
1194   1        onoffReceCountB = 0; // æŒ‡ä»¤æ¥æ”¶è®¡æ•°B    init
1195   1        onoffReceCountC = 0; // æŒ‡ä»¤æ¥æ”¶è®¡æ•°C    init
1196   1      
1197   1        fgCanBus = 0xAA; // é»˜è®¤Aæ€»çº¿              init
1198   1      
1199   1        fgSwitch1 = FALSE; // æ•°æ®é‡‡é›†ä¿å­˜åˆ‡åŒºæ ‡å¿—1        init
1200   1        fgSwitch2 = FALSE; // æ•°æ®é‡‡é›†ä¿å­˜åˆ‡åŒºæ ‡å¿—2        init
1201   1      
1202   1        equState1 = 0; // å‡è¡¡çŠ¶æ€å­—1æ¸…é›¶  init
1203   1        equState2 = 0; // å‡è¡¡çŠ¶æ€å­—2æ¸…é›¶  init
1204   1      
1205   1        genCurrent = (float)0.0; // æ¯çº¿ç”µæµ  init
1206   1      
1207   1        limbCurrent = (float)0.0;  // å¤ªé˜³ç¿¼æ€»ç”µæµ init
1208   1        limbCurrentA = (float)0.0; // å¤ªé˜³ç¿¼Aç”µæµ  init
1209   1        limbCurrentB = (float)0.0; // å¤ªé˜³ç¿¼Bç”µæµ  init
1210   1      
1211   1        chargeCurrent = (float)0.0;  // å……ç”µç”µæµ   init
1212   1        chargeCurrent1 = (float)0.0; // å……ç”µç”µæµ1  init
1213   1        chargeCurrent2 = (float)0.0; // å……ç”µç”µæµ2  init
1214   1      
1215   1        dischargeCurrent = (float)0.0;  // æ”¾ç”µç”µæµ     init
1216   1        dischargeCurrent1 = (float)0.0; // æ”¾ç”µç”µæµ1    init
1217   1        dischargeCurrent2 = (float)0.0; // æ”¾ç”µç”µæµ2    init
1218   1        meaV = 0.0;           // MEAæ¸…é›¶    init
1219   1        generatrixVol = 0.0;      // æ¯çº¿ç”µå‹   init
1220   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 21  

1221   1        fgOverChargeShort = FALSE;   // å……ç”µé˜µçŸ­è·¯æ•…éšœ    init
1222   1        fgOverChargePro = FALSE;   // å……ç”µé˜µå•è·¯æ•…éšœ    init
1223   1        fgOverChargeprotect = FALSE; // è“„ç”µæ± ç»„è¿‡å……æ ‡å¿— init
1224   1      
1225   1        singlesaveflag = FALSE; // init
1226   1        singlesaveVLevelA = 5;  // é»˜è®¤5æ¡£
1227   1        singlesaveVLevelB = 5;  // é»˜è®¤5æ¡£
1228   1      
1229   1        chargeFlag = FALSE; // é»˜è®¤ä¸å……ç”µçŠ¶æ€
1230   1      
1231   1        for (i = 0; i < 10; i++)
1232   1        {
1233   2          chargeArrayCurrent[i] = 0.0; // å……ç”µé˜µç”µæµæ¸…é›¶ init
1234   2          chargeArrayCount[i] = 0;   // å……ç”µé˜µè®¡æ•°æ¸…é›¶ init
1235   2        }
1236   1      
1237   1        chargeVolKickA = 5;   // å……ç”µé™å‹æ¡£æ•°A A   init
1238   1        chargeVolKickA_B = 5; // å……ç”µé™å‹æ¡£æ•°A B   init
1239   1        chargeVolKickA_C = 5; // å……ç”µé™å‹æ¡£æ•°A C   init
1240   1      
1241   1        chargeVolKickB = 5;   // å……ç”µé™å‹æ¡£æ•°B A   init
1242   1        chargeVolKickB_B = 5; // å……ç”µé™å‹æ¡£æ•°B B   init
1243   1        chargeVolKickB_C = 5; // å……ç”µé™å‹æ¡£æ•°B C   init
1244   1      
1245   1        chargeCurKickA = 5;   // å……ç”µé™æµæ¡£æ•°A A   init
1246   1        chargeCurKickA_B = 5; // å……ç”µé™æµæ¡£æ•°A B   init
1247   1        chargeCurKickA_C = 5; // å……ç”µé™æµæ¡£æ•°A C   init
1248   1      
1249   1        chargeCurKickB = 5;   // å……ç”µé™æµæ¡£æ•°B A   init
1250   1        chargeCurKickB_B = 5; // å……ç”µé™æµæ¡£æ•°B B   init
1251   1        chargeCurKickB_C = 5; // å……ç”µé™æµæ¡£æ•°B C   init
1252   1      
1253   1        chargeVolKickRsA = 5; // å……ç”µåˆ‡æ¢æ¡£ä½A  é¥æµ‹ä½¿ç”¨
1254   1        chargeVolKickRsB = 5; // å……ç”µåˆ‡æ¢æ¡£ä½B  é¥æµ‹ä½¿ç”¨
1255   1      
1256   1        for (i = 0; i < 41; i++)
1257   1        {
1258   2          filterFrame[i] = 0;   // init
1259   2          filterDataRec[i] = 0; // init  è¿‡æ»¤åŒ…ç¼“å­˜åŒºæ¸…é›¶
1260   2        }
1261   1      
1262   1        for (i = 0; i < 128; i++) // æµ‹è¯•RAMåŒºæ•°æ®è®¾ç½®
1263   1        {
1264   2          ramTestData[i] = 0x20 + i; // init
1265   2        }
1266   1      
1267   1        fgImportantDataRx = FALSE; // é»˜è®¤æ— é‡è¦æ•°æ®æ¢å¤å¤„ç†è¯·æ±‚  init
1268   1        importDataRxState = 0x00;  // é‡è¦æ•°æ®æ¢å¤çŠ¶æ€  é»˜è®¤åˆå§‹   init
1269   1      
1270   1        for (i = 0; i < 220; i++) // é‡è¦æ•°æ®åˆå§‹åŒ–è®¾ç½®
1271   1        {
1272   2          rsImportantData[i] = 0x00; // init
1273   2        }
1274   1      
1275   1        pcuState1 = 0; // PCUçŠ¶æ€å­—1åˆå§‹åŒ–  init
1276   1        pcuState2 = 0; // PCUçŠ¶æ€å­—2åˆå§‹åŒ–  init
1277   1        pcuState3 = 0; // PCUçŠ¶æ€å­—3åˆå§‹åŒ–  init
1278   1        pcuState4 = 0; // PCUçŠ¶æ€å­—4åˆå§‹åŒ–  init
1279   1      
1280   1        uploadParaData[0] = 0; // å‚æ•°ä¸Šæ³¨æ¸…é›¶ init
1281   1        uploadParaData[1] = 0;
1282   1        uploadParaData[2] = 0;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 22  

1283   1        uploadParaData[3] = 0;
1284   1      
1285   1        fgUploadPara = FALSE; // é»˜è®¤æ— ä¸Šæ³¨æ•°æ®å¤„ç†è¯·æ±‚ init
1286   1      
1287   1        wrOnoffIndex = 0; // å†™ç´¢å¼• init
1288   1        rdOnoffIndex = 0; // è¯»ç´¢å¼• init
1289   1        for (i = 0; i < 24; i++)
1290   1        {
1291   2          onoffBuffer[i][0] = 0; // æŒ‡ä»¤æ¥æ”¶ç¼“å†²åŒº æ¸…é›¶ init
1292   2          onoffBuffer[i][1] = 0; // æŒ‡ä»¤æ¥æ”¶ç¼“å†²åŒº æ¸…é›¶ init
1293   2        }
1294   1      
1295   1        wrOnoffRecIndex = 0;   // è‡ªä¸»æŒ‡ä»¤è®°å½•å†™ç´¢å¼•æ¸…é›¶ init
1296   1        for (i = 0; i < 24; i++) // è‡ªä¸»æŒ‡ä»¤è®°å½•åŒºæ¸…é›¶
1297   1        {
1298   2          for (j = 0; j < 6; j++)
1299   2          {
1300   3            onoffBufferRec[i][j] = 0x00; //  init
1301   3          }
1302   2        }
1303   1      
1304   1        fgRsRam = FALSE; // é»˜è®¤ä¸‹ä¼ æ— æ•ˆ init
1305   1        for (i = 0; i < 8; i++)
1306   1        {
1307   2          ramUploadData[i] = 0; // RAMä¸Šæ³¨æ•°æ®æ¸…é›¶  init
1308   2        }
1309   1      
1310   1        for (i = 0; i < 12; i++) // æœåŠ¡è¯·æ±‚æ¸…é›¶
1311   1        {
1312   2          reqData[i] = 0; // init
1313   2        }
1314   1        wrReqIndex = 0; // å†™ç´¢å¼• init
1315   1        rdReqIndex = 0; // è¯»ç´¢å¼• init
1316   1      
1317   1        accEquVA = 0;  // ç”µæ± ç»„ç”µå‹ä¸» init
1318   1        accEquVB = 0;  // ç”µæ± ç»„ç”µå‹å¤‡ init
1319   1        accVAHard = 0; // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ init
1320   1      
1321   1        accVAHardPyh = (float)0.0; // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ ç‰©ç†å€¼  -- ä¸‹ä½æœºé‡‡é›† init
1322   1        accVAEquPyh = (float)0.0;  // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡å™¨é‡‡é›† init
1323   1        accVBEquPyh = (float)0.0;  // ç”µæ± ç»„ç”µå‹å¤‡é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡å™¨é‡‡é›† init
1324   1        equVRefPhy = (float)0.0;   // å‡è¡¡å™¨åŸºå‡†ç”µå‹ ç‰©ç†å€¼     -- å‡è¡¡å™¨é‡‡é›† init
1325   1      
1326   1        equ5VP = 0;  // å‡è¡¡+5Vç”µå‹  init
1327   1        equ12VP = 0; // å‡è¡¡+12Vç”µå‹ init
1328   1        equ12VN = 0; // å‡è¡¡-12Vç”µå‹ init
1329   1        equVRef = 0; // å‡è¡¡åŸºå‡†ç”µå‹ init
1330   1      
1331   1        equOpenValue = 0.06;  // å‡è¡¡å¼€é—¨é™å€¼ init A
1332   1        equOpenValueB = 0.06; // å‡è¡¡å¼€é—¨é™å€¼ init B
1333   1        equOpenValueC = 0.06; // å‡è¡¡å¼€é—¨é™å€¼ init C
1334   1      
1335   1        equCloseValue = 0.01;  // å‡è¡¡å…³é—¨é™å€¼ init A
1336   1        equCloseValueB = 0.01; // å‡è¡¡å…³é—¨é™å€¼ init B
1337   1        equCloseValueC = 0.01; // å‡è¡¡å…³é—¨é™å€¼ init C
1338   1      
1339   1        singleVProtectValueUP = (float)4.20;  // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼A  init
1340   1        singleVProtectValueUPB = (float)4.20; // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼B  init
1341   1        singleVProtectValueUPC = (float)4.20; // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤æŠ¥è­¦å€¼C  init
1342   1      
1343   1        singleVWardValueUP = (float)4.30;  // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A  init
1344   1        singleVWardValueUPB = (float)4.30; // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B  init
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 23  

1345   1        singleVWardValueUPC = (float)4.30; // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C  init
1346   1      
1347   1        singleVWardValueDOWN = (float)3.50;  // å•ä½“ä¸‹é™æŠ¥è­¦å€¼A  init
1348   1        singleVWardValueDOWNB = (float)3.50; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼B  init
1349   1        singleVWardValueDOWNC = (float)3.50; // å•ä½“ä¸‹é™æŠ¥è­¦å€¼C  init
1350   1      
1351   1        batteryVAWardValueUP = (float)37.8;  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A  init
1352   1        batteryVAWardValueUPB = (float)37.8; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B  init
1353   1        batteryVAWardValueUPC = (float)37.8; // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C  init
1354   1      
1355   1        batteryVAWardValueDOWN = (float)27.0;  // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼A  init
1356   1        batteryVAWardValueDOWNB = (float)27.0; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼B  init
1357   1        batteryVAWardValueDOWNC = (float)27.0; // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼C  init
1358   1      
1359   1        wrEquOnoffIndex = 0; // å‡è¡¡æŒ‡ä»¤å†™ç´¢å¼•   init
1360   1        rdEquOnoffIndex = 0; // å‡è¡¡æŒ‡ä»¤è¯»ç´¢å¼• init
1361   1        for (i = 0; i < 48; i++)
1362   1        {
1363   2          equOnoffBuffer[i] = 0; // init
1364   2        }
1365   1      
1366   1        fgEquRx = FALSE;     // å‡è¡¡422æ¥æ”¶æ ‡å¿— é»˜è®¤ç¦æ­¢  init
1367   1        fgEquTx = FALSE;     // å‡è¡¡422å‘é€æ ‡å¿— é»˜è®¤ç¦æ­¢  init
1368   1        for (i = 0; i < 11; i++) // å•ä½“ç”µå‹åˆå§‹åŒ–
1369   1        {
1370   2          aq[i] = 0; // init
1371   2        }
1372   1      
1373   1        equRxCount = 0;      // å‡è¡¡422æ¥æ”¶è®¡æ•°  init
1374   1        for (i = 0; i < 40; i++) // å‡è¡¡å™¨æ•°æ®æ¥æ”¶ç¼“å­˜
1375   1        {
1376   2          equDataBuffer[i] = 0; // init
1377   2        }
1378   1      
1379   1        for (i = 0; i < 9; i++)
1380   1        {
1381   2          equExeCount[i] = 0; // å‡è¡¡æ‰§è¡Œè®¡æ•° init
1382   2        }
1383   1      
1384   1        aqStateContrl = 0xFFFF;  // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–A init
1385   1        aqStateContrlB = 0xFFFF; // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–B init
1386   1        aqStateContrlC = 0xFFFF; // å‡è¡¡æ§åˆ¶å­—åˆå§‹åŒ–C init
1387   1      
1388   1        sepCurrentState1 = 0x00; // åˆ†æµä¿æŠ¤é€šæ–­çŠ¶æ€ åˆå§‹æ¸…é›¶ init
1389   1        sepCurrentState2 = 0x00; // åˆ†æµä¿æŠ¤é€šæ–­çŠ¶æ€ åˆå§‹æ¸…é›¶ init
1390   1        sepCurrentState3 = 0x00; // åˆ†æµä¿æŠ¤é€šæ–­çŠ¶æ€ åˆå§‹æ¸…é›¶ init
1391   1        sepCurrentState4 = 0x00; // åˆ†æµä¿æŠ¤é€šæ–­çŠ¶æ€ åˆå§‹æ¸…é›¶ init
1392   1      
1393   1        ntrPower = (float)150.0;  // è®¾ç½®æ»¡ç”µé‡ é»˜è®¤å€¼ä¸º150 A init
1394   1        ntrPowerB = (float)150.0; // è®¾ç½®æ»¡ç”µé‡ é»˜è®¤å€¼ä¸º150  B init
1395   1        ntrPowerC = (float)150.0; // è®¾ç½®æ»¡ç”µé‡ é»˜è®¤å€¼ä¸º150  C init
1396   1      
1397   1        chargePower = (float)0.0;  // è“„ç”µæ± ç»„å……ç”µç”µé‡å€¼  init
1398   1        dischargePower = (float)0.0; // è“„ç”µæ± ç»„æ”¾ç”µç”µé‡å€¼  init
1399   1        currentPower = (float)150.0; // è“„ç”µæ± ç»„å½“å‰ç”µé‡å€¼   init
1400   1      
1401   1        powerSave[0] = (unsigned char)((unsigned int)((currentPower * 1000) / 3.0) >> 8); // ç”µé‡åˆå§‹åŒ–   in
             -it
1402   1        powerSave[1] = (unsigned char)((unsigned int)((currentPower * 1000) / 3.0) & 0xFF); // init
1403   1        powerSave[2] = 0x00;
1404   1        powerSave[3] = 0x00;
1405   1        powerSave[4] = 0x00;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 24  

1406   1        powerSave[5] = 0x00;
1407   1      
1408   1        proportion = 102;  // å……æ”¾æ¯”  init  A
1409   1        proportionB = 102; // å……æ”¾æ¯”  init  B
1410   1        proportionC = 102; // å……æ”¾æ¯”  init  C
1411   1      
1412   1        selfControlCount = 0x00; // è‡ªä¸»æ§åˆ¶è®¡æ•°æ¸…é›¶ init
1413   1      
1414   1        selfCheckStateWord = 0; // è‡ªæ£€çŠ¶æ€å­— init
1415   1      
1416   1        selfCheckStateContrl = 0xFF;  // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  A init
1417   1        selfCheckStateContrlB = 0xFF; // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  B init
1418   1        selfCheckStateContrlC = 0xFF; // é»˜è®¤è‡ªæ£€æ§åˆ¶å­— å…¨æœ‰æ•ˆ  C init
1419   1      
1420   1        healthStateWord1 = 0x0000; // å¥åº·çŠ¶æ€å­—1   init     é»˜è®¤
1421   1        healthStateWord2 = 0x0000; // å¥åº·çŠ¶æ€å­—4    init    é»˜è®¤
1422   1      
1423   1        healthStateContr1 = 0xFFFF;  // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­— init  é»˜è®¤ A
1424   1        healthStateContr1B = 0xFFFF; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­— init  é»˜è®¤ B
1425   1        healthStateContr1C = 0xFFFF; // å¥åº·çŠ¶æ€å­—1æ§åˆ¶å­— init  é»˜è®¤ C
1426   1      
1427   1        healthStateContr2 = 0xFFFF;  // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­— init   é»˜è®¤ A
1428   1        healthStateContr2B = 0xFFFF; // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­— init   é»˜è®¤ B
1429   1        healthStateContr2C = 0xFFFF; // å¥åº·çŠ¶æ€å­—4æ§åˆ¶å­— init   é»˜è®¤ C
1430   1      
1431   1        equControlEn = TRUE;  // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€A  init
1432   1        equControlEnB = TRUE; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B  init
1433   1        equControlEnC = TRUE; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C  init
1434   1      
1435   1        singleProtectChargeEn = FALSE;  // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€A  init
1436   1        singleProtectChargeEnB = FALSE; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B  init
1437   1        singleProtectChargeEnC = FALSE; // å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C  init
1438   1      
1439   1        overChargeProtectEn = FALSE;  // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—A  init
1440   1        overChargeProtectEnB = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—B  init
1441   1        overChargeProtectEnC = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—C  init
1442   1      
1443   1        fgAh = FALSE;    // é»˜è®¤å®‰æ—¶è®¡æœªå¯åŠ¨ init
1444   1        aqControlNumber = 9; // é»˜è®¤æ§åˆ¶9èŠ‚å‚ä¸ init
1445   1      
1446   1        for (i = 0; i < 3; i++)
1447   1        {
1448   2          currentModeCountA[i] = 0; // ç”µæµæ¨¡å¼è®¡æ•°Aæ¸…é›¶ init
1449   2          currentModeCountB[i] = 0; // ç”µæµæ¨¡å¼è®¡æ•°Bæ¸…é›¶ init
1450   2        }
1451   1      
1452   1        checkCount1 = 0; // æ¯çº¿è¿‡å‹æ—¶é—´è®¡æ•°    -- å¥åº·ç›‘æµ‹è®¡æ•°1 init
1453   1        checkCount2 = 0; // æ¯çº¿æ¬ å‹æ—¶é—´è®¡æ•°    -- å¥åº·ç›‘æµ‹è®¡æ•°2 init
1454   1        checkCount3 = 0; // è“„ç”µæ± ç»„è¿‡å‹æ—¶é—´è®¡æ•°  -- å¥åº·ç›‘æµ‹è®¡æ•°3 init
1455   1        checkCount4 = 0; // è“„ç”µæ± ç»„æ¬ å‹æ—¶é—´è®¡æ•°  -- å¥åº·ç›‘æµ‹è®¡æ•°4 init
1456   1        checkCount5 = 0; // å‡è¡¡åŸºå‡†ç”µå‹æ—¶é—´è®¡æ•°  -- å¥åº·ç›‘æµ‹è®¡æ•°5 init
1457   1        checkCount6 = 0; // å‡è¡¡å·¥ä½œç›‘æµ‹æ—¶é—´è®¡æ•°  -- å¥åº·ç›‘æµ‹è®¡æ•°6 init
1458   1        checkCount7 = 0; // åˆ†æµç®¡çŸ­è·¯æ—¶é—´è®¡æ•°     -- å¥åº·ç›‘æµ‹è®¡æ•°7 init
1459   1        checkCount8 = 0; // ä¾›ç”µè‡ªæ£€æ—¶é—´è®¡æ•°    -- è‡ªæ£€ç›‘æµ‹è®¡æ•°8 init
1460   1      
1461   1        fgCheck1 = FALSE; // æ¯çº¿è¿‡å‹æ ‡å¿—       -- å¥åº·æ ‡å¿—1 init
1462   1        fgCheck2 = FALSE; // æ¯çº¿æ¬ å‹æ ‡å¿—       -- å¥åº·æ ‡å¿—2 init
1463   1        fgCheck3 = FALSE; // è“„ç”µæ± ç»„ç”µå‹è¿‡å‹æ ‡å¿—   -- å¥åº·æ ‡å¿—3 init
1464   1        fgCheck4 = FALSE; // è“„ç”µæ± ç»„ç”µå‹æ¬ å‹æ ‡å¿—   -- å¥åº·æ ‡å¿—4 init
1465   1        fgCheck5 = FALSE; // å‡è¡¡åŸºå‡†ç”µå‹æ£€æµ‹æ ‡å¿—   -- å¥åº·æ ‡å¿—5 init
1466   1        fgCheck6 = FALSE; // å‡è¡¡å·¥ä½œæ£€æµ‹æ ‡å¿—     -- å¥åº·æ ‡å¿—6 init
1467   1        fgCheck7 = FALSE; // åˆ†æµç®¡çŸ­è·¯æ£€æµ‹æ ‡å¿—  -- å¥åº·æ ‡å¿—7 init
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 25  

1468   1        fgCheck8 = FALSE; // ä¾›ç”µè‡ªæ£€æ ‡å¿—       -- æ ‡å¿— init
1469   1      
1470   1        for (i = 0; i < 9; i++) // å•ä½“å¥åº·ç›¸å…³è®¡æ•°æ¸…é›¶
1471   1        {
1472   2          checkCountAqA[i] = 0; // å•ä½“æ¬ å‹è®¡æ•°æ¸…é›¶ init
1473   2          checkCountAqB[i] = 0; // å•ä½“è¿‡å‹è®¡æ•°æ¸…é›¶ init
1474   2      
1475   2          fgAqCheckA[i] = FALSE; // å•ä½“æ¬ å‹æ ‡å¿—æ¸…é›¶ init
1476   2          fgAqCheckB[i] = FALSE; // å•ä½“è¿‡å‹æ ‡å¿—æ¸…é›¶ init
1477   2        }
1478   1      
1479   1        overChargeProCount = 0;     // è¿‡å……ä¿æŠ¤æ‰§è¡Œè®¡æ•° init
1480   1        singleProtectChargeCount = 0; // è¿‡å……ä¿æŠ¤æ‰§è¡Œè®¡æ•° init
1481   1      
1482   1        sysTime = 0; // æ—¶é—´åˆå§‹åŒ– init
1483   1      }
1484          
1485          /***************************************************************************************/
1486          /* å‡½æ•°ä»‹ç»: AutoOnoff                                                                 */
1487          /* åŠŸèƒ½æè¿°: è‡ªåŠ¨æŒ‡ä»¤è¾“å‡º                                                              */
1488          /* ä¿®æ”¹è®°å½•:                                                                           */
1489          /*                                                                                     */
1490          /***************************************************************************************/
1491          void AutoOnoff(void)
1492          {
1493   1        DA_A_CUR = curCsTab[4]; // Aç»„å……ç”µé˜µé™æµ5
1494   1        Delay(3000);      // å»¶æ—¶ çº¦20ms
1495   1        dog = !dog;
1496   1      
1497   1        DA_B_CUR = curCsTab[4]; // Bç»„å……ç”µé˜µé™æµ5
1498   1        Delay(3000);      // å»¶æ—¶ çº¦20ms
1499   1        dog = !dog;
1500   1      
1501   1        DA_A_VOL = volCsTab[4]; // Aç»„å……ç”µé˜µé™å‹5
1502   1        Delay(3000);      // å»¶æ—¶ çº¦20ms
1503   1        dog = !dog;
1504   1      
1505   1        DA_B_VOL = volCsTab[4]; // Bç»„å……ç”µé˜µé™å‹5
1506   1        Delay(3000);      // å»¶æ—¶ çº¦20ms
1507   1        dog = !dog;
1508   1      
1509   1        ONOFFOutput(33); // BDRA1ä½¿èƒ½
1510   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1511   1        dog = !dog;
1512   1      
1513   1        ONOFFOutput(37); // BDRA2ä½¿èƒ½
1514   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1515   1        dog = !dog;
1516   1      
1517   1        ONOFFOutput(41); // BDRA3ä½¿èƒ½
1518   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1519   1        dog = !dog;
1520   1      
1521   1        ONOFFOutput(45); // BDRA4ä½¿èƒ½
1522   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1523   1        dog = !dog;
1524   1      
1525   1        ONOFFOutput(35); // BDRB1ä½¿èƒ½
1526   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1527   1        dog = !dog;
1528   1      
1529   1        ONOFFOutput(39); // BDRB2ä½¿èƒ½
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 26  

1530   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1531   1        dog = !dog;
1532   1      
1533   1        ONOFFOutput(43); // BDRB3ä½¿èƒ½
1534   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1535   1        dog = !dog;
1536   1      
1537   1        ONOFFOutput(47); // BDRB4ä½¿èƒ½
1538   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1539   1        dog = !dog;
1540   1      
1541   1        ONOFFOutput(8); // Aç»„å……ç”µé˜µæ¥é€š
1542   1        Delay(3000);  // å»¶æ—¶ çº¦20ms
1543   1        dog = !dog;
1544   1      
1545   1        ONOFFOutput(24); // Bç»„å……ç”µé˜µæ¥é€š
1546   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1547   1        dog = !dog;
1548   1      
1549   1        ONOFFOutput(9); // å……åˆ†æ¨¡å—1åˆ†æµä¿æŠ¤ç®¡æ¥é€š
1550   1        Delay(3000);  // å»¶æ—¶ çº¦20ms
1551   1        dog = !dog;   // ç‰µç‹—
1552   1      
1553   1        ONOFFOutput(16); // å……åˆ†æ¨¡å—2åˆ†æµä¿æŠ¤ç®¡æ¥é€š
1554   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1555   1        dog = !dog;    // ç‰µç‹—
1556   1      
1557   1        ONOFFOutput(25); // å……åˆ†æ¨¡å—3åˆ†æµä¿æŠ¤ç®¡æ¥é€š
1558   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1559   1        dog = !dog;    // ç‰µç‹—
1560   1      
1561   1        ONOFFOutput(32); // å……åˆ†æ¨¡å—4åˆ†æµä¿æŠ¤ç®¡æ¥é€š
1562   1        Delay(3000);   // å»¶æ—¶  çº¦20ms
1563   1        dog = !dog;    // ç‰µç‹—
1564   1      }
1565          
1566          //*****************************************************************
1567          // å‡½æ•°åç§° : CANInit
1568          // åŠŸèƒ½æè¿° :
1569          // *****************************************************************
1570          void CANInit(unsigned int address)
1571          {
1572   1        unsigned char temp;
1573   1      
1574   1        XBYTE[address] = 0x41; // è¿›å…¥å¤ä½æ¨¡å¼
1575   1        Delay(5);
1576   1        XBYTE[address + 1] = 0xEC;    // å‘½ä»¤å¯„å­˜å™¨è®¾ç½®
1577   1        XBYTE[address + 4] = CAN_ACR; // æ¥å—ä»£ç å¯„å­˜å™¨è®¾ç½®
1578   1        XBYTE[address + 5] = CAN_AMR; // æ¥å—å±è”½å¯„å­˜å™¨è®¾ç½®
1579   1        XBYTE[address + 6] = 0x00;    // æ€»çº¿æ—¶åºå¯„å­˜å™¨0è®¾ç½®  16M - 500K
1580   1        XBYTE[address + 7] = 0x1C;    // æ€»çº¿æ—¶åºå¯„å­˜å™¨1è®¾ç½®
1581   1        XBYTE[address + 8] = 0x4A;    // è¾“å‡ºæ§åˆ¶å¯„å­˜å™¨è®¾ç½®
1582   1        XBYTE[address + 31] = 0x04;   // æ—¶é’Ÿåˆ†é¢‘å¯„å­˜å™¨è®¾ç½®
1583   1      
1584   1        XBYTE[address] = 0x46; // ä¸­æ–­çš„å¼€å¯å¤„ç†
1585   1        Delay(1);        // å»¶æ—¶çº¦31us
1586   1        XBYTE[address] = 0x46; // é‡å¤è¿›è¡Œå·¥ä½œæ¨¡å¼ï¼ˆåº”å¯¹æ€»çº¿æŒ‚èµ·å¤„ç†ï¼‰
1587   1      
1588   1        temp = XBYTE[address + 2]; // æ¸…çŠ¶æ€å¯„å­˜å™¨
1589   1        temp = XBYTE[address + 3]; // æ¸…ä¸­æ–­å¯„å­˜å™¨
1590   1        Delay(10);           // å¢åŠ å»¶æ—¶ å›åˆ°å·¥ä½œæ¨¡å¼
1591   1      }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 27  

1592          
1593          //*****************************************************************
1594          // å‡½æ•°åç§° : CPUInit
1595          // åŠŸèƒ½æè¿° :
1596          // *****************************************************************
1597          void CPUInit(void)
1598          {
1599   1        IP = 0x06; // è®¾ç½®ä¼˜å…ˆçº§: T0ä¸ºé«˜ä¼˜å…ˆçº§ã€INT0ä¸ºä½ä¼˜å…ˆçº§ã€INT1ä¸ºé«˜ä¼˜å…ˆçº§
1600   1        IT0 = 0;   // ç”µå¹³ä¸­æ–­è§¦å‘
1601   1        IT1 = 0;   // ç”µå¹³ä¸­æ–­è§¦å‘
1602   1      
1603   1        TMOD = 0x01; // å®šæ—¶å™¨0è®¾å®šå·¥ä½œæ–¹å¼1
1604   1        TH0 = 0xB8;
1605   1        TL0 = 0x00; // å®šæ—¶å™¨10mså®šæ—¶
1606   1        TR0 = 1;  // å¯åŠ¨T0è®¡æ•°
1607   1      
1608   1        ET0 = 1; // å…è®¸å®šæ—¶å™¨0ä¸­æ–­
1609   1        EX0 = 1; // å…è®¸å¤–éƒ¨ä¸­æ–­0ä¸­æ–­
1610   1        EX1 = 1; // å…è®¸å¤–éƒ¨ä¸­æ–­1ä¸­æ–­
1611   1      }
1612          
1613          //*****************************************************************
1614          // å‡½æ•°åç§° : ANCollect
1615          // åŠŸèƒ½æè¿° :
1616          // *****************************************************************
1617          void ANCollect(void)
1618          {
1619   1        unsigned char i;
1620   1      
1621   1        EquAncollect(); // è¿›è¡Œå‡è¡¡å™¨422æ¥æ”¶   å…ˆè¿›è¡Œå‡è¡¡æ€§æ•°æ®é‡‡é›†å¤„ç†!!!
1622   1      
1623   1        for (i = 0; i < 86; i++) // é‡‡é›†å…¨éƒ¨é¥æµ‹å‚æ•°
1624   1        {
1625   2          anData[i] = ADConvert(rsTab[i]);
1626   2        }
1627   1      
1628   1        limbCurrentA = (float)(((float)anData[35] * K1) + b1) + (float)(((float)anData[37] * K3) + b3); // Aç¿¼å¤
             -ªé˜³é˜µç”µæµ = å……åˆ†æ¨¡å—1ç”µæµ + å……åˆ†æ¨¡å—3ç”µæµ;
1629   1        if (limbCurrentA < 0)                                     // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1630   1        {
1631   2          limbCurrentA = 0;
1632   2        }
1633   1      
1634   1        limbCurrentB = (float)(((float)anData[36] * K2) + b2) + (float)(((float)anData[38] * K4) + b4); // Bç¿¼å¤
             -ªé˜³é˜µç”µæµ = å……åˆ†æ¨¡å—2ç”µæµ + å……åˆ†æ¨¡å—4ç”µæµ;
1635   1        if (limbCurrentB < 0)                                     // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1636   1        {
1637   2          limbCurrentB = 0;
1638   2        }
1639   1      
1640   1        limbCurrent = limbCurrentA + limbCurrentB; // å¤ªé˜³ç¿¼æ€»ç”µæµ
1641   1      
1642   1        genCurrent = (float)(((float)anData[0] * K5) + b5) + (float)(((float)anData[2] * K6) + b6) + (float)(((fl
             -oat)anData[1] * K7) + b7) + (float)(((float)anData[3] * K8) + b8); // æ¯çº¿ç”µæµ = æ¯çº¿ç”µæµ1 + 2 + 3 + 4;
1643   1        if (genCurrent < 0)                                                                             // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1644   1        {
1645   2          genCurrent = 0;
1646   2        }
1647   1      
1648   1        chargeCurrent1 = (float)(((float)anData[25] * K9) + b9);
1649   1        if (chargeCurrent1 < 0) // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1650   1        {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 28  

1651   2          chargeCurrent1 = 0;
1652   2        }
1653   1        chargeCurrent2 = (float)(((float)anData[27] * K10) + b10);
1654   1        if (chargeCurrent2 < 0) // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1655   1        {
1656   2          chargeCurrent2 = 0;
1657   2        }
1658   1        chargeCurrent = chargeCurrent1 + chargeCurrent2; // å……ç”µç”µæµ
1659   1      
1660   1        dischargeCurrent1 = (float)(((float)anData[4] * K11) + b11); // æ”¾ç”µç”µæµ
1661   1        if (dischargeCurrent1 < 0)                   // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1662   1        {
1663   2          dischargeCurrent1 = 0;
1664   2        }
1665   1        dischargeCurrent2 = (float)(((float)anData[6] * K12) + b12); // æ”¾ç”µç”µæµ
1666   1        if (dischargeCurrent2 < 0)                   // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1667   1        {
1668   2          dischargeCurrent2 = 0;
1669   2        }
1670   1        dischargeCurrent = dischargeCurrent1 + dischargeCurrent2; // æ”¾ç”µç”µæµ
1671   1      
1672   1        meaV = (float)(((float)anData[48] * K23) + b23); // MEA
1673   1        if (meaV < 0)                  // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1674   1        {
1675   2          meaV = 0;
1676   2        }
1677   1      
1678   1        generatrixVol = (float)(((float)anData[34] * K24) + b24); // æ¯çº¿ç”µå‹
1679   1        if (generatrixVol < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1680   1        {
1681   2          generatrixVol = 0;
1682   2        }
1683   1      
1684   1        accVAHard = anData[5]; // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼æ›´æ–°
1685   1      
1686   1        accVAHardPyh = (float)(((float)accVAHard * K14) + b14); // è“„ç”µæ± ç»„ä¸»ä»½ ç‰©ç†å€¼æ›´æ–°
1687   1        if (accVAHardPyh < 0)                 // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1688   1        {
1689   2          accVAHardPyh = 0;
1690   2        }
1691   1      
1692   1        chargeArrayCurrent[0] = (float)(((float)anData[68] * K18) + b18); // å……ç”µé˜µA1å·¥ä½œç”µæµ
1693   1        if (chargeArrayCurrent[0] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1694   1        {
1695   2          chargeArrayCurrent[0] = 0;
1696   2        }
1697   1        chargeArrayCurrent[1] = (float)(((float)anData[70] * K19) + b19); // å……ç”µé˜µA2å·¥ä½œç”µæµ
1698   1        if (chargeArrayCurrent[1] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1699   1        {
1700   2          chargeArrayCurrent[1] = 0;
1701   2        }
1702   1        chargeArrayCurrent[2] = (float)(((float)anData[69] * K20) + b20); // å……ç”µé˜µA3å·¥ä½œç”µæµ
1703   1        if (chargeArrayCurrent[2] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1704   1        {
1705   2          chargeArrayCurrent[2] = 0;
1706   2        }
1707   1        chargeArrayCurrent[3] = (float)(((float)anData[72] * K21) + b21); // å……ç”µé˜µA4å·¥ä½œç”µæµ
1708   1        if (chargeArrayCurrent[3] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1709   1        {
1710   2          chargeArrayCurrent[3] = 0;
1711   2        }
1712   1        chargeArrayCurrent[4] = (float)(((float)anData[71] * K22) + b22); // å……ç”µé˜µA5å·¥ä½œç”µæµ
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 29  

1713   1        if (chargeArrayCurrent[4] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1714   1        {
1715   2          chargeArrayCurrent[4] = 0;
1716   2        }
1717   1      
1718   1        chargeArrayCurrent[5] = (float)(((float)anData[73] * K18) + b18); // å……ç”µé˜µB1å·¥ä½œç”µæµ
1719   1        if (chargeArrayCurrent[5] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1720   1        {
1721   2          chargeArrayCurrent[5] = 0;
1722   2        }
1723   1        chargeArrayCurrent[6] = (float)(((float)anData[76] * K19) + b19); // å……ç”µé˜µB2å·¥ä½œç”µæµ
1724   1        if (chargeArrayCurrent[6] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1725   1        {
1726   2          chargeArrayCurrent[6] = 0;
1727   2        }
1728   1        chargeArrayCurrent[7] = (float)(((float)anData[74] * K20) + b20); // å……ç”µé˜µB3å·¥ä½œç”µæµ
1729   1        if (chargeArrayCurrent[7] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1730   1        {
1731   2          chargeArrayCurrent[7] = 0;
1732   2        }
1733   1        chargeArrayCurrent[8] = (float)(((float)anData[78] * K21) + b21); // å……ç”µé˜µB4å·¥ä½œç”µæµ
1734   1        if (chargeArrayCurrent[8] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1735   1        {
1736   2          chargeArrayCurrent[8] = 0;
1737   2        }
1738   1        chargeArrayCurrent[9] = (float)(((float)anData[75] * K22) + b22); // å……ç”µé˜µB5å·¥ä½œç”µæµ
1739   1        if (chargeArrayCurrent[9] < 0)                    // è´Ÿæ•°ä¿æŠ¤è®¾ç½®
1740   1        {
1741   2          chargeArrayCurrent[9] = 0;
1742   2        }
1743   1      
1744   1        sepCurrentState1 = SepCurrentStateCal(anData[82]); // åˆ†æµé€šæ–­çŠ¶æ€1   æ›´æ–°åˆ†æµé€šæ–­çŠ¶æ€   åˆ†
             -æµé€šæ–­çŠ¶æ€æ— ç³»æ•°
1745   1        sepCurrentState2 = SepCurrentStateCal(anData[81]); // åˆ†æµé€šæ–­çŠ¶æ€2
1746   1        sepCurrentState3 = SepCurrentStateCal(anData[77]); // åˆ†æµé€šæ–­çŠ¶æ€3
1747   1        sepCurrentState4 = SepCurrentStateCal(anData[83]); // åˆ†æµé€šæ–­çŠ¶æ€4
1748   1      }
1749          
1750          //*****************************************************************
1751          // å‡½æ•°åç§° : EquAncollect
1752          // åŠŸèƒ½æè¿° :
1753          // *****************************************************************
1754          void EquAncollect(void)
1755          {
1756   1        unsigned char i;
1757   1        unsigned char j;
1758   1        unsigned char tempU;
1759   1        float tempF;
1760   1      
1761   1        for (i = 0; i < 40; i++) // å‡è¡¡å™¨æ¥æ”¶ç¼“å­˜åŒºæ¸…é›¶
1762   1        {
1763   2          equDataBuffer[i] = 0;
1764   2        }
1765   1      
1766   1        RXDCONTROL = 1; // é—¨æ§ç¦æ­¢
1767   1        equRxCount = 0; // æ¥æ”¶è®¡æ•°æ¸…é›¶
1768   1      
1769   1        fgEquRx = TRUE;   // è®¾ç½®æ¥æ”¶æ ‡å¿—
1770   1        tempU = TXD422BUFF; // æ¸…é™¤æ¥æ”¶ç¼“å­˜
1771   1        RXD422AEn = 0;    // æ¥æ”¶ä½¿èƒ½
1772   1        RXDCONTROL = 0;   // é—¨æ§æœ‰æ•ˆ
1773   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 30  

1774   1        dog = !dog;   // 1s ç‰µç‹—ä¸€æ¬¡
1775   1        Delay(20000); // å»¶æ—¶ç­‰å¾…
1776   1        dog = !dog;   // 1s ç‰µç‹—ä¸€æ¬¡
1777   1      
1778   1        for (i = 0; i < 9; i++) // è¯»å–å•ä½“ç”µå‹åŠ
1779   1        {
1780   2          aq[i] = (equDataBuffer[2 + 2 * i] * 256 + equDataBuffer[2 + 2 * i + 1]) & 0x0FFF;
1781   2        }
1782   1      
1783   1        accEquVA = (equDataBuffer[20] * 256 + equDataBuffer[21]) & 0x0FFF; // ç”µæ± ç»„ç”µå‹ä¸»
1784   1        accEquVB = (equDataBuffer[22] * 256 + equDataBuffer[23]) & 0x0FFF; // ç”µæ± ç»„ç”µå‹å¤‡
1785   1        equ12VP = (equDataBuffer[24] * 256 + equDataBuffer[25]) & 0x0FFF;  // å‡è¡¡+12Vç”µå‹
1786   1        equ12VN = (equDataBuffer[26] * 256 + equDataBuffer[27]) & 0x0FFF;  // å‡è¡¡-12Vç”µå‹
1787   1        equ5VP = (equDataBuffer[28] * 256 + equDataBuffer[29]) & 0x0FFF;   // å‡è¡¡+5Vç”µå‹
1788   1        equVRef = (equDataBuffer[30] * 256 + equDataBuffer[31]) & 0x0FFF;  // å‡è¡¡åŸºå‡†ç”µå‹
1789   1      
1790   1        equVRefPhy = (float)(((float)equVRef * K13) + b13);   // å‡è¡¡å™¨åŸºå‡†ç”µå‹ä¿®æ­£
1791   1        accVAEquPyh = (float)(((float)accEquVA * K16) + b16); // ç”µæ± ç»„ç”µå‹ä¸»é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡
             -å™¨é‡‡é›†
1792   1        accVBEquPyh = (float)(((float)accEquVB * K17) + b17); // ç”µæ± ç»„ç”µå‹å¤‡é‡‡é›†å€¼ ç‰©ç†å€¼  -- å‡è¡¡
             -å™¨é‡‡é›†
1793   1      
1794   1        aqPhy[0] = (float)(((float)aq[0] * Ka1) + ba1); // å•ä½“1ç”µå‹ç‰©ç†å€¼æ›´æ–°
1795   1        aqPhy[1] = (float)(((float)aq[1] * Ka2) + ba2); // å•ä½“2ç”µå‹ç‰©ç†å€¼æ›´æ–°
1796   1        aqPhy[2] = (float)(((float)aq[2] * Ka3) + ba3); // å•ä½“3ç”µå‹ç‰©ç†å€¼æ›´æ–°
1797   1        aqPhy[3] = (float)(((float)aq[3] * Ka4) + ba4); // å•ä½“4ç”µå‹ç‰©ç†å€¼æ›´æ–°
1798   1        aqPhy[4] = (float)(((float)aq[4] * Ka5) + ba5); // å•ä½“5ç”µå‹ç‰©ç†å€¼æ›´æ–°
1799   1        aqPhy[5] = (float)(((float)aq[5] * Ka6) + ba6); // å•ä½“6ç”µå‹ç‰©ç†å€¼æ›´æ–°
1800   1        aqPhy[6] = (float)(((float)aq[6] * Ka7) + ba7); // å•ä½“7ç”µå‹ç‰©ç†å€¼æ›´æ–°
1801   1        aqPhy[7] = (float)(((float)aq[7] * Ka8) + ba8); // å•ä½“8ç”µå‹ç‰©ç†å€¼æ›´æ–°
1802   1        aqPhy[8] = (float)(((float)aq[8] * Ka9) + ba9); // å•ä½“9ç”µå‹ç‰©ç†å€¼æ›´æ–°
1803   1      
1804   1        for (i = 0; i < 9; i++) // æ›´æ–°æ’åºåå•ä½“ç”µå‹
1805   1        {
1806   2          aqPhyPx[i] = aqPhy[i];
1807   2        }
1808   1      
1809   1        for (i = 0; i < 8; i++) // å†’æ³¡æ³•
1810   1        {
1811   2          for (j = 1; j < (unsigned char)(9 - i); j++)
1812   2          {
1813   3            if (aqPhyPx[i] > aqPhyPx[i + j]) // å‡åº
1814   3            {
1815   4              tempF = aqPhyPx[i + j];
1816   4              aqPhyPx[i + j] = aqPhyPx[i];
1817   4              aqPhyPx[i] = tempF;
1818   4            }
1819   3          }
1820   2        }
1821   1      }
1822          
1823          //*****************************************************************
1824          // å‡½æ•°åç§° : ADConvert
1825          // åŠŸèƒ½æè¿° :
1826          // *****************************************************************
1827          unsigned int ADConvert(unsigned char channel)
1828          {
1829   1        unsigned char i; // ä¸´æ—¶å˜é‡
1830   1        unsigned char j;
1831   1        unsigned int value;
1832   1        unsigned int xdata ad[10];
1833   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 31  

1834   1        AN_ADDR = channel; // æ‰“å¼€æ¨¡æ‹Ÿé‡é€šé“
1835   1        Delay(10);       // å»¶æ—¶ç­‰å¾…é€šé“æ‰“å¼€
1836   1        for (i = 0; i < 10; i++)
1837   1        {
1838   2          value = AD574S;                            // A/Då¯åŠ¨è½¬æ¢
1839   2          Delay(6);                              // A/Dè½¬æ¢å»¶æ—¶
1840   2          ad[i] = (unsigned int)(((unsigned int)AD574H << 4) + (AD574L >> 4)); // D11-D0
1841   2        }
1842   1        for (i = 0; i < 9; i++)
1843   1        {                         // ä»å¤§åˆ°å°æ’åº TData[9]--TData[0]
1844   2          for (j = 1; j < (unsigned char)(10 - i); j++) // å†’æ³¡æ³•æ’åº
1845   2          {
1846   3            if (ad[i] > ad[i + j])
1847   3            {
1848   4              value = ad[i + j];
1849   4              ad[i + j] = ad[i];
1850   4              ad[i] = value;
1851   4            }
1852   3          }
1853   2        }
1854   1        value = 0;
1855   1        for (i = 1; i < 9; i++) // å‰”é™¤æœ€å¤§ã€æœ€å°å€¼ï¼Œå–å¹³å‡å€¼
1856   1        {
1857   2          value = value + ad[i];
1858   2        }
1859   1        value = value + 4;    // å››èˆäº”å…¥
1860   1        value = (value >> 4); // å–å¹³å‡å€¼
1861   1        return (value);
1862   1      }
1863          
1864          //********************************************************************
1865          // å‡½æ•°åç§° : StateWordBuild
1866          // åŠŸèƒ½æè¿° :
1867          // ********************************************************************
1868          void StateWordBuild(void)
1869          {
1870   1        pcuState1 = 0;
1871   1        if ((anData[39] >> 3) > 125) // å……ç”µé˜µA1çŠ¶æ€
1872   1        {
1873   2          pcuState1 = pcuState1 | 0x80;
1874   2        }
1875   1        if ((anData[41] >> 3) > 125) // å……ç”µé˜µA2çŠ¶æ€
1876   1        {
1877   2          pcuState1 = pcuState1 | 0x40;
1878   2        }
1879   1        if ((anData[43] >> 3) > 125) // å……ç”µé˜µA3çŠ¶æ€
1880   1        {
1881   2          pcuState1 = pcuState1 | 0x20;
1882   2        }
1883   1        if ((anData[44] >> 3) > 125) // å……ç”µé˜µA4çŠ¶æ€
1884   1        {
1885   2          pcuState1 = pcuState1 | 0x10;
1886   2        }
1887   1        if ((anData[45] >> 3) > 125) // å……ç”µé˜µA5çŠ¶æ€
1888   1        {
1889   2          pcuState1 = pcuState1 | 0x08;
1890   2        }
1891   1        if ((anData[46] >> 3) > 125) // å……ç”µé˜µB1çŠ¶æ€
1892   1        {
1893   2          pcuState1 = pcuState1 | 0x04;
1894   2        }
1895   1        if ((anData[47] >> 3) > 125) // å……ç”µé˜µB2çŠ¶æ€
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 32  

1896   1        {
1897   2          pcuState1 = pcuState1 | 0x02;
1898   2        }
1899   1        if ((anData[49] >> 3) > 125) // å……ç”µé˜µB3çŠ¶æ€
1900   1        {
1901   2          pcuState1 = pcuState1 | 0x01;
1902   2        }
1903   1      
1904   1        pcuState2 = 0;
1905   1        if ((anData[50] >> 3) > 125) // å……ç”µé˜µB4çŠ¶æ€
1906   1        {
1907   2          pcuState2 = pcuState2 | 0x80;
1908   2        }
1909   1        if ((anData[51] >> 3) > 125) // å……ç”µé˜µB5çŠ¶æ€
1910   1        {
1911   2          pcuState2 = pcuState2 | 0x40;
1912   2        }
1913   1        if ((anData[28] >> 3) > 125) // é¢„æ¥é€šå¼€å…³1çŠ¶æ€
1914   1        {
1915   2          pcuState2 = pcuState2 | 0x20;
1916   2        }
1917   1        if ((anData[30] >> 3) > 125) // æ”¾ç”µå¼€å…³1-1çŠ¶æ€
1918   1        {
1919   2          pcuState2 = pcuState2 | 0x10;
1920   2        }
1921   1        if ((anData[32] >> 3) > 125) // æ”¾ç”µå¼€å…³1-2çŠ¶æ€
1922   1        {
1923   2          pcuState2 = pcuState2 | 0x08;
1924   2        }
1925   1        if ((anData[33] >> 3) > 125) // é¢„æ¥é€šå¼€å…³2çŠ¶æ€
1926   1        {
1927   2          pcuState2 = pcuState2 | 0x04;
1928   2        }
1929   1        if ((anData[29] >> 3) > 125) // æ”¾ç”µå¼€å…³2-1çŠ¶æ€
1930   1        {
1931   2          pcuState2 = pcuState2 | 0x02;
1932   2        }
1933   1        if ((anData[31] >> 3) > 125) // æ”¾ç”µå¼€å…³2-2çŠ¶æ€
1934   1        {
1935   2          pcuState2 = pcuState2 | 0x01;
1936   2        }
1937   1      
1938   1        pcuState3 = 0;
1939   1        if ((anData[8] >> 3) > 125) // BDRA1å·¥ä½œçŠ¶æ€
1940   1        {
1941   2          pcuState3 = pcuState3 | 0x80;
1942   2        }
1943   1        if ((anData[12] >> 3) > 125) // BDRA2å·¥ä½œçŠ¶æ€
1944   1        {
1945   2          pcuState3 = pcuState3 | 0x40;
1946   2        }
1947   1        if ((anData[16] >> 3) > 125) // BDRA3å·¥ä½œçŠ¶æ€
1948   1        {
1949   2          pcuState3 = pcuState3 | 0x20;
1950   2        }
1951   1        if ((anData[20] >> 3) > 125) // BDRA4å·¥ä½œçŠ¶æ€
1952   1        {
1953   2          pcuState3 = pcuState3 | 0x10;
1954   2        }
1955   1        if ((anData[10] >> 3) > 125) // BDRB1å·¥ä½œçŠ¶æ€
1956   1        {
1957   2          pcuState3 = pcuState3 | 0x08;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 33  

1958   2        }
1959   1        if ((anData[14] >> 3) > 125) // BDRB2å·¥ä½œçŠ¶æ€
1960   1        {
1961   2          pcuState3 = pcuState3 | 0x04;
1962   2        }
1963   1        if ((anData[18] >> 3) > 125) // BDRB3å·¥ä½œçŠ¶æ€
1964   1        {
1965   2          pcuState3 = pcuState3 | 0x02;
1966   2        }
1967   1        if ((anData[22] >> 3) > 125) // BDRB4å·¥ä½œçŠ¶æ€
1968   1        {
1969   2          pcuState3 = pcuState3 | 0x01;
1970   2        }
1971   1      
1972   1        pcuState4 = 0;
1973   1        if (fgOverChargeprotect == TRUE) // è“„ç”µæ± ç»„è¿‡å……çŠ¶æ€  bit7
1974   1        {
1975   2          pcuState4 = pcuState4 | 0x80;
1976   2        }
1977   1        if (fgCheck4 == TRUE) // è“„ç”µæ± ç»„æ¬ å‹çŠ¶æ€ bit6  -- å€Ÿç”¨å¥åº·å­—æ ‡å¿—
1978   1        {
1979   2          pcuState4 = pcuState4 | 0x40;
1980   2        }
1981   1        if (overChargeProtectEn == TRUE) // è¿‡å……ä¿æŠ¤ä½¿èƒ½çŠ¶æ€  bit5
1982   1        {
1983   2          pcuState4 = pcuState4 | 0x20;
1984   2        }
1985   1        if (equControlEn == TRUE) // å‡è¡¡æ§åˆ¶ä½¿èƒ½çŠ¶æ€ bit4
1986   1        {
1987   2          pcuState4 = pcuState4 | 0x10;
1988   2        }
1989   1        if (singleProtectChargeEn == TRUE) // å•ä½“ä¿æŠ¤å……ç”µæ§åˆ¶ä½¿èƒ½çŠ¶æ€  bit3
1990   1        {
1991   2          pcuState4 = pcuState4 | 0x08;
1992   2        }
1993   1        if (fgAh == TRUE) // ç”µé‡è®¡å¯åŠ¨æ ‡å¿—  bit2
1994   1        {
1995   2          pcuState4 = pcuState4 | 0x04;
1996   2        }
1997   1        if (fgCanBus == 0xAA) // æ€»çº¿ä½¿ç”¨æ ‡å¿— bit1
1998   1        {
1999   2          pcuState4 = pcuState4 | 0x02;
2000   2        }
2001   1      
2002   1        equState1 = 0;
2003   1        if ((equDataBuffer[0] & 0x01) == 0x01) // å‡è¡¡1çŠ¶æ€
2004   1        {
2005   2          equState1 = equState1 | 0x80; // å‡è¡¡422çŠ¶æ€1
2006   2        }
2007   1        if ((equDataBuffer[1] & 0x80) == 0x80) // å‡è¡¡2çŠ¶æ€
2008   1        {
2009   2          equState1 = equState1 | 0x40; // å‡è¡¡422çŠ¶æ€
2010   2        }
2011   1        if ((equDataBuffer[1] & 0x40) == 0x40) // å‡è¡¡3çŠ¶æ€
2012   1        {
2013   2          equState1 = equState1 | 0x20; // å‡è¡¡422çŠ¶æ€
2014   2        }
2015   1        if ((equDataBuffer[1] & 0x20) == 0x20) // å‡è¡¡4çŠ¶æ€
2016   1        {
2017   2          equState1 = equState1 | 0x10; // å‡è¡¡422çŠ¶æ€
2018   2        }
2019   1        if ((equDataBuffer[1] & 0x10) == 0x10) // å‡è¡¡5çŠ¶æ€
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 34  

2020   1        {
2021   2          equState1 = equState1 | 0x08; // å‡è¡¡422çŠ¶æ€
2022   2        }
2023   1        if ((equDataBuffer[1] & 0x08) == 0x08) // å‡è¡¡6çŠ¶æ€
2024   1        {
2025   2          equState1 = equState1 | 0x04; // å‡è¡¡422çŠ¶æ€
2026   2        }
2027   1        if ((equDataBuffer[1] & 0x04) == 0x04) // å‡è¡¡7çŠ¶æ€
2028   1        {
2029   2          equState1 = equState1 | 0x02; // å‡è¡¡422çŠ¶æ€
2030   2        }
2031   1        if ((equDataBuffer[1] & 0x02) == 0x02) // å‡è¡¡8çŠ¶æ€
2032   1        {
2033   2          equState1 = equState1 | 0x01; // å‡è¡¡422çŠ¶æ€
2034   2        }
2035   1      
2036   1        equState2 = 0;               // å‡è¡¡422çŠ¶æ€2
2037   1        if ((equDataBuffer[1] & 0x01) == 0x01) // å‡è¡¡9çŠ¶æ€
2038   1        {
2039   2          equState2 = equState2 | 0x80; // å‡è¡¡422çŠ¶æ€
2040   2        }
2041   1      }
2042          
2043          //********************************************************************
2044          // å‡½æ•°åç§° : SaveDataRs1
2045          // åŠŸèƒ½æè¿° :
2046          // ********************************************************************
2047          void SaveDataRs1(void) // ç»„å¸§å‡½æ•°--åŒ…1
2048          {
2049   1        unsigned char *p1; // RS1
2050   1        unsigned char sum; // ç´¯åŠ å’Œ
2051   1      
2052   1        //----------------------CANé¥æµ‹ç»„å¸§-------------------------------//
2053   1        if (fgSwitch1 == TRUE) // ç»„å¹€åˆ‡æ¢æ ‡å¿—
2054   1        {
2055   2          p1 = &rsFrame1B[0]; // æŒ‡å‘RS1ç¼“å­˜åŒºB
2056   2        }
2057   1        else
2058   1        {
2059   2          p1 = &rsFrame1A[0]; // æŒ‡å‘RS1ç¼“å­˜åŒºA
2060   2        }
2061   1      
2062   1        sum = 0;
2063   1        //===============================================================//
2064   1        //----------------------RSåŒ…ç»„å¸§--1 -----------------------------//
2065   1        *p1 = 0x9B; // ç¬¬1å¸§
2066   1        p1++;
2067   1        *p1 = 0x68;
2068   1        p1++;
2069   1        *p1 = 0x00; // å¸§è®¡æ•°
2070   1        p1++;
2071   1        *p1 = 0x2C; // é•¿åº¦
2072   1        p1++;
2073   1        *p1 = 0x30; // title
2074   1        sum = sum + *p1;
2075   1        p1++;
2076   1        *p1 = healthStateWord1 >> 8; // å¥åº·å­—1 - H W0
2077   1        sum = sum + *p1;
2078   1        p1++;
2079   1        *p1 = healthStateWord1; // å¥åº·å­—1 - L  W1
2080   1        sum = sum + *p1;
2081   1        p1++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 35  

2082   1        *p1 = healthStateWord2 >> 8; // å¥åº·å­—2 - H  W2
2083   1        sum = sum + *p1;
2084   1        p1++;
2085   1        *p1 = healthStateWord2; // å¥åº·å­—2 - L  W3
2086   1        sum = sum + *p1;
2087   1        p1++;
2088   1        *p1 = anData[34] >> 8; // æ¯çº¿ç”µå‹ - H  W4
2089   1        sum = sum + *p1;
2090   1        p1++;
2091   1        //----------------------RSåŒ…ç»„å¸§--2 --------------------------//
2092   1        *p1 = 0x9B; // ç¬¬2å¸§
2093   1        p1++;
2094   1        *p1 = 0x68;
2095   1        p1++;
2096   1        *p1 = 0x01; // å¸§è®¡æ•°
2097   1        p1++;
2098   1        *p1 = anData[34]; // æ¯çº¿ç”µå‹ - L  W5
2099   1        sum = sum + *p1;
2100   1        p1++;
2101   1        *p1 = anData[0] >> 8; // æ¯çº¿ç”µæµ1 - H  W6
2102   1        sum = sum + *p1;
2103   1        p1++;
2104   1        *p1 = anData[0]; // æ¯çº¿ç”µæµ1 - L  W7
2105   1        sum = sum + *p1;
2106   1        p1++;
2107   1        *p1 = anData[2] >> 8; // æ¯çº¿ç”µæµ2 - H W8
2108   1        sum = sum + *p1;
2109   1        p1++;
2110   1      
2111   1        *p1 = anData[2]; // æ¯çº¿ç”µæµ2 - L  W9
2112   1        sum = sum + *p1;
2113   1        p1++;
2114   1        *p1 = anData[1] >> 8; // æ¯çº¿ç”µæµ3 - H  W10
2115   1        sum = sum + *p1;
2116   1        p1++;
2117   1        *p1 = anData[1]; //  æ¯çº¿ç”µæµ3 - L  W11
2118   1        sum = sum + *p1;
2119   1        p1++;
2120   1        //----------------------RSåŒ…ç»„å¸§--3 ---------------------------//
2121   1        *p1 = 0x9B; // ç¬¬3å¸§
2122   1        p1++;
2123   1        *p1 = 0x68;
2124   1        p1++;
2125   1        *p1 = 0x02; // å¸§è®¡æ•°
2126   1        p1++;
2127   1        *p1 = anData[3] >> 8; // æ¯çº¿ç”µæµ4 - H  W12
2128   1        sum = sum + *p1;
2129   1        p1++;
2130   1        *p1 = anData[3]; // æ¯çº¿ç”µæµ4 - L   W13
2131   1        sum = sum + *p1;
2132   1        p1++;
2133   1        *p1 = accEquVA >> 8; //  è“„ç”µæ± ç”µå‹ä¸» - H  W14
2134   1        sum = sum + *p1;
2135   1        p1++;
2136   1        *p1 = accEquVA; //  è“„ç”µæ± ç”µå‹ä¸» - L  W15
2137   1        sum = sum + *p1;
2138   1        p1++;
2139   1        *p1 = accEquVB >> 8; //  è“„ç”µæ± ç»„å¤‡ - H  W16
2140   1        sum = sum + *p1;
2141   1        p1++;
2142   1        *p1 = accEquVB; //  è“„ç”µæ± ç»„å¤‡ - L  W17
2143   1        sum = sum + *p1;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 36  

2144   1        p1++;
2145   1        *p1 = anData[4] >> 8; // æ”¾ç”µç”µæµ1 - H  W18
2146   1        sum = sum + *p1;
2147   1        p1++;
2148   1        //----------------------RSåŒ…ç»„å¸§--4----------------------------//
2149   1        *p1 = 0x9B; // ç¬¬4å¸§
2150   1        p1++;
2151   1        *p1 = 0x68;
2152   1        p1++;
2153   1        *p1 = 0x03; // å¸§è®¡æ•°
2154   1        p1++;
2155   1        *p1 = anData[4]; // æ”¾ç”µç”µæµ1- L  W19
2156   1        sum = sum + *p1;
2157   1        p1++;
2158   1        *p1 = anData[25] >> 8; // å……ç”µç”µæµ1 - H  W20
2159   1        sum = sum + *p1;
2160   1        p1++;
2161   1        *p1 = anData[25]; // å……ç”µç”µæµ1 - L  W21
2162   1        sum = sum + *p1;
2163   1        p1++;
2164   1        *p1 = anData[6] >> 8; // æ”¾ç”µç”µæµ2 - H  W22
2165   1        sum = sum + *p1;
2166   1        p1++;
2167   1        *p1 = anData[6]; // æ”¾ç”µç”µæµ2 - L W23
2168   1        sum = sum + *p1;
2169   1        p1++;
2170   1        *p1 = anData[27] >> 8; // å……ç”µç”µæµ2 - H  W24
2171   1        sum = sum + *p1;
2172   1        p1++;
2173   1        *p1 = anData[27]; // å……ç”µç”µæµ2 - L  W25
2174   1        sum = sum + *p1;
2175   1        p1++;
2176   1        //-----------------------RSåŒ…ç»„å¸§--5 -------------------------//
2177   1        *p1 = 0x9B; // ç¬¬5å¸§
2178   1        p1++;
2179   1        *p1 = 0x68;
2180   1        p1++;
2181   1        *p1 = 0x04; // å¸§è®¡æ•°
2182   1        p1++;
2183   1        *p1 = (unsigned int)((limbCurrentA * 100) + 0.5) >> 8; // Aç¿¼å¤ªé˜³é˜µç”µæµ - H  W22    A * 100
2184   1        sum = sum + *p1;
2185   1        p1++;
2186   1        *p1 = (unsigned int)((limbCurrentA * 100) + 0.5); // Aç¿¼å¤ªé˜³é˜µç”µæµ - L  W23
2187   1        sum = sum + *p1;
2188   1        p1++;
2189   1        *p1 = (unsigned int)((limbCurrentB * 100) + 0.5) >> 8; // Bç¿¼å¤ªé˜³é˜µç”µæµ - H  W24
2190   1        sum = sum + *p1;
2191   1        p1++;
2192   1        *p1 = (unsigned int)((limbCurrentB * 100) + 0.5); // Bç¿¼å¤ªé˜³é˜µç”µæµ - L  W25
2193   1        sum = sum + *p1;
2194   1        p1++;
2195   1        *p1 = anData[48] >> 8; // MEAç”µå‹ - H  W30
2196   1        sum = sum + *p1;
2197   1        p1++;
2198   1        *p1 = anData[48]; // MEAç”µå‹ - L  W31
2199   1        sum = sum + *p1;
2200   1        p1++;
2201   1        *p1 = anData[40] >> 8; // BEAç”µå‹1 - H  W32
2202   1        sum = sum + *p1;
2203   1        p1++;
2204   1        //----------------------RSåŒ…ç»„å¸§--6 --------------------------//
2205   1        *p1 = 0x9B; // ç¬¬6å¸§
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 37  

2206   1        p1++;
2207   1        *p1 = 0x68;
2208   1        p1++;
2209   1        *p1 = 0x05; // å¸§è®¡æ•°
2210   1        p1++;
2211   1        *p1 = anData[40]; // BEAç”µå‹1 - L  W33
2212   1        sum = sum + *p1;
2213   1        p1++;
2214   1        *p1 = anData[42] >> 8; //  BEAç”µå‹2 - H  W34
2215   1        sum = sum + *p1;
2216   1        p1++;
2217   1        *p1 = anData[42]; // BEAç”µå‹2 - L  W35
2218   1        sum = sum + *p1;
2219   1        p1++;
2220   1        *p1 = (unsigned int)((genCurrent * 100) + 0.5) >> 8; // æ¯çº¿æ€»ç”µæµ - H  W36
2221   1        sum = sum + *p1;
2222   1        p1++;
2223   1        *p1 = (unsigned int)((genCurrent * 100) + 0.5); // æ¯çº¿æ€»ç”µæµ - L  W37
2224   1        sum = sum + *p1;
2225   1        p1++;
2226   1        *p1 = (unsigned int)((chargeCurrent * 100) + 0.5) >> 8; // å……ç”µæ€»ç”µæµ - H  W38
2227   1        sum = sum + *p1;
2228   1        p1++;
2229   1        *p1 = (unsigned int)((chargeCurrent * 100) + 0.5); // å……ç”µæ€»ç”µæµ - L  W39
2230   1        sum = sum + *p1;
2231   1        p1++;
2232   1        //---------------------- RSåŒ…ç»„å¸§--7  ----------------------------//
2233   1        *p1 = 0x9B; // ç¬¬7å¸§
2234   1        p1++;
2235   1        *p1 = 0x66;
2236   1        p1++;
2237   1        *p1 = 0x06; // å¸§è®¡æ•°
2238   1        p1++;
2239   1        *p1 = (unsigned int)((dischargeCurrent * 100) + 0.5) >> 8; // æ”¾ç”µæ€»ç”µæµ - H  W40
2240   1        sum = sum + *p1;
2241   1        p1++;
2242   1        *p1 = (unsigned int)((dischargeCurrent * 100) + 0.5); // æ”¾ç”µæ€»ç”µæµ - L  W41
2243   1        sum = sum + *p1;
2244   1        p1++;
2245   1        *p1 = (unsigned int)((limbCurrent * 100) + 0.5) >> 8; // Ì«å¤ªé˜³ç¿¼æ€»ç”µæµ - H  W42
2246   1        sum = sum + *p1;
2247   1        p1++;
2248   1        *p1 = (unsigned int)((limbCurrent * 100) + 0.5); // Ì«å¤ªé˜³ç¿¼æ€»ç”µæµ - L  W43
2249   1        sum = sum + *p1;
2250   1        p1++;
2251   1        *p1 = sum; // SUM
2252   1      
2253   1        if (fgSwitch1 == TRUE) // ç»„å¹€åˆ‡æ¢æ ‡å¿—
2254   1        {
2255   2          fgSwitch1 = FALSE; // åˆ‡æ¢æ ‡å¿—
2256   2        }
2257   1        else
2258   1        {
2259   2          fgSwitch1 = TRUE; // åˆ‡æ¢æ ‡å¿—
2260   2        }
2261   1      }
2262          
2263          //*****************************************************************
2264          // å‡½æ•°åç§° : SaveDataRs2
2265          // åŠŸèƒ½æè¿° :
2266          // *****************************************************************
2267          void SaveDataRs2(void) // ç»„å¸§å‡½æ•°--åŒ…2
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 38  

2268          {
2269   1        unsigned char *p1; // RS1
2270   1        unsigned char sum; // ç´¯åŠ å’Œ
2271   1      
2272   1        //----------------------CANé¥æµ‹ç»„å¸§-------------------------//
2273   1        if (fgSwitch2 == TRUE) // ç»„å¹€åˆ‡æ¢æ ‡å¿—
2274   1        {
2275   2          p1 = &rsFrame2B[0]; // æŒ‡å‘ç¼“å­˜åŒºB
2276   2        }
2277   1        else
2278   1        {
2279   2          p1 = &rsFrame2A[0]; // æŒ‡å‘ç¼“å­˜åŒºA
2280   2        }
2281   1      
2282   1        sum = 0;
2283   1      
2284   1        //----------------------RSåŒ…ç»„å¸§--1 ---------------------//
2285   1        *p1 = 0x9B; // ç¬¬1å¸§
2286   1        p1++;
2287   1        *p1 = 0x68;
2288   1        p1++;
2289   1        *p1 = 0x00; // å¸§è®¡æ•°
2290   1        p1++;
2291   1        *p1 = 0x6E; // é•¿åº¦
2292   1        p1++;
2293   1        *p1 = 0x50; // title
2294   1        sum = sum + *p1;
2295   1        p1++;
2296   1        *p1 = anData[9] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµA1 - H  W0
2297   1        sum = sum + *p1;
2298   1        p1++;
2299   1        *p1 = anData[9]; // æ”¾ç”µè¾“å‡ºç”µæµA1 - L W1
2300   1        sum = sum + *p1;
2301   1        p1++;
2302   1        *p1 = anData[13] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµA2 - H  W2
2303   1        sum = sum + *p1;
2304   1        p1++;
2305   1        *p1 = anData[13]; // æ”¾ç”µè¾“å‡ºç”µæµA2 - L  W3
2306   1        sum = sum + *p1;
2307   1        p1++;
2308   1        *p1 = anData[17] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµA3 - H  W4
2309   1        sum = sum + *p1;
2310   1        p1++;
2311   1        //----------------------RSåŒ…ç»„å¸§--2 -----------------------------------------------------------//
2312   1        *p1 = 0x9B; // ç¬¬2å¸§
2313   1        p1++;
2314   1        *p1 = 0x68;
2315   1        p1++;
2316   1        *p1 = 0x01; // å¸§è®¡æ•°
2317   1        p1++;
2318   1      
2319   1        *p1 = anData[17]; // æ”¾ç”µè¾“å‡ºç”µæµA3 - L  W5
2320   1        sum = sum + *p1;
2321   1        p1++;
2322   1        *p1 = anData[21] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµA4 - H  W6
2323   1        sum = sum + *p1;
2324   1        p1++;
2325   1        *p1 = anData[21]; // æ”¾ç”µè¾“å‡ºç”µæµA4 - L  W7
2326   1        sum = sum + *p1;
2327   1        p1++;
2328   1        *p1 = anData[11] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµB1 - H  W8
2329   1        sum = sum + *p1;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 39  

2330   1        p1++;
2331   1        *p1 = anData[11]; // æ”¾ç”µè¾“å‡ºç”µæµB1 - L  W9
2332   1        sum = sum + *p1;
2333   1        p1++;
2334   1        *p1 = anData[15] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµB2 - H  W10
2335   1        sum = sum + *p1;
2336   1        p1++;
2337   1        *p1 = anData[15]; // æ”¾ç”µè¾“å‡ºç”µæµB2 - L  W11
2338   1        sum = sum + *p1;
2339   1        p1++;
2340   1      
2341   1        //----------------------RSåŒ…ç»„å¸§--3 -----------------------------------------------------------//
2342   1        *p1 = 0x9B; // ç¬¬3å¸§
2343   1        p1++;
2344   1        *p1 = 0x68;
2345   1        p1++;
2346   1        *p1 = 0x02; // å¸§è®¡æ•°
2347   1        p1++;
2348   1      
2349   1        *p1 = anData[19] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµB3 - H  W12
2350   1        sum = sum + *p1;
2351   1        p1++;
2352   1        *p1 = anData[19]; // æ”¾ç”µè¾“å‡ºç”µæµB3 - L  W13
2353   1        sum = sum + *p1;
2354   1        p1++;
2355   1        *p1 = anData[23] >> 8; // æ”¾ç”µè¾“å‡ºç”µæµB4 - H  W14
2356   1        sum = sum + *p1;
2357   1        p1++;
2358   1        *p1 = anData[23]; // æ”¾ç”µè¾“å‡ºç”µæµB4 - L  W15
2359   1        sum = sum + *p1;
2360   1        p1++;
2361   1        *p1 = anData[35] >> 8; // å……åˆ†æ¨¡å—1ç”µæµ - H  W16
2362   1        sum = sum + *p1;
2363   1        p1++;
2364   1        *p1 = anData[35]; // å……åˆ†æ¨¡å—1ç”µæµ - L  W17
2365   1        sum = sum + *p1;
2366   1        p1++;
2367   1        *p1 = anData[36] >> 8; // å……åˆ†æ¨¡å—2ç”µæµ - H  W18
2368   1        sum = sum + *p1;
2369   1        p1++;
2370   1      
2371   1        //----------------------RSåŒ…ç»„å¸§--4 ----------------------//
2372   1        *p1 = 0x9B; // ç¬¬4å¸§
2373   1        p1++;
2374   1        *p1 = 0x68;
2375   1        p1++;
2376   1        *p1 = 0x03; // å¸§è®¡æ•°
2377   1        p1++;
2378   1      
2379   1        *p1 = anData[36]; // å……åˆ†æ¨¡å—2ç”µæµ - L  W19
2380   1        sum = sum + *p1;
2381   1        p1++;
2382   1        *p1 = anData[37] >> 8; // å……åˆ†æ¨¡å—3ç”µæµ - H  W20
2383   1        sum = sum + *p1;
2384   1        p1++;
2385   1        *p1 = anData[37]; // å……åˆ†æ¨¡å—3ç”µæµ - L  W21
2386   1        sum = sum + *p1;
2387   1        p1++;
2388   1        *p1 = anData[38] >> 8; // å……åˆ†æ¨¡å—4ç”µæµ - H  W22
2389   1        sum = sum + *p1;
2390   1        p1++;
2391   1        *p1 = anData[38]; // å……åˆ†æ¨¡å—4ç”µæµ - L  W23
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 40  

2392   1        sum = sum + *p1;
2393   1        p1++;
2394   1        *p1 = anData[68] >> 8; // å……ç”µé˜µA1å……ç”µç”µæµ - H  W24
2395   1        sum = sum + *p1;
2396   1        p1++;
2397   1        *p1 = anData[68]; // å……ç”µé˜µA1å……ç”µç”µæµ - L  W25
2398   1        sum = sum + *p1;
2399   1        p1++;
2400   1      
2401   1        //----------------------RSåŒ…ç»„å¸§--5 -----------------------------------------------------------//
2402   1        *p1 = 0x9B; // ç¬¬5å¸§
2403   1        p1++;
2404   1        *p1 = 0x68;
2405   1        p1++;
2406   1        *p1 = 0x04; // å¸§è®¡æ•°
2407   1        p1++;
2408   1      
2409   1        *p1 = anData[70] >> 8; // å……ç”µé˜µA2å……ç”µç”µæµ - H  W26
2410   1        sum = sum + *p1;
2411   1        p1++;
2412   1        *p1 = anData[70]; // å……ç”µé˜µA2å……ç”µç”µæµ - L  W27
2413   1        sum = sum + *p1;
2414   1        p1++;
2415   1        *p1 = anData[69] >> 8; // å……ç”µé˜µA3å……ç”µç”µæµ - H  W28
2416   1        sum = sum + *p1;
2417   1        p1++;
2418   1        *p1 = anData[69]; // å……ç”µé˜µA3å……ç”µç”µæµ - L  W29
2419   1        sum = sum + *p1;
2420   1        p1++;
2421   1        *p1 = anData[72] >> 8; // å……ç”µé˜µA4å……ç”µç”µæµ - H  W30
2422   1        sum = sum + *p1;
2423   1        p1++;
2424   1        *p1 = anData[72]; // å……ç”µé˜µA4å……ç”µç”µæµ - L  W31
2425   1        sum = sum + *p1;
2426   1        p1++;
2427   1        *p1 = anData[71] >> 8; // å……ç”µé˜µA5å……ç”µç”µæµ - H  W32
2428   1        sum = sum + *p1;
2429   1        p1++;
2430   1      
2431   1        //----------------------RSåŒ…ç»„å¸§--6 -----------------------------------------------------------//
2432   1        *p1 = 0x9B; // ç¬¬6å¸§
2433   1        p1++;
2434   1        *p1 = 0x68;
2435   1        p1++;
2436   1        *p1 = 0x05; // å¸§è®¡æ•°
2437   1        p1++;
2438   1      
2439   1        *p1 = anData[71]; // å……ç”µé˜µA5å……ç”µç”µæµ - L  W33
2440   1        sum = sum + *p1;
2441   1        p1++;
2442   1        *p1 = anData[73] >> 8; // å……ç”µé˜µB1å……ç”µç”µæµ - H  W34
2443   1        sum = sum + *p1;
2444   1        p1++;
2445   1        *p1 = anData[73]; // å……ç”µé˜µB1å……ç”µç”µæµ - L  W35
2446   1        sum = sum + *p1;
2447   1        p1++;
2448   1        *p1 = anData[76] >> 8; // å……ç”µé˜µB2å……ç”µç”µæµ - H  W36
2449   1        sum = sum + *p1;
2450   1        p1++;
2451   1        *p1 = anData[76]; // å……ç”µé˜µB2å……ç”µç”µæµ - L  W37
2452   1        sum = sum + *p1;
2453   1        p1++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 41  

2454   1        *p1 = anData[74] >> 8; // å……ç”µé˜µB3å……ç”µç”µæµ - H  W38
2455   1        sum = sum + *p1;
2456   1        p1++;
2457   1        *p1 = anData[74]; // å……ç”µé˜µB3å……ç”µç”µæµ - L  W39
2458   1        sum = sum + *p1;
2459   1        p1++;
2460   1      
2461   1        //----------------------RSåŒ…ç»„å¸§--7 -----------------------------------------------------------//
2462   1        *p1 = 0x9B; // ç¬¬7å¸§
2463   1        p1++;
2464   1        *p1 = 0x68;
2465   1        p1++;
2466   1        *p1 = 0x06; // å¸§è®¡æ•°
2467   1        p1++;
2468   1      
2469   1        *p1 = anData[78] >> 8; // å……ç”µé˜µB4å……ç”µç”µæµ - H  W40
2470   1        sum = sum + *p1;
2471   1        p1++;
2472   1        *p1 = anData[78]; // å……ç”µé˜µB4å……ç”µç”µæµ - L  W41
2473   1        sum = sum + *p1;
2474   1        p1++;
2475   1        *p1 = anData[75] >> 8; // å……ç”µé˜µB5å……ç”µç”µæµ - H  W42
2476   1        sum = sum + *p1;
2477   1        p1++;
2478   1        *p1 = anData[75]; // å……ç”µé˜µB5å……ç”µç”µæµ - L  W43
2479   1        sum = sum + *p1;
2480   1        p1++;
2481   1        *p1 = anData[60] >> 8; // å¤ªé˜³ç”µæ± é˜µ1ç”µå‹ - H  W44
2482   1        sum = sum + *p1;
2483   1        p1++;
2484   1        *p1 = anData[60]; // å¤ªé˜³ç”µæ± é˜µ1ç”µå‹ - L  W45
2485   1        sum = sum + *p1;
2486   1        p1++;
2487   1        *p1 = anData[56] >> 8; // å¤ªé˜³ç”µæ± é˜µ2ç”µå‹ - H  W46
2488   1        sum = sum + *p1;
2489   1        p1++;
2490   1      
2491   1        //----------------------RSåŒ…ç»„å¸§--8 -----------------------------------------------------------//
2492   1        *p1 = 0x9B; // ç¬¬7å¸§
2493   1        p1++;
2494   1        *p1 = 0x68;
2495   1        p1++;
2496   1        *p1 = 0x07; // å¸§è®¡æ•°
2497   1        p1++;
2498   1      
2499   1        *p1 = anData[56]; // å¤ªé˜³ç”µæ± é˜µ2ç”µå‹ - L  W47
2500   1        sum = sum + *p1;
2501   1        p1++;
2502   1        *p1 = anData[52] >> 8; // å¤ªé˜³ç”µæ± é˜µ3ç”µå‹ - H  W48
2503   1        sum = sum + *p1;
2504   1        p1++;
2505   1        *p1 = anData[52]; // å¤ªé˜³ç”µæ± é˜µ3ç”µå‹ - L  W49
2506   1        sum = sum + *p1;
2507   1        p1++;
2508   1        *p1 = anData[64] >> 8; // å¤ªé˜³ç”µæ± é˜µ4ç”µå‹ - H  W50
2509   1        sum = sum + *p1;
2510   1        p1++;
2511   1        *p1 = anData[64]; // å¤ªé˜³ç”µæ± é˜µ4ç”µå‹ - L  W51
2512   1        sum = sum + *p1;
2513   1        p1++;
2514   1        *p1 = anData[61] >> 8; // å¤ªé˜³ç”µæ± é˜µ5ç”µå‹ - H  W52
2515   1        sum = sum + *p1;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 42  

2516   1        p1++;
2517   1        *p1 = anData[61]; // å¤ªé˜³ç”µæ± é˜µ5ç”µå‹ - L  W53
2518   1        sum = sum + *p1;
2519   1        p1++;
2520   1      
2521   1        //----------------------RSåŒ…ç»„å¸§--9 -----------------------------------------------------------//
2522   1        *p1 = 0x9B; // ç¬¬9å¸§
2523   1        p1++;
2524   1        *p1 = 0x68;
2525   1        p1++;
2526   1        *p1 = 0x08; // å¸§è®¡æ•°
2527   1        p1++;
2528   1      
2529   1        *p1 = anData[57] >> 8; // å¤ªé˜³ç”µæ± é˜µ6ç”µå‹ - H  W54
2530   1        sum = sum + *p1;
2531   1        p1++;
2532   1        *p1 = anData[57]; // å¤ªé˜³ç”µæ± é˜µ6ç”µå‹ - L  W55
2533   1        sum = sum + *p1;
2534   1        p1++;
2535   1        *p1 = anData[53] >> 8; // å¤ªé˜³ç”µæ± é˜µ7ç”µå‹ - H  W56
2536   1        sum = sum + *p1;
2537   1        p1++;
2538   1        *p1 = anData[53]; // å¤ªé˜³ç”µæ± é˜µ7ç”µå‹ - L  W57
2539   1        sum = sum + *p1;
2540   1        p1++;
2541   1        *p1 = anData[65] >> 8; // å¤ªé˜³ç”µæ± é˜µ8ç”µå‹ - H  W58
2542   1        sum = sum + *p1;
2543   1        p1++;
2544   1        *p1 = anData[65]; // å¤ªé˜³ç”µæ± é˜µ8ç”µå‹ - L  W59
2545   1        sum = sum + *p1;
2546   1        p1++;
2547   1        *p1 = anData[62] >> 8; // å¤ªé˜³ç”µæ± é˜µ9ç”µå‹ - H  W60
2548   1        sum = sum + *p1;
2549   1        p1++;
2550   1      
2551   1        //----------------------RSåŒ…ç»„å¸§--10 -----------------------------------------------------------//
2552   1        *p1 = 0x9B; // ç¬¬10å¸§
2553   1        p1++;
2554   1        *p1 = 0x68;
2555   1        p1++;
2556   1        *p1 = 0x09; // å¸§è®¡æ•°
2557   1        p1++;
2558   1      
2559   1        *p1 = anData[62]; // å¤ªé˜³ç”µæ± é˜µ9ç”µå‹ - L  W61
2560   1        sum = sum + *p1;
2561   1        p1++;
2562   1        *p1 = anData[58] >> 8; // å¤ªé˜³ç”µæ± é˜µ10ç”µå‹ - H  W62
2563   1        sum = sum + *p1;
2564   1        p1++;
2565   1        *p1 = anData[58]; // å¤ªé˜³ç”µæ± é˜µ10ç”µå‹ - L  W63
2566   1        sum = sum + *p1;
2567   1        p1++;
2568   1        *p1 = anData[54] >> 8; // å¤ªé˜³ç”µæ± é˜µ11ç”µå‹ - H  W64
2569   1        sum = sum + *p1;
2570   1        p1++;
2571   1        *p1 = anData[54]; // å¤ªé˜³ç”µæ± é˜µ11ç”µå‹ - L  W65
2572   1        sum = sum + *p1;
2573   1        p1++;
2574   1        *p1 = anData[66] >> 8; // å¤ªé˜³ç”µæ± é˜µ12ç”µå‹ - H  W66
2575   1        sum = sum + *p1;
2576   1        p1++;
2577   1        *p1 = anData[66]; // å¤ªé˜³ç”µæ± é˜µ12ç”µå‹ - L  W67
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 43  

2578   1        sum = sum + *p1;
2579   1        p1++;
2580   1      
2581   1        //----------------------RSåŒ…ç»„å¸§--11 -----------------------------------------------------------//
2582   1        *p1 = 0x9B; // ç¬¬11å¸§
2583   1        p1++;
2584   1        *p1 = 0x68;
2585   1        p1++;
2586   1        *p1 = 0x0A; // å¸§è®¡æ•°
2587   1        p1++;
2588   1      
2589   1        *p1 = anData[63] >> 8; // å¤ªé˜³ç”µæ± é˜µ13ç”µå‹ - H  W68
2590   1        sum = sum + *p1;
2591   1        p1++;
2592   1        *p1 = anData[63]; // å¤ªé˜³ç”µæ± é˜µ13ç”µå‹ - L  W69
2593   1        sum = sum + *p1;
2594   1        p1++;
2595   1        *p1 = anData[59] >> 8; // å¤ªé˜³ç”µæ± é˜µ14ç”µå‹ - H  W70
2596   1        sum = sum + *p1;
2597   1        p1++;
2598   1        *p1 = anData[59]; // å¤ªé˜³ç”µæ± é˜µ14ç”µå‹ - L  W71
2599   1        sum = sum + *p1;
2600   1        p1++;
2601   1        *p1 = anData[55] >> 8; // å¤ªé˜³ç”µæ± é˜µ15ç”µå‹ - H  W72
2602   1        sum = sum + *p1;
2603   1        p1++;
2604   1        *p1 = anData[55]; // å¤ªé˜³ç”µæ± é˜µ15ç”µå‹ - L  W73
2605   1        sum = sum + *p1;
2606   1        p1++;
2607   1        *p1 = anData[67] >> 8; // å¤ªé˜³ç”µæ± é˜µ16ç”µå‹ - H  W74
2608   1        sum = sum + *p1;
2609   1        p1++;
2610   1      
2611   1        //----------------------RSåŒ…ç»„å¸§--12 -----------------------------------------------------------//
2612   1        *p1 = 0x9B; // ç¬¬12å¸§
2613   1        p1++;
2614   1        *p1 = 0x68;
2615   1        p1++;
2616   1        *p1 = 0x0B; // å¸§è®¡æ•°
2617   1        p1++;
2618   1      
2619   1        *p1 = anData[67]; // å¤ªé˜³ç”µæ± é˜µ16ç”µå‹ - L  W75 - W81
2620   1        sum = sum + *p1;
2621   1        p1++;
2622   1        *p1 = anData[79] >> 8; // åˆ†æµæ¨¡å—æ¸©åº¦1 - H
2623   1        sum = sum + *p1;
2624   1        p1++;
2625   1        *p1 = anData[79]; // åˆ†æµæ¨¡å—æ¸©åº¦1 - L
2626   1        sum = sum + *p1;
2627   1        p1++;
2628   1        *p1 = anData[80] >> 8; // åˆ†æµæ¨¡å—æ¸©åº¦2 - H
2629   1        sum = sum + *p1;
2630   1        p1++;
2631   1        *p1 = anData[80]; // åˆ†æµæ¨¡å—æ¸©åº¦2 - L
2632   1        sum = sum + *p1;
2633   1        p1++;
2634   1        *p1 = anData[24] >> 8; // æ”¾ç”µæ¨¡å—æ¸©åº¦1 - H
2635   1        sum = sum + *p1;
2636   1        p1++;
2637   1        *p1 = anData[24]; // æ”¾ç”µæ¨¡å—æ¸©åº¦1 - L
2638   1        sum = sum + *p1;
2639   1        p1++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 44  

2640   1      
2641   1        //----------------------RSåŒ…ç»„å¸§--13 ----------------------//
2642   1        *p1 = 0x9B; // ç¬¬13å¸§
2643   1        p1++;
2644   1        *p1 = 0x68;
2645   1        p1++;
2646   1        *p1 = 0x0C; // å¸§è®¡æ•°
2647   1        p1++;
2648   1      
2649   1        *p1 = anData[26] >> 8; // æ”¾ç”µæ¨¡å—æ¸©åº¦2 - H  W82 - W88
2650   1        sum = sum + *p1;
2651   1        p1++;
2652   1        *p1 = anData[26]; // æ”¾ç”µæ¨¡å—æ¸©åº¦2 - L
2653   1        sum = sum + *p1;
2654   1        p1++;
2655   1      
2656   1        *p1 = powerSave[0]; // å½“å‰ç”µé‡-H  W84
2657   1        sum = sum + *p1;
2658   1        p1++;
2659   1        *p1 = powerSave[1]; // å½“å‰ç”µé‡-L  W85
2660   1        sum = sum + *p1;
2661   1        p1++;
2662   1        *p1 = powerSave[2]; // å……ç”µç”µé‡-H  W86
2663   1        sum = sum + *p1;
2664   1        p1++;
2665   1        *p1 = powerSave[3]; // å……ç”µç”µé‡-L  W87
2666   1        sum = sum + *p1;
2667   1        p1++;
2668   1        *p1 = powerSave[4]; // æ”¾ç”µç”µé‡-H  W88
2669   1        sum = sum + *p1;
2670   1        p1++;
2671   1      
2672   1        //----------------------RSåŒ…ç»„å¸§--14 -----------------------//
2673   1        *p1 = 0x9B; // ç¬¬14å¸§
2674   1        p1++;
2675   1        *p1 = 0x68;
2676   1        p1++;
2677   1        *p1 = 0x0D; // å¸§è®¡æ•°
2678   1        p1++;
2679   1      
2680   1        *p1 = powerSave[5]; // æ”¾ç”µç”µé‡-L  W89
2681   1        sum = sum + *p1;
2682   1        p1++;
2683   1        *p1 = aq[0] >> 8; //  å•ä½“ç”µå‹1 - H W90
2684   1        sum = sum + *p1;
2685   1        p1++;
2686   1        *p1 = aq[0]; //  å•ä½“ç”µå‹1 - L W91
2687   1        sum = sum + *p1;
2688   1        p1++;
2689   1        *p1 = aq[1] >> 8; //  å•ä½“ç”µå‹2 - H W92
2690   1        sum = sum + *p1;
2691   1        p1++;
2692   1        *p1 = aq[1]; //  å•ä½“ç”µå‹2 - L W93
2693   1        sum = sum + *p1;
2694   1        p1++;
2695   1        *p1 = aq[2] >> 8; // å•ä½“ç”µå‹3 - H W94
2696   1        sum = sum + *p1;
2697   1        p1++;
2698   1        *p1 = aq[2]; // å•ä½“ç”µå‹3 - L W95
2699   1        sum = sum + *p1;
2700   1        p1++;
2701   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 45  

2702   1        //----------------------RSåŒ…ç»„å¸§--15  ---------------------//
2703   1        *p1 = 0x9B; // ç¬¬15å¸§
2704   1        p1++;
2705   1        *p1 = 0x68;
2706   1        p1++;
2707   1        *p1 = 0x0E; // Ö¡å¸§è®¡æ•°
2708   1        p1++;
2709   1      
2710   1        *p1 = aq[3] >> 8; //  å•ä½“ç”µå‹4 - H   W96
2711   1        sum = sum + *p1;
2712   1        p1++;
2713   1        *p1 = aq[3]; //  å•ä½“ç”µå‹4 - L   W97
2714   1        sum = sum + *p1;
2715   1        p1++;
2716   1        *p1 = aq[4] >> 8; //  å•ä½“ç”µå‹5 - H   W98
2717   1        sum = sum + *p1;
2718   1        p1++;
2719   1        *p1 = aq[4]; //  å•ä½“ç”µå‹5 - L   W99
2720   1        sum = sum + *p1;
2721   1        p1++;
2722   1        *p1 = aq[5] >> 8; //  å•ä½“ç”µå‹6 - H    W100
2723   1        sum = sum + *p1;
2724   1        p1++;
2725   1        *p1 = aq[5]; //  å•ä½“ç”µå‹6 - L    W101
2726   1        sum = sum + *p1;
2727   1        p1++;
2728   1        *p1 = aq[6] >> 8; //   å•ä½“ç”µå‹7 - H   W102
2729   1        sum = sum + *p1;
2730   1        p1++;
2731   1      
2732   1        //----------------------RSåŒ…ç»„å¸§--16 ----------------//
2733   1        *p1 = 0x9B; // ç¬¬16å¸§
2734   1        p1++;
2735   1        *p1 = 0x68;
2736   1        p1++;
2737   1        *p1 = 0x0F; // å¸§è®¡æ•°
2738   1        p1++;
2739   1      
2740   1        *p1 = aq[6]; //   å•ä½“ç”µå‹7 - L   W103
2741   1        sum = sum + *p1;
2742   1        p1++;
2743   1        *p1 = aq[7] >> 8; //  å•ä½“ç”µå‹8 - H  W104
2744   1        sum = sum + *p1;
2745   1        p1++;
2746   1        *p1 = aq[7]; //  å•ä½“ç”µå‹8 - L   W105
2747   1        sum = sum + *p1;
2748   1        p1++;
2749   1        *p1 = aq[8] >> 8; //  å•ä½“ç”µå‹9 - H   W106
2750   1        sum = sum + *p1;
2751   1        p1++;
2752   1        *p1 = aq[8]; //  å•ä½“ç”µå‹9 - L    W107
2753   1        sum = sum + *p1;
2754   1        p1++;
2755   1        *p1 = equState1; // å‡è¡¡çŠ¶æ€1    W108
2756   1        sum = sum + *p1;
2757   1        p1++;
2758   1        *p1 = equState2; // å‡è¡¡çŠ¶æ€2     W109
2759   1        sum = sum + *p1;
2760   1        p1++;
2761   1        //----------------------RSåŒ…ç»„å¸§--17 ----------------//
2762   1        *p1 = 0x9B; // ç¬¬17å¸§
2763   1        p1++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 46  

2764   1        *p1 = 0x62;
2765   1        p1++;
2766   1        *p1 = 0x10; // å¸§è®¡æ•°
2767   1        p1++;
2768   1      
2769   1        *p1 = sum; // SUM
2770   1      
2771   1        if (fgSwitch2 == TRUE) // ç»„å¹€åˆ‡æ¢æ ‡å¿—
2772   1        {
2773   2          fgSwitch2 = FALSE; // åˆ‡æ¢æ ‡å¿—
2774   2        }
2775   1        else
2776   1        {
2777   2          fgSwitch2 = TRUE; // åˆ‡æ¢æ ‡å¿—
2778   2        }
2779   1      }
2780          
2781          //*****************************************************************
2782          // å‡½æ•°åç§° : SaveDataRs3
2783          // åŠŸèƒ½æè¿° :
2784          // *****************************************************************
2785          void SaveDataRs3(void) // ç»„å¸§å‡½æ•°--åŒ…3
2786          {
2787   1        unsigned char i; // ä¸´æ—¶å˜é‡
2788   1        unsigned char j;
2789   1      
2790   1        unsigned char *p1; // è¿‡æ»¤åŒ…å‘é€ç¼“å†²åŒº
2791   1        unsigned char *p2; // è¿‡æ»¤åŒ…æ•°æ®ç¼“å†²åŒº
2792   1        unsigned char sum; // ç´¯åŠ å’Œ
2793   1      
2794   1        //----------------------CANé¥æµ‹ç»„å¸§---------------------------------------------------------------//
2795   1        p1 = &rsFrame3[0];    // æŒ‡å‘ç¼“å­˜åŒº
2796   1        p2 = &filterFrame[0]; // æŒ‡å‘ç¼“å­˜åŒº
2797   1      
2798   1        sum = 0;
2799   1      
2800   1        //----------------------RSåŒ…ç»„å¸§--1 -----------------------------------------------------------//
2801   1        *p1 = 0x9B; // ç¬¬1å¸§
2802   1        p1++;
2803   1        *p1 = 0x68;
2804   1        p1++;
2805   1        *p1 = 0x00; // å¸§è®¡æ•°
2806   1        p1++;
2807   1        *p1 = 0x29; // é•¿åº¦
2808   1        p1++;
2809   1        *p1 = 0x70; // title
2810   1        sum = sum + *p1;
2811   1        p1++;
2812   1      
2813   1        for (i = 0; i < 5; i++)
2814   1        {
2815   2          *p1 = *p2; // title
2816   2          sum = sum + *p1;
2817   2          p1++;
2818   2          p2++;
2819   2        }
2820   1      
2821   1        //----------------------RSåŒ…ç»„å¸§--ä¸­é—´å¸§ ----------------------------------------------------------
             --//
2822   1        for (j = 0; j < 5; j++) // W5 - W39
2823   1        {
2824   2          *p1 = 0x9B; // ç¬¬Nå¸§
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 47  

2825   2          p1++;
2826   2          *p1 = 0x68;
2827   2          p1++;
2828   2          *p1 = j + 1; // å¸§è®¡æ•°
2829   2          p1++;
2830   2      
2831   2          for (i = 0; i < 7; i++)
2832   2          {
2833   3            *p1 = *p2;
2834   3            sum = sum + *p1;
2835   3            p1++;
2836   3            p2++;
2837   3          }
2838   2        }
2839   1      
2840   1        //----------------------RSåŒ…ç»„å¸§--ç»“æŸå¸§ ----------------------------------------------------------
             --//
2841   1        *p1 = 0x9B; // ç¬¬Nå¸§
2842   1        p1++;
2843   1        *p1 = 0x63;
2844   1        p1++;
2845   1        *p1 = 0x06; // å¸§è®¡æ•°
2846   1        p1++;
2847   1      
2848   1        *p1 = *p2; // W40
2849   1        sum = sum + *p1;
2850   1        p1++;
2851   1        p2++;
2852   1      
2853   1        *p1 = sum;
2854   1      }
2855          
2856          //*****************************************************************
2857          // å‡½æ•°åç§° : SaveRamDataRs
2858          // åŠŸèƒ½æè¿° :
2859          // *****************************************************************
2860          void SaveRamDataRs(void) // ç»„å¸§å‡½æ•°--RAM
2861          {
2862   1        unsigned char i; // å˜é‡
2863   1        unsigned char j; // å˜é‡
2864   1      
2865   1        unsigned char *p1;     // RS
2866   1        unsigned char sum;     // ç´¯åŠ å’Œ
2867   1        unsigned int ramAddress; // å†…å­˜åœ°å€
2868   1      
2869   1        if (fgRsRam == TRUE) // ä¸‹ä¼ åœ°å€è®¾ç½®æœ‰æ•ˆ
2870   1        {
2871   2          fgRsRam = FALSE;
2872   2      
2873   2          ramAddress = ramUploadData[4] * 256 + ramUploadData[5]; // è®¾ç½®å†…å­˜åœ°å€
2874   2      
2875   2          //----------------------CANé¥æµ‹ç»„å¸§-----------------------------------------------//
2876   2          p1 = &rsRamFrame[0]; // æŒ‡å‘RSç¼“å­˜åŒºRAM
2877   2      
2878   2          sum = 0;
2879   2          //================================================================================//
2880   2      
2881   2          //----------------------RSåŒ…ç»„å¸§--1 -----------------------------------------------//
2882   2          *p1 = 0x9B; // ç¬¬1å¸§
2883   2          p1++;
2884   2          *p1 = 0x68;
2885   2          p1++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 48  

2886   2          *p1 = 0x00; // å¸§è®¡æ•°
2887   2          p1++;
2888   2          *p1 = 0x80; // é•¿åº¦ 128å­—èŠ‚
2889   2          p1++;
2890   2          *p1 = 0x90; // title
2891   2          sum = sum + *p1;
2892   2          p1++;
2893   2      
2894   2          for (i = 0; i < 5; i++) // å†…å­˜åœ°å€1-5
2895   2          {
2896   3            *p1 = ramUploadData[i];
2897   3            sum = sum + *p1;
2898   3            p1++;
2899   3          }
2900   2      
2901   2          //----------------------RSåŒ…ç»„å¸§--ç¬¬1å¸§ -----------------------------//
2902   2          *p1 = 0x9B; // ç¬¬Nå¸§
2903   2          p1++;
2904   2          *p1 = 0x68;
2905   2          p1++;
2906   2          *p1 = 1; // å¸§è®¡æ•°
2907   2          p1++;
2908   2      
2909   2          for (i = 0; i < 3; i++) // å†…å­˜åœ°å€5-8
2910   2          {
2911   3            *p1 = ramUploadData[5 + i];
2912   3            sum = sum + *p1;
2913   3            p1++;
2914   3          }
2915   2      
2916   2          for (i = 0; i < 4; i++)
2917   2          {
2918   3            *p1 = XBYTE[ramAddress];
2919   3            sum = sum + *p1;
2920   3            p1++;
2921   3            ramAddress++;
2922   3          }
2923   2      
2924   2          //----------------------RSåŒ…ç»„å¸§--ä¸­é—´å¸§ -----------------------------//
2925   2          for (j = 0; j < 16; j++)
2926   2          {
2927   3            *p1 = 0x9B; // ç¬¬Nå¸§
2928   3            p1++;
2929   3            *p1 = 0x68;
2930   3            p1++;
2931   3            *p1 = j + 2; // å¸§è®¡æ•°
2932   3            p1++;
2933   3      
2934   3            for (i = 0; i < 7; i++)
2935   3            {
2936   4              *p1 = XBYTE[ramAddress];
2937   4              sum = sum + *p1;
2938   4              p1++;
2939   4              ramAddress++;
2940   4            }
2941   3          }
2942   2      
2943   2          //----------------------RSåŒ…ç»„å¸§--ç»“æŸå¸§ ---------------------------------------------------------
             ---//
2944   2          *p1 = 0x9B; // ç¬¬Nå¸§
2945   2          p1++;
2946   2          *p1 = 0x66;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 49  

2947   2          p1++;
2948   2          *p1 = 0x12; // å¸§è®¡æ•°
2949   2          p1++;
2950   2      
2951   2          for (i = 0; i < 4; i++)
2952   2          {
2953   3            *p1 = XBYTE[ramAddress];
2954   3            sum = sum + *p1;
2955   3            p1++;
2956   3            ramAddress++;
2957   3          }
2958   2      
2959   2          *p1 = sum;
2960   2        }
2961   1      }
2962          
2963          //*****************************************************************
2964          // å‡½æ•°åç§° : SaveImportantDataRs
2965          // åŠŸèƒ½æè¿° :
2966          // *****************************************************************
2967          void SaveImportantDataRs(void) // ç»„å¸§å‡½æ•°--é‡è¦æ•°æ®
2968          {
2969   1        unsigned char i; // å˜é‡
2970   1        unsigned char j; // å˜é‡
2971   1      
2972   1        unsigned char *p1; // RS
2973   1        unsigned char *p2; // data
2974   1        unsigned char sum; // ç´¯åŠ å’Œ
2975   1      
2976   1        //----------------------CANé¥æµ‹ç»„å¸§---------------------------------------------------------------//
2977   1        p1 = &rsImportantFrame[0]; // æŒ‡å‘RSç¼“å­˜åŒºRAM
2978   1        p2 = &rsImportantData[0];  // æŒ‡å‘é‡è¦æ•°æ®ç¼“å­˜
2979   1      
2980   1        sum = 0;
2981   1        //=============================================================================================//
2982   1      
2983   1        //----------------------RSåŒ…ç»„å¸§--1 -----------------------------------------------------------//
2984   1        *p1 = 0x9B; // ç¬¬1å¸§
2985   1        p1++;
2986   1        *p1 = 0x68;
2987   1        p1++;
2988   1        *p1 = 0x00; // å¸§è®¡æ•°
2989   1        p1++;
2990   1        *p1 = 0xDC; // é•¿åº¦ 220å­—èŠ‚
2991   1        p1++;
2992   1        *p1 = 0xD0; // title
2993   1        sum = sum + *p1;
2994   1        p1++;
2995   1      
2996   1        for (i = 0; i < 5; i++)
2997   1        {
2998   2          *p1 = *p2;
2999   2          sum = sum + *p1;
3000   2          p1++;
3001   2          p2++;
3002   2        }
3003   1      
3004   1        //----------------------RSåŒ…ç»„å¸§--ä¸­é—´å¸§ ----------------------------------------------------------
             --//
3005   1        for (j = 0; j < 30; j++)
3006   1        {
3007   2          *p1 = 0x9B; // ç¬¬Nå¸§
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 50  

3008   2          p1++;
3009   2          *p1 = 0x68;
3010   2          p1++;
3011   2          *p1 = j + 1; // å¸§è®¡æ•°
3012   2          p1++;
3013   2      
3014   2          for (i = 0; i < 7; i++)
3015   2          {
3016   3            *p1 = *p2;
3017   3            sum = sum + *p1;
3018   3            p1++;
3019   3            p2++;
3020   3          }
3021   2        }
3022   1      
3023   1        //----------------------RSåŒ…ç»„å¸§--ç»“æŸå¸§ ----------------------------------------------------------
             --//
3024   1        *p1 = 0x9B; // ç¬¬Nå¸§
3025   1        p1++;
3026   1        *p1 = 0x67;
3027   1        p1++;
3028   1        *p1 = 0x1F; // å¸§è®¡æ•°
3029   1        p1++;
3030   1      
3031   1        for (i = 0; i < 5; i++)
3032   1        {
3033   2          *p1 = *p2;
3034   2          sum = sum + *p1;
3035   2          p1++;
3036   2          p2++;
3037   2        }
3038   1      
3039   1        *p1 = sum;
3040   1      }
3041          
3042          /***************************************************************************************/
3043          /*  å‡½æ•°åç§°:  HealthCheck                                                             */
3044          /*  åŠŸèƒ½æè¿°:  å¥åº·ç›‘æµ‹                                                                 */
3045          /*  ä¿®æ”¹è®°å½•:                                                                           */
3046          /***************************************************************************************/
3047          void SelfHealthCheck(void)
3048          {
3049   1        unsigned char result;
3050   1      
3051   1        selfCheckStateWord = 0; // è‡ªæ£€çŠ¶æ€å­—æ¸…é›¶
3052   1      
3053   1        result = RamCheck();  // RAMè‡ªæ£€
3054   1        if (RamCheck == TRUE) // å¼‚å¸¸æ—¶
3055   1        {
3056   2          selfCheckStateWord = (selfCheckStateWord | 0x01); // è®¾ç½®bit0 - 1
3057   2        }
3058   1        else
3059   1        {
3060   2          selfCheckStateWord = (selfCheckStateWord & 0xFE); // è®¾ç½®bit0 - 0
3061   2        }
3062   1      
3063   1        PowerSupplyCheck();   // ä¾›ç”µè‡ªæ£€
3064   1        if (fgCheck8 == TRUE) // å¼‚å¸¸æ—¶
3065   1        {
3066   2          selfCheckStateWord = (selfCheckStateWord | 0x02); // è®¾ç½®bit1 - 1
3067   2        }
3068   1        else
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 51  

3069   1        {
3070   2          selfCheckStateWord = (selfCheckStateWord & 0xFD); // è®¾ç½®bit1 - 0
3071   2        }
3072   1      
3073   1        selfCheckStateWord = selfCheckStateContrl & selfCheckStateWord; // æ§åˆ¶å­—1ç›¸å…³
3074   1      }
3075          
3076          /***************************************************************************************/
3077          /*  å‡½æ•°åç§°:  HealthCheck                                                             */
3078          /*  åŠŸèƒ½æè¿°:  å¥åº·ç›‘æµ‹                                                                 */
3079          /*  ä¿®æ”¹è®°å½•:                                                                           */
3080          /***************************************************************************************/
3081          void HealthCheck(void)
3082          {
3083   1        GenVolOverCheck();    // æ¯çº¿è¿‡å‹åˆ¤æ–­
3084   1        GenVolUnderCheck();   // æ¯çº¿æ¬ å‹åˆ¤æ–­
3085   1        AhVolOverCheck();   // è“„ç”µæ± ç»„ç”µå‹è¿‡å‹
3086   1        AhVolUnderCheck();    // è“„ç”µæ± ç»„ç”µå‹æ¬ å‹
3087   1        EquVRefCheck();     // å‡è¡¡åŸºå‡†åˆ¤æ–­
3088   1        EquWorkCheck();     // å‡è¡¡å·¥ä½œè‡ªæ£€
3089   1        SepCurrentShortCheck(); // åˆ†æµç®¡çŸ­è·¯
3090   1        AqVolCheck();     // å•ä½“ç”µå‹è‡ªæ£€
3091   1      
3092   1        AhVolOverCheck();
3093   1      
3094   1        HealthStateWordBuild(); // å¥åº·å­—çŠ¶æ€å­—ç»„å¸§
3095   1      }
3096          
3097          /***************************************************************************************/
3098          /*  å‡½æ•°åç§°:  GenVolOverCheck                                                         */
3099          /*  åŠŸèƒ½æè¿°:  å¥åº·å­—ç»„å¸§                                                           */
3100          /*  ä¿®æ”¹è®°å½•:                                                                          */
3101          /***************************************************************************************/
3102          void HealthStateWordBuild(void)
3103          {
3104   1        healthStateWord1 = 0; // å¥åº·å­—1 æ¸…é›¶
3105   1        if (fgCheck1 == TRUE) // bit15 ç”µæºæ¯çº¿è¿‡å‹
3106   1        {
3107   2          healthStateWord1 = healthStateWord1 | 0x8000;
3108   2        }
3109   1        if (fgCheck2 == TRUE) // bit14 ç”µæºæ¯çº¿æ¬ å‹
3110   1        {
3111   2          healthStateWord1 = healthStateWord1 | 0x4000;
3112   2        }
3113   1        if (fgCheck3 == TRUE) // bit13 è“„ç”µæ± ç»„ç”µå‹è¿‡å‹
3114   1        {
3115   2          healthStateWord1 = healthStateWord1 | 0x2000;
3116   2        }
3117   1        if (fgCheck4 == TRUE) // bit12 è“„ç”µæ± ç»„ç”µå‹æ¬ å‹
3118   1        {
3119   2          healthStateWord1 = healthStateWord1 | 0x1000;
3120   2        }
3121   1        if (fgCheck5 == TRUE) // bit11 å‡è¡¡å™¨åŸºå‡†æ•…éšœ
3122   1        {
3123   2          healthStateWord1 = healthStateWord1 | 0x0800;
3124   2        }
3125   1        if (fgCheck6 == TRUE) // bit10 å‡è¡¡å™¨å·¥ä½œæ•…éšœ
3126   1        {
3127   2          healthStateWord1 = healthStateWord1 | 0x0400;
3128   2        }
3129   1        if (fgCheck7 == TRUE) // bit9 åˆ†æµç®¡çŸ­è·¯æ•…éšœ
3130   1        {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 52  

3131   2          healthStateWord1 = healthStateWord1 | 0x0200;
3132   2        }
3133   1        if (fgOverChargeShort == TRUE) // bit8 å……ç”µç®¡çŸ­è·¯æ•…éšœ
3134   1        {
3135   2          healthStateWord1 = healthStateWord1 | 0x0100;
3136   2        }
3137   1        if (fgOverChargeprotect == TRUE) // bit7 å……ç”µæ•…éšœ
3138   1        {
3139   2          healthStateWord1 = healthStateWord1 | 0x0080;
3140   2        }
3141   1      
3142   1        healthStateWord1 = healthStateWord1 | (unsigned int)((overChargeProCount & 0x03) << 5);     // bit6-5 è“„ç
             -”µæ± ç»„è¿‡å……ä¿æŠ¤è®°å½•
3143   1        healthStateWord1 = healthStateWord1 | (unsigned int)((singleProtectChargeCount & 0x03) << 3); // bit4-3 å
             -•ä½“è¿‡å……ä¿æŠ¤è®°å½•
3144   1      
3145   1        if (fgAqCheckA[0] == TRUE) // bit1 å•ä½“1æ¬ å‹
3146   1        {
3147   2          healthStateWord1 = healthStateWord1 | 0x0002;
3148   2        }
3149   1        if (fgAqCheckA[1] == TRUE) // bit0 å•ä½“2æ¬ å‹
3150   1        {
3151   2          healthStateWord1 = healthStateWord1 | 0x0001;
3152   2        }
3153   1      
3154   1        healthStateWord2 = 0;    // å¥åº·å­—2 æ¸…é›¶
3155   1        if (fgAqCheckA[2] == TRUE) // bit15 å•ä½“3æ¬ å‹
3156   1        {
3157   2          healthStateWord2 = healthStateWord2 | 0x8000;
3158   2        }
3159   1        if (fgAqCheckA[3] == TRUE) // bit14 å•ä½“4æ¬ å‹
3160   1        {
3161   2          healthStateWord2 = healthStateWord2 | 0x4000;
3162   2        }
3163   1        if (fgAqCheckA[4] == TRUE) // bit13 å•ä½“5æ¬ å‹
3164   1        {
3165   2          healthStateWord2 = healthStateWord2 | 0x2000;
3166   2        }
3167   1        if (fgAqCheckA[5] == TRUE) // bit12 å•ä½“6æ¬ å‹
3168   1        {
3169   2          healthStateWord2 = healthStateWord2 | 0x1000;
3170   2        }
3171   1        if (fgAqCheckA[6] == TRUE) // bit11 å•ä½“7æ¬ å‹
3172   1        {
3173   2          healthStateWord2 = healthStateWord2 | 0x0800;
3174   2        }
3175   1        if (fgAqCheckA[7] == TRUE) // bit10 å•ä½“8æ¬ å‹
3176   1        {
3177   2          healthStateWord2 = healthStateWord2 | 0x0400;
3178   2        }
3179   1        if (fgAqCheckA[8] == TRUE) // bit9 å•ä½“9æ¬ å‹
3180   1        {
3181   2          healthStateWord2 = healthStateWord2 | 0x0200;
3182   2        }
3183   1        if (fgAqCheckB[0] == TRUE) // bit8 å•ä½“1è¿‡å‹
3184   1        {
3185   2          healthStateWord2 = healthStateWord2 | 0x0100;
3186   2        }
3187   1        if (fgAqCheckB[1] == TRUE) // bit7 å•ä½“2è¿‡å‹
3188   1        {
3189   2          healthStateWord2 = healthStateWord2 | 0x0080;
3190   2        }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 53  

3191   1        if (fgAqCheckB[2] == TRUE) // bit6 å•ä½“3è¿‡å‹
3192   1        {
3193   2          healthStateWord2 = healthStateWord2 | 0x0040;
3194   2        }
3195   1        if (fgAqCheckB[3] == TRUE) // bit5 å•ä½“4è¿‡å‹
3196   1        {
3197   2          healthStateWord2 = healthStateWord2 | 0x0020;
3198   2        }
3199   1        if (fgAqCheckB[4] == TRUE) // bit4 å•ä½“5è¿‡å‹
3200   1        {
3201   2          healthStateWord2 = healthStateWord2 | 0x0010;
3202   2        }
3203   1        if (fgAqCheckB[5] == TRUE) // bit3 å•ä½“6è¿‡å‹
3204   1        {
3205   2          healthStateWord2 = healthStateWord2 | 0x0008;
3206   2        }
3207   1        if (fgAqCheckB[6] == TRUE) // bit2 å•ä½“7è¿‡å‹
3208   1        {
3209   2          healthStateWord2 = healthStateWord2 | 0x0004;
3210   2        }
3211   1        if (fgAqCheckB[7] == TRUE) // bit1 å•ä½“8è¿‡å‹
3212   1        {
3213   2          healthStateWord2 = healthStateWord2 | 0x0002;
3214   2        }
3215   1        if (fgAqCheckB[8] == TRUE) // bit0 å•ä½“9è¿‡å‹
3216   1        {
3217   2          healthStateWord2 = healthStateWord2 | 0x0001;
3218   2        }
3219   1      
3220   1        healthStateWord1 = healthStateWord1 & healthStateContr1; // æ§åˆ¶å­—1ç›¸å…³
3221   1        healthStateWord2 = healthStateWord2 & healthStateContr2; // æ§åˆ¶å­—2ç›¸å…³
3222   1      }
3223          
3224          /***************************************************************************************/
3225          /*  å‡½æ•°åç§°:  GenVolOverCheck                                                         */
3226          /*  åŠŸèƒ½æè¿°:  ç”µæºæ¯çº¿è¿‡å‹                                                            */
3227          /*  ä¿®æ”¹è®°å½•:                                                                          */
3228          /***************************************************************************************/
3229          void GenVolOverCheck(void)
3230          {
3231   1        if (generatrixVol > 42.0) // æ¯çº¿ç”µå‹å¤§äº42V
3232   1        {
3233   2          checkCount1++;     // è®¡æ•°å¢åŠ 
3234   2          if (checkCount1 > 4) // æŒç»­æ—¶é—´è¶…4S
3235   2          {
3236   3            fgCheck1 = TRUE; // è‡ªæ£€å¼‚å¸¸ è¿”å› TRUE - å¼‚å¸¸èŒƒå›´
3237   3          }
3238   2        }
3239   1        else
3240   1        {
3241   2          fgCheck1 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸ è¿”å› TRUE  ç¦æ­¢æ£€æµ‹ æ¢å¤çŠ¶æ€
3242   2          checkCount1 = 0;  // æ¸…é™¤è®¡æ•°
3243   2        }
3244   1      }
3245          
3246          /***************************************************************************************/
3247          /*  å‡½æ•°åç§°:  GenVolUnderCheck                                                        */
3248          /*  åŠŸèƒ½æè¿°:  ç”µæºæ¯çº¿æ¬ å‹                                                            */
3249          /*  ä¿®æ”¹è®°å½•:                                                                          */
3250          /***************************************************************************************/
3251          void GenVolUnderCheck(void)
3252          {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 54  

3253   1        if (generatrixVol < 38.0) // æ¯çº¿ç”µå‹å°äº38V
3254   1        {
3255   2          checkCount2++;     // è®¡æ•°å¢åŠ 
3256   2          if (checkCount2 > 4) // æŒç»­æ—¶é—´è¶…4S
3257   2          {
3258   3            fgCheck2 = TRUE; // è‡ªæ£€å¼‚å¸¸ è¿”å› TRUE - å¼‚å¸¸èŒƒå›´
3259   3          }
3260   2        }
3261   1        else
3262   1        {
3263   2          fgCheck2 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸ è¿”å› TRUE  ç¦æ­¢æ£€æµ‹ æ¢å¤çŠ¶æ€
3264   2          checkCount2 = 0;  // æ¸…é™¤è®¡æ•°
3265   2        }
3266   1      }
3267          
3268          /***************************************************************************************/
3269          /*  å‡½æ•°åç§°:  AhVolOverCheck                                                         */
3270          /*  åŠŸèƒ½æè¿°:  è“„ç”µæ± ç»„è¿‡å‹                                                           */
3271          /*  ä¿®æ”¹è®°å½•:                                                                          */
3272          /***************************************************************************************/
3273          void AhVolOverCheck(void)
3274          {
3275   1        if (accVAHardPyh > batteryVAWardValueUP) //  è“„ç”µæ± ç»„ç”µå‹ å¤§äº ä¸Šé™ä¿æŠ¤å€¼
3276   1        {
3277   2          checkCount3++;      // è®¡æ•°å¢åŠ 
3278   2          if (checkCount3 > 16) // æŒç»­æ—¶é—´è¶…16S
3279   2          {
3280   3            fgCheck3 = TRUE; // è‡ªæ£€å¼‚å¸¸
3281   3          }
3282   2        }
3283   1        else
3284   1        {
3285   2          fgCheck3 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸
3286   2          checkCount3 = 0;  // æ¸…é™¤è®¡æ•°
3287   2        }
3288   1      }
3289          
3290          /***************************************************************************************/
3291          /*  å‡½æ•°åç§°:  AhVolUnderCheck                                                         */
3292          /*  åŠŸèƒ½æè¿°:  è“„ç”µæ± ç»„æ¬ å‹                                                           */
3293          /*  ä¿®æ”¹è®°å½•:                                                                          */
3294          /***************************************************************************************/
3295          void AhVolUnderCheck(void)
3296          {
3297   1        if (accVAHardPyh < batteryVAWardValueDOWN) //  è“„ç”µæ± ç»„ç”µå‹ å¤§äº ä¸Šé™ä¿æŠ¤å€¼
3298   1        {
3299   2          checkCount4++;      // è®¡æ•°å¢åŠ 
3300   2          if (checkCount4 > 16) // æŒç»­æ—¶é—´è¶…16S
3301   2          {
3302   3            fgCheck4 = TRUE; // è‡ªæ£€å¼‚å¸¸
3303   3          }
3304   2        }
3305   1        else
3306   1        {
3307   2          fgCheck4 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸
3308   2          checkCount4 = 0;  // æ¸…é™¤è®¡æ•°
3309   2        }
3310   1      }
3311          
3312          /***************************************************************************************/
3313          /*  å‡½æ•°åç§°:  EquVRefCheck                                                         */
3314          /*  åŠŸèƒ½æè¿°:  å‡è¡¡å™¨åŸºå‡†è‡ªæ£€                                                           */
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 55  

3315          /*  ä¿®æ”¹è®°å½•:                                                                          */
3316          /***************************************************************************************/
3317          void EquVRefCheck(void)
3318          {
3319   1        if ((equVRefPhy < 4.9) || (equVRefPhy > 5.1)) // å‡è¡¡å™¨åŸºå‡†èƒ½å¦æ­£å¸¸å·¥ä½œ
3320   1        {
3321   2          checkCount5++;     // è®¡æ•°å¢åŠ 
3322   2          if (checkCount5 > 4) // æŒç»­æ—¶é—´è¶…4S
3323   2          {
3324   3            fgCheck5 = TRUE; // è‡ªæ£€å¼‚å¸¸
3325   3          }
3326   2        }
3327   1        else
3328   1        {
3329   2          fgCheck5 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸
3330   2          checkCount5 = 0;  // æ¸…é™¤è®¡æ•°
3331   2        }
3332   1      }
3333          
3334          /***************************************************************************************/
3335          /*  å‡½æ•°åç§°:  EquWorkCheck                                                         */
3336          /*  åŠŸèƒ½æè¿°:  å‡è¡¡å™¨å·¥ä½œè‡ªæ£€                                                           */
3337          /*  ä¿®æ”¹è®°å½•:                                                                          */
3338          /***************************************************************************************/
3339          void EquWorkCheck(void)
3340          {
3341   1        if ((aqPhyPx[4] > 4.5) || (aqPhyPx[4] < 3)) // å‡è¡¡å™¨ç”µå‹ç›‘æµ‹4èŠ‚ä»¥ä¸Š
3342   1        {
3343   2          checkCount6++;     // è®¡æ•°å¢åŠ 
3344   2          if (checkCount6 > 4) // æŒç»­æ—¶é—´è¶…4S
3345   2          {
3346   3            fgCheck6 = TRUE; // è‡ªæ£€å¼‚å¸¸
3347   3          }
3348   2        }
3349   1        else
3350   1        {
3351   2          fgCheck6 = FALSE; // è‡ªæ£€æŒç»­å¼‚å¸¸
3352   2          checkCount6 = 0;  // æ¸…é™¤è®¡æ•°
3353   2        }
3354   1      }
3355          
3356          /***************************************************************************************/
3357          /*  å‡½æ•°åç§°:  SepCurrentShortCheck                                                    */
3358          /*  åŠŸèƒ½æè¿°:  åˆ†æµç®¡çŸ­è·¯                                                              */
3359          /*  ä¿®æ”¹è®°å½•:                                                                          */
3360          /***************************************************************************************/
3361          void SepCurrentShortCheck(void)
3362          {
3363   1        unsigned char i;
3364   1        float xdata min;
3365   1        float xdata sunWingVol[16]; /* å¤ªé˜³ç¿¼ç”µå‹        */
3366   1      
3367   1        sunWingVol[0] = (float)(((float)anData[60] * Ks1) + bs1);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹01      */
3368   1        sunWingVol[1] = (float)(((float)anData[56] * Ks2) + bs2);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹02      */
3369   1        sunWingVol[2] = (float)(((float)anData[52] * Ks3) + bs3);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹03      */
3370   1        sunWingVol[3] = (float)(((float)anData[64] * Ks4) + bs4);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹04    */
3371   1        sunWingVol[4] = (float)(((float)anData[61] * Ks5) + bs5);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹05    */
3372   1        sunWingVol[5] = (float)(((float)anData[57] * Ks6) + bs6);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹06      */
3373   1        sunWingVol[6] = (float)(((float)anData[53] * Ks7) + bs7);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹07      */
3374   1        sunWingVol[7] = (float)(((float)anData[65] * Ks8) + bs8);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹08      */
3375   1        sunWingVol[8] = (float)(((float)anData[62] * Ks9) + bs9);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹09      */
3376   1        sunWingVol[9] = (float)(((float)anData[58] * Ks10) + bs10);  /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹10      */
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 56  

3377   1        sunWingVol[10] = (float)(((float)anData[54] * Ks11) + bs11); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹11      */
3378   1        sunWingVol[11] = (float)(((float)anData[66] * Ks12) + bs12); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹12      */
3379   1        sunWingVol[12] = (float)(((float)anData[63] * Ks13) + bs13); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹13    */
3380   1        sunWingVol[13] = (float)(((float)anData[59] * Ks14) + bs14); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹14    */
3381   1        sunWingVol[14] = (float)(((float)anData[55] * Ks15) + bs15); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹15    */
3382   1        sunWingVol[15] = (float)(((float)anData[67] * Ks16) + bs16); /* å¤ªé˜³ç¿¼ç”µæ± ç»„ç”µå‹16      */
3383   1      
3384   1        min = sunWingVol[0];
3385   1        for (i = 1; i < 16; i++) /* æ’åº            */
3386   1        {
3387   2          if (min > sunWingVol[i]) /* å‚æ•°ä¼ é€’        */
3388   2          {
3389   3            min = sunWingVol[i];
3390   3          }
3391   2        }
3392   1      
3393   1        if ((limbCurrent > 60.0) && (meaV < 7.5) && (min < 5.0)) /* ä¸‰ä¸ªæ¡ä»¶åŒæ—¶æˆç«‹å››åˆ†é’Ÿ   */
3394   1        {
3395   2          checkCount7++;       /* è®¡æ•°å¢åŠ           */
3396   2          if (checkCount7 > 240) /* æŒç»­æ—¶é—´è¶…4min       */
3397   2          {
3398   3            fgCheck7 = TRUE; /* è‡ªæ£€å¼‚å¸¸ è¿”å› TRUE - å¼‚å¸¸èŒƒå›´  */
3399   3          }
3400   2        }
3401   1        else
3402   1        {
3403   2          fgCheck7 = FALSE; /* è‡ªæ£€æŒç»­å¼‚å¸¸ è¿”å› TRUE  ç¦æ­¢æ£€æµ‹ æ¢å¤çŠ¶æ€    */
3404   2          checkCount7 = 0;  /* æ¸…é™¤è®¡æ•°                     */
3405   2        }
3406   1      }
3407          
3408          /********************************************************************/
3409          /*  å‡½æ•°åç§°:  AqVolCheck                                        */
3410          /*  åŠŸèƒ½æè¿°:                                                        */
3411          /*  ä¿®æ”¹è®°å½•:                                                        */
3412          /*********************************************************************/
3413          void AqVolCheck(void)
3414          {
3415   1        unsigned char i;
3416   1      
3417   1        for (i = 0; i < 9; i++) // å•ä½“æ‰§è¡Œåˆ¤è¯»  æ¬ å‹
3418   1        {
3419   2          if (aqPhy[i] < singleVWardValueDOWN) // å•ä½“è¿‡å‹
3420   2          {
3421   3            checkCountAqA[i]++;      // å•ä½“è¿‡å‹è®¡æ•°
3422   3            if (checkCountAqA[i] > 16) // æŒç»­16s
3423   3            {
3424   4              fgAqCheckA[i] = TRUE; // è®¾ç½®å¼‚å¸¸
3425   4            }
3426   3          }
3427   2          else
3428   2          {
3429   3            checkCountAqA[i] = 0;  // å•ä½“æ¬ å‹è®¡æ•°æ¸…é›¶
3430   3            fgAqCheckA[i] = FALSE; // è®¾ç½®æ­£å¸¸
3431   3          }
3432   2        }
3433   1      
3434   1        for (i = 0; i < 9; i++) // å•ä½“æ‰§è¡Œåˆ¤è¯» è¿‡å‹
3435   1        {
3436   2          if (aqPhy[i] > singleVWardValueUP) // å•ä½“è¿‡å‹
3437   2          {
3438   3            checkCountAqB[i]++;      // å•ä½“è¿‡å‹è®¡æ•°
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 57  

3439   3            if (checkCountAqB[i] > 16) // æŒç»­16s
3440   3            {
3441   4              fgAqCheckB[i] = TRUE; // è®¾ç½®å¼‚å¸¸
3442   4            }
3443   3          }
3444   2          else
3445   2          {
3446   3            checkCountAqB[i] = 0;  // å•ä½“è¿‡å‹è®¡æ•°æ¸…é›¶
3447   3            fgAqCheckB[i] = FALSE; // è®¾ç½®æ­£å¸¸
3448   3          }
3449   2        }
3450   1      }
3451          
3452          //*****************************************************************
3453          // å‡½æ•°åç§° : SaveData
3454          // åŠŸèƒ½æè¿° :
3455          // *****************************************************************
3456          void SaveData(void) // ç»„å¸§å‡½æ•°
3457          {
3458   1        SaveDataRs1();   // ç»„å¸§1 - å¿«åŒ…
3459   1        SaveDataRs2();   // ç»„å¸§2 - æ…¢åŒ…
3460   1        SaveRamDataRs(); // RAMæ•°æ®åŒ…ç»„å¸§  ï¼ˆå½“è®¾ç½®å†…å­˜åœ°å€åæ›´æ–°ï¼‰
3461   1      }
3462          
3463          //*****************************************************************
3464          // å‡½æ•°åç§° : CanResume
3465          // åŠŸèƒ½æè¿° :
3466          // *****************************************************************
3467          void CanResume(void)
3468          {
3469   1        unsigned char aSR;
3470   1        unsigned char bSR;
3471   1        unsigned char aCR;
3472   1        unsigned char bCR;
3473   1      
3474   1        aCR = XBYTE[BUSA_ADDR]; // è¯»Aã€Bæ€»çº¿SJA1000æ§åˆ¶å­—
3475   1        bCR = XBYTE[BUSB_ADDR];
3476   1      
3477   1        aSR = XBYTE[BUSA_ADDR + 2]; // è¯»Aã€Bæ€»çº¿SJA1000çŠ¶æ€å­—
3478   1        bSR = XBYTE[BUSB_ADDR + 2];
3479   1      
3480   1        errorCount++; // æ¯ç§’æ‰§è¡Œè®¡æ•°ï¼Œç”±ä¸­æ–­è¿›è¡Œæ¸…é›¶
3481   1      
3482   1        if ((aSR & 0x02) != 0) // åˆ¤æ–­Aæ€»çº¿æ§åˆ¶å™¨æ•°æ®æº¢å‡º
3483   1        {
3484   2          EX0 = 0;      // å…³é—­ä¸­æ–­
3485   2          CANInit(BUSA_ADDR); // å¯¹Aæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3486   2          CANInfoA();
3487   2          EX0 = 1; // å¼€ä¸­æ–­
3488   2        }
3489   1      
3490   1        if ((bSR & 0x02) != 0) // åˆ¤æ–­Bæ€»çº¿æ§åˆ¶å™¨æ•°æ®æº¢å‡º
3491   1        {
3492   2          EX0 = 0;      // å…³é—­ä¸­æ–­
3493   2          CANInit(BUSB_ADDR); // å¯¹Bæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3494   2          CANInfoB();
3495   2          EX0 = 1; // å¼€ä¸­æ–­
3496   2        }
3497   1      
3498   1        if (((aSR & 0x80) == 0x80) || ((aCR & 0x02) == 0x00)) // åˆ¤æ–­Aæ€»çº¿æŒ‚èµ· æˆ– Aæ§åˆ¶å™¨æ¥æ”¶æ— æ•ˆ
3499   1        {
3500   2          errorCountA++; // Aæ€»çº¿è®¡æ•°+1
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 58  

3501   2      
3502   2          if (errorCountA > 15) // æŒç»­16ç§’
3503   2          {
3504   3            EX0 = 0;      // å…³é—­ä¸­æ–­
3505   3            CANInit(BUSA_ADDR); // å¯¹Aæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3506   3            CANInfoA();
3507   3            errorCountA = 0;
3508   3            EX0 = 1;
3509   3            EA = 1;
3510   3          }
3511   2        }
3512   1        else // æ¡ä»¶ä¸æ»¡è¶³æ—¶
3513   1        {
3514   2          errorCountA = 0;
3515   2        }
3516   1      
3517   1        if (((bSR & 0x80) == 0x80) || ((bCR & 0x02) == 0x00)) // åˆ¤æ–­Bæ€»çº¿æŒ‚èµ· æˆ– Bæ§åˆ¶å™¨æ¥æ”¶æ— æ•ˆ
3518   1        {
3519   2          errorCountB++; // Bæ€»çº¿è®¡æ•°+1
3520   2      
3521   2          if (errorCountB > 15) // æŒç»­16ç§’
3522   2          {
3523   3            EX0 = 0;      // å…³é—­ä¸­æ–­
3524   3            CANInit(BUSB_ADDR); // å¯¹Bæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3525   3            CANInfoB();
3526   3            errorCountB = 0;
3527   3            EX0 = 1;
3528   3            EA = 1;
3529   3          }
3530   2        }
3531   1        else // æ¡ä»¶ä¸æ»¡è¶³æ—¶
3532   1        {
3533   2          errorCountB = 0;
3534   2        }
3535   1      
3536   1        if (errorCount >= SILENT_TIME) // ä¸ç¬¦åˆåè®®æ—¶é—´è¶…é™
3537   1        {
3538   2          Delay(50);
3539   2          EX0 = 0;      // å…³é—­ä¸­æ–­
3540   2          CANInit(BUSA_ADDR); // å¯¹Aæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3541   2          CANInit(BUSB_ADDR); // å¯¹Bæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
3542   2          errorCount = 0;
3543   2          CANInfoA();
3544   2          CANInfoB();
3545   2          EX0 = 1; // å¢åŠ å¼€ä¸­æ–­æ“ä½œ
3546   2          EA = 1;
3547   2        }
3548   1      }
3549          
3550          //*****************************************************************
3551          // å‡½æ•°åç§° : ONOFFOutput
3552          // åŠŸèƒ½æè¿° :
3553          // *****************************************************************
3554          void ONOFFOutput(unsigned char index)
3555          {
3556   1        ONOFF_ADDR = onoffTab[index - 1]; // æŒ‡ä»¤è·¯åº
3557   1        onoffEn = 0;            // ä½¿èƒ½å…è®¸
3558   1        Delay(5600);            // å»¶æ—¶çº¦40ms
3559   1        Delay(5600);            // å»¶æ—¶çº¦40ms
3560   1        ONOFF_ADDR = 0xFF;          // åœ°å€æ— æ•ˆ
3561   1        onoffEn = 1;            // ä½¿èƒ½ç¦æ­¢
3562   1      }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 59  

3563          
3564          //*****************************************************************
3565          // å‡½æ•°åç§° : ONOFFHook
3566          // åŠŸèƒ½æè¿° :
3567          // *****************************************************************
3568          void ONOFFHook(void)
3569          {
3570   1        unsigned int i;
3571   1      
3572   1        if (rdOnoffIndex != wrOnoffIndex)
3573   1        {
3574   2          onoffReceCount++;  // æ¥æ”¶æŒ‡ä»¤è®¡æ•°++
3575   2          onoffReceCountB++; // æ¥æ”¶æŒ‡ä»¤è®¡æ•°B++
3576   2          onoffReceCountC++; // æ¥æ”¶æŒ‡ä»¤è®¡æ•°C++
3577   2      
3578   2          switch (onoffBuffer[rdOnoffIndex][0])
3579   2          {
3580   3          case 0x01: // BDRA1ä½¿èƒ½
3581   3            ONOFFOutput(33);
3582   3      
3583   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3584   3            onoffExeCountB++;
3585   3            onoffExeCountC++;
3586   3            break;
3587   3      
3588   3          case 0x02: // BDRA2ä½¿èƒ½
3589   3            ONOFFOutput(37);
3590   3      
3591   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3592   3            onoffExeCountB++;
3593   3            onoffExeCountC++;
3594   3            break;
3595   3      
3596   3          case 0x03: // BDRA3ä½¿èƒ½
3597   3            ONOFFOutput(41);
3598   3      
3599   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3600   3            onoffExeCountB++;
3601   3            onoffExeCountC++;
3602   3            break;
3603   3      
3604   3          case 0x04: // BDRA4ä½¿èƒ½
3605   3            ONOFFOutput(45);
3606   3      
3607   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3608   3            onoffExeCountB++;
3609   3            onoffExeCountC++;
3610   3            break;
3611   3      
3612   3          case 0x05: // BDRB1ä½¿èƒ½
3613   3            ONOFFOutput(35);
3614   3      
3615   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3616   3            onoffExeCountB++;
3617   3            onoffExeCountC++;
3618   3            break;
3619   3      
3620   3          case 0x06: // BDRB2ä½¿èƒ½
3621   3            ONOFFOutput(39);
3622   3      
3623   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3624   3            onoffExeCountB++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 60  

3625   3            onoffExeCountC++;
3626   3            break;
3627   3      
3628   3          case 0x07: // BDRB3ä½¿èƒ½
3629   3            ONOFFOutput(43);
3630   3      
3631   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3632   3            onoffExeCountB++;
3633   3            onoffExeCountC++;
3634   3            break;
3635   3      
3636   3          case 0x08: // BDRB4ä½¿èƒ½
3637   3            ONOFFOutput(47);
3638   3      
3639   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3640   3            onoffExeCountB++;
3641   3            onoffExeCountC++;
3642   3            break;
3643   3      
3644   3          case 0x09: // BDRA1ç¦æ­¢
3645   3            ONOFFOutput(34);
3646   3      
3647   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3648   3            onoffExeCountB++;
3649   3            onoffExeCountC++;
3650   3            break;
3651   3      
3652   3          case 0x0A: // BDRA2ç¦æ­¢
3653   3            ONOFFOutput(38);
3654   3      
3655   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3656   3            onoffExeCountB++;
3657   3            onoffExeCountC++;
3658   3            break;
3659   3      
3660   3          case 0x0B: // BDRA3ç¦æ­¢
3661   3            ONOFFOutput(42);
3662   3      
3663   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3664   3            onoffExeCountB++;
3665   3            onoffExeCountC++;
3666   3            break;
3667   3      
3668   3          case 0x0C: // BDRA4ç¦æ­¢
3669   3            ONOFFOutput(46);
3670   3      
3671   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3672   3            onoffExeCountB++;
3673   3            onoffExeCountC++;
3674   3            break;
3675   3      
3676   3          case 0x0D: // BDRB1ç¦æ­¢
3677   3            ONOFFOutput(36);
3678   3      
3679   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3680   3            onoffExeCountB++;
3681   3            onoffExeCountC++;
3682   3            break;
3683   3      
3684   3          case 0x0E: // BDRB2ç¦æ­¢
3685   3            ONOFFOutput(40);
3686   3      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 61  

3687   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3688   3            onoffExeCountB++;
3689   3            onoffExeCountC++;
3690   3            break;
3691   3      
3692   3          case 0x0F: // BDRB3ç¦æ­¢
3693   3            ONOFFOutput(44);
3694   3      
3695   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3696   3            onoffExeCountB++;
3697   3            onoffExeCountC++;
3698   3            break;
3699   3      
3700   3          case 0x10: // BDRB4ç¦æ­¢
3701   3            ONOFFOutput(48);
3702   3      
3703   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3704   3            onoffExeCountB++;
3705   3            onoffExeCountC++;
3706   3            break;
3707   3      
3708   3          case 0x11: // å……ç”µé˜µA1æ–­å¼€
3709   3            ONOFFOutput(5);
3710   3      
3711   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3712   3            onoffExeCountB++;
3713   3            onoffExeCountC++;
3714   3            break;
3715   3      
3716   3          case 0x12: // å……ç”µé˜µA2æ–­å¼€
3717   3            ONOFFOutput(14);
3718   3      
3719   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3720   3            onoffExeCountB++;
3721   3            onoffExeCountC++;
3722   3            break;
3723   3      
3724   3          case 0x13: // å……ç”µé˜µA3æ–­å¼€
3725   3            ONOFFOutput(6);
3726   3      
3727   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3728   3            onoffExeCountB++;
3729   3            onoffExeCountC++;
3730   3            break;
3731   3      
3732   3          case 0x14: // å……ç”µé˜µA4æ–­å¼€
3733   3            ONOFFOutput(15);
3734   3      
3735   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3736   3            onoffExeCountB++;
3737   3            onoffExeCountC++;
3738   3            break;
3739   3      
3740   3          case 0x15: // å……ç”µé˜µA5æ–­å¼€
3741   3            ONOFFOutput(7);
3742   3      
3743   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3744   3            onoffExeCountB++;
3745   3            onoffExeCountC++;
3746   3            break;
3747   3      
3748   3          case 0x16: // Aç»„å……ç”µé˜µæ¥é€š
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 62  

3749   3            ONOFFOutput(8);
3750   3      
3751   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3752   3            onoffExeCountB++;
3753   3            onoffExeCountC++;
3754   3            break;
3755   3      
3756   3          case 0x17: // å……ç”µé˜µB1æ–­å¼€
3757   3            ONOFFOutput(21);
3758   3      
3759   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3760   3            onoffExeCountB++;
3761   3            onoffExeCountC++;
3762   3            break;
3763   3      
3764   3          case 0x18: // å……ç”µé˜µB2æ–­å¼€
3765   3            ONOFFOutput(30);
3766   3      
3767   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3768   3            onoffExeCountB++;
3769   3            onoffExeCountC++;
3770   3            break;
3771   3      
3772   3          case 0x19: // å……ç”µé˜µB3æ–­å¼€
3773   3            ONOFFOutput(22);
3774   3      
3775   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3776   3            onoffExeCountB++;
3777   3            onoffExeCountC++;
3778   3            break;
3779   3      
3780   3          case 0x1A: // å……ç”µé˜µB4æ–­å¼€
3781   3            ONOFFOutput(31);
3782   3      
3783   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3784   3            onoffExeCountB++;
3785   3            onoffExeCountC++;
3786   3            break;
3787   3      
3788   3          case 0x1B: // å……ç”µé˜µB5æ–­å¼€
3789   3            ONOFFOutput(23);
3790   3      
3791   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3792   3            onoffExeCountB++;
3793   3            onoffExeCountC++;
3794   3            break;
3795   3      
3796   3          case 0x1C: // Bç»„å……ç”µé˜µæ¥é€š
3797   3            ONOFFOutput(24);
3798   3      
3799   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3800   3            onoffExeCountB++;
3801   3            onoffExeCountC++;
3802   3            break;
3803   3      
3804   3          case 0x1D:          // Aç»„å……ç”µé™å‹1
3805   3            DA_A_VOL = volCsTab[0]; // Aç»„ç”µå‹
3806   3            chargeVolKickA = 1;
3807   3            chargeVolKickA_B = 1;
3808   3            chargeVolKickA_C = 1;
3809   3      
3810   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 63  

3811   3            onoffExeCountB++;
3812   3            onoffExeCountC++;
3813   3            break;
3814   3      
3815   3          case 0x1E:          // Aç»„å……ç”µé™å‹2
3816   3            DA_A_VOL = volCsTab[1]; // Aç»„ç”µå‹
3817   3            chargeVolKickA = 2;
3818   3            chargeVolKickA_B = 2;
3819   3            chargeVolKickA_C = 2;
3820   3      
3821   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3822   3            onoffExeCountB++;
3823   3            onoffExeCountC++;
3824   3            break;
3825   3      
3826   3          case 0x1F:          // Aç»„å……ç”µé™å‹3
3827   3            DA_A_VOL = volCsTab[2]; // Aç»„ç”µå‹
3828   3            chargeVolKickA = 3;
3829   3            chargeVolKickA_B = 3;
3830   3            chargeVolKickA_C = 3;
3831   3      
3832   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3833   3            onoffExeCountB++;
3834   3            onoffExeCountC++;
3835   3            break;
3836   3      
3837   3          case 0x20:          // Aç»„å……ç”µé™å‹4
3838   3            DA_A_VOL = volCsTab[3]; // Aç»„ç”µå‹
3839   3            chargeVolKickA = 4;
3840   3            chargeVolKickA_B = 4;
3841   3            chargeVolKickA_C = 4;
3842   3      
3843   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3844   3            onoffExeCountB++;
3845   3            onoffExeCountC++;
3846   3            break;
3847   3      
3848   3          case 0x21:          // Aç»„å……ç”µé™å‹5
3849   3            DA_A_VOL = volCsTab[4]; // Aç»„ç”µå‹
3850   3            chargeVolKickA = 5;
3851   3            chargeVolKickA_B = 5;
3852   3            chargeVolKickA_C = 5;
3853   3      
3854   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3855   3            onoffExeCountB++;
3856   3            onoffExeCountC++;
3857   3            break;
3858   3      
3859   3          case 0x22:          // Aç»„å……ç”µé™å‹6
3860   3            DA_A_VOL = volCsTab[5]; // Aç»„ç”µå‹
3861   3            chargeVolKickA = 6;
3862   3            chargeVolKickA_B = 6;
3863   3            chargeVolKickA_C = 6;
3864   3      
3865   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3866   3            onoffExeCountB++;
3867   3            onoffExeCountC++;
3868   3            break;
3869   3      
3870   3          case 0x23:          // Aç»„å……ç”µé™å‹7
3871   3            DA_A_VOL = volCsTab[6]; // Aç»„ç”µå‹
3872   3            chargeVolKickA = 7;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 64  

3873   3            chargeVolKickA_B = 7;
3874   3            chargeVolKickA_C = 7;
3875   3      
3876   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3877   3            onoffExeCountB++;
3878   3            onoffExeCountC++;
3879   3            break;
3880   3      
3881   3          case 0x24:          // Aç»„å……ç”µé™å‹8
3882   3            DA_A_VOL = volCsTab[7]; // Aç»„ç”µå‹
3883   3            chargeVolKickA = 8;
3884   3            chargeVolKickA_B = 8;
3885   3            chargeVolKickA_C = 8;
3886   3      
3887   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3888   3            onoffExeCountB++;
3889   3            onoffExeCountC++;
3890   3            break;
3891   3      
3892   3          case 0x25:          // Aç»„å……ç”µé™æµ1
3893   3            DA_A_CUR = curCsTab[0]; // è®¾ç½®é™æµæ¡£ä½
3894   3            chargeCurKickA = 1;
3895   3            chargeCurKickA_B = 1;
3896   3            chargeCurKickA_C = 1;
3897   3      
3898   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3899   3            onoffExeCountB++;
3900   3            onoffExeCountC++;
3901   3            break;
3902   3      
3903   3          case 0x26:          // Aç»„å……ç”µé™æµ2
3904   3            DA_A_CUR = curCsTab[1]; // è®¾ç½®é™æµæ¡£ä½
3905   3            chargeCurKickA = 2;
3906   3            chargeCurKickA_B = 2;
3907   3            chargeCurKickA_C = 2;
3908   3      
3909   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3910   3            onoffExeCountB++;
3911   3            onoffExeCountC++;
3912   3            break;
3913   3      
3914   3          case 0x27:          // Aç»„å……ç”µé™æµ3
3915   3            DA_A_CUR = curCsTab[2]; // è®¾ç½®é™æµæ¡£ä½
3916   3            chargeCurKickA = 3;
3917   3            chargeCurKickA_B = 3;
3918   3            chargeCurKickA_C = 3;
3919   3      
3920   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3921   3            onoffExeCountB++;
3922   3            onoffExeCountC++;
3923   3            break;
3924   3      
3925   3          case 0x28:          // Aç»„å……ç”µé™æµ4
3926   3            DA_A_CUR = curCsTab[3]; // è®¾ç½®é™æµæ¡£ä½
3927   3            chargeCurKickA = 4;
3928   3            chargeCurKickA_B = 4;
3929   3            chargeCurKickA_C = 4;
3930   3      
3931   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3932   3            onoffExeCountB++;
3933   3            onoffExeCountC++;
3934   3            break;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 65  

3935   3      
3936   3          case 0x29:          // Aç»„å……ç”µé™æµ5
3937   3            DA_A_CUR = curCsTab[4]; // è®¾ç½®é™æµæ¡£ä½
3938   3            chargeCurKickA = 5;
3939   3            chargeCurKickA_B = 5;
3940   3            chargeCurKickA_C = 5;
3941   3      
3942   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3943   3            onoffExeCountB++;
3944   3            onoffExeCountC++;
3945   3            break;
3946   3      
3947   3          case 0x2A:          // Aç»„å……ç”µé™æµ6
3948   3            DA_A_CUR = curCsTab[5]; // è®¾ç½®é™æµæ¡£ä½
3949   3            chargeCurKickA = 6;
3950   3            chargeCurKickA_B = 6;
3951   3            chargeCurKickA_C = 6;
3952   3      
3953   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3954   3            onoffExeCountB++;
3955   3            onoffExeCountC++;
3956   3            break;
3957   3      
3958   3          case 0x2B:          // Aç»„å……ç”µé™æµ7
3959   3            DA_A_CUR = curCsTab[6]; // è®¾ç½®é™æµæ¡£ä½
3960   3            chargeCurKickA = 7;
3961   3            chargeCurKickA_B = 7;
3962   3            chargeCurKickA_C = 7;
3963   3      
3964   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3965   3            onoffExeCountB++;
3966   3            onoffExeCountC++;
3967   3            break;
3968   3      
3969   3          case 0x2C:          // Aç»„å……ç”µé™æµ8
3970   3            DA_A_CUR = curCsTab[7]; // è®¾ç½®é™æµæ¡£ä½
3971   3            chargeCurKickA = 8;
3972   3            chargeCurKickA_B = 8;
3973   3            chargeCurKickA_C = 8;
3974   3      
3975   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3976   3            onoffExeCountB++;
3977   3            onoffExeCountC++;
3978   3            break;
3979   3      
3980   3          case 0x2D:          // Bç»„å……ç”µé™å‹1
3981   3            DA_B_VOL = volCsTab[0]; // Bç»„ç”µå‹
3982   3            chargeVolKickB = 1;
3983   3            chargeVolKickB_B = 1;
3984   3            chargeVolKickB_C = 1;
3985   3      
3986   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3987   3            onoffExeCountB++;
3988   3            onoffExeCountC++;
3989   3            break;
3990   3      
3991   3          case 0x2E:          // Bç»„å……ç”µé™å‹2
3992   3            DA_B_VOL = volCsTab[1]; // Bç»„ç”µå‹
3993   3            chargeVolKickB = 2;
3994   3            chargeVolKickB_B = 2;
3995   3            chargeVolKickB_C = 2;
3996   3      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 66  

3997   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
3998   3            onoffExeCountB++;
3999   3            onoffExeCountC++;
4000   3            break;
4001   3      
4002   3          case 0x2F:          // Bç»„å……ç”µé™å‹3
4003   3            DA_B_VOL = volCsTab[2]; // Bç»„ç”µå‹
4004   3            chargeVolKickB = 3;
4005   3            chargeVolKickB_B = 3;
4006   3            chargeVolKickB_C = 3;
4007   3      
4008   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4009   3            onoffExeCountB++;
4010   3            onoffExeCountC++;
4011   3            break;
4012   3      
4013   3          case 0x30:          // Bç»„å……ç”µé™å‹4
4014   3            DA_B_VOL = volCsTab[3]; // Bç»„ç”µå‹
4015   3            chargeVolKickB = 4;
4016   3            chargeVolKickB_B = 4;
4017   3            chargeVolKickB_C = 4;
4018   3      
4019   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4020   3            onoffExeCountB++;
4021   3            onoffExeCountC++;
4022   3            break;
4023   3      
4024   3          case 0x31:          // Bç»„å……ç”µé™å‹5
4025   3            DA_B_VOL = volCsTab[4]; // Bç»„ç”µå‹
4026   3            chargeVolKickB = 5;
4027   3            chargeVolKickB_B = 5;
4028   3            chargeVolKickB_C = 5;
4029   3      
4030   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4031   3            onoffExeCountB++;
4032   3            onoffExeCountC++;
4033   3            break;
4034   3      
4035   3          case 0x32:          // Bç»„å……ç”µé™å‹6
4036   3            DA_B_VOL = volCsTab[5]; // Bç»„ç”µå‹
4037   3            chargeVolKickB = 6;
4038   3            chargeVolKickB_B = 6;
4039   3            chargeVolKickB_C = 6;
4040   3      
4041   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4042   3            onoffExeCountB++;
4043   3            onoffExeCountC++;
4044   3            break;
4045   3      
4046   3          case 0x33:          // Bç»„å……ç”µé™å‹7
4047   3            DA_B_VOL = volCsTab[6]; // Bç»„ç”µå‹
4048   3            chargeVolKickB = 7;
4049   3            chargeVolKickB_B = 7;
4050   3            chargeVolKickB_C = 7;
4051   3      
4052   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4053   3            onoffExeCountB++;
4054   3            onoffExeCountC++;
4055   3            break;
4056   3      
4057   3          case 0x34:          // Bç»„å……ç”µé™å‹8
4058   3            DA_B_VOL = volCsTab[7]; // Bç»„ç”µå‹
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 67  

4059   3            chargeVolKickB = 8;
4060   3            chargeVolKickB_B = 8;
4061   3            chargeVolKickB_C = 8;
4062   3      
4063   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4064   3            onoffExeCountB++;
4065   3            onoffExeCountC++;
4066   3            break;
4067   3      
4068   3          case 0x35:          // Bç»„å……ç”µé™æµ1
4069   3            DA_B_CUR = curCsTab[0]; // è®¾ç½®é™æµæ¡£ä½
4070   3            chargeCurKickB = 1;
4071   3            chargeCurKickB_B = 1;
4072   3            chargeCurKickB_C = 1;
4073   3      
4074   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4075   3            onoffExeCountB++;
4076   3            onoffExeCountC++;
4077   3            break;
4078   3      
4079   3          case 0x36:          // Bç»„å……ç”µé™æµ2
4080   3            DA_B_CUR = curCsTab[1]; // è®¾ç½®é™æµæ¡£ä½
4081   3            chargeCurKickB = 2;
4082   3            chargeCurKickB_B = 2;
4083   3            chargeCurKickB_C = 2;
4084   3      
4085   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4086   3            onoffExeCountB++;
4087   3            onoffExeCountC++;
4088   3            break;
4089   3      
4090   3          case 0x37:          // Bç»„å……ç”µé™æµ3
4091   3            DA_B_CUR = curCsTab[2]; // è®¾ç½®é™æµæ¡£ä½
4092   3            chargeCurKickB = 3;
4093   3            chargeCurKickB_B = 3;
4094   3            chargeCurKickB_C = 3;
4095   3      
4096   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4097   3            onoffExeCountB++;
4098   3            onoffExeCountC++;
4099   3            break;
4100   3      
4101   3          case 0x38:          // Bç»„å……ç”µé™æµ4
4102   3            DA_B_CUR = curCsTab[3]; // è®¾ç½®é™æµæ¡£ä½
4103   3            chargeCurKickB = 4;
4104   3            chargeCurKickB_B = 4;
4105   3            chargeCurKickB_C = 4;
4106   3      
4107   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4108   3            onoffExeCountB++;
4109   3            onoffExeCountC++;
4110   3            break;
4111   3      
4112   3          case 0x39:          // Bç»„å……ç”µé™æµ5
4113   3            DA_B_CUR = curCsTab[4]; // è®¾ç½®é™æµæ¡£ä½
4114   3            chargeCurKickB = 5;
4115   3            chargeCurKickB_B = 5;
4116   3            chargeCurKickB_C = 5;
4117   3      
4118   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4119   3            onoffExeCountB++;
4120   3            onoffExeCountC++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 68  

4121   3            break;
4122   3      
4123   3          case 0x3A:          // Bç»„å……ç”µé™æµ6
4124   3            DA_B_CUR = curCsTab[5]; // è®¾ç½®é™æµæ¡£ä½
4125   3            chargeCurKickB = 6;
4126   3            chargeCurKickB_B = 6;
4127   3            chargeCurKickB_C = 6;
4128   3      
4129   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4130   3            onoffExeCountB++;
4131   3            onoffExeCountC++;
4132   3            break;
4133   3      
4134   3          case 0x3B:          // Bç»„å……ç”µé™æµ7
4135   3            DA_B_CUR = curCsTab[6]; // è®¾ç½®é™æµæ¡£ä½
4136   3            chargeCurKickB = 7;
4137   3            chargeCurKickB_B = 7;
4138   3            chargeCurKickB_C = 7;
4139   3      
4140   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4141   3            onoffExeCountB++;
4142   3            onoffExeCountC++;
4143   3            break;
4144   3      
4145   3          case 0x3C:          // Bç»„å……ç”µé™æµ8
4146   3            DA_B_CUR = curCsTab[7]; // è®¾ç½®é™æµæ¡£ä½
4147   3            chargeCurKickB = 8;
4148   3            chargeCurKickB_B = 8;
4149   3            chargeCurKickB_C = 8;
4150   3      
4151   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4152   3            onoffExeCountB++;
4153   3            onoffExeCountC++;
4154   3            break;
4155   3      
4156   3          case 0x3D: // åˆ†æµä¿æŠ¤ç®¡1æ–­å¼€
4157   3            ONOFFOutput(1);
4158   3      
4159   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4160   3            onoffExeCountB++;
4161   3            onoffExeCountC++;
4162   3            break;
4163   3      
4164   3          case 0x3E: // åˆ†æµä¿æŠ¤ç®¡2æ–­å¼€
4165   3            ONOFFOutput(17);
4166   3      
4167   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4168   3            onoffExeCountB++;
4169   3            onoffExeCountC++;
4170   3            break;
4171   3      
4172   3          case 0x3F: // åˆ†æµä¿æŠ¤ç®¡3æ–­å¼€
4173   3            ONOFFOutput(10);
4174   3      
4175   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4176   3            onoffExeCountB++;
4177   3            onoffExeCountC++;
4178   3            break;
4179   3      
4180   3          case 0x40: // åˆ†æµä¿æŠ¤ç®¡4æ–­å¼€
4181   3            ONOFFOutput(26);
4182   3      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 69  

4183   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4184   3            onoffExeCountB++;
4185   3            onoffExeCountC++;
4186   3            break;
4187   3      
4188   3          case 0x41: // åˆ†æµä¿æŠ¤ç®¡5æ–­å¼€
4189   3            ONOFFOutput(2);
4190   3      
4191   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4192   3            onoffExeCountB++;
4193   3            onoffExeCountC++;
4194   3            break;
4195   3      
4196   3          case 0x42: // åˆ†æµä¿æŠ¤ç®¡6æ–­å¼€
4197   3            ONOFFOutput(18);
4198   3      
4199   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4200   3            onoffExeCountB++;
4201   3            onoffExeCountC++;
4202   3            break;
4203   3      
4204   3          case 0x43: // åˆ†æµä¿æŠ¤ç®¡7æ–­å¼€
4205   3            ONOFFOutput(11);
4206   3      
4207   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4208   3            onoffExeCountB++;
4209   3            onoffExeCountC++;
4210   3            break;
4211   3      
4212   3          case 0x44: // åˆ†æµä¿æŠ¤ç®¡8æ–­å¼€
4213   3            ONOFFOutput(27);
4214   3      
4215   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4216   3            onoffExeCountB++;
4217   3            onoffExeCountC++;
4218   3            break;
4219   3      
4220   3          case 0x45: // åˆ†æµä¿æŠ¤ç®¡9æ–­å¼€
4221   3            ONOFFOutput(3);
4222   3      
4223   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4224   3            onoffExeCountB++;
4225   3            onoffExeCountC++;
4226   3            break;
4227   3      
4228   3          case 0x46: // åˆ†æµä¿æŠ¤ç®¡10æ–­å¼€
4229   3            ONOFFOutput(19);
4230   3      
4231   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4232   3            onoffExeCountB++;
4233   3            onoffExeCountC++;
4234   3            break;
4235   3      
4236   3          case 0x47: // åˆ†æµä¿æŠ¤ç®¡11æ–­å¼€
4237   3            ONOFFOutput(12);
4238   3      
4239   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4240   3            onoffExeCountB++;
4241   3            onoffExeCountC++;
4242   3            break;
4243   3      
4244   3          case 0x48: // åˆ†æµä¿æŠ¤ç®¡12æ–­å¼€
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 70  

4245   3            ONOFFOutput(28);
4246   3      
4247   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4248   3            onoffExeCountB++;
4249   3            onoffExeCountC++;
4250   3            break;
4251   3      
4252   3          case 0x49: // åˆ†æµä¿æŠ¤ç®¡13æ–­å¼€
4253   3            ONOFFOutput(4);
4254   3      
4255   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4256   3            onoffExeCountB++;
4257   3            onoffExeCountC++;
4258   3            break;
4259   3      
4260   3          case 0x4A: // åˆ†æµä¿æŠ¤ç®¡14æ–­å¼€
4261   3            ONOFFOutput(20);
4262   3      
4263   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4264   3            onoffExeCountB++;
4265   3            onoffExeCountC++;
4266   3            break;
4267   3      
4268   3          case 0x4B: // åˆ†æµä¿æŠ¤ç®¡15æ–­å¼€
4269   3            ONOFFOutput(13);
4270   3      
4271   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4272   3            onoffExeCountB++;
4273   3            onoffExeCountC++;
4274   3            break;
4275   3      
4276   3          case 0x4C: // åˆ†æµä¿æŠ¤ç®¡16æ–­å¼€
4277   3            ONOFFOutput(29);
4278   3      
4279   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4280   3            onoffExeCountB++;
4281   3            onoffExeCountC++;
4282   3            break;
4283   3      
4284   3          case 0x4D: // å……åˆ†æ¨¡å—1åˆ†æµä¿æŠ¤ç®¡æ¥é€š
4285   3            ONOFFOutput(9);
4286   3      
4287   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4288   3            onoffExeCountB++;
4289   3            onoffExeCountC++;
4290   3            break;
4291   3      
4292   3          case 0x4E: // å……åˆ†æ¨¡å—2åˆ†æµä¿æŠ¤ç®¡æ¥é€š
4293   3            ONOFFOutput(16);
4294   3      
4295   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4296   3            onoffExeCountB++;
4297   3            onoffExeCountC++;
4298   3            break;
4299   3      
4300   3          case 0x4F: // å……åˆ†æ¨¡å—3åˆ†æµä¿æŠ¤ç®¡æ¥é€š
4301   3            ONOFFOutput(25);
4302   3      
4303   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4304   3            onoffExeCountB++;
4305   3            onoffExeCountC++;
4306   3            break;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 71  

4307   3      
4308   3          case 0x50: // å……åˆ†æ¨¡å—4åˆ†æµä¿æŠ¤ç®¡æ¥é€š
4309   3            ONOFFOutput(32);
4310   3      
4311   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4312   3            onoffExeCountB++;
4313   3            onoffExeCountC++;
4314   3            break;
4315   3      
4316   3          case 0x51: // å•ä½“1å‡è¡¡é€š
4317   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[0];
4318   3            wrEquOnoffIndex++;
4319   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4320   3            {
4321   4              wrEquOnoffIndex = 0;
4322   4            }
4323   3      
4324   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4325   3            onoffExeCountB++;
4326   3            onoffExeCountC++;
4327   3            break;
4328   3          case 0x52: // å•ä½“1å‡è¡¡æ–­
4329   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[0];
4330   3            wrEquOnoffIndex++;
4331   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4332   3            {
4333   4              wrEquOnoffIndex = 0;
4334   4            }
4335   3      
4336   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4337   3            onoffExeCountB++;
4338   3            onoffExeCountC++;
4339   3            break;
4340   3          case 0x53: // å•ä½“2å‡è¡¡é€š
4341   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[1];
4342   3            wrEquOnoffIndex++;
4343   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4344   3            {
4345   4              wrEquOnoffIndex = 0;
4346   4            }
4347   3      
4348   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4349   3            onoffExeCountB++;
4350   3            onoffExeCountC++;
4351   3            break;
4352   3          case 0x54: // å•ä½“2å‡è¡¡æ–­
4353   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[1];
4354   3            wrEquOnoffIndex++;
4355   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4356   3            {
4357   4              wrEquOnoffIndex = 0;
4358   4            }
4359   3      
4360   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4361   3            onoffExeCountB++;
4362   3            onoffExeCountC++;
4363   3            break;
4364   3          case 0x55: // å•ä½“3å‡è¡¡é€š
4365   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[2];
4366   3            wrEquOnoffIndex++;
4367   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4368   3            {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 72  

4369   4              wrEquOnoffIndex = 0;
4370   4            }
4371   3      
4372   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4373   3            onoffExeCountB++;
4374   3            onoffExeCountC++;
4375   3            break;
4376   3          case 0x56: // å•ä½“3å‡è¡¡æ–­
4377   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[2];
4378   3            wrEquOnoffIndex++;
4379   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4380   3            {
4381   4              wrEquOnoffIndex = 0;
4382   4            }
4383   3      
4384   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4385   3            onoffExeCountB++;
4386   3            onoffExeCountC++;
4387   3            break;
4388   3          case 0x57: // å•ä½“4å‡è¡¡é€š
4389   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[3];
4390   3            wrEquOnoffIndex++;
4391   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4392   3            {
4393   4              wrEquOnoffIndex = 0;
4394   4            }
4395   3      
4396   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4397   3            onoffExeCountB++;
4398   3            onoffExeCountC++;
4399   3            break;
4400   3          case 0x58: // å•ä½“4å‡è¡¡æ–­
4401   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[3];
4402   3            wrEquOnoffIndex++;
4403   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4404   3            {
4405   4              wrEquOnoffIndex = 0;
4406   4            }
4407   3      
4408   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4409   3            onoffExeCountB++;
4410   3            onoffExeCountC++;
4411   3            break;
4412   3          case 0x59: // å•ä½“5å‡è¡¡é€š
4413   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[4];
4414   3            wrEquOnoffIndex++;
4415   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4416   3            {
4417   4              wrEquOnoffIndex = 0;
4418   4            }
4419   3      
4420   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4421   3            onoffExeCountB++;
4422   3            onoffExeCountC++;
4423   3            break;
4424   3          case 0x5A: // å•ä½“5å‡è¡¡æ–­
4425   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[4];
4426   3            wrEquOnoffIndex++;
4427   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4428   3            {
4429   4              wrEquOnoffIndex = 0;
4430   4            }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 73  

4431   3      
4432   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4433   3            onoffExeCountB++;
4434   3            onoffExeCountC++;
4435   3            break;
4436   3          case 0x5B: // å•ä½“6å‡è¡¡é€š
4437   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[5];
4438   3            wrEquOnoffIndex++;
4439   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4440   3            {
4441   4              wrEquOnoffIndex = 0;
4442   4            }
4443   3      
4444   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4445   3            onoffExeCountB++;
4446   3            onoffExeCountC++;
4447   3            break;
4448   3          case 0x5C: // å•ä½“6å‡è¡¡æ–­
4449   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[5];
4450   3            wrEquOnoffIndex++;
4451   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4452   3            {
4453   4              wrEquOnoffIndex = 0;
4454   4            }
4455   3      
4456   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4457   3            onoffExeCountB++;
4458   3            onoffExeCountC++;
4459   3            break;
4460   3          case 0x5D: // å•ä½“7å‡è¡¡é€š
4461   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[6];
4462   3            wrEquOnoffIndex++;
4463   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4464   3            {
4465   4              wrEquOnoffIndex = 0;
4466   4            }
4467   3      
4468   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4469   3            onoffExeCountB++;
4470   3            onoffExeCountC++;
4471   3            break;
4472   3          case 0x5E: // å•ä½“7å‡è¡¡æ–­
4473   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[6];
4474   3            wrEquOnoffIndex++;
4475   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4476   3            {
4477   4              wrEquOnoffIndex = 0;
4478   4            }
4479   3      
4480   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4481   3            onoffExeCountB++;
4482   3            onoffExeCountC++;
4483   3            break;
4484   3      
4485   3          case 0x5F: // å•ä½“8å‡è¡¡é€š
4486   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[7];
4487   3            wrEquOnoffIndex++;
4488   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4489   3            {
4490   4              wrEquOnoffIndex = 0;
4491   4            }
4492   3      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 74  

4493   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4494   3            onoffExeCountB++;
4495   3            onoffExeCountC++;
4496   3            break;
4497   3          case 0x60: // å•ä½“8å‡è¡¡æ–­
4498   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[7];
4499   3            wrEquOnoffIndex++;
4500   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4501   3            {
4502   4              wrEquOnoffIndex = 0;
4503   4            }
4504   3      
4505   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4506   3            onoffExeCountB++;
4507   3            onoffExeCountC++;
4508   3            break;
4509   3          case 0x61: // å•ä½“9å‡è¡¡é€š
4510   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[8];
4511   3            wrEquOnoffIndex++;
4512   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4513   3            {
4514   4              wrEquOnoffIndex = 0;
4515   4            }
4516   3      
4517   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4518   3            onoffExeCountB++;
4519   3            onoffExeCountC++;
4520   3            break;
4521   3          case 0x62: // å•ä½“9å‡è¡¡æ–­
4522   3            equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[8];
4523   3            wrEquOnoffIndex++;
4524   3            if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4525   3            {
4526   4              wrEquOnoffIndex = 0;
4527   4            }
4528   3      
4529   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4530   3            onoffExeCountB++;
4531   3            onoffExeCountC++;
4532   3            break;
4533   3          case 0x63: // é¢„ç•™1
4534   3      
4535   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4536   3            onoffExeCountB++;
4537   3            onoffExeCountC++;
4538   3            break;
4539   3          case 0x64: // é¢„ç•™2
4540   3      
4541   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4542   3            onoffExeCountB++;
4543   3            onoffExeCountC++;
4544   3            break;
4545   3      
4546   3          case 0x65: // è“„ç”µæ± è¿‡å……ä¿æŠ¤ä½¿èƒ½
4547   3            overChargeProtectEn = TRUE;
4548   3            overChargeProtectEnB = TRUE;
4549   3            overChargeProtectEnC = TRUE;
4550   3      
4551   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4552   3            onoffExeCountB++;
4553   3            onoffExeCountC++;
4554   3            break;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 75  

4555   3          case 0x66: // è“„ç”µæ± è¿‡å……ä¿æŠ¤ç¦æ­¢
4556   3            overChargeProtectEn = FALSE;
4557   3            overChargeProtectEnB = FALSE;
4558   3            overChargeProtectEnC = FALSE;
4559   3      
4560   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4561   3            onoffExeCountB++;
4562   3            onoffExeCountC++;
4563   3            break;
4564   3      
4565   3          case 0x67: // å‡è¡¡æ§åˆ¶ä½¿èƒ½
4566   3            equControlEn = TRUE;
4567   3            equControlEnB = TRUE;
4568   3            equControlEnC = TRUE;
4569   3      
4570   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4571   3            onoffExeCountB++;
4572   3            onoffExeCountC++;
4573   3            break;
4574   3          case 0x68: // å‡è¡¡æ§åˆ¶ç¦æ­¢
4575   3            equControlEn = FALSE;
4576   3            equControlEnB = FALSE;
4577   3            equControlEnC = FALSE;
4578   3      
4579   3            for (i = 0; i < 9; i++) // åŒæ—¶å‘é€å…¨éƒ¨å‡è¡¡æ–­å¼€æŒ‡ä»¤
4580   3            {
4581   4              equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[i];
4582   4              wrEquOnoffIndex++;
4583   4              if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
4584   4              {
4585   5                wrEquOnoffIndex = 0;
4586   5              }
4587   4            }
4588   3      
4589   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4590   3            onoffExeCountB++;
4591   3            onoffExeCountC++;
4592   3            break;
4593   3      
4594   3          case 0x69: // è“„ç”µæ± å•ä½“ä¿æŠ¤å……ç”µä½¿èƒ½
4595   3            singleProtectChargeEn = TRUE;
4596   3            singleProtectChargeEnB = TRUE;
4597   3            singleProtectChargeEnC = TRUE;
4598   3      
4599   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4600   3            onoffExeCountB++;
4601   3            onoffExeCountC++;
4602   3            break;
4603   3      
4604   3          case 0x6A: // è“„ç”µæ± å•ä½“ä¿æŠ¤å……ç”µç¦æ­¢
4605   3            singleProtectChargeEn = FALSE;
4606   3            singleProtectChargeEnB = FALSE;
4607   3            singleProtectChargeEnC = FALSE;
4608   3      
4609   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4610   3            onoffExeCountB++;
4611   3            onoffExeCountC++;
4612   3            break;
4613   3      
4614   3          case 0x6B:        // CAN-Aæ€»çº¿å¤ä½
4615   3            EX0 = 0;      // å…³é—­ä¸­æ–­
4616   3            CANInit(BUSA_ADDR); // å¯¹Aæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 76  

4617   3            CANInfoA();
4618   3            EX0 = 1; // å¼€ä¸­æ–­
4619   3      
4620   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4621   3            onoffExeCountB++;
4622   3            onoffExeCountC++;
4623   3            break;
4624   3      
4625   3          case 0x6C:        // CAN-Bæ€»çº¿å¤ä½
4626   3            EX0 = 0;      // å…³é—­ä¸­æ–­
4627   3            CANInit(BUSB_ADDR); // å¯¹Bæ€»çº¿æ§åˆ¶å™¨é‡æ–°åˆå§‹åŒ–
4628   3            CANInfoB();
4629   3            EX0 = 1; // å¼€ä¸­æ–­
4630   3      
4631   3            onoffExeCount++; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•°åŠ 1
4632   3            onoffExeCountB++;
4633   3            onoffExeCountC++;
4634   3            break;
4635   3      
4636   3          default:
4637   3            onoffErrorCount++;  // é”™è¯¯æŒ‡ä»¤è®¡æ•°++
4638   3            onoffErrorCountB++; // é”™è¯¯æŒ‡ä»¤è®¡æ•°B++
4639   3            onoffErrorCountC++; // é”™è¯¯æŒ‡ä»¤è®¡æ•°C++
4640   3            break;
4641   3          }
4642   2      
4643   2          onoffBuffer[rdOnoffIndex][0] = 0x00; // æŒ‡ä»¤ç æ¸…é›¶1
4644   2          onoffBuffer[rdOnoffIndex][1] = 0x00; // æŒ‡ä»¤ç æ¸…é›¶2
4645   2      
4646   2          rdOnoffIndex++;
4647   2          if (rdOnoffIndex >= 24)
4648   2          {
4649   3            rdOnoffIndex = 0;
4650   3          }
4651   2        }
4652   1      }
4653          
4654          //*****************************************************************
4655          // å‡½æ•°åç§° : Get2_3_U
4656          // åŠŸèƒ½æè¿° :
4657          // *****************************************************************
4658          unsigned char Get2_3_U(unsigned char *a, unsigned char *b, unsigned char *c)
4659          {
4660   1        if ((*a == *b) && (*b == *c)) // ä¸‰è€…ä¸€è‡´ è¿”å›
4661   1        {
4662   2          return (TRUE); // æ­£ç¡®è¿”å›
4663   2        }
4664   1        else
4665   1        {
4666   2          if (*a == *b) // ä»»æ„ä¸¤è€…ä¸€è‡´ è¿”å›
4667   2          {
4668   3            EA = 0; // å…³é—­ä¸­æ–­è¿›è¡Œæ•°æ®çº é”™
4669   3            *c = *a;
4670   3            EA = 1;
4671   3            return (TRUE); // æ­£ç¡®è¿”å›
4672   3          }
4673   2          else
4674   2          {
4675   3            if (*a == *c)
4676   3            {
4677   4              EA = 0; // å…³é—­ä¸­æ–­è¿›è¡Œæ•°æ®çº é”™
4678   4              *b = *a;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 77  

4679   4              EA = 1;
4680   4              return (TRUE);
4681   4            }
4682   3            else
4683   3            {
4684   4              if (*b == *c)
4685   4              {
4686   5                EA = 0; // å…³é—­ä¸­æ–­è¿›è¡Œæ•°æ®çº é”™
4687   5                *a = *b;
4688   5                EA = 1;
4689   5                return (TRUE);
4690   5              }
4691   4              else // ä»»æ„ä¸¤è€…ä¸ä¸€è‡´ è¿”å›
4692   4              {
4693   5                return (FALSE); // é”™è¯¯è¿”å›
4694   5              }
4695   4            }
4696   3          }
4697   2        }
4698   1      }
4699          
4700          /***************************************************************************************/
4701          /* å‡½æ•°ä»‹ç»: 2/3åˆ¤å†³å‡½æ•°(floatä½¿ç”¨)                                                    */
4702          /* åŠŸèƒ½æè¿°:                                                                           */
4703          /* ä¿®æ”¹è®°å½•:                                                                           */
4704          /*                                                                                     */
4705          /***************************************************************************************/
4706          unsigned char Get2_3_F(float *a, float *b, float *c)
4707          {
4708   1        float xdata temp1;
4709   1        float xdata temp2;
4710   1        float xdata temp3;
4711   1      
4712   1        temp1 = fabs(*a - *b);
4713   1        temp2 = fabs(*a - *c);
4714   1        temp3 = fabs(*b - *c);
4715   1      
4716   1        if ((temp1 < 0.0001) && (temp2 < 0.0001) && (temp3 < 0.0001)) /* ä¸‰è€…ä¸€è‡´ è¿”å› */
4717   1        {
4718   2          return (TRUE); /* æ­£ç¡®è¿”å›TRUE     */
4719   2        }
4720   1        else
4721   1        {
4722   2          if (temp1 < 0.0001) /* ä¸¤è€…ä¸€è‡´ è¿”å› */
4723   2          {
4724   3            *c = *a;
4725   3            return (TRUE); /* æ­£ç¡®è¿”å›TRUE */
4726   3          }
4727   2          else
4728   2          {
4729   3            if (temp2 < 0.0001)
4730   3            {
4731   4              *b = *a;
4732   4              return (TRUE);
4733   4            }
4734   3            else
4735   3            {
4736   4              if (temp3 < 0.0001)
4737   4              {
4738   5                *a = *b;
4739   5                return (TRUE);
4740   5              }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 78  

4741   4              else /* ä¸‰è€…ä¸ä¸€è‡´ è¿”å› */
4742   4              {
4743   5                return (FALSE); /* é”™è¯¯è¿”å›FALSE */
4744   5              }
4745   4            }
4746   3          }
4747   2        }
4748   1      }
4749          
4750          /***************************************************************************************/
4751          /* å‡½æ•°ä»‹ç»: Get2_3_I åˆ¤å†³å‡½æ•°(uintä½¿ç”¨)                                               */
4752          /* åŠŸèƒ½æè¿°:                                                                           */
4753          /* ä¿®æ”¹è®°å½•:                                                                           */
4754          /*                                                                                     */
4755          /***************************************************************************************/
4756          unsigned char Get2_3_I(unsigned int *a, unsigned int *b, unsigned int *c)
4757          {
4758   1        if ((*a == *b) && (*b == *c)) /* ä¸‰åŒºå¯¹æ¯”ä¸€è‡´ */
4759   1        {
4760   2          return (TRUE); /* 3å–2åˆ¤è¯»æ­£ç¡® */
4761   2        }
4762   1        else
4763   1        {
4764   2          if (*a == *b) /* å‰ä¸¤ä¸ªæ•°ç›¸ç­‰  */
4765   2          {
4766   3            *c = *a;     /* èµ‹å€¼æ“ä½œ */
4767   3            return (TRUE); /* 3å–2åˆ¤è¯»æ­£ç¡® */
4768   3          }
4769   2          else
4770   2          {
4771   3            if (*a == *c) /* å¦ä¸¤ä¸ªæ•°ç›¸ç­‰ */
4772   3            {
4773   4              *b = *a;     /* èµ‹å€¼æ“ä½œ */
4774   4              return (TRUE); /* 3å–2åˆ¤è¯»æ­£ç¡® */
4775   4            }
4776   3            else
4777   3            {
4778   4              if (*b == *c) /* å‰©ä½™ä¸¤ä¸ªæ•°ç›¸ç­‰ */
4779   4              {
4780   5                *a = *b;     /* èµ‹å€¼æ“ä½œ */
4781   5                return (TRUE); /* 3å–2åˆ¤è¯»æ­£ç¡® */
4782   5              }
4783   4              else
4784   4              {
4785   5                return (FALSE); /* 3å–2åˆ¤è¯»å¼‚å¸¸ */
4786   5              }
4787   4            }
4788   3          }
4789   2        }
4790   1      }
4791          
4792          //*****************************************************************
4793          // å‡½æ•°åç§° : EQU_ISR
4794          // åŠŸèƒ½æè¿° :
4795          // *****************************************************************
4796          void EQU_ISR(void) interrupt 2 using 3
4797          {
4798   1        unsigned char temp;
4799   1      
4800   1        temp = TXD422BUFF;   // æ¸…ä¸­æ–­
4801   1        if (fgEquRx == TRUE) // æ¥æ”¶æ ‡å¿—
4802   1        {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 79  

4803   2          equDataBuffer[equRxCount] = RXD422BUFF; // è¯»å‡ºå‡è¡¡å™¨çŠ¶æ€
4804   2          equRxCount++;             // æ¥æ”¶è®¡æ•°
4805   2      
4806   2          if (equRxCount >= 39) // æ¥æ”¶48ååœæ­¢é—¨æ§
4807   2          {
4808   3            RXDCONTROL = 1;
4809   3            RXD422AEn = 1;
4810   3      
4811   3            equRxCount = 0;
4812   3            fgEquRx = FALSE;
4813   3          }
4814   2        }
4815   1        else if (fgEquTx == TRUE) // å‘é€æ ‡å¿—
4816   1        {
4817   2          TXD422BUFF = (equOnoffBuffer[rdEquOnoffIndex] & 0xFF);
4818   2          fgEquTx = FALSE;
4819   2        }
4820   1      }
4821          
4822          //*****************************************************************
4823          // å‡½æ•°åç§° : CAN_ISR
4824          // åŠŸèƒ½æè¿° :
4825          // *****************************************************************
4826          void CAN_ISR(void) interrupt 0 using 1
4827          {
4828   1        unsigned char IR;
4829   1      
4830   1        IR = XBYTE[BUSA_ADDR + 3]; // è¯»Aæ€»çº¿ä¸­æ–­å¯„å­˜å™¨
4831   1        if ((IR & 0x01) == 0x01)   // ä¸­æ–­å¯„å­˜å™¨æ¥æ”¶çŠ¶æ€å­—åˆ¤è¯»
4832   1        {
4833   2          fgCanBus = 0xAA;
4834   2          CANRXDA(); // Aæ€»çº¿æ¥æ”¶
4835   2        }
4836   1      
4837   1        if ((IR & 0x02) == 0x02) // ä¸­æ–­å¯„å­˜å™¨å‘é€çŠ¶æ€å­—åˆ¤è¯»
4838   1        {
4839   2          CANTXDA(); // Aæ€»çº¿å‘é€
4840   2        }
4841   1      
4842   1        IR = XBYTE[BUSB_ADDR + 3]; // è¯»Bæ€»çº¿ä¸­æ–­å¯„å­˜å™¨
4843   1        if ((IR & 0x01) == 0x01)   // ä¸­æ–­å¯„å­˜å™¨æ¥æ”¶çŠ¶æ€åˆ¤è¯»
4844   1        {
4845   2          fgCanBus = 0xBB;
4846   2          CANRXDB(); // Bæ€»çº¿æ¥æ”¶
4847   2        }
4848   1      
4849   1        if ((IR & 0x02) == 0x02) // ä¸­æ–­å¯„å­˜å™¨å‘é€çŠ¶æ€åˆ¤è¯»
4850   1        {
4851   2          CANTXDB(); // Bæ€»çº¿å‘é€
4852   2        }
4853   1      }
4854          
4855          //*****************************************************************
4856          // å‡½æ•°åç§° : CANRXDA
4857          // åŠŸèƒ½æè¿° :
4858          // *****************************************************************
4859          void CANRXDA(void) using 1
4860          {
4861   1        unsigned char i; // å®šä¹‰ä¸´æ—¶å˜é‡
4862   1        unsigned char dlc;
4863   1        unsigned char length;
4864   1        unsigned char fgEndFrame;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 80  

4865   1        unsigned char xdata *p;
4866   1      
4867   1        if ((XBYTE[0xA014] == 0x9B) || (XBYTE[0xA014] == 0x5B) || (XBYTE[0xA014] == 0x4F)) // åˆ¤æ–­ä¸ºç”µæºä¸‹ä
             -½æœºID æˆ– å¹¿æ’­
4868   1        {
4869   2          fgEndFrame = FALSE;              // ç½®æ•°æ®åŒ…æ¥æ”¶ç»“æŸæ ‡å¿—
4870   2          dlc = (unsigned char)(XBYTE[0xA015] & 0x0F); // å¸§æœ‰æ•ˆæ•°æ®é•¿åº¦
4871   2      
4872   2          if ((XBYTE[0xA015] & 0x20) == 0x00) // åˆ¤æ–­å•å¸§/å¤šå¸§ç»“æŸå¸§/å¤šå¸§ä¸­æ–­å¸§     ??????  é¦–å¸§åˆ¤è
             -¯» ???????????????????
4873   2          {
4874   3            length = dlc;                  // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
4875   3            p = 0xA016;                    // ç½®æ¥æ”¶æ•°æ®æŒ‡é’ˆ
4876   3            receiveSumA = 0;                 // æ¥æ”¶æ•°æ®ç´¯åŠ å’Œæ¸…é›¶
4877   3            receiveBufferA[0] = (unsigned char)(length - 2); // å­˜å‚¨é•¿åº¦å­—
4878   3            receiveCountA = 1;
4879   3          }
4880   2          else
4881   2          {
4882   3            if (dlc < 8) // æ•°æ®å¸§ä¸ºå¤šå¸§ç»“æŸå¸§
4883   3            {
4884   4              length = (unsigned char)(dlc - 1);         // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
4885   4              receiveSumA = receiveSumA - receiveBufferA[0]; // æ¥æ”¶æ•°æ®ç´¯åŠ å’Œå‡å»å¤šå¸§æ•°æ®çš„lengthå­—è
             -Š‚
4886   4            }
4887   3            else // æ•°æ®å¸§ä¸ºå¤šå¸§ä¸­ç»§å¸§
4888   3            {
4889   4              length = 7;      // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
4890   4              fgEndFrame = TRUE; // ç½®æ•°æ®åŒ…æ­£åœ¨æ¥æ”¶æ ‡å¿—
4891   4            }
4892   3      
4893   3            p = 0xA017;    // ç½®æ¥æ”¶æ•°æ®æŒ‡é’ˆ(ä¸åŒ…æ‹¬å¸§index)
4894   3                     //     if ((XBYTE[0xA014] != 0x5B) || (XBYTE[0xA016] == 0x00) || (XBYTE[0xA016] != receiveFrameA))
4895   3                     //     {
4896   3                     //       receiveSumA = 0; // ç´¯åŠ å’Œã€è®¡æ•°æ¸…é›¶
4897   3                     //       receiveCountA = 0;
4898   3                     //       receiveFrameA = 0;
4899   3                     //       length = 0;
4900   3                     //       // æ¸…é™¤æ•°æ®é•¿åº¦
4901   3                     //       if ((XBYTE[0xA014] == 0x5B) && (XBYTE[0xA016] == 0x00))
4902   3                     //       { // é¦–å¸§åˆ™ç½®æ¥æ”¶æ•°æ®é•¿åº¦
4903   3                     //         length = 7;
4904   3                     //       }
4905   3                     //     }
4906   3            receiveFrameA++; // å¤šå¸§è®¡æ•°å¢åŠ 
4907   3          }
4908   2      
4909   2          for (i = 0; i < length; i++) // æ¥æ”¶æ•°æ®(TITLE+DATA+SUM)å¹¶è®¡ç®—ç´¯åŠ å’Œ
4910   2          {
4911   3            receiveBufferA[receiveCountA] = *p;
4912   3            receiveSumA = receiveSumA + *p; // ç´¯åŠ å’Œè®¡ç®—(Title + Data + Sum)
4913   3            p++;
4914   3            receiveCountA++; // å­˜å‚¨DATAè®¡æ•°
4915   3          }
4916   2      
4917   2          if ((fgEndFrame == FALSE) && (receiveCountA > 0)) // åˆ¤æ–­ç»“æŸå¤„ç†
4918   2          {
4919   3            receiveSumA = ((receiveSumA - receiveBufferA[receiveCountA - 1]) & 0x00FF); // è®¡ç®—ç´¯åŠ å’Œ
4920   3      
4921   3            if ((receiveSumA == receiveBufferA[receiveCountA - 1]) && (receiveCountA == (unsigned char)(receiveBuff
             -erA[0] + 3))) // åˆ¤æ–­æ•°æ®åŒ…çš„ç´¯åŠ å’Œä¸é•¿åº¦éƒ½æ­£ç¡®
4922   3            {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 81  

4923   4              errorCount = 0; // é€šè®¯é”™è¯¯è®¡æ•°æ¸…é›¶
4924   4              switch (receiveBufferA[1])
4925   4              {
4926   5              case 0x00: // è½®è¯¢æ§åˆ¶å¤„ç†
4927   5                if ((XBYTE[0xA014] == 0x9B) && (receiveBufferA[2] == 0x10))
4928   5                {
4929   6                  RsManageA();
4930   6                }
4931   5                break;
4932   5      
4933   5              case 0x40: // é—´æ¥æŒ‡ä»¤å¤„ç†
4934   5                if (XBYTE[0xA014] == 0x5B)
4935   5                {
4936   6                  ONOFFManageA();
4937   6                }
4938   5      
4939   5                if (XBYTE[0xA014] == 0x4F)
4940   5                {
4941   6                  TimeBcA();
4942   6                }
4943   5      
4944   5                break;
4945   5      
4946   5              case 0x60: // ä¸Šè¡Œå‚æ•°å—
4947   5                if (XBYTE[0xA014] == 0x5B)
4948   5                {
4949   6                  DataManageA();
4950   6                }
4951   5                break;
4952   5      
4953   5              case 0xD0: // é‡è¦æ•°æ®è¿”å›ï¼ˆæ¥æ”¶ï¼‰
4954   5                if (XBYTE[0xA014] == 0x9B)
4955   5                {
4956   6                  ImportantManageA();
4957   6                }
4958   5                break;
4959   5      
4960   5              case 0xE0: // å†…å­˜åœ°å€è®¾ç½®
4961   5                if (XBYTE[0xA014] == 0x5B)
4962   5                {
4963   6                  RamManageA();
4964   6                }
4965   5                break;
4966   5      
4967   5              default:
4968   5                break;
4969   5              }
4970   4            }
4971   3      
4972   3            receiveSumA = 0; // ç´¯åŠ å’Œæ¸…é›¶
4973   3            receiveCountA = 0;
4974   3            receiveFrameA = 0;
4975   3          }
4976   2        }
4977   1      
4978   1        XBYTE[0xA001] = 0x0C; // é‡Šæ”¾æ¥æ”¶ç¼“å­˜å™¨
4979   1      }
4980          
4981          //*****************************************************************
4982          // å‡½æ•°åç§° : CANRXDB
4983          // åŠŸèƒ½æè¿° :
4984          // *****************************************************************
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 82  

4985          void CANRXDB(void) using 1
4986          {
4987   1        unsigned char i; // å®šä¹‰ä¸´æ—¶å˜é‡
4988   1        unsigned char dlc;
4989   1        unsigned char length;
4990   1        unsigned char fgEndFrame;
4991   1        unsigned char xdata *p;
4992   1      
4993   1        if ((XBYTE[0xC014] == 0x9B) || (XBYTE[0xC014] == 0x5B) || (XBYTE[0xC014] == 0x4F)) // åˆ¤æ–­ä¸ºç”µæºä¸‹ä
             -½æœºID æˆ– å¹¿æ’­
4994   1        {
4995   2          fgEndFrame = FALSE;              // ç½®æ•°æ®åŒ…æ¥æ”¶ç»“æŸæ ‡å¿—
4996   2          dlc = (unsigned char)(XBYTE[0xC015] & 0x0F); // å¸§æœ‰æ•ˆæ•°æ®é•¿åº¦
4997   2      
4998   2          if ((XBYTE[0xC015] & 0x20) == 0x00) // åˆ¤æ–­å•å¸§/å¤šå¸§ç»“æŸå¸§/å¤šå¸§ä¸­æ–­å¸§     ??????  é¦–å¸§åˆ¤è
             -¯» ???????????????????
4999   2          {
5000   3            length = dlc;                  // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
5001   3            p = 0xC016;                    // ç½®æ¥æ”¶æ•°æ®æŒ‡é’ˆ
5002   3            receiveSumB = 0;                 // æ¥æ”¶æ•°æ®ç´¯åŠ å’Œæ¸…é›¶
5003   3            receiveBufferB[0] = (unsigned char)(length - 2); // å­˜å‚¨é•¿åº¦å­—
5004   3            receiveCountB = 1;
5005   3          }
5006   2          else
5007   2          {
5008   3            if (dlc < 8) // æ•°æ®å¸§ä¸ºå¤šå¸§ç»“æŸå¸§
5009   3            {
5010   4              length = (unsigned char)(dlc - 1);         // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
5011   4              receiveSumB = receiveSumB - receiveBufferB[0]; // æ¥æ”¶æ•°æ®ç´¯åŠ å’Œå‡å»å¤šå¸§æ•°æ®çš„lengthå­—è
             -Š‚
5012   4            }
5013   3            else // æ•°æ®å¸§ä¸ºå¤šå¸§ä¸­ç»§å¸§
5014   3            {
5015   4              length = 7;      // ç½®æ¥æ”¶æ•°æ®é•¿åº¦
5016   4              fgEndFrame = TRUE; // ç½®æ•°æ®åŒ…æ­£åœ¨æ¥æ”¶æ ‡å¿—
5017   4            }
5018   3      
5019   3            p = 0xC017;    // ç½®æ¥æ”¶æ•°æ®æŒ‡é’ˆ(ä¸åŒ…æ‹¬å¸§index)
5020   3                     //     if ((XBYTE[0xC014] != 0x5B) || (XBYTE[0xC016] == 0x00) || (XBYTE[0xC016] != receiveFrameB))
5021   3                     //     {
5022   3                     //       receiveSumB = 0; // ç´¯åŠ å’Œã€è®¡æ•°æ¸…é›¶
5023   3                     //       receiveCountB = 0;
5024   3                     //       receiveFrameB = 0;
5025   3                     //       length = 0;
5026   3                     //       // æ¸…é™¤æ•°æ®é•¿åº¦
5027   3                     //       if ((XBYTE[0xC014] == 0x5B) && (XBYTE[0xC016] == 0x00))
5028   3                     //       { // é¦–å¸§åˆ™ç½®æ¥æ”¶æ•°æ®é•¿åº¦
5029   3                     //         length = 7;
5030   3                     //       }
5031   3                     //     }
5032   3            receiveFrameB++; // å¤šå¸§è®¡æ•°å¢åŠ 
5033   3          }
5034   2      
5035   2          for (i = 0; i < length; i++) // æ¥æ”¶æ•°æ®(TITLE+DATA+SUM)å¹¶è®¡ç®—ç´¯åŠ å’Œ
5036   2          {
5037   3            receiveBufferB[receiveCountB] = *p;
5038   3            receiveSumB = receiveSumB + *p; // ç´¯åŠ å’Œè®¡ç®—(Title + Data + Sum)
5039   3            p++;
5040   3            receiveCountB++; // å­˜å‚¨DATAè®¡æ•°
5041   3          }
5042   2      
5043   2          if ((fgEndFrame == FALSE) && (receiveCountB > 0)) // åˆ¤æ–­ç»“æŸå¤„ç†
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 83  

5044   2          {
5045   3            receiveSumB = ((receiveSumB - receiveBufferB[receiveCountB - 1]) & 0x00FF); // è®¡ç®—ç´¯åŠ å’Œ
5046   3      
5047   3            if ((receiveSumB == receiveBufferB[receiveCountB - 1]) && (receiveCountB == (unsigned char)(receiveBuff
             -erB[0] + 3))) // åˆ¤æ–­æ•°æ®åŒ…çš„ç´¯åŠ å’Œä¸é•¿åº¦éƒ½æ­£ç¡®
5048   3            {
5049   4              errorCount = 0; // é€šè®¯é”™è¯¯è®¡æ•°æ¸…é›¶
5050   4              switch (receiveBufferB[1])
5051   4              {
5052   5              case 0x00: // è½®è¯¢æ§åˆ¶å¤„ç†
5053   5                if ((XBYTE[0xC014] == 0x9B) && (receiveBufferB[2] == 0x10))
5054   5                {
5055   6                  RsManageB();
5056   6                }
5057   5                break;
5058   5      
5059   5              case 0x40: // é—´æ¥æŒ‡ä»¤å¤„ç†
5060   5                if (XBYTE[0xC014] == 0x5B)
5061   5                {
5062   6                  ONOFFManageB();
5063   6                }
5064   5      
5065   5                if (XBYTE[0xC014] == 0x4F)
5066   5                {
5067   6                  TimeBcB();
5068   6                }
5069   5      
5070   5                break;
5071   5      
5072   5              case 0x60: // ä¸Šè¡Œå‚æ•°å—
5073   5                if (XBYTE[0xC014] == 0x5B)
5074   5                {
5075   6                  DataManageB();
5076   6                }
5077   5                break;
5078   5      
5079   5              case 0xD0: // é‡è¦æ•°æ®è¿”å›ï¼ˆæ¥æ”¶ï¼‰
5080   5                if (XBYTE[0xC014] == 0x9B)
5081   5                {
5082   6                  ImportantManageB();
5083   6                }
5084   5                break;
5085   5      
5086   5              case 0xE0: // å†…å­˜åœ°å€è®¾ç½®
5087   5                if (XBYTE[0xC014] == 0x5B)
5088   5                {
5089   6                  RamManageB();
5090   6                }
5091   5                break;
5092   5      
5093   5              default:
5094   5                break;
5095   5              }
5096   4            }
5097   3      
5098   3            receiveSumB = 0; // ç´¯åŠ å’Œæ¸…é›¶
5099   3            receiveCountB = 0;
5100   3            receiveFrameB = 0;
5101   3          }
5102   2        }
5103   1      
5104   1        XBYTE[0xC001] = 0x0C; // é‡Šæ”¾æ¥æ”¶ç¼“å­˜å™¨
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 84  

5105   1      }
5106          
5107          //*****************************************************************
5108          // å‡½æ•°åç§° : CANTXDA
5109          // åŠŸèƒ½æè¿° :
5110          // *****************************************************************
5111          void CANTXDA(void) using 1
5112          {
5113   1        unsigned char i;
5114   1      
5115   1        if (sendIndexA != sendFrameA) // åˆ¤æ–­åº”ç­”å¸§æ˜¯å¦å‘å®Œ
5116   1        {
5117   2          for (i = 0; i < 10; i++) // æ„æˆå‘é€å¸§
5118   2          {
5119   3            XBYTE[0xA00A + i] = *pSendA;
5120   3            pSendA++;
5121   3          }
5122   2          XBYTE[0xA001] = 0x01;
5123   2          sendIndexA++; // å‘é€å¸§ç´¢å¼•å·+1
5124   2        }
5125   1        else
5126   1        {
5127   2          sendIndexA = 1; // è®¾ç½®å‘é€ç»“æŸ
5128   2          sendFrameA = 1;
5129   2        }
5130   1      }
5131          
5132          //*****************************************************************
5133          // å‡½æ•°åç§° : CANTXDB
5134          // åŠŸèƒ½æè¿° :
5135          // *****************************************************************
5136          void CANTXDB(void) using 1
5137          {
5138   1        unsigned char i;
5139   1      
5140   1        if (sendIndexB != sendFrameB) // åˆ¤æ–­åº”ç­”å¸§æ˜¯å¦å‘å®Œ
5141   1        {
5142   2          for (i = 0; i < 10; i++) // æ„æˆå‘é€å¸§
5143   2          {
5144   3            XBYTE[0xC00A + i] = *pSendB;
5145   3            pSendB++;
5146   3          }
5147   2          XBYTE[0xC001] = 0x01;
5148   2          sendIndexB++; // å‘é€å¸§ç´¢å¼•å·+1
5149   2        }
5150   1        else
5151   1        {
5152   2          sendIndexB = 1; // è®¾ç½®å‘é€ç»“æŸ
5153   2          sendFrameB = 1;
5154   2        }
5155   1      }
5156          
5157          //*****************************************************************
5158          // å‡½æ•°åç§° : RsManageA
5159          // åŠŸèƒ½æè¿° :
5160          // *****************************************************************
5161          void RsManageA(void) using 1
5162          {
5163   1        unsigned char i;
5164   1        unsigned char sum;
5165   1        unsigned char xdata *p;
5166   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 85  

5167   1        fgCanBus = 0xAA; // è®¾ç½®Aæ€»çº¿æ ‡å¿—
5168   1      
5169   1        p = 0xA00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5170   1      
5171   1        switch (receiveBufferA[3]) // åˆ¤æ–­æ§åˆ¶è½®è¯¢æ•°æ®ç±»å‹
5172   1        {
5173   2        case 0x01:          // ç”µæºçŠ¶æ€é¥æµ‹å‚æ•°
5174   2          if (fgSwitch1 == FALSE) // åˆ‡æ¢Bç¼“å†²åŒºå‘é€
5175   2          {
5176   3            pSendA = &rsFrame1B[0];
5177   3          }
5178   2          else
5179   2          {
5180   3            pSendA = &rsFrame1A[0]; // åˆ‡æ¢Aç¼“å†²åŒºå‘é€
5181   3          }
5182   2      
5183   2          for (i = 0; i < 10; i++) // å†™å…¥å‘é€ç¼“å†²åŒº
5184   2          {
5185   3            *p = *pSendA;
5186   3            p++;
5187   3            pSendA++;
5188   3          }
5189   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5190   2          sendIndexA = 1;
5191   2          sendFrameA = 7; // 6å¸§é€Ÿå˜å‚æ•°
5192   2      
5193   2          break;
5194   2      
5195   2        case 0x02:          // ç”µæºç¼“å˜é¥æµ‹å‚æ•°
5196   2          if (fgSwitch2 == FALSE) // åˆ‡æ¢BåŒºå‘é€
5197   2          {
5198   3            pSendA = &rsFrame2B[0];
5199   3          }
5200   2          else
5201   2          {
5202   3            pSendA = &rsFrame2A[0]; // åˆ‡æ¢AåŒºå‘é€
5203   3          }
5204   2      
5205   2          for (i = 0; i < 10; i++) // å†™å…¥å‘é€ç¼“å†²åŒº
5206   2          {
5207   3            *p = *pSendA;
5208   3            p++;
5209   3            pSendA++;
5210   3          }
5211   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5212   2          sendIndexA = 1;
5213   2          sendFrameA = 17; // 22å¸§ç¼“å˜å‚æ•°
5214   2      
5215   2          break;
5216   2      
5217   2        case 0x03: //
5218   2          pSendA = &rsFrame3[0];
5219   2      
5220   2          for (i = 0; i < 10; i++)
5221   2          {
5222   3            *p = *pSendA;
5223   3            p++;
5224   3            pSendA++;
5225   3          }
5226   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5227   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5228   2          sendFrameA = 7;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 86  

5229   2          break;
5230   2      
5231   2        case 0x61: // RAMä¸‹ä¼ åŒ…
5232   2          pSendA = &rsRamFrame[0];
5233   2      
5234   2          for (i = 0; i < 10; i++)
5235   2          {
5236   3            *p = *pSendA;
5237   3            p++;
5238   3            pSendA++;
5239   3          }
5240   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5241   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5242   2          sendFrameA = 19;
5243   2          break;
5244   2      
5245   2        case 0x80: // é‡è¦æ•°æ®å‘é€
5246   2          pSendA = &rsImportantFrame[0];
5247   2      
5248   2          for (i = 0; i < 10; i++)
5249   2          {
5250   3            *p = *pSendA;
5251   3            p++;
5252   3            pSendA++;
5253   3          }
5254   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5255   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5256   2          sendFrameA = 32;
5257   2          break;
5258   2      
5259   2        case 0xC0: // æœåŠ¡è¯·æ±‚
5260   2          sum = 0;
5261   2      
5262   2          *p = 0x9B; //
5263   2          p++;
5264   2          *p = 0x44;
5265   2          p++;
5266   2          *p = 0x10;
5267   2          sum = sum + *p;
5268   2          p++;
5269   2      
5270   2          if (wrReqIndex != rdReqIndex) // æœ‰æœåŠ¡è¯·æ±‚æ—¶
5271   2          {
5272   3            *p = reqData[rdReqIndex];
5273   3            sum = sum + *p;
5274   3            p++;
5275   3            *p = reqData[rdReqIndex];
5276   3            sum = sum + *p;
5277   3            p++;
5278   3      
5279   3            reqData[rdReqIndex] = 0; // æ¸…é™¤æœåŠ¡è¯·æ±‚ç 
5280   3      
5281   3            rdReqIndex++; // è¯»ç´¢å¼•
5282   3            if (rdReqIndex > 11)
5283   3            {
5284   4              rdReqIndex = 0;
5285   4            }
5286   3          }
5287   2          else // è®¾ç½®æœåŠ¡è¯·æ±‚
5288   2          {
5289   3            *p = 0x55;
5290   3            sum = sum + *p;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 87  

5291   3            p++;
5292   3            *p = 0x55;
5293   3            sum = sum + *p;
5294   3            p++;
5295   3          }
5296   2      
5297   2          *p = sum;
5298   2      
5299   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5300   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5301   2          sendFrameA = 1;
5302   2          break;
5303   2      
5304   2        default:
5305   2          break;
5306   2        }
5307   1      }
5308          
5309          //*****************************************************************
5310          // å‡½æ•°åç§° : RsManageB
5311          // åŠŸèƒ½æè¿° :
5312          // *****************************************************************
5313          void RsManageB(void) using 1
5314          {
5315   1        unsigned char i;
5316   1        unsigned char sum;
5317   1        unsigned char xdata *p;
5318   1      
5319   1        fgCanBus = 0xBB; // è®¾ç½®Bæ€»çº¿æ ‡å¿—
5320   1      
5321   1        p = 0xC00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5322   1      
5323   1        switch (receiveBufferB[3]) // åˆ¤æ–­æ§åˆ¶è½®è¯¢æ•°æ®ç±»å‹
5324   1        {
5325   2        case 0x01:          // ç”µæºçŠ¶æ€é¥æµ‹å‚æ•°
5326   2          if (fgSwitch1 == FALSE) // åˆ‡æ¢Bç¼“å†²åŒºå‘é€
5327   2          {
5328   3            pSendB = &rsFrame1B[0];
5329   3          }
5330   2          else
5331   2          {
5332   3            pSendB = &rsFrame1A[0]; // åˆ‡æ¢Aç¼“å†²åŒºå‘é€
5333   3          }
5334   2      
5335   2          for (i = 0; i < 10; i++) // å†™å…¥å‘é€ç¼“å†²åŒº
5336   2          {
5337   3            *p = *pSendB;
5338   3            p++;
5339   3            pSendB++;
5340   3          }
5341   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5342   2          sendIndexB = 1;
5343   2          sendFrameB = 7; // 6å¸§é€Ÿå˜å‚æ•°
5344   2      
5345   2          break;
5346   2      
5347   2        case 0x02:          // ç”µæºç¼“å˜é¥æµ‹å‚æ•°
5348   2          if (fgSwitch2 == FALSE) // åˆ‡æ¢BåŒºå‘é€
5349   2          {
5350   3            pSendB = &rsFrame2B[0];
5351   3          }
5352   2          else
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 88  

5353   2          {
5354   3            pSendB = &rsFrame2A[0]; // åˆ‡æ¢AåŒºå‘é€
5355   3          }
5356   2      
5357   2          for (i = 0; i < 10; i++) // å†™å…¥å‘é€ç¼“å†²åŒº
5358   2          {
5359   3            *p = *pSendB;
5360   3            p++;
5361   3            pSendB++;
5362   3          }
5363   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5364   2          sendIndexB = 1;
5365   2          sendFrameB = 17; // 22å¸§ç¼“å˜å‚æ•°
5366   2      
5367   2          break;
5368   2      
5369   2        case 0x03: //
5370   2          pSendB = &rsFrame3[0];
5371   2      
5372   2          for (i = 0; i < 10; i++)
5373   2          {
5374   3            *p = *pSendB;
5375   3            p++;
5376   3            pSendB++;
5377   3          }
5378   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5379   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5380   2          sendFrameB = 7;
5381   2          break;
5382   2      
5383   2        case 0x61: // RAMä¸‹ä¼ åŒ…
5384   2          pSendB = &rsRamFrame[0];
5385   2      
5386   2          for (i = 0; i < 10; i++)
5387   2          {
5388   3            *p = *pSendB;
5389   3            p++;
5390   3            pSendB++;
5391   3          }
5392   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5393   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5394   2          sendFrameB = 19;
5395   2          break;
5396   2      
5397   2        case 0x80: // é‡è¦æ•°æ®å‘é€
5398   2          pSendB = &rsImportantFrame[0];
5399   2      
5400   2          for (i = 0; i < 10; i++)
5401   2          {
5402   3            *p = *pSendB;
5403   3            p++;
5404   3            pSendB++;
5405   3          }
5406   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5407   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5408   2          sendFrameB = 32;
5409   2          break;
5410   2      
5411   2        case 0xC0: // æœåŠ¡è¯·æ±‚
5412   2          sum = 0;
5413   2      
5414   2          *p = 0x9B; //
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 89  

5415   2          p++;
5416   2          *p = 0x44;
5417   2          p++;
5418   2          *p = 0x10;
5419   2          sum = sum + *p;
5420   2          p++;
5421   2      
5422   2          if (wrReqIndex != rdReqIndex) // æœ‰æœåŠ¡è¯·æ±‚æ—¶
5423   2          {
5424   3            *p = reqData[rdReqIndex];
5425   3            sum = sum + *p;
5426   3            p++;
5427   3            *p = reqData[rdReqIndex];
5428   3            sum = sum + *p;
5429   3            p++;
5430   3      
5431   3            reqData[rdReqIndex] = 0; // æ¸…é™¤æœåŠ¡è¯·æ±‚ç 
5432   3      
5433   3            rdReqIndex++; // è¯»ç´¢å¼•
5434   3            if (rdReqIndex > 11)
5435   3            {
5436   4              rdReqIndex = 0;
5437   4            }
5438   3          }
5439   2          else // è®¾ç½®æœåŠ¡è¯·æ±‚
5440   2          {
5441   3            *p = 0x55;
5442   3            sum = sum + *p;
5443   3            p++;
5444   3            *p = 0x55;
5445   3            sum = sum + *p;
5446   3            p++;
5447   3          }
5448   2      
5449   2          *p = sum;
5450   2      
5451   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5452   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5453   2          sendFrameB = 1;
5454   2          break;
5455   2      
5456   2        default:
5457   2          break;
5458   2        }
5459   1      }
5460          
5461          //*****************************************************************
5462          // å‡½æ•°åç§° : ONOFFManageA
5463          // åŠŸèƒ½æè¿° :
5464          // *****************************************************************
5465          void ONOFFManageA(void) using 1
5466          {
5467   1        unsigned char xdata *p;
5468   1      
5469   1        if ((receiveBufferA[2] == 0x01) && (receiveBufferA[3] == 0x1B) && (receiveBufferA[4] == 0x2A) && (receive
             -BufferA[5] == 0x02)) // æŒ‡ä»¤æ ‡è¯†åˆ¤æ–­
5470   1        {
5471   2          p = 0xA00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5472   2      
5473   2          *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5474   2          p++;
5475   2          *p = 0x44;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 90  

5476   2          p++;
5477   2          *p = 0x10;
5478   2          p++;
5479   2          *p = 0xFF;
5480   2          p++;
5481   2          *p = 0x40;
5482   2          p++;
5483   2          *p = 0x4F;
5484   2      
5485   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5486   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5487   2          sendFrameA = 1;
5488   2      
5489   2          onoffBuffer[wrOnoffIndex][0] = receiveBufferA[6]; // è¯»å–æœ‰æ•ˆæŒ‡ä»¤ç 
5490   2          onoffBuffer[wrOnoffIndex][1] = receiveBufferA[7]; // è¯»å–æœ‰æ•ˆæŒ‡ä»¤ç 
5491   2      
5492   2          wrOnoffIndex++;
5493   2          if (wrOnoffIndex >= 24) // æŒ‡ä»¤ç¼“å­˜ 24æ¡
5494   2          {
5495   3            wrOnoffIndex = 0;
5496   3          }
5497   2        }
5498   1      }
5499          
5500          //*****************************************************************
5501          // å‡½æ•°åç§° : ONOFFManageB
5502          // åŠŸèƒ½æè¿° :
5503          // *****************************************************************
5504          void ONOFFManageB(void) using 1
5505          {
5506   1        unsigned char xdata *p;
5507   1      
5508   1        if ((receiveBufferB[2] == 0x01) && (receiveBufferB[3] == 0x1B) && (receiveBufferB[4] == 0x2A) && (receive
             -BufferB[5] == 0x02)) // æŒ‡ä»¤æ ‡è¯†åˆ¤æ–­
5509   1        {
5510   2          p = 0xC00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5511   2      
5512   2          *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5513   2          p++;
5514   2          *p = 0x44;
5515   2          p++;
5516   2          *p = 0x10;
5517   2          p++;
5518   2          *p = 0xFF;
5519   2          p++;
5520   2          *p = 0x40;
5521   2          p++;
5522   2          *p = 0x4F;
5523   2      
5524   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5525   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5526   2          sendFrameB = 1;
5527   2      
5528   2          onoffBuffer[wrOnoffIndex][0] = receiveBufferB[6]; // è¯»å–æœ‰æ•ˆæŒ‡ä»¤ç 
5529   2          onoffBuffer[wrOnoffIndex][1] = receiveBufferB[7]; // è¯»å–æœ‰æ•ˆæŒ‡ä»¤ç 
5530   2      
5531   2          wrOnoffIndex++;
5532   2          if (wrOnoffIndex >= 24) // æŒ‡ä»¤ç¼“å­˜ 24æ¡
5533   2          {
5534   3            wrOnoffIndex = 0;
5535   3          }
5536   2        }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 91  

5537   1      }
5538          
5539          //*****************************************************************
5540          // å‡½æ•°åç§° : DataManageA
5541          // åŠŸèƒ½æè¿° :
5542          // *****************************************************************
5543          void DataManageA(void) using 1
5544          {
5545   1        //  unsigned char i;
5546   1        unsigned char xdata *p;
5547   1      
5548   1        if ((receiveBufferA[2] == 0x4A) && (receiveBufferA[3] == 0x01)) // æŒ‡ä»¤æ ‡è¯†åˆ¤æ–­
5549   1        {
5550   2      
5551   2          p = 0xA00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5552   2      
5553   2          *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5554   2          p++;
5555   2          *p = 0x44;
5556   2          p++;
5557   2          *p = 0x10;
5558   2          p++;
5559   2          *p = 0xFF;
5560   2          p++;
5561   2          *p = 0x60;
5562   2          p++;
5563   2          *p = 0x6F;
5564   2      
5565   2          XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5566   2          sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5567   2          sendFrameA = 1;
5568   2      
5569   2          uploadParaData[0] = receiveBufferA[4]; // æ›´æ–°å‚æ•°
5570   2          uploadParaData[1] = receiveBufferA[5];
5571   2          uploadParaData[2] = receiveBufferA[6];
5572   2          uploadParaData[3] = receiveBufferA[7];
5573   2      
5574   2          fgUploadPara = TRUE; // è®¾ç½®å‚æ•°ä¸Šæ³¨è¯·æ±‚
5575   2        }
5576   1      }
5577          
5578          //*****************************************************************
5579          // å‡½æ•°åç§° : DataManageB
5580          // åŠŸèƒ½æè¿° :
5581          // *****************************************************************
5582          void DataManageB(void) using 1
5583          {
5584   1        //  unsigned char i;
5585   1        unsigned char xdata *p;
5586   1      
5587   1        if ((receiveBufferB[2] == 0x4A) && (receiveBufferB[3] == 0x01)) // æŒ‡ä»¤æ ‡è¯†åˆ¤æ–­
5588   1        {
5589   2      
5590   2          p = 0xC00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5591   2      
5592   2          *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5593   2          p++;
5594   2          *p = 0x44;
5595   2          p++;
5596   2          *p = 0x10;
5597   2          p++;
5598   2          *p = 0xFF;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 92  

5599   2          p++;
5600   2          *p = 0x60;
5601   2          p++;
5602   2          *p = 0x6F;
5603   2      
5604   2          XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5605   2          sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5606   2          sendFrameB = 1;
5607   2      
5608   2          uploadParaData[0] = receiveBufferB[4]; // æ›´æ–°å‚æ•°
5609   2          uploadParaData[1] = receiveBufferB[5];
5610   2          uploadParaData[2] = receiveBufferB[6];
5611   2          uploadParaData[3] = receiveBufferB[7];
5612   2      
5613   2          fgUploadPara = TRUE; // è®¾ç½®å‚æ•°ä¸Šæ³¨è¯·æ±‚
5614   2        }
5615   1      }
5616          
5617          //*****************************************************************
5618          // å‡½æ•°åç§° : RamManageA
5619          // åŠŸèƒ½æè¿° :
5620          // *****************************************************************
5621          void RamManageA(void) using 1
5622          {
5623   1        unsigned char i;
5624   1        unsigned char xdata *p;
5625   1      
5626   1        p = 0xA00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5627   1      
5628   1        *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5629   1        p++;
5630   1        *p = 0x44;
5631   1        p++;
5632   1        *p = 0x10;
5633   1        p++;
5634   1        *p = 0xFF;
5635   1        p++;
5636   1        *p = 0xE0;
5637   1        p++;
5638   1        *p = 0xEF;
5639   1      
5640   1        XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5641   1        sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5642   1        sendFrameA = 1;
5643   1      
5644   1        for (i = 0; i < 8; i++) // åœ°å€è®¾ç½®ä¿¡æ¯æ•°æ®(8byte)
5645   1        {
5646   2          ramUploadData[i] = receiveBufferA[2 + i];
5647   2        }
5648   1      
5649   1        fgRsRam = TRUE; // è®¾ç½®åœ°å€å¤„ç†è¯·æ±‚æœ‰æ•ˆ
5650   1      }
5651          
5652          //*****************************************************************
5653          // å‡½æ•°åç§° : RamManageB
5654          // åŠŸèƒ½æè¿° :
5655          // *****************************************************************
5656          void RamManageB(void) using 1
5657          {
5658   1        unsigned char i;
5659   1        unsigned char xdata *p;
5660   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 93  

5661   1        p = 0xC00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5662   1      
5663   1        *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5664   1        p++;
5665   1        *p = 0x44;
5666   1        p++;
5667   1        *p = 0x10;
5668   1        p++;
5669   1        *p = 0xFF;
5670   1        p++;
5671   1        *p = 0xE0;
5672   1        p++;
5673   1        *p = 0xEF;
5674   1      
5675   1        XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5676   1        sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5677   1        sendFrameB = 1;
5678   1      
5679   1        for (i = 0; i < 8; i++) // åœ°å€è®¾ç½®ä¿¡æ¯æ•°æ®(8byte)
5680   1        {
5681   2          ramUploadData[i] = receiveBufferB[2 + i];
5682   2        }
5683   1      
5684   1        fgRsRam = TRUE; // è®¾ç½®åœ°å€å¤„ç†è¯·æ±‚æœ‰æ•ˆ
5685   1      }
5686          
5687          //*****************************************************************
5688          // å‡½æ•°åç§° : ImportantManageA
5689          // åŠŸèƒ½æè¿° :
5690          // *****************************************************************
5691          void ImportantManageA(void) using 1
5692          {
5693   1        unsigned char i;
5694   1        unsigned char xdata *p;
5695   1      
5696   1        p = 0xA00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5697   1      
5698   1        *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5699   1        p++;
5700   1        *p = 0x44;
5701   1        p++;
5702   1        *p = 0x10;
5703   1        p++;
5704   1        *p = 0xFF;
5705   1        p++;
5706   1        *p = 0xC0;
5707   1        p++;
5708   1        *p = 0xCF;
5709   1      
5710   1        XBYTE[0xA001] = 0x01; // å¯åŠ¨å‘é€å¸§
5711   1        sendIndexA = 1;     // æ„æˆå‘é€ä¿¡æ¯
5712   1        sendFrameA = 1;
5713   1      
5714   1        for (i = 0; i < 220; i++) // è¯»å–é‡è¦æ•°æ®
5715   1        {
5716   2          rsImportantData[i] = receiveBufferA[2 + i];
5717   2        }
5718   1        fgImportantDataRx = TRUE; // é‡è¦æ•°æ®æ¢å¤æœ‰æ•ˆæ ‡å¿—
5719   1      }
5720          
5721          //*****************************************************************
5722          // å‡½æ•°åç§° : ImportantManageB
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 94  

5723          // åŠŸèƒ½æè¿° :
5724          // *****************************************************************
5725          void ImportantManageB(void) using 1
5726          {
5727   1        unsigned char i;
5728   1        unsigned char xdata *p;
5729   1      
5730   1        p = 0xC00A; // æŒ‡å‘CANæ€»çº¿å‘é€ç¼“å†²åŒº
5731   1      
5732   1        *p = 0x5B; // æŒ‡ä»¤åº”ç­”ç 
5733   1        p++;
5734   1        *p = 0x44;
5735   1        p++;
5736   1        *p = 0x10;
5737   1        p++;
5738   1        *p = 0xFF;
5739   1        p++;
5740   1        *p = 0xC0;
5741   1        p++;
5742   1        *p = 0xCF;
5743   1      
5744   1        XBYTE[0xC001] = 0x01; // å¯åŠ¨å‘é€å¸§
5745   1        sendIndexB = 1;     // æ„æˆå‘é€ä¿¡æ¯
5746   1        sendFrameB = 1;
5747   1      
5748   1        for (i = 0; i < 220; i++) // è¯»å–é‡è¦æ•°æ®
5749   1        {
5750   2          rsImportantData[i] = receiveBufferB[2 + i];
5751   2        }
5752   1        fgImportantDataRx = TRUE; // é‡è¦æ•°æ®æ¢å¤æœ‰æ•ˆæ ‡å¿—
5753   1      }
5754          
5755          //*****************************************************************
5756          // å‡½æ•°åç§° : TimeBcA
5757          // åŠŸèƒ½æè¿° : ä»…è¯»å–ç§’
5758          // *****************************************************************
5759          void TimeBcA(void) using 1
5760          {
5761   1        sysTime = (unsigned long)(receiveBufferA[3] << 24) | (unsigned long)(receiveBufferA[4] << 16) | (unsigned
             - long)(receiveBufferA[5] << 8) | (unsigned long)(receiveBufferA[6]);
5762   1      }
5763          
5764          //*****************************************************************
5765          // å‡½æ•°åç§° : TimeBcB
5766          // åŠŸèƒ½æè¿° : ä»…è¯»å–ç§’
5767          // *****************************************************************
5768          void TimeBcB(void) using 1
5769          {
5770   1        sysTime = (unsigned long)(receiveBufferB[3] << 24) | (unsigned long)(receiveBufferB[4] << 16) | (unsigned
             - long)(receiveBufferB[5] << 8) | (unsigned long)(receiveBufferB[6]);
5771   1      }
5772          
5773          //*****************************************************************
5774          // å‡½æ•°åç§° : TIMER_ISR
5775          // åŠŸèƒ½æè¿° :
5776          // *****************************************************************
5777          void TIMER_ISR(void) interrupt 1 using 2
5778          {
5779   1        TR0 = 0;  // å®šæ—¶å™¨é‡æ–°è®¡æ•°
5780   1        TH0 = 0xB8; // è£…è½½æ–°å€¼
5781   1        TL0 = 0x00;
5782   1        TR0 = 1;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 95  

5783   1      
5784   1        clockCount++; // æ—¶é’Ÿè®¡æ•°
5785   1      }
5786          
5787          //*****************************************************************
5788          // å‡½æ•°åç§° : CANInfoA
5789          // åŠŸèƒ½æè¿° :
5790          // *****************************************************************
5791          void CANInfoA(void)
5792          {
5793   1        unsigned int i;
5794   1      
5795   1        sendIndexA = 0; // å˜é‡æ¸…é›¶
5796   1        receiveFrameA = 0;
5797   1        sendFrameA = 0;
5798   1        receiveSumA = 0;
5799   1        receiveCountA = 0;
5800   1      
5801   1        for (i = 0; i < 256; i++)
5802   1        {
5803   2          receiveBufferA[i] = 0x00; //   æ¸…é›¶
5804   2        }
5805   1      }
5806          
5807          //*****************************************************************
5808          // å‡½æ•°åç§° : CANInfoB
5809          // åŠŸèƒ½æè¿° :
5810          // *****************************************************************
5811          void CANInfoB(void)
5812          {
5813   1        unsigned int i;
5814   1      
5815   1        sendIndexB = 0; // å˜é‡æ¸…é›¶
5816   1        receiveFrameB = 0;
5817   1        sendFrameB = 0;
5818   1        receiveSumB = 0;
5819   1        receiveCountB = 0;
5820   1      
5821   1        for (i = 0; i < 256; i++)
5822   1        {
5823   2          receiveBufferB[i] = 0x00; //   æ¸…é›¶
5824   2        }
5825   1      }
5826          
5827          //*****************************************************************
5828          // å‡½æ•°åç§° : SepCurrentStateCal
5829          // åŠŸèƒ½æè¿° :
5830          // *****************************************************************
5831          unsigned char SepCurrentStateCal(unsigned int val)
5832          {
5833   1        float xdata valTemp;
5834   1        unsigned char stateVal;
5835   1      
5836   1        valTemp = (float)((float)val * 0.0025); // è®¡ç®—ç”µå‹å€¼
5837   1        stateVal = 0xFF;            // é»˜è®¤å¡«å…… 0xFF
5838   1      
5839   1        if (valTemp < 0.5) // 0-0.5  04H
5840   1        {
5841   2          stateVal = 0x04;
5842   2        }
5843   1      
5844   1        if ((valTemp < 1.5) && (valTemp >= 0.7)) // 0.7-1.7  03H
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 96  

5845   1        {
5846   2          stateVal = 0x03;
5847   2        }
5848   1      
5849   1        if ((valTemp < 2.5) && (valTemp >= 1.7)) // 1.7-2.5  02H
5850   1        {
5851   2          stateVal = 0x02;
5852   2        }
5853   1      
5854   1        if ((valTemp < 3.5) && (valTemp >= 2.7)) // 2.7-3.5  01H
5855   1        {
5856   2          stateVal = 0x01;
5857   2        }
5858   1      
5859   1        if ((valTemp < 4.5) && (valTemp >= 3.7)) // 2.7-3.5  01H
5860   1        {
5861   2          stateVal = 0x00;
5862   2        }
5863   1      
5864   1        return (stateVal);
5865   1      }
5866          
5867          //*****************************************************************
5868          // å‡½æ•°åç§° : ImportantDataRx
5869          // åŠŸèƒ½æè¿° : é‡è¦æ•°æ®å‘¨æœŸæ¥æ”¶å¤„ç†
5870          // *****************************************************************
5871          void ImportantDataRx(void)
5872          {
5873   1        unsigned int i;
5874   1        unsigned int j;
5875   1      
5876   1        for (j = 0; j < 3; j++) // æœ€å¤šè¿ç»­ä¸‰æ¬¡æœåŠ¡è¯·æ±‚
5877   1        {
5878   2          reqData[wrReqIndex] = 0xA3; // è®¾ç½®é‡è¦æ•°æ®æ¢å¤è¯·æ±‚
5879   2          wrReqIndex++;       // è¯»ç´¢å¼•
5880   2          if (wrReqIndex > 11)
5881   2          {
5882   3            wrReqIndex = 0;
5883   3          }
5884   2      
5885   2          for (i = 0; i < 150; i++) // å»¶æ—¶ä¿è¯é‡è¦æ•°æ®æ¢å¤  å¾…æµ‹è¯•æ—¶é—´é—´éš”
5886   2          {
5887   3            dog = !dog; // ç‰µç‹—
5888   3            Delay(2000);
5889   3          }
5890   2      
5891   2          if (fgImportantDataRx == TRUE) // é‡è¦æ•°æ®æœ‰æ•ˆæ¢å¤
5892   2          {
5893   3            fgImportantDataRx = FALSE; // æ¸…é™¤é‡è¦æ•°æ®æ¢å¤è¯·æ±‚
5894   3            ImportDataFlush();       // é‡è¦æ•°æ®åˆ·æ–°
5895   3          }
5896   2      
5897   2          if (importDataRxState == 0x0F) // é‡è¦æ•°æ®æ¢å¤æˆåŠŸ
5898   2          {
5899   3            break;
5900   3          }
5901   2        }
5902   1      
5903   1        if (importDataRxState == 0x00) // é‡è¦æ•°æ®æ¢å¤å¤±è´¥
5904   1        {
5905   2          AutoOnoff(); // è¿›è¡Œé»˜è®¤çŠ¶æ€ä¸‹çš„æŒ‡ä»¤åˆå§‹è®¾ç½®
5906   2        }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 97  

5907   1      
5908   1        clockCount = 0; // å¢åŠ æ—¶é—´å˜é‡æ¸…é›¶æ“ä½œ
5909   1      }
5910          
5911          //*************************************************************************************
5912          // å‡½æ•°ä»‹ç»: ImportDataFlush
5913          // åŠŸèƒ½æè¿°: é‡è¦æ•°æ®æ¢å¤æ›´æ–°
5914          // ä¿®æ”¹è®°å½•:
5915          //*************************************************************************************
5916          void ImportDataFlush(void)
5917          {
5918   1        unsigned char i;
5919   1        unsigned char sum;    // æ ¡éªŒå’Œ
5920   1        unsigned char fgZero; // éå…¨é›¶æ ‡å¿—
5921   1      
5922   1        fgZero = FALSE; // é»˜è®¤ä¸ºéå…¨é›¶
5923   1      
5924   1        sum = 0;
5925   1        for (i = 0; i < 43; i++) // WORD -> BYTE
5926   1        {
5927   2          sum = sum + rsImportantData[i];
5928   2          if (rsImportantData[i] != 0) // å­˜åœ¨éé›¶æ•°æ®
5929   2          {
5930   3            fgZero = TRUE; // è®¾ç½®éå…¨é›¶æœ‰æ•ˆ
5931   3          }
5932   2        }
5933   1      
5934   1        if ((sum == rsImportantData[43]) && (fgZero == TRUE)) // æ ¡éªŒå’Œä¸€è‡´ ä¸” éå…¨é›¶
5935   1        {
5936   2          importDataRxState = 0x0F; // é‡è¦æ•°æ®æ¢å¤çŠ¶æ€  æˆåŠŸ
5937   2      
5938   2          if ((rsImportantData[0] & 0x80) == 0x80) // W0 - bit7  å‡è¡¡æ§åˆ¶ä½¿èƒ½çŠ¶æ€
5939   2          {
5940   3            equControlEn = TRUE; // ä½¿èƒ½æœ‰æ•ˆ
5941   3            equControlEnB = TRUE;
5942   3            equControlEnC = TRUE;
5943   3          }
5944   2          else
5945   2          {
5946   3            equControlEn = FALSE; // ä½¿èƒ½æ— æ•ˆ
5947   3            equControlEnB = FALSE;
5948   3            equControlEnC = FALSE;
5949   3          }
5950   2      
5951   2          if ((rsImportantData[0] & 0x40) == 0x40) // W0 - bit6  è“„ç”µæ± ç»„è¿‡å……ä¿æŠ¤ä½¿èƒ½çŠ¶æ€
5952   2          {
5953   3            overChargeProtectEn = TRUE;  // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—A
5954   3            overChargeProtectEnB = TRUE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—B
5955   3            overChargeProtectEnC = TRUE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—C
5956   3          }
5957   2          else
5958   2          {
5959   3            overChargeProtectEn = FALSE;  // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—A
5960   3            overChargeProtectEnB = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—B
5961   3            overChargeProtectEnC = FALSE; // è¿‡å……ä¿æŠ¤å…è®¸æ ‡å¿—C
5962   3          }
5963   2      
5964   2          if ((rsImportantData[0] & 0x20) == 0x20) // W0 - bit5  è“„ç”µæ± å•ä½“ä¿æŠ¤å……ç”µä½¿èƒ½çŠ¶æ€
5965   2          {
5966   3            singleProtectChargeEn = TRUE;  //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€
5967   3            singleProtectChargeEnB = TRUE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B
5968   3            singleProtectChargeEnC = TRUE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 98  

5969   3          }
5970   2          else
5971   2          {
5972   3            singleProtectChargeEn = FALSE;  //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€
5973   3            singleProtectChargeEnB = FALSE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€B
5974   3            singleProtectChargeEnC = FALSE; //å•ä½“ä¿æŠ¤ä½¿èƒ½çŠ¶æ€C
5975   3          }
5976   2      
5977   2          chargeVolKickA = rsImportantData[1]; // Aç»„å……ç”µé™å‹æ¡£æ•°
5978   2          chargeVolKickA_B = rsImportantData[1];
5979   2          chargeVolKickA_C = rsImportantData[1];
5980   2      
5981   2          chargeVolKickB = rsImportantData[2]; // Bç»„å……ç”µé™å‹æ¡£æ•°
5982   2          chargeVolKickB_B = rsImportantData[2];
5983   2          chargeVolKickB_C = rsImportantData[2];
5984   2      
5985   2          chargeVolKickRsA = chargeVolKickA; // å……ç”µåˆ‡æ¢æ¡£ä½A  é¥æµ‹ä½¿ç”¨
5986   2          chargeVolKickRsB = chargeVolKickB; // å……ç”µåˆ‡æ¢æ¡£ä½B  é¥æµ‹ä½¿ç”¨
5987   2      
5988   2          chargeCurKickA = rsImportantData[3]; // Aç»„å……ç”µç”µæµæ¡£æ•°
5989   2          chargeCurKickA_B = rsImportantData[3];
5990   2          chargeCurKickA_C = rsImportantData[3];
5991   2      
5992   2          chargeCurKickB = rsImportantData[4]; // Bç»„å……ç”µç”µæµæ¡£æ•°
5993   2          chargeCurKickB_B = rsImportantData[4];
5994   2          chargeCurKickB_C = rsImportantData[4];
5995   2      
5996   2          DA_A_VOL = volCsTab[chargeVolKickA - 1]; // Aç»„ç”µå‹ æ¢å¤æ‰§è¡Œ
5997   2          DA_A_CUR = curCsTab[chargeCurKickA - 1]; // Aç»„ç”µæµ
5998   2          DA_B_VOL = volCsTab[chargeVolKickB - 1]; // Bç»„ç”µå‹ æ¢å¤æ‰§è¡Œ
5999   2          DA_B_CUR = curCsTab[chargeCurKickB - 1]; // Bç»„ç”µæµ
6000   2      
6001   2          ntrPower = (float)((float)((unsigned int)(rsImportantData[5] * 256) + rsImportantData[6]) * 3.0 / 1000.0
             -); // NTR æ»¡ç”µé‡å€¼æ¢å¤
6002   2          ntrPowerB = (float)((float)((unsigned int)(rsImportantData[5] * 256) + rsImportantData[6]) * 3.0 / 1000.
             -0);
6003   2          ntrPowerC = (float)((float)((unsigned int)(rsImportantData[5] * 256) + rsImportantData[6]) * 3.0 / 1000.
             -0);
6004   2      
6005   2          currentPower = ntrPower; // NTRæ›´æ–°å½“å‰ç”µé‡
6006   2      
6007   2          powerSave[0] = (unsigned char)((unsigned int)((ntrPower * 1000) / 3.0) >> 8); // å–å½“å‰ç”µé‡çš„é«˜å­
             -—èŠ‚ -A  æ›´æ–°æ»¡ç”µé‡å€¼
6008   2          powerSave[1] = (unsigned char)((unsigned int)((ntrPower * 1000) / 3.0) & 0xFF); // å–å½“å‰ç”µé‡çš„ä½
             -å­—èŠ‚
6009   2          powerSave[2] = 0;
6010   2          powerSave[3] = 0;
6011   2          powerSave[4] = 0;
6012   2          powerSave[5] = 0;
6013   2      
6014   2          proportion = rsImportantData[8]; // è“„ç”µæ± ç»„ å……æ”¾æ¯” ä½¿ç”¨åŒå­—èŠ‚ ä½ä½
6015   2          proportionB = rsImportantData[8];
6016   2          proportionC = rsImportantData[8];
6017   2      
6018   2          aqStateContrl = (unsigned int)((unsigned int)(rsImportantData[9] * 256) + rsImportantData[10]); // å•ä½
             -“æ§åˆ¶å­—
6019   2      
6020   2          healthStateContr1 = (unsigned int)((unsigned int)(rsImportantData[11] * 256) + rsImportantData[12]); // 
             -å¥åº·æ§åˆ¶å­—1
6021   2          healthStateContr1B = (unsigned int)((unsigned int)(rsImportantData[11] * 256) + rsImportantData[12]);
6022   2          healthStateContr1C = (unsigned int)((unsigned int)(rsImportantData[11] * 256) + rsImportantData[12]);
6023   2      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 99  

6024   2          healthStateContr2 = (unsigned int)((unsigned int)(rsImportantData[13] * 256) + rsImportantData[14]); // 
             -å¥åº·æ§åˆ¶å­—4
6025   2          healthStateContr2B = (unsigned int)((unsigned int)(rsImportantData[13] * 256) + rsImportantData[14]);
6026   2          healthStateContr2C = (unsigned int)((unsigned int)(rsImportantData[13] * 256) + rsImportantData[14]);
6027   2      
6028   2          selfCheckStateContrl = rsImportantData[15]; // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—
6029   2          selfCheckStateContrlB = rsImportantData[15];
6030   2          selfCheckStateContrlC = rsImportantData[15];
6031   2      
6032   2          equOpenValue = (float)((float)((unsigned int)(rsImportantData[16] * 256) + rsImportantData[17]) / 1000.0
             -);  // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼A
6033   2          equOpenValueB = (float)((float)((unsigned int)(rsImportantData[16] * 256) + rsImportantData[17]) / 1000.
             -0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼B
6034   2          equOpenValueC = (float)((float)((unsigned int)(rsImportantData[16] * 256) + rsImportantData[17]) / 1000.
             -0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼C
6035   2      
6036   2          equCloseValue = (float)((float)((unsigned int)(rsImportantData[18] * 256) + rsImportantData[19]) / 1000.
             -0);   // å‡è¡¡å…³é—­ç”µå‹é—¨é™å€¼A
6037   2          equCloseValueB = (float)((float)((unsigned int)(rsImportantData[18] * 256) + rsImportantData[19]) / 1000
             -.0); // å‡è¡¡å…³é—­ç”µå‹é—¨é™å€¼B
6038   2          equCloseValueC = (float)((float)((unsigned int)(rsImportantData[18] * 256) + rsImportantData[19]) / 1000
             -.0); // å‡è¡¡å…³é—­ç”µå‹é—¨é™å€¼C
6039   2      
6040   2          singleVWardValueUP = (float)((float)((unsigned int)(rsImportantData[20] * 256) + rsImportantData[21]) / 
             -100.0);   // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A
6041   2          singleVWardValueUPB = (float)((float)((unsigned int)(rsImportantData[20] * 256) + rsImportantData[21]) /
             - 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B
6042   2          singleVWardValueUPC = (float)((float)((unsigned int)(rsImportantData[20] * 256) + rsImportantData[21]) /
             - 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C
6043   2      
6044   2          singleVWardValueDOWN = (float)((float)((unsigned int)(rsImportantData[22] * 256) + rsImportantData[23]) 
             -/ 100.0);  // å•ä½“ç”µå‹ä¸‹é™æŠ¥è­¦å€¼A
6045   2          singleVWardValueDOWNB = (float)((float)((unsigned int)(rsImportantData[22] * 256) + rsImportantData[23])
             - / 100.0); // å•ä½“ç”µå‹ä¸‹é™æŠ¥è­¦å€¼B
6046   2          singleVWardValueDOWNC = (float)((float)((unsigned int)(rsImportantData[22] * 256) + rsImportantData[23])
             - / 100.0); // å•ä½“ç”µå‹ä¸‹é™æŠ¥è­¦å€¼C
6047   2      
6048   2          singleVProtectValueUP = (float)((float)((unsigned int)(rsImportantData[24] * 256) + rsImportantData[25])
             - / 100.0);  // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A
6049   2          singleVProtectValueUPB = (float)((float)((unsigned int)(rsImportantData[24] * 256) + rsImportantData[25]
             -) / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B
6050   2          singleVProtectValueUPC = (float)((float)((unsigned int)(rsImportantData[24] * 256) + rsImportantData[25]
             -) / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C
6051   2      
6052   2          batteryVAWardValueUP = (float)((float)((unsigned int)(rsImportantData[26] * 256) + rsImportantData[27]) 
             -/ 100.0);  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A
6053   2          batteryVAWardValueUPB = (float)((float)((unsigned int)(rsImportantData[26] * 256) + rsImportantData[27])
             - / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B
6054   2          batteryVAWardValueUPC = (float)((float)((unsigned int)(rsImportantData[26] * 256) + rsImportantData[27])
             - / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C
6055   2      
6056   2          batteryVAWardValueDOWN = (float)((float)((unsigned int)(rsImportantData[28] * 256) + rsImportantData[29]
             -) / 100.0);   // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼A
6057   2          batteryVAWardValueDOWNB = (float)((float)((unsigned int)(rsImportantData[28] * 256) + rsImportantData[29
             -]) / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼B
6058   2          batteryVAWardValueDOWNC = (float)((float)((unsigned int)(rsImportantData[28] * 256) + rsImportantData[29
             -]) / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™ä¿æŠ¤å€¼C
6059   2      
6060   2          for (i = 0; i < 9; i++) // å•ä½“å‡è¡¡æ¬¡æ•°
6061   2          {
6062   3            equExeCount[i] = rsImportantData[34 + i];
6063   3          }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 100 

6064   2        }
6065   1        else
6066   1        {
6067   2          importDataRxState = 0x00; // é‡è¦æ•°æ®æ¢å¤çŠ¶æ€  å¤±è´¥
6068   2        }
6069   1      }
6070          
6071          //*****************************************************************
6072          // å‡½æ•°åç§° : ImportantDataTx
6073          // åŠŸèƒ½æè¿° : é‡è¦æ•°æ®å‘¨æœŸå‘é€å¤„ç†-- 16sé—´éš” *
6074          // ****************************************************************
6075          void ImportantDataTx(void)
6076          {
6077   1        fg16S++;
6078   1        if (fg16S > 15) // 16ç§’å‘¨æœŸ
6079   1        {
6080   2          fg16S = 0;
6081   2      
6082   2          ImportantSaveData(&rsImportantData[0]); // é‡è¦æ•°æ®ç¼“å­˜æ›´æ–°
6083   2          SaveImportantDataRs();          // é‡è¦æ•°æ®ç»„å¸§æ›´æ–°
6084   2      
6085   2          reqData[wrReqIndex] = 0xA0; // è®¾ç½®è¿‡æ»¤åŒ…ç´¢å–
6086   2          wrReqIndex++;       // è¯»ç´¢å¼•
6087   2          if (wrReqIndex > 11)
6088   2          {
6089   3            wrReqIndex = 0;
6090   3          }
6091   2        }
6092   1      }
6093          
6094          //*****************************************************************
6095          // å‡½æ•°åç§° : FilterSaveData
6096          // åŠŸèƒ½æè¿° :
6097          // *****************************************************************
6098          void ImportantSaveData(unsigned char xdata *pRs)
6099          {
6100   1        unsigned char i;
6101   1        unsigned char sum;
6102   1        unsigned char state;
6103   1      
6104   1        state = 0;
6105   1        if (equControlEn == TRUE) // å‡è¡¡æ§åˆ¶ä½¿èƒ½  bit7
6106   1        {
6107   2          state = state | 0x80;
6108   2        }
6109   1        if (overChargeProtectEn == TRUE) // è¿‡å……ä¿æŠ¤ä½¿èƒ½  bit6
6110   1        {
6111   2          state = state | 0x40;
6112   2        }
6113   1        if (singleProtectChargeEn == TRUE) // å•ä½“ä¿æŠ¤å……ç”µçŠ¶æ€  bit5
6114   1        {
6115   2          state = state | 0x20;
6116   2        }
6117   1      
6118   1        sum = 0; // ç´¯åŠ å’Œæ¸…é›¶
6119   1      
6120   1        *pRs = state; // çŠ¶æ€  W0
6121   1        sum = sum + *pRs;
6122   1        pRs++;
6123   1      
6124   1        *pRs = chargeVolKickRsA; // Aç»„å……ç”µé™å‹æ¡£æ•°  W1
6125   1        sum = sum + *pRs;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 101 

6126   1        pRs++;
6127   1        *pRs = chargeVolKickRsB; // Bç»„å……ç”µé™å‹æ¡£æ•°  W2
6128   1        sum = sum + *pRs;
6129   1        pRs++;
6130   1        *pRs = chargeCurKickA; // Aç»„å……ç”µç”µæµæ¡£æ•°  W3
6131   1        sum = sum + *pRs;
6132   1        pRs++;
6133   1        *pRs = chargeCurKickB; // Bç»„å……ç”µç”µæµæ¡£æ•°  W4
6134   1        sum = sum + *pRs;
6135   1        pRs++;
6136   1      
6137   1        *pRs = (unsigned char)(((unsigned int)((ntrPower * 1000) / 3.0)) >> 8); // è“„ç”µæ± ç»„ç”µé‡ NTRA H  W5
6138   1        sum = sum + *pRs;
6139   1        pRs++;
6140   1        *pRs = (unsigned char)(((unsigned int)(ntrPower * 1000) / 3.0)); // è“„ç”µæ± ç»„ç”µé‡ NTRA L W6
6141   1        sum = sum + *pRs;
6142   1        pRs++;
6143   1      
6144   1        *pRs = 0x00; // å……æ”¾æ¯” - H - 00H
6145   1        sum = sum + *pRs;
6146   1        pRs++;
6147   1        *pRs = proportion; // å……æ”¾æ¯” - L
6148   1        sum = sum + *pRs;
6149   1        pRs++;
6150   1      
6151   1        *pRs = aqStateContrl >> 8; // å•ä½“æ§åˆ¶å­— - H W9
6152   1        sum = sum + *pRs;
6153   1        pRs++;
6154   1        *pRs = aqStateContrl; // å•ä½“æ§åˆ¶å­— - L  W10
6155   1        sum = sum + *pRs;
6156   1        pRs++;
6157   1      
6158   1        *pRs = healthStateContr1 >> 8; // å¥åº·æ§åˆ¶å­—1 - H  W11
6159   1        sum = sum + *pRs;
6160   1        pRs++;
6161   1        *pRs = healthStateContr1; // å¥åº·æ§åˆ¶å­—1 - L W12
6162   1        sum = sum + *pRs;
6163   1        pRs++;
6164   1      
6165   1        *pRs = healthStateContr2 >> 8; // å¥åº·æ§åˆ¶å­—2 - H  W13
6166   1        sum = sum + *pRs;
6167   1        pRs++;
6168   1        *pRs = healthStateContr2; // å¥åº·æ§åˆ¶å­—2 - L W14
6169   1        sum = sum + *pRs;
6170   1        pRs++;
6171   1      
6172   1        *pRs = selfCheckStateContrl; // è‡ªæ£€æ§åˆ¶å­— W15
6173   1        sum = sum + *pRs;
6174   1        pRs++;
6175   1      
6176   1        *pRs = (unsigned char)(((unsigned int)(equOpenValue * 1000 + 0.001)) >> 8); // å‡è¡¡å¼€å¯ç”µå‹è®¾å®šå€
             -¼ - H  W16
6177   1        sum = sum + *pRs;
6178   1        pRs++;
6179   1        *pRs = (unsigned char)((unsigned int)(equOpenValue * 1000 + 0.001)); // å‡è¡¡å¼€å¯ç”µå‹è®¾å®šå€¼ - L W
             -17
6180   1        sum = sum + *pRs;
6181   1        pRs++;
6182   1        *pRs = (unsigned char)(((unsigned int)(equCloseValue * 1000 + 0.001)) >> 8); // å‡è¡¡å…³é—­ç”µå‹è®¾å®šå
             -€¼ - H  W18
6183   1        sum = sum + *pRs;
6184   1        pRs++;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 102 

6185   1        *pRs = (unsigned char)((unsigned int)(equCloseValue * 1000 + 0.001)); // å‡è¡¡å…³é—­ç”µå‹è®¾å®šå€¼ - L  
             -W19
6186   1        sum = sum + *pRs;
6187   1        pRs++;
6188   1      
6189   1        *pRs = (unsigned char)(((unsigned int)(singleVWardValueUP * 100 + 0.001)) >> 8); // å•ä½“ç”µå‹ä¸Šé™æŠ¥
             -è­¦å€¼ - H  W20
6190   1        sum = sum + *pRs;
6191   1        pRs++;
6192   1        *pRs = (unsigned char)((unsigned int)(singleVWardValueUP * 100 + 0.001)); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼ 
             -- L  W21
6193   1        sum = sum + *pRs;
6194   1        pRs++;
6195   1        *pRs = (unsigned char)(((unsigned int)(singleVWardValueDOWN * 100 + 0.001)) >> 8); // å•ä½“ç”µå‹ä¸‹é™æ
             -Š¥è­¦å€¼ - H  W22
6196   1        sum = sum + *pRs;
6197   1        pRs++;
6198   1        *pRs = (unsigned char)((unsigned int)(singleVWardValueDOWN * 100 + 0.001)); // å•ä½“ç”µå‹ä¸‹é™æŠ¥è­¦å€
             -¼ - L  W23
6199   1        sum = sum + *pRs;
6200   1        pRs++;
6201   1      
6202   1        *pRs = (unsigned char)(((unsigned int)((float)(singleVProtectValueUP * 100) + 0.001)) >> 8); // å•ä½“ç”µ
             -å‹ä¸Šé™ä¿æŠ¤å€¼ - H  W24
6203   1        sum = sum + *pRs;
6204   1        pRs++;
6205   1        *pRs = (unsigned char)((unsigned int)((float)(singleVProtectValueUP * 100) + 0.001)); // å•ä½“ç”µå‹ä¸Šé
             -™ä¿æŠ¤å€¼ - L W25
6206   1        sum = sum + *pRs;
6207   1        pRs++;
6208   1      
6209   1        *pRs = (unsigned char)(((unsigned int)(batteryVAWardValueUP * 100 + 0.001)) >> 8); // è“„ç”µæ± ç»„ç”µå‹ä
             -¸Šé™ä¿æŠ¤å€¼ - H  W26
6210   1        sum = sum + *pRs;
6211   1        pRs++;
6212   1        *pRs = (unsigned char)((unsigned int)(batteryVAWardValueUP * 100 + 0.001)); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿
             -æŠ¤å€¼ - L  W27
6213   1        sum = sum + *pRs;
6214   1        pRs++;
6215   1        *pRs = (unsigned char)(((unsigned int)(batteryVAWardValueDOWN * 100 + 0.001)) >> 8); // è“„ç”µæ± ç»„ç”µå
             -‹ä¸‹é™ä¿æŠ¤å€¼ - H  W28
6216   1        sum = sum + *pRs;
6217   1        pRs++;
6218   1        *pRs = (unsigned char)((unsigned int)(batteryVAWardValueDOWN * 100 + 0.001)); // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™
             -ä¿æŠ¤å€¼ - L  W29
6219   1        sum = sum + *pRs;
6220   1        pRs++;
6221   1      
6222   1        *pRs = 0xAA; // é¢„ç•™  W30
6223   1        sum = sum + *pRs;
6224   1        pRs++;
6225   1        *pRs = 0xAA; // é¢„ç•™  W31
6226   1        sum = sum + *pRs;
6227   1        pRs++;
6228   1        *pRs = 0xAA; // é¢„ç•™  W32
6229   1        sum = sum + *pRs;
6230   1        pRs++;
6231   1        *pRs = 0xAA; // é¢„ç•™  W33
6232   1        sum = sum + *pRs;
6233   1        pRs++;
6234   1      
6235   1        for (i = 0; i < 9; i++)
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 103 

6236   1        {
6237   2          *pRs = equExeCount[i]; // å•ä½“å‡è¡¡è®¡æ•° W34 ~ W42
6238   2          sum = sum + *pRs;
6239   2          pRs++;
6240   2        }
6241   1      
6242   1        *pRs = sum; // SUM
6243   1      }
6244          
6245          //*****************************************************************
6246          // å‡½æ•°åç§° : FilterManage
6247          // åŠŸèƒ½æè¿° :
6248          // *****************************************************************
6249          void UploadParaManage(void)
6250          {
6251   1        unsigned int dataTemp;
6252   1      
6253   1        if (fgUploadPara == TRUE) // ä¸Šæ³¨å‚æ•°å¤„ç†è¯·æ±‚
6254   1        {
6255   2          fgUploadPara = FALSE;                         // æ¸…é™¤è¯·æ±‚æ ‡å¿—
6256   2          dataTemp = (unsigned int)(uploadParaData[1] * 256) + uploadParaData[2]; // ä¸Šæ³¨åŸç èŒƒå›´åˆ¤æ–­
6257   2      
6258   2          switch (uploadParaData[0])
6259   2          {
6260   3          case 0x21:            // å•ä½“æ§åˆ¶å­—
6261   3            aqStateContrl = dataTemp; // å•ä½“æ§åˆ¶å­—
6262   3            break;
6263   3      
6264   3          case 0x22:               // å¥åº·æ§åˆ¶å­—1
6265   3            healthStateContr1 = dataTemp;  // å¥åº·æ§åˆ¶å­—1A
6266   3            healthStateContr1B = dataTemp; // å¥åº·æ§åˆ¶å­—1B
6267   3            healthStateContr1C = dataTemp; // å¥åº·æ§åˆ¶å­—1C
6268   3            break;
6269   3      
6270   3          case 0x23:               // å¥åº·æ§åˆ¶å­—2
6271   3            healthStateContr2 = dataTemp;  // å¥åº·æ§åˆ¶å­—2A
6272   3            healthStateContr2B = dataTemp; // å¥åº·æ§åˆ¶å­—2B
6273   3            healthStateContr2C = dataTemp; // å¥åº·æ§åˆ¶å­—2C
6274   3            break;
6275   3      
6276   3          case 0x24:                    // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼
6277   3            if ((dataTemp >= 350) && (dataTemp <= 450)) // 3.5-4.5V
6278   3            {
6279   4              singleVWardValueUP = (float)((float)dataTemp / 100.0);  // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A
6280   4              singleVWardValueUPB = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B
6281   4              singleVWardValueUPC = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C
6282   4            }
6283   3            break;
6284   3      
6285   3          case 0x25:                    // å•ä½“ç”µå‹ä¸‹é™æŠ¥è­¦å€¼
6286   3            if ((dataTemp >= 250) && (dataTemp <= 350)) // 2.5-3.5V
6287   3            {
6288   4              singleVWardValueDOWN = (float)((float)dataTemp / 100.0);  // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A
6289   4              singleVWardValueDOWNB = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B
6290   4              singleVWardValueDOWNC = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C
6291   4            }
6292   3            break;
6293   3      
6294   3          case 0x26:                    // å•ä½“ç”µå‹ä¸Šé™ä¿æŠ¤å€¼
6295   3            if ((dataTemp >= 350) && (dataTemp <= 450)) // 3.5-4.5V
6296   3            {
6297   4              singleVProtectValueUP = (float)((float)dataTemp / 100.0);  // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼A
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 104 

6298   4              singleVProtectValueUPB = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼B
6299   4              singleVProtectValueUPC = (float)((float)dataTemp / 100.0); // å•ä½“ç”µå‹ä¸Šé™æŠ¥è­¦å€¼C
6300   4            }
6301   3            break;
6302   3      
6303   3          case 0x27:                      // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼
6304   3            if ((dataTemp >= 2400) && (dataTemp <= 3900)) // 24~39V
6305   3            {
6306   4              batteryVAWardValueUP = (float)((float)dataTemp / 100.0);  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A
6307   4              batteryVAWardValueUPB = (float)((float)dataTemp / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B
6308   4              batteryVAWardValueUPC = (float)((float)dataTemp / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C
6309   4            }
6310   3            break;
6311   3      
6312   3          case 0x28:                      // å½“å‰ç”µé‡NTR
6313   3            if ((dataTemp >= 40000) && (dataTemp <= 60000)) // 120~180Ah
6314   3            {
6315   4              ntrPower = (float)((float)dataTemp * 3.0 / 1000.0);  // NTR æ»¡ç”µé‡å€¼æ¢å¤A
6316   4              ntrPowerB = (float)((float)dataTemp * 3.0 / 1000.0); // NTR æ»¡ç”µé‡å€¼æ¢å¤B
6317   4              ntrPowerC = (float)((float)dataTemp * 3.0 / 1000.0); // NTR æ»¡ç”µé‡å€¼æ¢å¤C
6318   4      
6319   4              currentPower = ntrPower;  /* Aç»„è“„ç”µæ± ç»„ç”µé‡  */
6320   4              chargePower = (float)0.0; /* å½“å‰ç”µé‡æ¢å¤ ï¼Œ å……ç”µç”µé‡è®¾ç½®0  */
6321   4              dischargePower = (float)0.0;
6322   4              fgAh = TRUE;
6323   4      
6324   4              powerSave[0] = (unsigned char)((unsigned int)((ntrPower * 1000) / 3.0) >> 8); /* å–å½“å‰ç”µé‡çš„é«˜
             -å­—èŠ‚ -A  æ›´æ–°æ»¡ç”µé‡å€¼  */
6325   4              powerSave[1] = (unsigned char)((unsigned int)((ntrPower * 1000) / 3.0) & 0xFF); /* å–å½“å‰ç”µé‡çš„ä
             -½å­—èŠ‚  */
6326   4              powerSave[2] = 0x00;
6327   4              powerSave[3] = 0x00;
6328   4              powerSave[4] = 0x00;
6329   4              powerSave[5] = 0x00;
6330   4            }
6331   3            break;
6332   3      
6333   3          case 0x29:                     // å……æ”¾æ¯”
6334   3            dataTemp = (dataTemp & 0x00FF);        // ä¸Šæ³¨åŸç èŒƒå›´åˆ¤æ–­
6335   3            if ((dataTemp >= 80) && (dataTemp <= 150)) // 0.8 ~ 1.5
6336   3            {
6337   4              proportion = dataTemp; // è“„ç”µæ± ç»„ å……æ”¾æ¯” ä½¿ç”¨åŒå­—èŠ‚ ä½ä½
6338   4              proportionB = dataTemp;
6339   4              proportionC = dataTemp;
6340   4            }
6341   3            break;
6342   3      
6343   3          case 0x2A:                     // å‡è¡¡å¼€å¯ç”µå‹å€¼
6344   3            if ((dataTemp >= 30) && (dataTemp <= 200)) // 0.03~0.2V
6345   3            {
6346   4              equOpenValue = (float)((float)dataTemp / 1000.0);  // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼A
6347   4              equOpenValueB = (float)((float)dataTemp / 1000.0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼B
6348   4              equOpenValueC = (float)((float)dataTemp / 1000.0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼C
6349   4            }
6350   3            break;
6351   3      
6352   3          case 0x2B:                     // å‡è¡¡å…³é—­ç”µå‹å€¼
6353   3            if ((dataTemp >= 10) && (dataTemp <= 100)) // 3.5-4.5V
6354   3            {
6355   4              equCloseValue = (float)((float)dataTemp / 1000.0);  // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼A
6356   4              equCloseValueB = (float)((float)dataTemp / 1000.0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼B
6357   4              equCloseValueC = (float)((float)dataTemp / 1000.0); // å‡è¡¡å¼€å¯ç”µå‹é—¨é™å€¼C
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 105 

6358   4            }
6359   3            break;
6360   3      
6361   3          case 0x2C:                      // è“„ç”µæ± ç»„ç”µå‹ä¸‹é™æŠ¥è­¦å€¼
6362   3            if ((dataTemp >= 1800) && (dataTemp <= 3000)) // 18~30V
6363   3            {
6364   4              batteryVAWardValueDOWN = (float)((float)dataTemp / 100.0);  // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼A
6365   4              batteryVAWardValueDOWNB = (float)((float)dataTemp / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼B
6366   4              batteryVAWardValueDOWNC = (float)((float)dataTemp / 100.0); // è“„ç”µæ± ç»„ç”µå‹ä¸Šé™ä¿æŠ¤å€¼C
6367   4            }
6368   3            break;
6369   3      
6370   3          case 0x2D:              // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—
6371   3            dataTemp = (dataTemp & 0x00FF); // ä¸Šæ³¨åŸç èŒƒå›´åˆ¤æ–­
6372   3      
6373   3            selfCheckStateContrl = dataTemp; // è‡ªæ£€çŠ¶æ€æ§åˆ¶å­—
6374   3            selfCheckStateContrlB = dataTemp;
6375   3            selfCheckStateContrlC = dataTemp;
6376   3            break;
6377   3      
6378   3          default:
6379   3            break;
6380   3          }
6381   2        }
6382   1      }
6383          
6384          //*****************************************************************
6385          // å‡½æ•°åç§° : FilterManage
6386          // åŠŸèƒ½æè¿° :
6387          // *****************************************************************
6388          void FilterManage(void)
6389          {
6390   1        unsigned char result;
6391   1      
6392   1        fg60S++; // å‘¨æœŸè®¡æ•°å¢åŠ   æ— å˜åŒ–æ—¶ 60s æ›´æ–°
6393   1      
6394   1        FilterSaveData(&filterFrame[0]); // è¿‡æ»¤å‚æ•°é¥æµ‹ç»„å¸§
6395   1        result = FilterDataComp();     // è¿‡æ»¤åŒ…æ•°æ®å¯¹æ¯”
6396   1      
6397   1        if ((result == TRUE) || (fg60S > 59)) // å¯¹æ¯”ç»“æœå‡ºç°å˜åŒ–æ—¶ æˆ–æ˜¯ 60s å‘¨æœŸ
6398   1        {
6399   2          fg60S = 0x00; // é‡æ–°è®¡æ•°
6400   2      
6401   2          SaveDataRs3(); // ç»„å¸§è¿‡æ»¤åŒ…
6402   2      
6403   2          reqData[wrReqIndex] = 0xA6; // è®¾ç½®è¿‡æ»¤åŒ…ç´¢å–
6404   2          wrReqIndex++;       // è¯»ç´¢å¼•
6405   2          if (wrReqIndex > 11)
6406   2          {
6407   3            wrReqIndex = 0;
6408   3          }
6409   2        }
6410   1      }
6411          
6412          //*****************************************************************
6413          // å‡½æ•°åç§° : FilterDataComp
6414          // åŠŸèƒ½æè¿° : è¿‡æ»¤åŒ…æ•°æ®å¯¹æ¯”å¤„ç†å¤„ç†
6415          // *****************************************************************
6416          unsigned char FilterDataComp(void)
6417          {
6418   1        unsigned int i;
6419   1        unsigned char fgComp; // å¯¹æ¯”ç»“æœæ ‡å¿—
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 106 

6420   1        int result;       // æ¯”å¯¹ç»“æœ ä¸´æ—¶å˜é‡
6421   1      
6422   1        fgComp = FALSE; // é»˜è®¤æ— å˜åŒ–
6423   1      
6424   1        for (i = 0; i < 4; i++) // çŠ¶æ€å€¼æ¯”è¾ƒ  bit å˜åŒ–
6425   1        {
6426   2          if (filterFrame[i] != filterDataRec[i])
6427   2          {
6428   3            fgComp = TRUE;
6429   3          }
6430   2        }
6431   1      
6432   1        result = abs((int)(filterFrame[4] * 256 + filterFrame[5]) - (int)(filterDataRec[4] * 256 + filterDataRec[
             -5]));
6433   1        if (result > 100) // 5V ä¸» å¯¹æ¯”ç»“æœå¤§äº100åˆ†å±‚  0.25V
6434   1        {
6435   2          fgComp = TRUE;
6436   2        }
6437   1        result = abs((int)(filterFrame[6] * 256 + filterFrame[7]) - (int)(filterDataRec[6] * 256 + filterDataRec[
             -7]));
6438   1        if (result > 100) // 5V å¤‡ å¯¹æ¯”ç»“æœå¤§äº100åˆ†å±‚  0.25V
6439   1        {
6440   2          fgComp = TRUE;
6441   2        }
6442   1        result = abs((int)(filterFrame[8] * 256 + filterFrame[9]) - (int)(filterDataRec[8] * 256 + filterDataRec[
             -9]));
6443   1        if (result > 100) // 5V å‡è¡¡ å¯¹æ¯”ç»“æœå¤§äº100åˆ†å±‚  0.25V
6444   1        {
6445   2          fgComp = TRUE;
6446   2        }
6447   1        result = abs((int)(filterFrame[10] * 256 + filterFrame[11]) - (int)(filterDataRec[10] * 256 + filterDataR
             -ec[11]));
6448   1        if (result > 480) // +12V å‡è¡¡ å¯¹æ¯”ç»“æœå¤§äº480åˆ†å±‚  1.2V
6449   1        {
6450   2          fgComp = TRUE;
6451   2        }
6452   1        result = abs((int)(filterFrame[12] * 256 + filterFrame[13]) - (int)(filterDataRec[12] * 256 + filterDataR
             -ec[13]));
6453   1        if (result > 480) // -12V å‡è¡¡ å¯¹æ¯”ç»“æœå¤§äº480åˆ†å±‚  1.2V
6454   1        {
6455   2          fgComp = TRUE;
6456   2        }
6457   1        result = abs((int)(filterFrame[14] * 256 + filterFrame[15]) - (int)(filterDataRec[14] * 256 + filterDataR
             -ec[15]));
6458   1        if (result > 100) // +12V å‡è¡¡ å¯¹æ¯”ç»“æœå¤§äº480åˆ†å±‚  1.2V
6459   1        {
6460   2          fgComp = TRUE;
6461   2        }
6462   1      
6463   1        for (i = 16; i < 41; i++) // çŠ¶æ€å€¼æ¯”è¾ƒ  bit å˜åŒ–
6464   1        {
6465   2          if (filterFrame[i] != filterDataRec[i])
6466   2          {
6467   3            fgComp = TRUE;
6468   3          }
6469   2        }
6470   1      
6471   1        for (i = 0; i < 41; i++) // æ•°æ®æ›´æ–°
6472   1        {
6473   2          filterDataRec[i] = filterFrame[i];
6474   2        }
6475   1      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 107 

6476   1        return (fgComp);
6477   1      }
6478          
6479          //*****************************************************************
6480          // å‡½æ•°åç§° : FilterSaveData
6481          // åŠŸèƒ½æè¿° :
6482          // *****************************************************************
6483          void FilterSaveData(unsigned char xdata *pRs)
6484          {
6485   1        unsigned char i;
6486   1      
6487   1        *pRs = pcuState1; // PCUçŠ¶æ€å­—1  W0
6488   1        pRs++;
6489   1        *pRs = pcuState2; // PCUçŠ¶æ€å­—2  W1
6490   1        pRs++;
6491   1        *pRs = pcuState3; // PCUçŠ¶æ€å­—3  W2
6492   1        pRs++;
6493   1        *pRs = pcuState4; // PCUçŠ¶æ€å­—4  W3
6494   1        pRs++;
6495   1      
6496   1        *pRs = anData[84] >> 8; // ä¸»æœº5V - H  W4
6497   1        pRs++;
6498   1        *pRs = anData[84]; // ä¸»æœº5V - L  W5
6499   1        pRs++;
6500   1        *pRs = anData[85] >> 8; // å¤‡æœº5V - H  W6
6501   1        pRs++;
6502   1        *pRs = anData[86]; // å¤‡æœº5V - L  W7
6503   1        pRs++;
6504   1      
6505   1        *pRs = equ5VP >> 8; // å‡è¡¡+5Vç”µå‹ - H  W8
6506   1        pRs++;
6507   1        *pRs = equ5VP; // å‡è¡¡+5Vç”µå‹ - L  W9
6508   1        pRs++;
6509   1        *pRs = equ12VP >> 8; // å‡è¡¡+12Vç”µå‹ - H  W10
6510   1        pRs++;
6511   1        *pRs = equ12VP; // å‡è¡¡+12Vç”µå‹ - L  W11
6512   1        pRs++;
6513   1        *pRs = equ12VN >> 8; // å‡è¡¡-12Vç”µå‹ - H  W12
6514   1        pRs++;
6515   1        *pRs = equ12VN; // å‡è¡¡-12Vç”µå‹ - L  W13
6516   1        pRs++;
6517   1        *pRs = equVRef >> 8; // å‡è¡¡åŸºå‡†ç”µå‹ - H  W14
6518   1        pRs++;
6519   1        *pRs = equVRef; // å‡è¡¡åŸºå‡†ç”µå‹ - L  W15
6520   1        pRs++;
6521   1      
6522   1        *pRs = sepCurrentState1; // å……åˆ†æ¨¡å—1åˆ†æµæŒ‡ç¤º  W16
6523   1        pRs++;
6524   1        *pRs = sepCurrentState2; // å……åˆ†æ¨¡å—2åˆ†æµæŒ‡ç¤º  W17
6525   1        pRs++;
6526   1        *pRs = sepCurrentState3; // å……åˆ†æ¨¡å—3åˆ†æµæŒ‡ç¤º  W18
6527   1        pRs++;
6528   1        *pRs = sepCurrentState4; // å……åˆ†æ¨¡å—4åˆ†æµæŒ‡ç¤º  W19
6529   1        pRs++;
6530   1      
6531   1        *pRs = chargeVolKickRsA; // Aç»„å……ç”µé™å‹æ¡£æ•°  W20
6532   1        pRs++;
6533   1        *pRs = chargeVolKickRsB; // Bç»„å……ç”µé™å‹æ¡£æ•°  W21
6534   1        pRs++;
6535   1        *pRs = chargeCurKickA; // Aç»„å……ç”µé™æµæ¡£æ•°  W22
6536   1        pRs++;
6537   1        *pRs = chargeCurKickB; // Bç»„å……ç”µé™æµæ¡£æ•°  W23
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 108 

6538   1        pRs++;
6539   1      
6540   1        *pRs = proportion; // è“„ç”µæ± ç»„å……æ”¾æ¯”  W24
6541   1        pRs++;
6542   1        *pRs = importDataRxState; // é‡è¦æ•°æ®æ¢å¤çŠ¶æ€å­— W25
6543   1        pRs++;
6544   1        *pRs = selfControlCount; // è‡ªä¸»æ§åˆ¶å™¨è®¡æ•° W26
6545   1        pRs++;
6546   1        *pRs = selfCheckStateWord; // ä¸‹ä½æœºè‡ªæ£€çŠ¶æ€å­— W27
6547   1        pRs++;
6548   1        *pRs = onoffReceCount; // æŒ‡ä»¤æ¥æ”¶è®¡æ•°å™¨ W28
6549   1        pRs++;
6550   1        *pRs = resetCount; // çƒ­å¤ä½è®¡æ•° W29
6551   1        pRs++;
6552   1        *pRs = onoffErrorCount; // é”™è¯¯æŒ‡ä»¤è®¡æ•° W30
6553   1        pRs++;
6554   1        *pRs = onoffExeCount; // æŒ‡ä»¤æ‰§è¡Œè®¡æ•° W31
6555   1        pRs++;
6556   1      
6557   1        for (i = 0; i < 9; i++)
6558   1        {
6559   2          *pRs = equExeCount[i]; // å•ä½“å‡è¡¡è®¡æ•° W33 ~ W41
6560   2          pRs++;
6561   2        }
6562   1      }
6563          
6564          /***************************************************************************************/
6565          /* å‡½æ•°ä»‹ç»: PowerControl å®‰æ—¶è®¡ç”µé‡è®¡ç®—å‡½æ•°                                          */
6566          /* åŠŸèƒ½æè¿°:                                                                           */
6567          /* ä¿®æ”¹è®°å½•:                                                                           */
6568          /*                                                                                     */
6569          /***************************************************************************************/
6570          void PowerControl(void)
6571          {
6572   1        unsigned char fgVa;
6573   1      
6574   1        // è“„ç”µæ± ç”µå‹ ä¸‰å–äºŒ
6575   1        if ((accVAHardPyh > volTab[chargeCurKickA - 1]) && (accVAEquPyh > volTab[chargeCurKickA - 1]))
6576   1        {
6577   2          fgVa = TRUE;
6578   2        }
6579   1        else if ((accVAHardPyh > volTab[chargeCurKickA - 1]) && (accVBEquPyh > volTab[chargeCurKickA - 1]))
6580   1        {
6581   2          fgVa = TRUE;
6582   2        }
6583   1        else if ((accVAEquPyh > volTab[chargeCurKickA - 1]) && (accVBEquPyh > volTab[chargeCurKickA - 1]))
6584   1        {
6585   2          fgVa = TRUE;
6586   2        }
6587   1        else // æ— æ»¡è¶³æ¡ä»¶
6588   1        {
6589   2          fgVa = FALSE;
6590   2        }
6591   1      
6592   1        if (fgVa == TRUE) // æ»¡ç”µé‡è“„ç”µæ± ç»„ç”µå‹åˆ¤è¯»
6593   1        {
6594   2          AhCount16S++;    // æ»¡ç”µé‡æ—¶é—´åˆ¤è¯»
6595   2          if (AhCount16S >= 4) // æ»¡ç”µé‡æ—¶é—´æŒç»­16sä»¥ä¸Š
6596   2          {
6597   3            if ((limbCurrentA + limbCurrentB) > (genCurrent + chargeCurrent + 2)) // ç”µæµåˆ¤æ–­
6598   3            {
6599   4              if ((chargeCurrent < 5.0) && (chargeCurrent > 0.5)) // æœ‰æ•ˆåŒºé—´
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 109 

6600   4              {
6601   5                fgAh = TRUE; // è®¾ç½® å®‰æ—¶è®¡ å¯åŠ¨æ ‡å¿—
6602   5      
6603   5                currentPower = ntrPower;  // è®¾ç½®å½“å‰ç”µé‡ä¸ºæ»¡ç”µé‡
6604   5                chargePower = (float)0.0; // å……ç”µã€æ”¾ç”µç”µé‡æ˜¯0Ah
6605   5                dischargePower = (float)0.0;
6606   5      
6607   5                AhCount16S = 0; // è®¡æ•°æ¸…é›¶
6608   5              }
6609   4            }
6610   3          }
6611   2        }
6612   1        else
6613   1        {
6614   2          AhCount16S = 0; // è®¡æ•°æ¸…é›¶
6615   2        }
6616   1      
6617   1        if (fgAh == TRUE) // å®‰æ—¶è®¡æ ‡å¿—ä¸º1
6618   1        {
6619   2          if (chargeCurrent > 0.5) // å……ç”µç”µæµ æœ‰æ•ˆèŒƒå›´
6620   2          {
6621   3            chargePower = chargePower + (chargeCurrent / (float)(9 * proportion)); // å……ç”µç”µé‡è®¡ç®—
6622   3          }
6623   2      
6624   2          if (dischargeCurrent > 2.0)
6625   2          {
6626   3            dischargePower = dischargePower + (dischargeCurrent / 900); // æ”¾ç”µç”µæµè®¡ç®—
6627   3          }
6628   2      
6629   2          currentPower = ntrPower + chargePower - dischargePower; // å½“å‰ç”µé‡è®¡ç®—
6630   2      
6631   2          if (chargePower >= dischargePower) // å……ç”µç”µé‡å¤§äºç­‰äºæ”¾ç”µç”µé‡è“„ç”µæ± å……æ»¡
6632   2          {
6633   3            chargePower = (float)0.0;
6634   3            dischargePower = (float)0.0;
6635   3            currentPower = ntrPower;
6636   3          }
6637   2        }
6638   1      
6639   1        if (currentPower <= 0) // å¦‚æœå½“å‰ç”µé‡å€¼å‡ºç°è´Ÿå€¼
6640   1        {
6641   2          currentPower = (float)0.0; // å½“å‰ç”µé‡ç»´æŒ0Ah
6642   2        }
6643   1      
6644   1        if (dischargePower >= ntrPower) // å¦‚æœæ”¾ç”µç”µé‡è¶…è¿‡æ»¡ç”µé‡
6645   1        {
6646   2          dischargePower = dischargePower - chargePower; // æ”¾ç”µç”µé‡å–æ”¾ç”µç”µé‡ä¸å……ç”µç”µé‡å·®å€¼
6647   2          chargePower = (float)0.0;            // å……ç”µç”µé‡æ¸…é›¶
6648   2        }
6649   1      
6650   1        powerSave[0] = (unsigned char)((unsigned int)((currentPower * 1000) / 3.0) >> 8);   /* å–å½“å‰ç”µé‡çš„
             -é«˜å­—èŠ‚  */
6651   1        powerSave[1] = (unsigned char)((unsigned int)((currentPower * 1000) / 3.0) & 0xFF);   /* å–å½“å‰ç”µé‡ç
             -š„ä½å­—èŠ‚  */
6652   1        powerSave[2] = (unsigned char)((unsigned int)((chargePower * 1000) / 3.0) >> 8);    /* å–å……ç”µç”µé‡çš„é
             -«˜å­—èŠ‚  */
6653   1        powerSave[3] = (unsigned char)((unsigned int)((chargePower * 1000) / 3.0) & 0xFF);    /* å–å……ç”µç”µé‡çš
             -„ä½å­—èŠ‚  */
6654   1        powerSave[4] = (unsigned char)((unsigned int)((dischargePower * 1000) / 3.0) >> 8);   /* å–æ”¾ç”µç”µé‡ç
             -š„é«˜å­—èŠ‚  */
6655   1        powerSave[5] = (unsigned char)((unsigned int)((dischargePower * 1000) / 3.0) & 0xFF); /* å–æ”¾ç”µç”µé‡ç
             -š„ä½å­—èŠ‚  */
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 110 

6656   1      }
6657          
6658          //******************************************************
6659          // å‡½æ•°åç§° : EquControl
6660          // åŠŸèƒ½æè¿° : å‡è¡¡æ§åˆ¶
6661          // ä¿®æ”¹è®°å½• :
6662          // *******************************************************
6663          void EquControl(void)
6664          {
6665   1        unsigned char i;
6666   1        unsigned char j;
6667   1        unsigned char index;
6668   1        unsigned char maxindex; // æ ‡ç¤º3~4.5Vçš„æœ€å¤§åºå·
6669   1        unsigned int TlevelSet;
6670   1      
6671   1        if (equControlEn == TRUE) // å‡è¡¡æ§åˆ¶ä½¿èƒ½
6672   1        {
6673   2          fg30S++; // å‡è¡¡æ—¶é—´è®¡æ•°
6674   2      
6675   2          if (fg30S > 29) // 30ç§’æ§åˆ¶å‘¨æœŸ
6676   2          {
6677   3            fg30S = 0; // æ§åˆ¶å‘¨æœŸæ¸…é›¶
6678   3      
6679   3            index = 0;
6680   3            maxindex = 9;
6681   3      
6682   3            for (i = 0; i < 9; i++)
6683   3            {
6684   4              if (aqPhyPx[i] > (float)4.5) // å•ä½“ç”µå‹å¤§äº3Vå°äº4.5V 3/0.0025=1200
6685   4              {
6686   5                maxindex = i; // ç”µå‹å¤§äº3Vçš„å•ä½“è®¡æ•°
6687   5                break;
6688   5              }
6689   4            }
6690   3      
6691   3            for (i = 0; i < maxindex; i++)
6692   3            {
6693   4              if (aqPhyPx[i] >= (float)3.0) // å•ä½“ç”µå‹å¤§äº3Vå°äº4.5V 3/0.0025=1200
6694   4              {
6695   5                index++; // ç”µå‹å¤§äºç­‰äº3Vçš„å•ä½“è®¡æ•°
6696   5              }
6697   4            }
6698   3      
6699   3            for (j = 0; j < index; j++)
6700   3            {
6701   4              for (i = 0; i < 9; i++)
6702   4              {
6703   5                if (fabs(aqPhy[i] - aqPhyPx[(maxindex - index) + j]) < 0.0001) // åˆ¤æ–­æ˜¯å¦ç›¸ç­‰
6704   5                {
6705   6                  if (((aqStateContrl << i) & 0x8000) == 0x8000) // æœ€å°å•ä½“å‚ä¸æ§åˆ¶
6706   6                  {
6707   7                    break;
6708   7                  }
6709   6                }
6710   5              }
6711   4              if (i < 9)
6712   4              {
6713   5                break;
6714   5              }
6715   4            }
6716   3      
6717   3            index = (unsigned char)(index - j);
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 111 

6718   3            if (index > 1) //å‚ä¸å‡è¡¡æ§åˆ¶çš„å•ä½“å¤§äºç­‰äº2
6719   3            {
6720   4              for (i = 0; i < 9; i++)
6721   4              {
6722   5                if (((aqPhy[i] >= (float)3.0) && (aqPhy[i] <= (float)4.5)) && (fabs(aqPhy[i] - aqPhyPx[maxindex - ind
             -ex]) >= 0.0001) && (((aqStateContrl << i) & 0x8000) == 0x8000)) //å•ä½“ç”µå‹ä¸æ˜¯æœ€å°å€¼ä¸”å‚ä¸æ§åˆ¶
6723   5                {
6724   6                  if ((aqPhy[i] - aqPhyPx[maxindex - index]) > equOpenValue) //å·®å€¼å¤§äº60mv
6725   6                  {
6726   7                    equOnoffBuffer[wrEquOnoffIndex] = equAqOnTab[i]; // å‘é€šæŒ‡ä»¤
6727   7                    wrEquOnoffIndex++;
6728   7                    if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
6729   7                    {
6730   8                      wrEquOnoffIndex = 0;
6731   8                    }
6732   7      
6733   7                    TlevelSet = equState1 * 256 + equState2;   // å‡è¡¡å™¨çŠ¶æ€å­—
6734   7                    if (((TlevelSet << i) & 0x8000) != 0x8000) // æ–­
6735   7                    {
6736   8                      equExeCount[i]++; // å‡è¡¡è®¡æ•°++  ï¼ˆæ–­åˆ°é€šï¼‰
6737   8                    }
6738   7                  }
6739   6                  else //çŠ¶æ€ä¸ºå¼€å¯
6740   6                  {
6741   7                    if ((aqPhy[i] - aqPhyPx[maxindex - index]) < equCloseValue) //å·®å€¼å°äº10mv
6742   7                    {
6743   8                      equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[i]; // å‘æ–­æŒ‡ä»¤
6744   8                      wrEquOnoffIndex++;
6745   8                      if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
6746   8                      {
6747   9                        wrEquOnoffIndex = 0;
6748   9                      }
6749   8                    }
6750   7                  }
6751   6                }
6752   5                else
6753   5                {
6754   6                  equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[i]; // å‘æ–­æŒ‡ä»¤
6755   6                  wrEquOnoffIndex++;
6756   6                  if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
6757   6                  {
6758   7                    wrEquOnoffIndex = 0;
6759   7                  }
6760   6                }
6761   5              }
6762   4            }
6763   3            else
6764   3            {
6765   4              for (i = 0; i < 9; i++) //å¦åˆ™å…¨éƒ¨æ–­å¼€
6766   4              {
6767   5                equOnoffBuffer[wrEquOnoffIndex] = equAqOffTab[i];
6768   5                wrEquOnoffIndex++;
6769   5                if (wrEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
6770   5                {
6771   6                  wrEquOnoffIndex = 0;
6772   6                }
6773   5              }
6774   4            }
6775   3          }
6776   2        }
6777   1        else // å‡è¡¡ç¦æ­¢æ—¶ï¼Œæ§åˆ¶æ—¶é—´è®¡æ•°æ¸…é›¶
6778   1        {
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 112 

6779   2          fg30S = 0;
6780   2        }
6781   1      }
6782          
6783          //******************************************************
6784          // å‡½æ•°åç§° : EquOnoffHook
6785          // åŠŸèƒ½æè¿° : å‡è¡¡æ§åˆ¶
6786          // ä¿®æ”¹è®°å½• :
6787          // *******************************************************
6788          void EquOnoffHook(void)
6789          {
6790   1        if (wrEquOnoffIndex != rdEquOnoffIndex) // æ˜¯å¦æœ‰è½¬å‘æŒ‡ä»¤è¯·æ±‚
6791   1        {
6792   2          fgEquTx = TRUE; //è®¾ç½®æ ‡å¿—
6793   2      
6794   2          TXD422En = 0; //å‘é€ä½¿èƒ½
6795   2      
6796   2          TXD422BUFF = (equOnoffBuffer[rdEquOnoffIndex] >> 8) & 0xFF;
6797   2          TXDCONTROL = 0; // é—¨æ§ä½¿èƒ½
6798   2      
6799   2          Delay(1000);  // å»¶æ—¶4ms
6800   2          TXDCONTROL = 1; // é—¨æ§ç¦æ­¢
6801   2          TXD422En = 1; // å‘é€ç¦æ­¢
6802   2      
6803   2          rdEquOnoffIndex++;
6804   2          if (rdEquOnoffIndex > 47) // å¾ªç¯æŒ‡å›
6805   2          {
6806   3            rdEquOnoffIndex = 0;
6807   3          }
6808   2        }
6809   1      }
6810          
6811          //****************************************************
6812          // å‡½æ•°åç§° : SingleProtectChargeAControl
6813          // åŠŸèƒ½æè¿° : å•ä½“ä¿æŠ¤å……ç”µæ§åˆ¶æ¨¡å—
6814          // *****************************************************
6815          void SingleProtectChargeControl(void)
6816          {
6817   1        unsigned char i;
6818   1        unsigned char j;
6819   1        unsigned char tflag;
6820   1        unsigned char singleV;
6821   1        float xdata aqCalVA;
6822   1        float xdata aqCalVB;
6823   1        float xdata result1;
6824   1        float xdata result2;
6825   1      
6826   1        if ((singleProtectChargeEn == TRUE) && (chargeFlag == TRUE)) //å•ä½“ä¿æŠ¤å……ç”µæ§åˆ¶å…è®¸&& å……ç”µ
6827   1        {
6828   2          if ((equVRefPhy >= 4.9) && (equVRefPhy <= 5.1)) //å‡è¡¡å™¨åŸºå‡†èƒ½å¦æ­£å¸¸å·¥ä½œ//å‡è¡¡å™¨åŸºå‡†èƒ½å
             -¦æ­£å¸¸å·¥ä½œ
6829   2          {
6830   3            if (accVAEquPyh > (float)(3.6 * (float)aqControlNumber)) //æ¥è‡ªå‡è¡¡å™¨çš„è“„ç”µæ± ç»„ç”µå‹ -- ä¸»ç
             -”µå‹
6831   3            {
6832   4              for (i = 0; i < 9; i++)
6833   4              {
6834   5                tflag = FALSE;
6835   5                if ((((aqStateContrl << i) & 0x8000) != 0x8000) || (aqPhy[i] <= 3.50) || (aqPhy[i] >= 4.50)) //æœ€å°
             -å•ä½“å‚ä¸æ§åˆ¶
6836   5                {
6837   6                  tflag = FALSE;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 113 

6838   6                }
6839   5                else // æ­£å¸¸å•ä½“æ§åˆ¶æ—¶
6840   5                {
6841   6                  for (j = 0; j < 9; j++) // è®¡ç®—é™¤æ­¤èŠ‚å•ä½“å¤–ç”µå‹å€¼
6842   6                  {
6843   7                    if (i = !j) // é™¤æ­¤èŠ‚å•ä½“ç”µå‹å¤–
6844   7                    {
6845   8                      aqCalVA = accVAEquPyh - aqPhy[i]; // è“„ç”µæ± ç»„A è®¡ç®—å•ä½“å€¼
6846   8                      aqCalVB = accVBEquPyh - aqPhy[i]; // è“„ç”µæ± ç»„B è®¡ç®—å•ä½“å€¼
6847   8                    }
6848   7                  }
6849   6      
6850   6                  if ((aqPhy[i] >= singleVProtectValueUP) && (aqCalVA >= singleVProtectValueUP)) // ä¸¤è€…åŒæ—¶è¶…è¿‡
             -ä¸Šé™ä¿æŠ¤å€¼
6851   6                  {
6852   7                    tflag = TRUE;
6853   7                  }
6854   6                  else if (((aqPhy[i] >= singleVProtectValueUP)) || (aqCalVA >= singleVProtectValueUP)) // æœ‰ä¸€ä¸ªè¶
             -…è¿‡ä¸Šé™ä¿æŠ¤å€¼
6855   6                  {
6856   7                    result1 = fabs(aqPhy[i] - aqCalVB);   // å·®å€¼1
6857   7                    result2 = fabs(aqCalVA  - aqCalVB);   // å·®å€¼2
6858   7                    if (result1 > result2) // Aç»„å€¼å¤§äºBç»„
6859   7                    {
6860   8                      if (aqCalVA >= singleVProtectValueUP)
6861   8                      {
6862   9                        tflag = TRUE;
6863   9                      }
6864   8                    }
6865   7                    else // Aç»„ç»‡å°äºBç»„
6866   7                    {
6867   8                      if (aqPhy[i] >= singleVProtectValueUP)
6868   8                      {
6869   9                        tflag = TRUE;
6870   9                      }
6871   8                    }
6872   7                  }
6873   6                }
6874   5      
6875   5                if (tflag == TRUE) // éœ€è¦è¿›è¡Œå•ä½“ä¿æŠ¤
6876   5                {
6877   6                  for (singleV = 1; singleV < 8; singleV++) // ç”µå‹æ¡£ä½
6878   6                  {
6879   7                    if ((accVAEquPyh <= singlechargeVolt[singleV]) && (accVAEquPyh > singlechargeVolt[singleV - 1])) //
             - æ‰¾åˆ°éœ€è¦é™æ¡£çš„æ¡£æ•°
6880   7                    {
6881   8                      if (singlesaveflag == FALSE)
6882   8                      {
6883   9                        singlesaveVLevelA = chargeVolKickA; // ä¿å­˜å•ä½“ä¿æŠ¤å‰çš„çŠ¶æ€
6884   9                        singlesaveVLevelB = chargeVolKickB; // ä¿å­˜å•ä½“ä¿æŠ¤å‰çš„çŠ¶æ€
6885   9                        singlesaveflag = TRUE;
6886   9                      }
6887   8      
6888   8                      chargeVolKickRsA = volKickTab[singleV - 1]; // è®°å½•æ¡£ä½
6889   8                      chargeVolKickRsB = volKickTab[singleV - 1]; // è®°å½•æ¡£ä½
6890   8      
6891   8                      DA_A_VOL = volCsTab[chargeVolKickRsA - 1]; // Aç»„ç”µå‹ åˆ‡æ¢æ‰§è¡Œ
6892   8                      DA_B_VOL = volCsTab[chargeVolKickRsA - 1]; // Bç»„ç”µå‹ åˆ‡æ¢æ‰§è¡Œ
6893   8      
6894   8                      OnoffSelfExeRec(0xAA, chargeVolKickRsA); // è‡ªä¸»æŒ‡ä»¤è®°å½• - Aç»„ åˆ‡æ¢è¿‡å‹åˆ‡æ¢è®°å½•
6895   8                      OnoffSelfExeRec(0xAB, chargeVolKickRsB); // è‡ªä¸»æŒ‡ä»¤è®°å½• - Bç»„ åˆ‡æ¢è¿‡å‹åˆ‡æ¢è®°å½•
6896   8      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 114 

6897   8                      selfControlCount++; // è‡ªä¸»ä¿æŠ¤è®¡æ•°åŠ 1
6898   8                      singleProtectChargeCount++;
6899   8                      if (singleProtectChargeCount > 3) // æœ‰æ•ˆèŒƒå›´
6900   8                      {
6901   9                        singleProtectChargeCount = 0;
6902   9                      }
6903   8      
6904   8                      break;
6905   8                    }
6906   7                  }
6907   6                }
6908   5              }
6909   4            }
6910   3          }
6911   2        }
6912   1      }
6913          
6914          // ****************************************************
6915          // å‡½æ•°åç§° : OnoffSelfExeRec
6916          // åŠŸèƒ½æè¿° :
6917          // *****************************************************
6918          void OnoffSelfExeRec(unsigned char type, unsigned char number)
6919          {
6920   1        if (type == 0xAA) // Aç»„ è¿‡å‹åˆ‡æ¢è®°å½•
6921   1        {
6922   2          onoffBufferRec[wrOnoffRecIndex][0] = sysTime >> 24; // è®°å½•è‡ªä¸»æŒ‡ä»¤æ—¶é—´
6923   2          onoffBufferRec[wrOnoffRecIndex][1] = sysTime >> 16;
6924   2          onoffBufferRec[wrOnoffRecIndex][2] = sysTime >> 8;
6925   2          onoffBufferRec[wrOnoffRecIndex][3] = sysTime;
6926   2          onoffBufferRec[wrOnoffRecIndex][4] = volSwitchOnoffTabA[number - 1]; // è®°å½•æŒ‡ä»¤ç 
6927   2          onoffBufferRec[wrOnoffRecIndex][5] = volSwitchOnoffTabA[number - 1];
6928   2      
6929   2          wrOnoffRecIndex++;
6930   2          if (wrOnoffRecIndex > 23) // æŒ‡ä»¤è®°å½•èŒƒå›´
6931   2          {
6932   3            wrOnoffRecIndex = 0;
6933   3          }
6934   2        }
6935   1        else if (type == 0xAB) // Bç»„ è¿‡å‹åˆ‡æ¢è®°å½•
6936   1        {
6937   2          onoffBufferRec[wrOnoffRecIndex][0] = sysTime >> 24; // è®°å½•è‡ªä¸»æŒ‡ä»¤æ—¶é—´
6938   2          onoffBufferRec[wrOnoffRecIndex][1] = sysTime >> 16;
6939   2          onoffBufferRec[wrOnoffRecIndex][2] = sysTime >> 8;
6940   2          onoffBufferRec[wrOnoffRecIndex][3] = sysTime;
6941   2          onoffBufferRec[wrOnoffRecIndex][4] = volSwitchOnoffTabB[number - 1]; // è®°å½•æŒ‡ä»¤ç 
6942   2          onoffBufferRec[wrOnoffRecIndex][5] = volSwitchOnoffTabB[number - 1];
6943   2      
6944   2          wrOnoffRecIndex++;
6945   2          if (wrOnoffRecIndex > 23) // æŒ‡ä»¤è®°å½•èŒƒå›´
6946   2          {
6947   3            wrOnoffRecIndex = 0;
6948   3          }
6949   2        }
6950   1        else if (type == 0xBB)
6951   1        {
6952   2          onoffBufferRec[wrOnoffRecIndex][0] = sysTime >> 24; // è®°å½•è‡ªä¸»æŒ‡ä»¤æ—¶é—´
6953   2          onoffBufferRec[wrOnoffRecIndex][1] = sysTime >> 16;
6954   2          onoffBufferRec[wrOnoffRecIndex][2] = sysTime >> 8;
6955   2          onoffBufferRec[wrOnoffRecIndex][3] = sysTime;
6956   2          onoffBufferRec[wrOnoffRecIndex][4] = number; // è®°å½•æŒ‡ä»¤ç 
6957   2          onoffBufferRec[wrOnoffRecIndex][5] = number;
6958   2      
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 115 

6959   2          wrOnoffRecIndex++;
6960   2          if (wrOnoffRecIndex > 23) // æŒ‡ä»¤è®°å½•èŒƒå›´
6961   2          {
6962   3            wrOnoffRecIndex = 0;
6963   3          }
6964   2        }
6965   1      }
6966          
6967          // ****************************************************
6968          // å‡½æ•°åç§° : RamCheck
6969          // åŠŸèƒ½æè¿° : RAMè‡ªæ£€å‡½æ•°
6970          // *****************************************************
6971          unsigned char RamCheck(void)
6972          {
6973   1        unsigned char i;
6974   1        unsigned char xdata check[64];
6975   1      
6976   1        for (i = 0; i < 64; i++) //å‘SRAMå†™å…¥0x55
6977   1        {
6978   2          check[i] = 0x55;
6979   2        }
6980   1        for (i = 0; i < 64; i++)
6981   1        {
6982   2          if (check[i] != 0x55)
6983   2          {
6984   3            return (TRUE); // è¿”å›é”™è¯¯20170815
6985   3          }
6986   2        }
6987   1        for (i = 0; i < 64; i++) //å‘SRAMå†™å…¥0xAA
6988   1        {
6989   2          check[i] = 0xAA;
6990   2        }
6991   1        for (i = 0; i < 64; i++)
6992   1        {
6993   2          if (check[i] != 0xAA)
6994   2          {
6995   3            return (TRUE); // è¿”å›é”™è¯¯
6996   3          }
6997   2        }
6998   1        return (FALSE); //è¿”å›æ­£ç¡®
6999   1      }
7000          
7001          /***************************************************************************************/
7002          /*  å‡½æ•°åç§°:  PowerSupplyCheck                                                        */
7003          /*  åŠŸèƒ½æè¿°:  ä¾›ç”µå‡½æ•°                                                                */
7004          /*  ä¿®æ”¹è®°å½•:                                                                          */
7005          /***************************************************************************************/
7006          void PowerSupplyCheck(void)
7007          {
7008   1        if (selectAB == 0xAA) // Aæœº æ—¶    åŒºåˆ†ABç”µå‹åˆ¤è¯»
7009   1        {
7010   2          if ((anData[84] > (0x3E8 + 120)) || (anData[84] < (0x3E8 - 120))) // 5VåŸºå‡†ç”µå‹ ä¸»æœº5V 0.3V
7011   2          {
7012   3            checkCount8++; // è®¡æ•°å¢åŠ 
7013   3            if (checkCount8 > 16)
7014   3            {
7015   4              fgCheck8 = TRUE; // è‡ªæ£€å¼‚å¸¸ è¿”å› TRUE - å¼‚å¸¸èŒƒå›´
7016   4            }
7017   3          }
7018   2          else
7019   2          {
7020   3            checkCount8 = 0;  // è®¡æ•°æ¸…é›¶
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 116 

7021   3            fgCheck8 = FALSE; //
7022   3          }
7023   2        }
7024   1        else // Bæœº æ—¶
7025   1        {
7026   2          if ((anData[85] > (0x3E8 + 120)) || (anData[85] < (0x3E8 - 120))) // 5VåŸºå‡†ç”µå‹  å¤‡æœº5V  0.3V
7027   2          {
7028   3            checkCount8++; // è®¡æ•°å¢åŠ 
7029   3            if (checkCount8 > 16)
7030   3            {
7031   4              fgCheck8 = TRUE; // è‡ªæ£€å¼‚å¸¸ è¿”å› TRUE - å¼‚å¸¸èŒƒå›´
7032   4            }
7033   3          }
7034   2          else
7035   2          {
7036   3            checkCount8 = 0;  // è®¡æ•°æ¸…é›¶
7037   3            fgCheck8 = FALSE; //
7038   3          }
7039   2        }
7040   1      }
7041          
7042          //****************************************************
7043          // å‡½æ•°åç§° : OverChargeProtect
7044          // åŠŸèƒ½æè¿° : è¿‡å……ä¿æŠ¤å‡½æ•°
7045          // *****************************************************
7046          void OverChargeProtect(void)
7047          {
7048   1        unsigned char i;
7049   1        float xdata batteryVminus1;
7050   1        float xdata batteryVminus2;
7051   1        float xdata tempfloat;
7052   1        unsigned int xdata batteryValueCunt;
7053   1        unsigned int xdata batteryChannel;
7054   1      
7055   1        if ((overChargeProtectEn == TRUE) && (chargeFlag == TRUE)) // è¿‡å……ä¿æŠ¤å…è®¸
7056   1        {
7057   2          if ((equVRefPhy >= 4.9) && (equVRefPhy <= 5.1)) // å‡è¡¡å™¨åŸºå‡†èƒ½å¦æ­£å¸¸å·¥ä½œ
7058   2          {
7059   3            if ((accVAEquPyh >= batteryVAWardValueUP) && (accVBEquPyh >= batteryVAWardValueUP)) // è“„ç”µæ± ç»„ç”µå
             -‹ä¸»ã€å¤‡éƒ½ä¸å°äºè“„ç”µæ± ç”µå‹ä¸Šé™ä¿æŠ¤å€¼
7060   3            {
7061   4              fgOverChargeprotect = TRUE;
7062   4            }
7063   3            else if ((accVAEquPyh >= batteryVAWardValueUP) || (accVBEquPyh >= batteryVAWardValueUP)) // åªå­˜åœ¨1ä
             -¸ªä¸å°äº
7064   3            {
7065   4              batteryVminus1 = fabs(accVAEquPyh - accVAHardPyh);
7066   4              batteryVminus2 = fabs(accVBEquPyh - accVAHardPyh);
7067   4              tempfloat = (batteryVminus1 < batteryVminus2) ? accVAEquPyh : accVBEquPyh;
7068   4              if (tempfloat >= batteryVAWardValueUP) // å·®å€¼å°çš„æ˜¯å¦è¶…è¿‡è®¾å®šé˜ˆå€¼
7069   4              {
7070   5                fgOverChargeprotect = TRUE;
7071   5              }
7072   4              else
7073   4              {
7074   5                fgOverChargeprotect = FALSE; // å¢åŠ è¿‡å……ä¿æŠ¤çŠ¶æ€æ¸…é›¶æ“ä½œ
7075   5              }
7076   4            }
7077   3            else
7078   3            {
7079   4              fgOverChargeprotect = FALSE; // å¢åŠ è¿‡å……ä¿æŠ¤çŠ¶æ€æ¸…é›¶æ“ä½œ
7080   4            }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 117 

7081   3      
7082   3            if (fgOverChargeprotect == TRUE) // æ˜¯å¦å¯ä»¥åˆ¤æ–­ä¸ºè¿‡å……çŠ¶æ€ä¸‹
7083   3            {
7084   4              for (i = 0; i < 10; i++) // éœ€è¦åˆ¤æ–­Aç»„å……ç”µç”µè·¯æ˜¯å¦æœ‰ä¸”åªæœ‰ä¸€è·¯æ•…éšœå……ç”µ
7085   4              {
7086   5                if (chargeArrayCurrent[i] > 4.0) // å……ç”µé˜µç”µæµå¤§äº4A
7087   5                {
7088   6                  chargeArrayCount[i]++;
7089   6                }
7090   5                else
7091   5                {
7092   6                  chargeArrayCount[i] = 0;
7093   6                }
7094   5              }
7095   4              batteryValueCunt = 0;
7096   4              batteryChannel = 0;
7097   4      
7098   4              if (batteryValueCunt == 1) // æœ‰ä¸”ä»…æœ‰ä¸€è·¯å……ç”µé˜µæ•…éšœ
7099   4              {
7100   5                fgOverChargeShort = TRUE; //
7101   5      
7102   5                if ((pcuState1 == 0xFF) && ((pcuState2 & 0xC0) == 0xC0)) // å……ç”µé˜µå…¨éƒ¨æ¥é€šæ¡ä»¶ä¸‹ ABç»„
7103   5                {
7104   6                  switch (batteryChannel) // æ•…éšœè·¯æ•°
7105   6                  {
7106   7                  case 0:              // A1æ•…éšœ
7107   7                    ONOFFOutput(5);        // å……ç”µé˜µA1æ–­å¼€
7108   7                    OnoffSelfExeRec(0xBB, 0x11); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7109   7                    break;
7110   7      
7111   7                  case 1:              // A2æ•…éšœ
7112   7                    ONOFFOutput(14);       // å……ç”µé˜µA2æ–­å¼€
7113   7                    OnoffSelfExeRec(0xBB, 0x12); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7114   7                    break;
7115   7      
7116   7                  case 2:              // A3æ•…éšœ
7117   7                    ONOFFOutput(6);        // å……ç”µé˜µA3æ–­å¼€
7118   7                    OnoffSelfExeRec(0xBB, 0x13); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7119   7                    break;
7120   7      
7121   7                  case 3:              // A4æ•…éšœ
7122   7                    ONOFFOutput(15);       // å……ç”µé˜µA4æ–­å¼€
7123   7                    OnoffSelfExeRec(0xBB, 0x14); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7124   7                    break;
7125   7      
7126   7                  case 4:              // A5æ•…éšœ
7127   7                    ONOFFOutput(7);        // å……ç”µé˜µA5æ–­å¼€
7128   7                    OnoffSelfExeRec(0xBB, 0x15); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7129   7                    break;
7130   7      
7131   7                  case 5:              // B1æ•…éšœ
7132   7                    ONOFFOutput(21);       // å……ç”µé˜µA5æ–­å¼€
7133   7                    OnoffSelfExeRec(0xBB, 0x17); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7134   7                    break;
7135   7      
7136   7                  case 6:              // B2æ•…éšœ
7137   7                    ONOFFOutput(30);       // å……ç”µé˜µB1æ–­å¼€
7138   7                    OnoffSelfExeRec(0xBB, 0x18); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7139   7                    break;
7140   7      
7141   7                  case 7:              // B3æ•…éšœ
7142   7                    ONOFFOutput(22);       // å……ç”µé˜µB2æ–­å¼€
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 118 

7143   7                    OnoffSelfExeRec(0xBB, 0x19); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7144   7                    break;
7145   7      
7146   7                  case 8:              // B4æ•…éšœ
7147   7                    ONOFFOutput(31);       // å……ç”µé˜µB3æ–­å¼€
7148   7                    OnoffSelfExeRec(0xBB, 0x1A); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7149   7                    break;
7150   7      
7151   7                  case 9:              // B5æ•…éšœ
7152   7                    ONOFFOutput(23);       // å……ç”µé˜µB4æ–­å¼€
7153   7                    OnoffSelfExeRec(0xBB, 0x1B); // è‡ªä¸»æŒ‡ä»¤è®°å½•
7154   7                    break;
7155   7      
7156   7                  default:
7157   7                    break;
7158   7                  }
7159   6      
7160   6                  selfControlCount++;     // è¿‡å……è‡ªä¸»æ§åˆ¶è®¡æ•°
7161   6                  overChargeProCount++;   // è¿‡å……ä¿æŠ¤è‡ªä¸»è®¡æ•°
7162   6                  if (overChargeProCount > 3) // bit2 æœ‰æ•ˆèŒƒå›´
7163   6                  {
7164   7                    overChargeProCount = 0;
7165   7                  }
7166   6                }
7167   5              }
7168   4            }
7169   3            else //
7170   3            {
7171   4              for (i = 0; i < 10; i++) // ä¸è¿‡å……åˆ™æ¸…é›¶è®¡æ•°
7172   4              {
7173   5                chargeArrayCount[i] = 0;
7174   5              }
7175   4            }
7176   3          }
7177   2        }
7178   1      }
7179          
7180          //****************************************************
7181          // **å‡½æ•°åç§° : ChargeCheck
7182          // **åŠŸèƒ½æè¿° : å……ç”µæ§åˆ¶æ¨¡å—
7183          // *****************************************************
7184          void ChargeCheck(void)
7185          {
7186   1        unsigned char temp;
7187   1        unsigned char ttflag;
7188   1      
7189   1        ttflag = FALSE;
7190   1        temp = ((aqStateContrl >> 5) & 0x03); // åˆ¤æ–­æœ‰å‡ èŠ‚å•ä½“å‚ä¸æ§åˆ¶
7191   1      
7192   1        switch (temp)
7193   1        {
7194   2        case 0x03:
7195   2          aqControlNumber = 0x09;
7196   2          break;
7197   2        case 0x02:
7198   2          aqControlNumber = 0x08;
7199   2          break;
7200   2        case 0x01:
7201   2          aqControlNumber = 0x07;
7202   2          break;
7203   2        case 0x00:
7204   2          aqControlNumber = 0x06;
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 119 

7205   2          break;
7206   2        default:
7207   2          break;
7208   2        }
7209   1      
7210   1        chargeFlag = FALSE; //å……ç”µçŠ¶æ€é»˜è®¤ä¸å……ç”µ
7211   1        if (meaV > 7.5)   // MEAå¤§äº7.5V
7212   1        {
7213   2          currentModeCountB[0]++;   //MEAè®¡æ•°
7214   2          currentModeCountA[0] = 0; //MEAè®¡æ•°
7215   2        }
7216   1        else
7217   1        {
7218   2          currentModeCountA[0]++;   // MEAè®¡æ•°
7219   2          currentModeCountB[0] = 0; // MEAè®¡æ•°
7220   2        }
7221   1        if (chargeCurrent1 > 4) // å……ç”µç”µæµå¤§äº4A
7222   1        {
7223   2          currentModeCountB[1]++; //MEAè®¡æ•°
7224   2        }
7225   1        else
7226   1        {
7227   2          currentModeCountB[1] = 0; //MEAè®¡æ•°
7228   2        }
7229   1        if (chargeCurrent2 > 4) //Bç»„å……ç”µç”µæµå¤§äº4A
7230   1        {
7231   2          currentModeCountB[2]++; //MEAè®¡æ•°
7232   2        }
7233   1        else
7234   1        {
7235   2          currentModeCountB[2] = 0; //MEAè®¡æ•°
7236   2        }
7237   1        if (dischargeCurrent1 > 5) // æ”¾ç”µç”µæµ1è®¡æ•°
7238   1        {
7239   2          currentModeCountA[1]++;
7240   2        }
7241   1        else
7242   1        {
7243   2          currentModeCountA[1] = 0;
7244   2        }
7245   1        if (dischargeCurrent2 > 5) // æ”¾ç”µç”µæµ2è®¡æ•°
7246   1        {
7247   2          currentModeCountA[2]++;
7248   2        }
7249   1        else
7250   1        {
7251   2          currentModeCountA[2] = 0;
7252   2        }
7253   1        // åˆ¤æ–­æ˜¯å¦å¤„äºæ”¾ç”µçŠ¶æ€
7254   1        if (currentModeCountA[0] >= 28)
7255   1        {
7256   2          if ((currentModeCountA[1] > 59) || (currentModeCountA[2] > 59))
7257   2          {
7258   3            ttflag = TRUE;
7259   3          }
7260   2        }
7261   1        else
7262   1        {
7263   2          if ((currentModeCountA[1] > 59) && (currentModeCountA[2] > 59))
7264   2          {
7265   3            ttflag = TRUE;
7266   3          }
C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 120 

7267   2        }
7268   1      
7269   1        // åˆ¤æ–­æ˜¯å¦å¤„äºå……ç”µçŠ¶æ€
7270   1        if (currentModeCountB[0] >= 28)
7271   1        {
7272   2          if ((currentModeCountB[1] > 27) || (currentModeCountB[2] > 27)) //å……ç”µçŠ¶æ€
7273   2          {
7274   3            chargeFlag = TRUE; // è®¾ç½®å……ç”µçŠ¶æ€
7275   3          }
7276   2        }
7277   1        else
7278   1        {
7279   2          if ((currentModeCountB[1] > 27) && (currentModeCountB[2] > 27)) //å……ç”µçŠ¶æ€
7280   2          {
7281   3            chargeFlag = TRUE; // è®¾ç½®å……ç”µçŠ¶æ€
7282   3          }
7283   2        }
7284   1      
7285   1        if (ttflag == TRUE) // å¤„äºæ”¾ç”µ
7286   1        {
7287   2          if (singlesaveflag == TRUE) // å•ä½“ä¿æŠ¤å……ç”µæ§åˆ¶è‡ªä¸»åˆ‡æ¢æ›²çº¿
7288   2          {
7289   3            if ((singlesaveVLevelA > 0) && (singlesaveVLevelA < 9)) //æ¡£ä½èŒƒå›´1~8
7290   3            {
7291   4              chargeVolKickA = singlesaveVLevelA;   //æ¢å¤ä¿æŠ¤å‰çŠ¶æ€
7292   4              chargeVolKickA_B = singlesaveVLevelA; // Aç»„ç”µå‹
7293   4              chargeVolKickA_C = singlesaveVLevelA; // Aç»„ç”µå‹
7294   4      
7295   4              chargeVolKickB = singlesaveVLevelB;   // æ¢å¤ä¿æŠ¤å‰çŠ¶æ€
7296   4              chargeVolKickB_B = singlesaveVLevelB; // Bç»„ç”µå‹
7297   4              chargeVolKickB_C = singlesaveVLevelB; // Bç»„ç”µå‹
7298   4      
7299   4              singlesaveflag = FALSE; //ä¿å­˜çŠ¶æ€
7300   4      
7301   4              chargeVolKickRsA = chargeVolKickA;
7302   4              chargeVolKickRsB = chargeVolKickB;
7303   4      
7304   4              DA_A_VOL = volCsTab[chargeVolKickRsA - 1]; // Aç»„ç”µå‹ åˆ‡æ¢æ‰§è¡Œ
7305   4              DA_B_VOL = volCsTab[chargeVolKickRsA - 1]; // Bç»„ç”µå‹ åˆ‡æ¢æ‰§è¡Œ
7306   4      
7307   4              OnoffSelfExeRec(0xAA, chargeVolKickRsA); // è‡ªä¸»æŒ‡ä»¤è®°å½• - Aç»„ åˆ‡æ¢è¿‡å‹åˆ‡æ¢è®°å½•
7308   4              OnoffSelfExeRec(0xAB, chargeVolKickRsB); // è‡ªä¸»æŒ‡ä»¤è®°å½• - Bç»„ åˆ‡æ¢è¿‡å‹åˆ‡æ¢è®°å½•
7309   4      
7310   4              selfControlCount++; // è‡ªä¸»æ§åˆ¶è®¡æ•°
7311   4            }
7312   3          }
7313   2        }
7314   1      }
7315          
7316          //--------------------------------------------------------------------------------------------------------
             --------//


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  34101    ----
   CONSTANT SIZE    =    290    ----
   XDATA SIZE       =   2501     200
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     28     102
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.60.0.0   POWER                                                             03/24/2020 19:38:00 PAGE 121 


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
